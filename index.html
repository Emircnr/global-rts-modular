<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures ↔ Spot — Anlık Fark (Ultra Hızlı)</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --spotAsk:#ef4444; --spotBid:#22c55e; --futBid:#22c55e; --futAsk:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:16px; --maxW:1180px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#4b5563;
    --panel:#f4f7fb; --panel2:#ffffff; --glass:rgba(0,0,0,.06);
    --border:#d7e0ef; --accent:#2563eb; --good:#16a34a; --bad:#dc2626;
    --spotAsk:#b91c1c; --spotBid:#15803d; --futBid:#15803d; --futAsk:#b91c1c;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg); background:
      radial-gradient(1200px 800px at 15% -10%, #0f2b59 0%, transparent 55%),
      radial-gradient(1000px 700px at 110% 0%, #153160 0%, transparent 55%),
      linear-gradient(180deg,#0a1222 0%, #0b0f19 60%);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  }

  /* ---- Layout (ortada) ---- */
  .wrap{max-width:var(--maxW); margin:0 auto; padding:18px}
  header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(5,10,22,.85), transparent); backdrop-filter:blur(10px)}
  .center{display:flex; justify-content:center}
  h1{margin:0; font-size:22px; letter-spacing:.2px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .right{margin-left:auto}

  /* ---- Buttons / inputs ---- */
  .btn{
    border:1px solid var(--border);
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer
  }
  .btn:hover{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 20%, transparent)}
  .iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:12px}
  input,select{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); color:var(--fg); border-radius:12px; padding:10px 12px
  }
  .chip{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); display:inline-flex; gap:8px; align-items:center}

  /* ---- Top card ---- */
  #topCard{
    margin:18px auto; max-width:900px;
    padding:16px 18px; border-radius:20px; border:1px solid var(--border);
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), transparent),
      radial-gradient(900px 400px at -10% -30%, rgba(96,165,250,.18), transparent 60%),
      linear-gradient(180deg,var(--panel),var(--panel2));
  }
  #topCard.hidden{display:none}
  .pill{border:1px solid var(--border); padding:5px 10px; border-radius:999px}
  .mono{font-variant-numeric:tabular-nums slashed-zero; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .blink{animation:blink .6s ease-in-out 1} @keyframes blink{50%{filter:brightness(1.35)}}
  .sym{font-weight:800; font-size:22px}

  /* ---- Table ---- */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow:0 10px 34px rgba(0,0,0,.22)}
  table{width:100%; border-collapse:separate; border-spacing:0 var(--gap)}
  thead th{font-size:13px; color:var(--muted); text-align:left; padding:0 12px}
  tbody td{padding:var(--padY) var(--padX); font-size:var(--font); background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-left:none; border-right:none}
  tbody tr td:first-child{border-top-left-radius:var(--radius); border-bottom-left-radius:var(--radius); border-left:1px solid var(--border)}
  tbody tr td:last-child{border-top-right-radius:var(--radius); border-bottom-right-radius:var(--radius); border-right:1px solid var(--border)}
  .src-spotAsk{background:color-mix(in oklab, var(--spotAsk) 18%, transparent)}
  .src-futBid{background:color-mix(in oklab, var(--futBid) 18%, transparent)}
  .src-spotBid{background:color-mix(in oklab, var(--spotBid) 18%, transparent)}
  .src-futAsk{background:color-mix(in oklab, var(--futAsk) 18%, transparent)}
  .pctPos{color:var(--good); font-weight:800}

  /* ---- Floating manager (popup) ---- */
  #mgrBtn{position:fixed; right:22px; top:18px; z-index:50}
  #mgrModal{position:fixed; inset:0; display:none; z-index:60}
  #mgrModal.open{display:block}
  .overlay{position:absolute; inset:0; background:rgba(3,6,15,.55); backdrop-filter:blur(4px); opacity:0; animation:fadeIn .15s ease forwards}
  @keyframes fadeIn{to{opacity:1}}
  .panel{
    position:absolute; right:24px; top:72px; width:min(460px, calc(100% - 32px));
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.45);
    transform:translateY(-10px); opacity:0; animation:pop .18s ease forwards
  }
  @keyframes pop{to{transform:none; opacity:1}}
  .panel header{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 0}
  .panel h3{margin:0; font-size:16px}
  .panel .content{padding:12px 14px 14px; display:grid; gap:12px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chipx{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset; cursor:pointer; color:var(--muted)}
  .grp{border:1px dashed var(--border); border-radius:14px; padding:10px}
  .lbl{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
</style>
</head>
<body>
  <!-- Tek yönetim kutusu (popup) -->
  <button id="mgrBtn" class="btn iconbtn" title="Yönetim">⚙️</button>

  <header class="wrap center">
    <div class="row">
      <h1>Gate.io Futures ↔ Spot — Anlık Fark</h1>
      <div class="chip">Saat: <span id="clock" class="mono">—:—:—</span></div>
    </div>
  </header>

  <!-- Top Fark Kartı (ortada) — SADECE SHORT gösterecek -->
  <div class="wrap center">
    <div id="topCard" class="card" style="width:100%; max-width:900px;">
      <span id="topSym" class="sym">—</span>
      <span id="topSide" class="pill bad">FUTURES SHORT</span>
      <span id="topDesc" class="mono">Spot ASK — ↔ Futures BID —</span>
      <span id="topPct" class="mono">—</span>
    </div>
  </div>

  <!-- Tablo (ortada) -->
  <main class="wrap center" style="padding-bottom:34px">
    <div class="card" style="width:100%">
      <table>
        <thead>
          <tr>
            <th>Coin</th>
            <th>Spot ASK (Kırmızı)</th>
            <th>Futures BID (Yeşil)</th>
            <th>% Fark (SHORT)</th>
            <th>Spot BID (Yeşil)</th>
            <th>Futures ASK (Kırmızı)</th>
            <th>% Fark (LONG)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Yönetim Modal -->
  <div id="mgrModal">
    <div class="overlay" data-close="1"></div>
    <div class="panel">
      <header>
        <h3>Yönetim</h3>
        <div class="row">
          <select id="themeSel">
            <option value="dark">Koyu tema</option>
            <option value="light">Açık tema</option>
          </select>
          <button class="btn iconbtn" title="Kapat" data-close="1">✖</button>
        </div>
      </header>
      <div class="content">
        <div class="grp">
          <label class="lbl">Coin ekle / çıkar (örn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
          <div class="row">
            <input id="addSym" type="text" placeholder="Sembol"/>
            <button id="btnAdd" class="btn">Ekle</button>
            <button id="btnClear" class="btn" style="margin-left:auto">Tümünü Sil</button>
          </div>
          <div id="chipWrap" class="chips" style="margin-top:8px"></div>
        </div>

        <div class="grp">
          <label class="lbl">Fark eşiği (%) — sadece BU eşik ÜSTÜ ve POZİTİF farklar yazılır (satırlar sabit kalır)</label>
          <div class="row">
            <input id="thresh" type="number" step="0.01" value="0.10" style="width:160px"/>
            <label class="row" style="margin-left:auto"><input type="checkbox" id="toggleTop" checked/> En yüksek (SHORT) kart</label>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= Yardımcılar ========= */
const $ = s=>document.querySelector(s);
const now = ()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const nf = new Intl.NumberFormat('tr-TR',{maximumFractionDigits:9});
const toNum = v => (typeof v === 'number') ? v : parseFloat(v);
const pctStr = v => isFinite(v) ? ((v>=0?'+':'') + v.toFixed(3) + '%') : '—';

/* ========= Durum ========= */
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('gate:list')||'["BTC_USDT","ETH_USDT"]')),
  ui: {
    thresh:+(localStorage.getItem('gate:thresh')||0.10),
    theme: localStorage.getItem('gate:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('gate:showTop')||'true')
  },
  spot: new Map(), // sym -> {bid, ask, ts}
  fut: new Map(),  // sym -> {bid, ask, ts}
  rowEls: new Map(),
  rafScheduled:false,
  ws:{spot:null, fut:null},
  ping:{spot:null, fut:null},
  lastTop:null
};
function saveList(){ localStorage.setItem('gate:list', JSON.stringify([...S.coins])); }
function saveUI(){ localStorage.setItem('gate:thresh',S.ui.thresh); localStorage.setItem('gate:theme',S.ui.theme); localStorage.setItem('gate:showTop',S.ui.showTop); }

/* ========= Tema & Saat ========= */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
applyTheme();
setInterval(()=>$('#clock').textContent=now(), 1000);

/* ========= Modal ========= */
const mgr = { open(){ $('#mgrModal').classList.add('open'); $('#addSym').focus(); }, close(){ $('#mgrModal').classList.remove('open'); } };
$('#mgrBtn').onclick = ()=>mgr.open();
$('#mgrModal').addEventListener('click', e=>{ if(e.target.dataset.close) mgr.close(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape') mgr.close(); });

/* ========= Yönetim UI ========= */
$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#themeSel').value = S.ui.theme;

$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); scheduleDraw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop=e.target.checked; saveUI(); scheduleDraw(); };
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };

function renderChips(){
  const wrap=$('#chipWrap'); wrap.innerHTML='';
  const frag=document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d=document.createElement('div'); d.className='chipx';
    const b=document.createElement('b'); b.textContent=sym.replace('_','');
    const x=document.createElement('button'); x.textContent='✕';
    x.onclick=()=>{ S.coins.delete(sym); saveList(); unsub(sym); const el=S.rowEls.get(sym); el?.tr.remove(); S.rowEls.delete(sym); };
    d.append(b,x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
renderChips();

$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase(); if(!raw) return;
  let sym = raw.includes('_')? raw : raw.replace('USDT','_USDT');
  sym = sym.replace(/[^A-Z0-9_]/g,'');
  if(!sym.endsWith('_USDT')) return alert('Sadece *_USDT sembolleri.');
  if(!S.coins.has(sym)){
    S.coins.add(sym); saveList(); renderChips(); ensureRow(sym); sub(sym);
  }
  $('#addSym').value='';
};
$('#btnClear').onclick = ()=>{
  if(confirm('Tüm coinleri sil?')){
    [...S.coins].forEach(s=>unsub(s)); S.coins.clear(); saveList();
    S.rowEls.forEach(el=>el.tr.remove()); S.rowEls.clear();
  }
};

/* ========= Gate.io WebSocket ========= */
/* Spot:    wss://api.gateio.ws/ws/v4/       channel: spot.book_ticker (payload: ["BTC_USDT"]) */
/* Futures: wss://fx-ws.gateio.ws/v4/ws/usdt channel: futures.book_ticker (payload: ["BTC_USDT"]) */
function wsConnect(kind){
  const isSpot = kind==='spot';
  try{ S.ws[kind]?.close?.(); }catch{}
  const url = isSpot ? 'wss://api.gateio.ws/ws/v4/' : 'wss://fx-ws.gateio.ws/v4/ws/usdt';
  const ws = new WebSocket(url); S.ws[kind]=ws;

  ws.onopen = ()=>{
    // clear eski ping
    if(S.ping[kind]){ clearInterval(S.ping[kind]); S.ping[kind]=null; }
    // abone ol
    for(const sym of S.coins){ sendSub(kind, sym, true); }
    // ping
    S.ping[kind] = setInterval(()=>{
      if(ws.readyState===1){
        ws.send(JSON.stringify({time:Math.floor(Date.now()/1000), channel:isSpot?'spot.ping':'futures.ping'}));
      }
    }, 15000);
  };
  ws.onmessage = (ev)=>{
    try{
      const j = JSON.parse(ev.data);
      if(!j || j.event!=='update' || !j.result) return;

      if(isSpot && j.channel==='spot.book_ticker'){
        const r=j.result; const sym=r.s; const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.spot.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
      if(!isSpot && j.channel==='futures.book_ticker'){
        const r=j.result; const sym=r.s; const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.fut.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
    }catch(_){}
  };
  ws.onclose = ()=>{
    if(S.ping[kind]){ clearInterval(S.ping[kind]); S.ping[kind]=null; }
    setTimeout(()=>wsConnect(kind), 800 + Math.random()*400);
  };
}
function sendSub(kind, sym, on){
  const ws=S.ws[kind]; if(!ws || ws.readyState!==1) return;
  const channel = (kind==='spot') ? 'spot.book_ticker' : 'futures.book_ticker';
  ws.send(JSON.stringify({ time: Math.floor(Date.now()/1000), channel, event: on?'subscribe':'unsubscribe', payload:[sym] }));
}
function sub(sym){ sendSub('spot',sym,true); sendSub('fut',sym,true); }
function unsub(sym){ sendSub('spot',sym,false); sendSub('fut',sym,false); S.spot.delete(sym); S.fut.delete(sym); }

/* bağlan */
wsConnect('spot'); wsConnect('fut');

/* ========= Hesaplama ========= */
function cmpFor(sym){
  const sp=S.spot.get(sym), fu=S.fut.get(sym);
  if(!sp || !fu) return null;
  const askS=sp.ask, bidS=sp.bid, bidF=fu.bid, askF=fu.ask;
  const okShort = isFinite(askS)&&isFinite(bidF)&&askS>0;
  const okLong  = isFinite(bidS)&&isFinite(askF)&&askF>0;
  const shortPct = okShort ? ((bidF - askS)/askS*100) : NaN;
  const longPct  = okLong  ? ((bidS - askF)/askF*100) : NaN;
  return {sym, askS, bidS, bidF, askF, shortPct, longPct};
}

/* ========= Tablo ve Top Kart ========= */
function ensureRow(sym){
  if(S.rowEls.has(sym)) return;
  const tr=document.createElement('tr'); tr.dataset.sym=sym;
  const tdC   = document.createElement('td'); tdC.className='sym'; tdC.textContent=sym.replace('_','');
  const tdA   = document.createElement('td'); tdA.className='mono src-spotAsk'; tdA.textContent='—';
  const tdFB  = document.createElement('td'); tdFB.className='mono src-futBid';  tdFB.textContent='—';
  const tdSP  = document.createElement('td'); tdSP.className='mono'; tdSP.textContent='—'; // short %
  const tdSB  = document.createElement('td'); tdSB.className='mono src-spotBid'; tdSB.textContent='—';
  const tdFA  = document.createElement('td'); tdFA.className='mono src-futAsk';  tdFA.textContent='—';
  const tdLP  = document.createElement('td'); tdLP.className='mono'; tdLP.textContent='—'; // long %
  tr.append(tdC,tdA,tdFB,tdSP,tdSB,tdFA,tdLP);
  $('#tbody').appendChild(tr);
  S.rowEls.set(sym,{tr,tdA,tdFB,tdSP,tdSB,tdFA,tdLP});
}
function scheduleDraw(){ if(!S.rafScheduled){ S.rafScheduled=true; requestAnimationFrame(draw); } }

function draw(){
  S.rafScheduled=false;
  const thr = Number(S.ui.thresh)||0;

  // tablo: SIRALAMA YOK, sabit sıra — sadece hücreler güncellenir, satırlar asla gizlenmez
  for(const sym of S.coins){
    ensureRow(sym);
    const r = cmpFor(sym);
    const el = S.rowEls.get(sym);

    if(!r){
      // veri yoksa hücreler '—' kalır
      continue;
    }

    // fiyatlar (her zaman yaz)
    el.tdA.textContent  = isFinite(r.askS) ? nf.format(r.askS) : '—';
    el.tdFB.textContent = isFinite(r.bidF) ? nf.format(r.bidF) : '—';
    el.tdSB.textContent = isFinite(r.bidS) ? nf.format(r.bidS) : '—';
    el.tdFA.textContent = isFinite(r.askF) ? nf.format(r.askF) : '—';

    // sadece POZİTİF ve EŞİK ÜSTÜ yüzde yaz; aksi '—'
    const showShort = isFinite(r.shortPct) && r.shortPct>0 && r.shortPct>=thr;
    const showLong  = isFinite(r.longPct)  && r.longPct>0  && r.longPct>=thr;

    el.tdSP.innerHTML = showShort ? `<span class="pctPos">${pctStr(r.shortPct)}</span>` : '—';
    el.tdLP.innerHTML = showLong  ? `<span class="pctPos">${pctStr(r.longPct)}</span>`  : '—';
  }

  // Top kart: SADECE SHORT ve en yükseği bul (sıralama yapmadan)
  const top=$('#topCard');
  if(!S.ui.showTop){ top.classList.add('hidden'); $('#clock').textContent=now(); return; }

  let bestSym=null, bestPct=-Infinity, bestAskS=null, bestBidF=null;
  for(const sym of S.coins){
    const r = cmpFor(sym);
    if(!r) continue;
    const p = r.shortPct;
    if(isFinite(p) && p>0 && p>=thr && p>bestPct){
      bestPct=p; bestSym=sym; bestAskS=r.askS; bestBidF=r.bidF;
    }
  }
  if(bestSym){
    $('#topSym').textContent = bestSym.replace('_','');
    $('#topSide').textContent = 'FUTURES SHORT';
    $('#topSide').className = 'pill bad';
    $('#topDesc').textContent = `Spot ASK ${nf.format(bestAskS)} ↔ Futures BID ${nf.format(bestBidF)}`;
    const pctEl = $('#topPct'); pctEl.textContent = pctStr(bestPct); pctEl.className='mono good';
    const sig = bestSym+'|'+bestPct.toFixed(5);
    if(S.lastTop!==sig){ top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 260); S.lastTop=sig; }
    top.classList.remove('hidden');
  }else{
    top.classList.add('hidden');
  }

  $('#clock').textContent = now();
}

/* ========= Başlangıç ========= */
function start(){
  // mevcut coinler için sabit satırlar oluştur
  S.coins.forEach(sym=>ensureRow(sym));
  // abone ol
  S.coins.forEach(sym=>{ sendSub('spot',sym,true); sendSub('fut',sym,true); });

  // saat ve ilk çizim
  $('#clock').textContent = now();
  scheduleDraw();
}
start();
</script>
</body>
</html>
