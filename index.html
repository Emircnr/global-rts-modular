<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures â†” Spot â€” AnlÄ±k Fark (Ultra HÄ±zlÄ± + Bot)</title>
<!--
  Gate API v4 imza:
    SIGN_STRING = METHOD \n /api/v4 + PATH \n QUERY \n HEX(SHA512(BODY)) \n TIMESTAMP
  Spot REST base:    https://api.gateio.ws
  Futures REST base: https://fx-api.gateio.ws
  WS: spot  -> wss://api.gateio.ws/ws/v4/
      fut   -> wss://fx-ws.gateio.ws/v4/ws/usdt

  Ã–nemli notlar:
  - Spot market BUY emrinde 'amount' = QUOTE (USDT) miktarÄ±dÄ±r. (Gate v4)
  - Market emirler iÃ§in time_in_force = 'ioc' kullanÄ±lmalÄ±dÄ±r.
  - Futures market: price:"0" + tif:"ioc"; SHORT iÃ§in size < 0, kapama iÃ§in reduce_only + size > 0.

  GÃ¼venlik: API anahtarlarÄ±nÄ± tarayÄ±cÄ±da saklamak risklidir; prodâ€™da imzalamayÄ± sunucu/worker Ã¼zerinden yapÄ±n.
-->
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --spotAsk:#ef4444; --spotBid:#22c55e; --futBid:#22c55e; --futAsk:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:16px; --maxW:1180px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#4b5563; --panel:#f4f7fb; --panel2:#ffffff;
    --glass:rgba(0,0,0,.06); --border:#d7e0ef; --accent:#2563eb;
    --good:#16a34a; --bad:#dc2626;
    --spotAsk:#b91c1c; --spotBid:#15803d; --futBid:#15803d; --futAsk:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    background:
      radial-gradient(1200px 800px at 15% -10%, #0f2b59 0%, transparent 55%),
      radial-gradient(1000px 700px at 110% 0%, #153160 0%, transparent 55%),
      linear-gradient(180deg,#0a1222 0%, #0b0f19 60%);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  }
  .wrap{max-width:var(--maxW); margin:0 auto; padding:18px}
  header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(5,10,22,.85), transparent); backdrop-filter:blur(10px)}
  .center{display:flex; justify-content:center}
  h1{margin:0; font-size:22px; letter-spacing:.2px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel2));
    color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer
  }
  .btn:hover{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 20%, transparent)}
  .iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:12px}
  input,select,textarea{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); color:var(--fg); border-radius:12px; padding:10px 12px
  }
  .chip{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); display:inline-flex; gap:8px; align-items:center}

  /* Top card */
  #topCard{ margin:18px auto; max-width:900px; padding:16px 18px; border-radius:20px; border:1px solid var(--border);
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent),
                radial-gradient(900px 400px at -10% -30%, rgba(96,165,250,.18), transparent 60%),
                linear-gradient(180deg,var(--panel),var(--panel2));
  }
  #topCard.hidden{display:none}
  .pill{border:1px solid var(--border); padding:5px 10px; border-radius:999px}
  .mono{font-variant-numeric:tabular-nums slashed-zero; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .blink{animation:blink .6s ease-in-out 1}
  @keyframes blink{50%{filter:brightness(1.35)}}
  .sym{font-weight:800; font-size:22px}

  /* Table */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow:0 10px 34px rgba(0,0,0,.22)}
  table{width:100%; border-collapse:separate; border-spacing:0 var(--gap)}
  thead th{font-size:13px; color:var(--muted); text-align:left; padding:0 12px}
  tbody td{padding:var(--padY) var(--padX); font-size:var(--font); background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-left:none; border-right:none}
  tbody tr td:first-child{border-top-left-radius:var(--radius); border-bottom-left-radius:var(--radius); border-left:1px solid var(--border)}
  tbody tr td:last-child{border-top-right-radius:var(--radius); border-bottom-right-radius:var(--radius); border-right:1px solid var(--border)}
  .src-spotAsk{background:color-mix(in oklab, var(--spotAsk) 18%, transparent)}
  .src-futBid{background:color-mix(in oklab, var(--futBid) 18%, transparent)}
  .src-spotBid{background:color-mix(in oklab, var(--spotBid) 18%, transparent)}
  .src-futAsk{background:color-mix(in oklab, var(--futAsk) 18%, transparent)}
  .pctPos{color:var(--good); font-weight:800}

  /* Floating buttons & modals */
  #mgrBtn{position:fixed; right:22px; top:18px; z-index:50}
  #botBtn{position:fixed; right:72px; top:18px; z-index:50}
  .modal{position:fixed; inset:0; display:none; z-index:60}
  .modal.open{display:block}
  .overlay{position:absolute; inset:0; background:rgba(3,6,15,.55); backdrop-filter:blur(4px); opacity:0; animation:fadeIn .15s ease forwards}
  @keyframes fadeIn{to{opacity:1}}
  .panel{ position:absolute; right:24px; top:72px; width:min(560px, calc(100% - 32px)); background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.45); transform:translateY(-10px); opacity:0; animation:pop .18s ease forwards }
  @keyframes pop{to{transform:none; opacity:1}}
  .panel header{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 0}
  .panel h3{margin:0; font-size:16px}
  .panel .content{padding:12px 14px 14px; display:grid; gap:12px}
  .grp{border:1px dashed var(--border); border-radius:14px; padding:10px}
  .lbl{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chipx{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset; cursor:pointer; color:var(--muted)}
  .warn{font-size:12px; color:var(--muted)}
  #botLog{height:140px; resize:vertical}
</style>
</head>
<body>
  <!-- Buttons -->
  <button id="botBtn" class="btn iconbtn" title="Bot"> ğŸ¤– </button>
  <button id="mgrBtn" class="btn iconbtn" title="YÃ¶netim"> âš™ï¸ </button>

  <header class="wrap center">
    <div class="row">
      <h1>Gate.io Futures â†” Spot â€” AnlÄ±k Fark</h1>
      <div class="chip">Saat: <span id="clock" class="mono">â€”:â€”:â€”</span></div>
    </div>
  </header>

  <!-- Top Diff Card -->
  <div class="wrap center">
    <div id="topCard" class="card" style="width:100%; max-width:900px;">
      <span id="topSym" class="sym">â€”</span>
      <span id="topSide" class="pill">â€”</span>
      <span id="topDesc" class="mono">â€”</span>
      <span id="topPct" class="mono">â€”</span>
    </div>
  </div>

  <!-- Table -->
  <main class="wrap center" style="padding-bottom:34px">
    <div class="card" style="width:100%">
      <table>
        <thead>
          <tr>
            <th>Coin</th>
            <th>Spot ASK (KÄ±rmÄ±zÄ±)</th>
            <th>Futures BID (YeÅŸil)</th>
            <th>% Fark (SHORT)</th>
            <th>Spot BID (YeÅŸil)</th>
            <th>Futures ASK (KÄ±rmÄ±zÄ±)</th>
            <th>% Fark (LONG)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p id="emptyNote" style="margin:12px 6px 2px; color:var(--muted); font-size:13px; display:none">
        EÅŸik Ã¼stÃ¼ <b>pozitif</b> fark yok.
      </p>
    </div>
  </main>

  <!-- YÃ¶netim Modal -->
  <div id="mgrModal" class="modal">
    <div class="overlay" data-close="1"></div>
    <div class="panel">
      <header>
        <h3>YÃ¶netim</h3>
        <div class="row">
          <select id="themeSel">
            <option value="dark">Koyu tema</option>
            <option value="light">AÃ§Ä±k tema</option>
          </select>
          <button class="btn iconbtn" title="Kapat" data-close="1">âœ–</button>
        </div>
      </header>
      <div class="content">
        <div class="grp">
          <label class="lbl">Coin ekle / Ã§Ä±kar (Ã¶rn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
          <div class="row">
            <input id="addSym" type="text" placeholder="Sembol"/>
            <button id="btnAdd" class="btn">Ekle</button>
            <button id="btnClear" class="btn" style="margin-left:auto">TÃ¼mÃ¼nÃ¼ Sil</button>
          </div>
          <div id="chipWrap" class="chips" style="margin-top:8px"></div>
        </div>
        <div class="grp">
          <label class="lbl">Fark eÅŸiÄŸi (%) â€” tabloda sadece bu eÅŸik ÃœSTÃœ ve POZÄ°TÄ°F farklar listelenir</label>
          <div class="row">
            <input id="thresh" type="number" step="0.01" value="0.10" style="width:160px"/>
            <label class="row" style="margin-left:auto"><input type="checkbox" id="toggleTop" checked/> En yÃ¼ksek fark kartÄ±</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT Modal -->
  <div id="botModal" class="modal">
    <div class="overlay" data-close="1"></div>
    <div class="panel">
      <header>
        <h3>Arbitraj Botu (Spot AL + Futures SHORT)</h3>
        <button class="btn iconbtn" title="Kapat" data-close="1">âœ–</button>
      </header>
      <div class="content">
        <div class="grp">
          <label class="lbl">Ã‡alÄ±ÅŸma</label>
          <div class="row">
            <label class="row"><input type="checkbox" id="botEnable"/> Botu BaÅŸlat</label>
            <label class="row"><input type="checkbox" id="botDry" checked/> Dry-Run (sadece log, emir yok)</label>
            <label class="row"><input type="checkbox" id="botUseTableThresh" checked/> AÃ§Ä±ÅŸ iÃ§in tablo eÅŸiÄŸini kullan</label>
          </div>
        </div>

        <div class="grp">
          <label class="lbl">EÅŸikler & Tutar</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <label> AÃ§Ä±ÅŸ EÅŸiÄŸi % <input id="botOpenThresh" type="number" step="0.01" value="0.30" style="width:120px"/></label>
            <label> KapanÄ±ÅŸ EÅŸiÄŸi % (LONG) <input id="botCloseThresh" type="number" step="0.01" value="0.20" style="width:150px"/></label>
            <label> Ä°ÅŸlem TutarÄ± (USDT) <input id="botNotional" type="number" step="1" value="50" style="width:120px"/></label>
          </div>
        </div>

        <div class="grp">
          <label class="lbl">Futures AyarlarÄ±</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <label> KaldÄ±raÃ§ <input id="botLev" type="number" step="1" value="5" style="width:100px"/></label>
            <label> Marjin
              <select id="botMargin" style="width:140px">
                <option value="isolated" selected>Isolated</option>
                <option value="cross">Cross</option>
              </select>
            </label>
            <label> Cooldown (sn) <input id="botCooldown" type="number" step="1" value="5" style="width:90px"/></label>
          </div>
          <div class="warn">AynÄ± sembolde aynÄ± anda yalnÄ±zca <b>tek aktif iÅŸlem</b> aÃ§Ä±lÄ±r. LONG sinyali kapanÄ±ÅŸ demektir (yeni long aÃ§maz).</div>
        </div>

        <div class="grp">
          <label class="lbl">API & Proxy</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <input id="spotKey" placeholder="Spot API KEY" style="flex:1 1 220px"/>
            <input id="spotSec" placeholder="Spot API SECRET" type="password" style="flex:1 1 220px"/>
          </div>
          <div class="row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
            <input id="futKey" placeholder="Futures API KEY" style="flex:1 1 220px"/>
            <input id="futSec" placeholder="Futures API SECRET" type="password" style="flex:1 1 220px"/>
          </div>
          <div class="row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
            <input id="proxyUrl" value="http://localhost:8787/" placeholder="Proxy URL (Ã¶rn: http://localhost:8787/ veya Cloudflare/Vercel)" style="flex:1 1 320px"/>
            <input id="proxyToken" placeholder="Proxy Token (opsiyonel)" style="flex:1 1 220px"/>
          </div>
          <div class="warn">âš  TarayÄ±cÄ±dan direkt REST Ã§aÄŸrÄ±larÄ±nda CORS olur. Yerel proxy/Worker/Vercel adresinizi girin.</div>
        </div>

        <div class="grp">
          <label class="lbl">Log</label>
          <textarea id="botLog" class="mono" placeholder="Log..."></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== YardÄ±mcÄ±lar ====== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const now = ()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const nf = new Intl.NumberFormat('tr-TR',{maximumFractionDigits:9});
const toNum = v => (typeof v === 'number') ? v : parseFloat(v);
const pctStr = v => isFinite(v) ? ((v>=0?'+':'') + v.toFixed(3) + '%') : 'â€”';
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const roundTo = (x,dec=6)=> Number.parseFloat(x).toFixed(dec);
function roundDown(x, decimals){ const f = Math.pow(10, decimals); return Math.floor(x * f) / f; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ====== Durum ====== */
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('gate:list')||'["BTC_USDT","ETH_USDT"]')),
  ui: {
    thresh:+(localStorage.getItem('gate:thresh')||0.10),
    theme: localStorage.getItem('gate:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('gate:showTop')||'true')
  },
  spot: new Map(),   // sym -> {bid, ask, ts}
  fut: new Map(),    // sym -> {bid, ask, ts}
  rowEls: new Map(),
  rafScheduled:false,
  ws:{spot:null, fut:null},
  lastTop:null,

  // Pozisyon takibi: aynÄ± coinde tek aktif iÅŸlem
  active: new Map(), // sym -> { baseQty, futContracts, openedAt }

  bot:{
    enabled:false, dry:true, useTableThresh:true,
    openThresh:0.30, closeThresh:0.20,
    notional:50, lev:5, margin:'isolated',
    cooldown:5,
    busy:false, lastExecBySym:new Map(),

    // API (RAM only)
    spotKey:'', spotSec:'', futKey:'', futSec:'',
    // Proxy
    proxy:'http://localhost:8787/', proxyToken:'',
    // caches
    futSetup:new Set()
  }
};
function saveList(){ localStorage.setItem('gate:list', JSON.stringify([...S.coins])); }
function saveUI(){ localStorage.setItem('gate:thresh', S.ui.thresh); localStorage.setItem('gate:theme', S.ui.theme); localStorage.setItem('gate:showTop', S.ui.showTop); }

/* ====== Tema & Saat ====== */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
applyTheme();
setInterval(()=>$('#clock').textContent=now(), 1000);

/* ====== Modal helpers ====== */
const mgr = { open(){ $('#mgrModal').classList.add('open'); $('#addSym').focus(); }, close(){ $('#mgrModal').classList.remove('open'); } };
const bot = { open(){ $('#botModal').classList.add('open'); }, close(){ $('#botModal').classList.remove('open'); } };
$('#mgrBtn').onclick = ()=>mgr.open();
$('#botBtn').onclick = ()=>bot.open();
document.querySelectorAll('.modal').forEach(m=>{
  m.addEventListener('click', e=>{ if(e.target.dataset.close) m.classList.remove('open'); });
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ mgr.close(); bot.close(); }});

/* ====== YÃ¶netim UI ====== */
$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#themeSel').value = S.ui.theme;
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); scheduleDraw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop=e.target.checked; saveUI(); scheduleDraw(); };
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };

/* ====== Bot UI ====== */
function botLog(line){ const ta=$('#botLog'); ta.value += `[${now()}] ${line}\n`; ta.scrollTop = ta.scrollHeight; }
$('#botEnable').onchange = e=>{ S.bot.enabled = e.target.checked; botLog(S.bot.enabled?'Bot AÃ‡IK':'Bot KAPALI'); };
$('#botDry').onchange = e=>{ S.bot.dry = e.target.checked; };
$('#botUseTableThresh').onchange = e=>{ S.bot.useTableThresh = e.target.checked; };
$('#botOpenThresh').onchange = e=>{ S.bot.openThresh = +e.target.value; };
$('#botCloseThresh').onchange = e=>{ S.bot.closeThresh = +e.target.value; };
$('#botNotional').onchange = e=>{ S.bot.notional = Math.max(10, +e.target.value||0); }; // min 10 USDT
$('#botLev').onchange = e=>{ S.bot.lev = clamp(+e.target.value||1, 1, 125); };
$('#botMargin').onchange = e=>{ S.bot.margin = e.target.value; };
$('#botCooldown').onchange = e=>{ S.bot.cooldown = Math.max(1, +e.target.value||1); };
$('#spotKey').oninput = e=>S.bot.spotKey=e.target.value.trim();
$('#spotSec').oninput = e=>S.bot.spotSec=e.target.value.trim();
$('#futKey').oninput  = e=>S.bot.futKey = e.target.value.trim();
$('#futSec').oninput  = e=>S.bot.futSec = e.target.value.trim();
$('#proxyUrl').oninput = e=>S.bot.proxy = e.target.value.trim();
$('#proxyToken').oninput = e=>S.bot.proxyToken = e.target.value.trim();

/* ====== Coin list UI ====== */
function renderChips(){
  const wrap = $('#chipWrap'); wrap.innerHTML = '';
  const frag = document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d = document.createElement('div'); d.className='chipx';
    const b = document.createElement('b'); b.textContent = sym.replace('_','');
    const x = document.createElement('button'); x.textContent='âœ•';
    x.onclick=()=>{ S.coins.delete(sym); saveList(); unsub(sym); S.rowEls.get(sym)?.remove(); S.rowEls.delete(sym); scheduleDraw(); };
    d.append(b,x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
renderChips();

$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase();
  if(!raw) return;
  let sym = raw.includes('_')? raw : raw.replace('USDT','_USDT');
  sym = sym.replace(/[^A-Z0-9_]/g,'');
  if(!sym.endsWith('_USDT')) return alert('Sadece *_USDT sembolleri.');
  if(!S.coins.has(sym)){ S.coins.add(sym); saveList(); renderChips(); sub(sym); }
  $('#addSym').value='';
};
$('#btnClear').onclick = ()=>{
  if(confirm('TÃ¼m coinleri sil?')){
    [...S.coins].forEach(s=>unsub(s));
    S.coins.clear(); saveList();
    S.rowEls.forEach(el=>el.remove()); S.rowEls.clear();
    scheduleDraw();
  }
};

/* ====== Gate.io WebSocket (ticker) ====== */
function wsConnect(kind){
  const isSpot = kind==='spot';
  try{ S.ws[kind]?.close?.(); }catch{}
  const url = isSpot ? 'wss://api.gateio.ws/ws/v4/' : 'wss://fx-ws.gateio.ws/v4/ws/usdt';
  const ws = new WebSocket(url); S.ws[kind]=ws;
  ws.onopen = ()=>{ for(const sym of S.coins){ sendSub(kind, sym, true); } };
  ws.onmessage = (ev)=>{
    try{
      const j = JSON.parse(ev.data);
      if(!j || j.event!=='update' || !j.result) return;
      if(isSpot && j.channel==='spot.book_ticker'){
        const r = j.result; const sym = r.s;
        const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.spot.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
      if(!isSpot && j.channel==='futures.book_ticker'){
        const r = j.result; const sym = r.s;
        const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.fut.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
    }catch(_){}
  };
  ws.onclose = ()=>{ setTimeout(()=>wsConnect(kind), 800 + Math.random()*400); };
  setInterval(()=>{ if(ws.readyState===1){
    const t = Math.floor(Date.now()/1000);
    ws.send(JSON.stringify({time:t,channel:isSpot?'spot.ping':'futures.ping'}));
  }}, 15000);
}
function sendSub(kind, sym, on){
  const ws=S.ws[kind]; if(!ws || ws.readyState!==1) return;
  const channel = (kind==='spot') ? 'spot.book_ticker' : 'futures.book_ticker';
  ws.send(JSON.stringify({ time: Math.floor(Date.now()/1000), channel, event: on?'subscribe':'unsubscribe', payload:[sym] }));
}
function sub(sym){ sendSub('spot',sym,true); sendSub('fut',sym,true); ensureRow(sym); }
function unsub(sym){ sendSub('spot',sym,false); sendSub('fut',sym,false); S.spot.delete(sym); S.fut.delete(sym); }
wsConnect('spot'); wsConnect('fut');

/* ====== Hesaplama ====== */
function cmpFor(sym){
  const sp=S.spot.get(sym), fu=S.fut.get(sym);
  if(!sp || !fu) return null;
  const askS=sp.ask, bidS=sp.bid, bidF=fu.bid, askF=fu.ask;
  const okShort = isFinite(askS)&&isFinite(bidF)&&askS>0;
  const okLong  = isFinite(bidS)&&isFinite(askF)&&askF>0;
  const shortPct = okShort ? ( (bidF - askS) / askS * 100 ) : NaN;
  const longPct  = okLong  ? ( (bidS - askF) / askF * 100 ) : NaN;
  return {sym, askS, bidS, bidF, askF, shortPct, longPct};
}

/* ====== Tablo & Top kart (rAF) ====== */
function ensureRow(sym){
  if(S.rowEls.has(sym)) return;
  const tr=document.createElement('tr'); tr.dataset.sym=sym;
  const tdC=document.createElement('td'); tdC.className='sym'; tdC.textContent=sym.replace('_','');
  const tdSAsk=document.createElement('td'); tdSAsk.className='mono src-spotAsk'; tdSAsk.textContent='â€”';
  const tdFBid=document.createElement('td'); tdFBid.className='mono src-futBid'; tdFBid.textContent='â€”';
  const tdShort=document.createElement('td'); tdShort.className='mono'; tdShort.textContent='â€”';
  const tdSBid=document.createElement('td'); tdSBid.className='mono src-spotBid'; tdSBid.textContent='â€”';
  const tdFAsk=document.createElement('td'); tdFAsk.className='mono src-futAsk'; tdFAsk.textContent='â€”';
  const tdLong=document.createElement('td'); tdLong.className='mono'; tdLong.textContent='â€”';
  tr.append(tdC,tdSAsk,tdFBid,tdShort,tdSBid,tdFAsk,tdLong);
  $('#tbody').appendChild(tr);
  S.rowEls.set(sym,{tr,tdSAsk,tdFBid,tdShort,tdSBid,tdFAsk,tdLong});
}
function scheduleDraw(){ if(!S.rafScheduled){ S.rafScheduled=true; requestAnimationFrame(draw); } }

async function draw(){
  S.rafScheduled=false;
  const rows=[];
  let visibleCount=0;
  for(const sym of S.coins){
    ensureRow(sym);
    const r = cmpFor(sym);
    const el = S.rowEls.get(sym);
    if(!r){ el.tr.style.display='none'; continue; }
    const thr = Number(S.ui.thresh)||0;

    // SADECE POZÄ°TÄ°F: >0 ve eÅŸik Ã¼stÃ¼
    const showShort = isFinite(r.shortPct) && r.shortPct > 0 && r.shortPct >= thr;
    const showLong  = isFinite(r.longPct)  && r.longPct  > 0 && r.longPct  >= thr;

    // SatÄ±r gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼
    const show = (showShort || showLong);
    el.tr.style.display = show ? '' : 'none';
    if(show) visibleCount++;

    // Fiyat hÃ¼creleri
    el.tdSAsk.textContent = isFinite(r.askS) ? nf.format(r.askS) : 'â€”';
    el.tdFBid.textContent = isFinite(r.bidF) ? nf.format(r.bidF) : 'â€”';
    el.tdSBid.textContent = isFinite(r.bidS) ? nf.format(r.bidS) : 'â€”';
    el.tdFAsk.textContent = isFinite(r.askF) ? nf.format(r.askF) : 'â€”';

    // YÃ¼zdeler
    el.tdShort.innerHTML = showShort ? `<span class="pctPos">${pctStr(r.shortPct)}</span>` : 'â€”';
    el.tdLong.innerHTML  = showLong  ? `<span class="pctPos">${pctStr(r.longPct)}</span>`  : 'â€”';

    if(show){
      const best = Math.max(showShort?r.shortPct:-Infinity, showLong?r.longPct:-Infinity);
      rows.push({sym, best, r});
    }

    // ==== BOT TETÄ°K ====
    await maybeBot(sym, r, showShort, showLong);
  }

  // BoÅŸ mesaj
  $('#emptyNote').style.display = visibleCount===0 ? '' : 'none';

  // En iyi kart
  const top=$('#topCard');
  if(!S.ui.showTop || rows.length===0){
    top.classList.add('hidden');
  } else {
    rows.sort((a,b)=>b.best-a.best);
    const t=rows[0].r;
    const isLong = (t.longPct||-1) >= (t.shortPct||-1);
    $('#topSym').textContent = t.sym.replace('_','');
    $('#topSide').textContent = isLong ? 'FUTURES LONG' : 'FUTURES SHORT';
    $('#topSide').className = 'pill ' + (isLong ? 'good' : 'bad');
    $('#topDesc').textContent = isLong
      ? `Spot BID ${nf.format(t.bidS)} â†” Futures ASK ${nf.format(t.askF)}`
      : `Spot ASK ${nf.format(t.askS)} â†” Futures BID ${nf.format(t.bidF)}`;
    const bestPct = isLong ? t.longPct : t.shortPct;
    const pctEl = $('#topPct');
    pctEl.textContent = pctStr(bestPct);
    pctEl.className = 'mono good';
    if(!S.lastTop || S.lastTop.sym!==t.sym || S.lastTop.side!==(isLong?'L':'S') || Math.abs(S.lastTop.pct-bestPct)>0.0005){
      top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 260);
      S.lastTop = {sym:t.sym, side:isLong?'L':'S', pct:bestPct};
    }
    top.classList.remove('hidden');
  }

  $('#clock').textContent = now();
}

/* ====== Creds helper (tek anahtarÄ± iki yerde kullan) ====== */
function credsSpot(){ return { key: S.bot.spotKey || S.bot.futKey, sec: S.bot.spotSec || S.bot.futSec }; }
function credsFut(){  return { key: S.bot.futKey  || S.bot.spotKey, sec: S.bot.futSec  || S.bot.spotSec }; }

/* ====== Gate REST â€” imza & fetch ====== */
const GATE = {
  spotHost: 'https://api.gateio.ws',
  futHost:  'https://fx-api.gateio.ws',
  prefix:   '/api/v4'
};

async function sha512Hex(str){
  const data = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest('SHA-512', data);
  return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function hmac512Hex(secret, msg){
  const key = await crypto.subtle.importKey('raw', new TextEncoder().encode(secret), {name:'HMAC', hash:'SHA-512'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, new TextEncoder().encode(msg));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function signHeaders(method, path, query, body, secret, key){
  const ts = Math.floor(Date.now()/1000).toString();
  const bodyHex = await sha512Hex(body||'');
  const signStr = `${method}\n${GATE.prefix}${path}\n${query||''}\n${bodyHex}\n${ts}`;
  const sign = await hmac512Hex(secret, signStr);
  return { 'Content-Type':'application/json', 'Accept':'application/json', 'KEY':key, 'Timestamp':ts, 'SIGN':sign };
}

async function gateFetch(host, method, path, {query='', bodyObj=null, key='', secret='', proxy='', token='' }){
  const body = bodyObj ? JSON.stringify(bodyObj) : '';
  const headers = await signHeaders(method, path, query, body, secret, key);
  const url = host + GATE.prefix + path + (query?`?${query}`:'');
  const target = proxy ? (proxy.endsWith('/')? proxy.slice(0,-1):proxy) : null;

  if(target){
    const forwardHeaders = {'Content-Type':'application/json'};
    if(token) forwardHeaders['x-proxy-token'] = token;
    const f = await fetch(target, {
      method:'POST', headers:forwardHeaders,
      body:JSON.stringify({ url, method, headers, body })
    });
    if(!f.ok){
      const txt = await f.text().catch(()=>String(f.status));
      throw new Error(`Proxy ${f.status}: ${txt}`);
    }
    const ct = f.headers.get('content-type')||'';
    return ct.includes('application/json') ? f.json() : f.text();
  } else {
    const f = await fetch(url, { method, headers, body });
    if(!f.ok){
      const txt = await f.text().catch(()=>String(f.status));
      throw new Error(`HTTP ${f.status}: ${txt}`);
    }
    const ct = f.headers.get('content-type')||'';
    return ct.includes('application/json') ? f.json() : f.text();
  }
}

/* ====== Futures meta & ayarlar ====== */
const ContractMeta = new Map(); // sym -> meta cache

async function getContractMeta(sym){
  if (ContractMeta.has(sym)) return ContractMeta.get(sym);
  const { key, sec } = credsFut();
  const meta = await gateFetch(GATE.futHost, 'GET', `/futures/usdt/contracts/${sym}`, {
    key, secret: sec, proxy: S.bot.proxy, token: S.bot.proxyToken
  });
  const m = {
    quanto_multiplier: Number(meta.quanto_multiplier ?? meta.multiplier ?? 1),
    order_size_min: Number(meta.order_size_min ?? 1),
    order_size_max: Number(meta.order_size_max ?? 1000000),
    order_size_step: Number(meta.order_size_step ?? 1)
  };
  ContractMeta.set(sym, m);
  return m;
}

async function ensureFuturesSettings(sym, margin, lev){
  const { key, sec } = credsFut();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const cacheKey = `${sym}:${margin}:${lev}`;
  if (S.bot.futSetup.has(cacheKey)) return;

  const mode = margin === 'cross' ? 'cross' : 'isolated';
  try{
    await gateFetch(GATE.futHost, 'POST', `/futures/usdt/positions/margin_mode`, {
      bodyObj: { mode }, key, secret:sec, proxy, token
    });
    botLog(`âš™ Futures margin_mode=${mode}`);
  }catch(e1){
    // Fallback eski uÃ§
    try{
      await gateFetch(GATE.futHost, 'POST', `/futures/usdt/positions/cross_mode`, {
        query: `cross=${mode==='cross'}`, bodyObj: {}, key, secret:sec, proxy, token
      });
      botLog(`âš™ Futures cross_mode=${mode==='cross'}`);
    }catch(e2){
      botLog(`(uyarÄ±) margin_mode set edilemedi: ${e1?.message||e1} | alt uÃ§: ${e2?.message||e2}`);
    }
  }

  try{
    await gateFetch(GATE.futHost, 'POST', `/futures/usdt/positions/${sym}/leverage`, {
      query: `leverage=${lev}`, bodyObj: {}, key, secret:sec, proxy, token
    });
    botLog(`âš™ ${sym} kaldÄ±raÃ§=${lev}x`);
  }catch(e){
    botLog(`(uyarÄ±) leverage set edilemedi (${sym}): ${e?.message||e}`);
  }

  S.bot.futSetup.add(cacheKey);
}

/* ====== Futures emirleri ====== */
async function placeFuturesShortMarket(sym, baseQty){
  const { key, sec } = credsFut();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const m = await getContractMeta(sym);

  const perContractBase = m.quanto_multiplier > 0 ? m.quanto_multiplier : 1;
  let contracts = baseQty / perContractBase;

  const step = m.order_size_step > 0 ? m.order_size_step : 1;
  contracts = Math.floor(contracts / step) * step;
  contracts = Math.max(m.order_size_min, Math.min(contracts, m.order_size_max));
  contracts = Math.trunc(contracts);
  if (!(contracts > 0)) throw new Error(`GeÃ§ersiz kontrat adedi (hesaplanan=${contracts})`);

  botLog(`FUT calc â†’ qm=${m.quanto_multiplier} step=${m.order_size_step} min=${m.order_size_min} max=${m.order_size_max} contracts=${contracts}`);

  const body = { contract: sym, size: -contracts, price: "0", tif: "ioc" }; // SHORT
  const res = await gateFetch(GATE.futHost, 'POST', `/futures/usdt/orders`, { bodyObj: body, key, secret:sec, proxy, token });
  return { id: res?.id, contracts };
}

async function closeFuturesShortMarket(sym, contracts){
  const { key, sec } = credsFut();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const body = { contract: sym, size: Math.abs(contracts), price: "0", tif: "ioc", reduce_only: true };
  const res = await gateFetch(GATE.futHost, 'POST', `/futures/usdt/orders`, { bodyObj: body, key, secret:sec, proxy, token });
  return { id: res?.id };
}

/* ====== Spot meta & emirler ====== */
const SpotMeta = new Map();

async function getSpotPairMeta(sym){
  if (SpotMeta.has(sym)) return SpotMeta.get(sym);
  const { key, sec } = credsSpot();
  const m = await gateFetch(GATE.spotHost, 'GET', `/spot/currency_pairs/${sym}`, {
    key, secret: sec, proxy: S.bot.proxy, token: S.bot.proxyToken
  });
  const meta = {
    min_base_amount: Number(m.min_base_amount ?? 0),
    min_quote_amount: Number(m.min_quote_amount ?? 0),
    amount_precision: Number(m.amount_precision ?? 6),
    base: (m.base || sym.split('_')[0]).toUpperCase(),
    quote: (m.quote || 'USDT').toUpperCase()
  };
  SpotMeta.set(sym, meta);
  return meta;
}

// Market BUY (side=buy, amount = QUOTE USDT) â€” IOC
async function placeSpotBuyMarket(sym, baseQty){
  const { key, sec } = credsSpot();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const meta = await getSpotPairMeta(sym);
  const px = (S.spot.get(sym)?.ask) || 0;
  if(!(px>0)) throw new Error('Spot fiyat yok');

  // Almak istediÄŸimiz baseâ€™e karÅŸÄ±lÄ±k gelen USDT (quote) tutarÄ±
  let quoteAmt = baseQty * px;

  // min_quote uygula
  if (meta.min_quote_amount && quoteAmt < meta.min_quote_amount) {
    quoteAmt = meta.min_quote_amount;
  }
  // Ã‡ok kÃ¼Ã§Ã¼k kÃ¼suratlarÄ± yuvarla (USDT 2 ondalÄ±k idealdir ama Gate katÄ± deÄŸil; 6 dec yapalÄ±m)
  quoteAmt = Number(roundTo(quoteAmt, 6));
  if(!(quoteAmt>0)) throw new Error(`GeÃ§ersiz quote amount (${quoteAmt})`);

  const body = {
    currency_pair: sym,
    type: 'market',
    account: 'spot',
    side: 'buy',
    amount: String(quoteAmt),   // IMPORTANT: market buy -> QUOTE
    time_in_force: 'ioc'
  };
  const res = await gateFetch(GATE.spotHost, 'POST', `/spot/orders`, { bodyObj: body, key, secret: sec, proxy, token });
  // Tahmini alÄ±nan base
  const estBase = quoteAmt / px;
  return { id: res?.id, estBase };
}

// Market SELL (side=sell, amount = BASE) â€” IOC
async function placeSpotSellMarket(sym, baseAmt){
  const { key, sec } = credsSpot();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const meta = await getSpotPairMeta(sym);
  let amt = roundDown(baseAmt, meta.amount_precision);

  // min_base uygula
  if (meta.min_base_amount && amt < meta.min_base_amount) amt = meta.min_base_amount;
  if(!(amt>0)) throw new Error(`GeÃ§ersiz spot sell amount (${amt})`);

  const body = {
    currency_pair: sym,
    type: 'market',
    account: 'spot',
    side: 'sell',
    amount: String(amt),
    time_in_force: 'ioc'
  };
  const res = await gateFetch(GATE.spotHost, 'POST', `/spot/orders`, { bodyObj: body, key, secret: sec, proxy, token });
  return { id: res?.id, sold: amt };
}

// Gerekirse mevcut spot bakiyeyi al (kapanÄ±ÅŸta 'BALANCE_NOT_ENOUGH' durumuna karÅŸÄ±)
async function getSpotAvailable(baseCurrency){
  const { key, sec } = credsSpot();
  const proxy=S.bot.proxy, token=S.bot.proxyToken;
  const q = baseCurrency ? `currency=${encodeURIComponent(baseCurrency)}` : '';
  const list = await gateFetch(GATE.spotHost, 'GET', `/spot/accounts`, { query: q, key, secret: sec, proxy, token });
  const rec = Array.isArray(list) ? list.find(x=> (x.currency||'').toUpperCase()===baseCurrency) : null;
  const avail = rec ? Number(rec.available||0) : 0;
  return avail;
}

/* ====== BOT AKIÅI ====== */
async function maybeBot(sym, r, showShort, showLong){
  if(!S.bot.enabled || S.bot.busy) return;

  const openRef = S.bot.useTableThresh ? S.ui.thresh : S.bot.openThresh;
  const closeRef = S.bot.closeThresh;

  const shortOK = isFinite(r.shortPct) && r.shortPct > 0 && r.shortPct >= openRef;
  const longOK  = isFinite(r.longPct)  && r.longPct  > 0 && r.longPct  >= closeRef;

  const isActive = S.active.has(sym);

  // KAPANIÅ: aktif short + long sinyali
  if(isActive && longOK){
    await closePair(sym);
    return;
  }

  // AÃ‡ILIÅ: aktif deÄŸil + short sinyali
  if(!isActive && shortOK){
    await openPair(sym, r);
  }
}

/* AÃ§Ä±lÄ±ÅŸ: Spot BUY + Futures SHORT */
async function openPair(sym, r){
  if(S.bot.busy) return;
  // cooldown
  const last = S.bot.lastExecBySym.get(sym) || 0;
  if(Date.now() - last < S.bot.cooldown*1000) return;

  // API kontrol
  const hasSpot = (S.bot.spotKey && S.bot.spotSec) || (S.bot.futKey && S.bot.futSec);
  const hasFut  = (S.bot.futKey && S.bot.futSec)  || (S.bot.spotKey && S.bot.spotSec);
  if(!S.bot.dry && (!hasSpot || !hasFut)){
    botLog(`â— [OPEN] ${sym}: API bilgileri eksik (Spot & Futures).`);
    return;
  }

  // Base miktar (hedge referansÄ±) â€” notional/ask
  const ask = r?.askS || 0;
  if(!(ask>0)) return;
  const baseQty = +roundTo(S.bot.notional / ask, 6);
  if(!(baseQty>0)) return;

  S.bot.busy = true;
  S.bot.lastExecBySym.set(sym, Date.now());
  botLog(`â© [OPEN] ${sym} SHORT sinyal ${pctStr(r.shortPct)} | baseâ‰ˆ${baseQty}`);

  try{
    if(S.bot.dry){
      botLog(`(dry-run) â†’ Spot BUY (quoteâ‰ˆ${S.bot.notional} USDT) + Futures SHORT (baseâ‰ˆ${baseQty})`);
      S.active.set(sym, { baseQty, futContracts: 0, openedAt: Date.now() });
      return;
    }

    await ensureFuturesSettings(sym, S.bot.margin, S.bot.lev);

    // Emirleri ardÄ±ÅŸÄ±k ve gÃ¼venli aÃ§ (Ã¶nce futures, sonra spot) veya paralel?
    // AÃ§Ä±lÄ±ÅŸta hedge eksik kalmasÄ±n diye paralel deneriz, biri fail olursa diÄŸerini geri alÄ±rÄ±z.
    const futP = placeFuturesShortMarket(sym, baseQty);
    const spotP = placeSpotBuyMarket(sym, baseQty);

    const [futRes, spotRes] = await Promise.allSettled([futP, spotP]);

    let futOk=false, spotOk=false, futContracts=0, boughtBase=0;

    if(futRes.status==='fulfilled'){ futOk=true; futContracts = futRes.value.contracts; botLog(`âœ… Futures SHORT OK: ${futRes.value?.id||'â€”'} | contracts=${futContracts}`); }
    else botLog(`âŒ Futures hata [OPEN]: ${futRes.reason?.message||String(futRes.reason)}`);

    if(spotRes.status==='fulfilled'){ spotOk=true; boughtBase = spotRes.value.estBase; botLog(`âœ… Spot BUY OK: ${spotRes.value?.id||'â€”'} | estBaseâ‰ˆ${roundTo(boughtBase,6)}`); }
    else botLog(`âŒ Spot BUY hata [OPEN]: ${spotRes.reason?.message||String(spotRes.reason)}`);

    if(futOk && spotOk){
      S.active.set(sym, { baseQty: boughtBase, futContracts, openedAt: Date.now() });
      botLog(`ğŸ“Œ [OPEN] ${sym} aktif. Baseâ‰ˆ${roundTo(boughtBase,6)} | Cntr=${futContracts}`);
    } else {
      // Fail-safe: biri baÅŸarÄ±sÄ±zsa diÄŸerini geri al
      if(futOk && !spotOk){
        botLog(`â†© [OPEN] Spot baÅŸarÄ±sÄ±z â†’ futures short kapatÄ±lÄ±yor (fail-safe)`);
        try{ await closeFuturesShortMarket(sym, futContracts); botLog(`âœ… Fail-safe futures kapandÄ±`); }catch(e){ botLog(`ğŸ’¥ Fail-safe futures kapanamadÄ±: ${e?.message||e}`); }
      }
      if(!futOk && spotOk){
        botLog(`â†© [OPEN] Futures baÅŸarÄ±sÄ±z â†’ spot satÄ±ÅŸla geri al (fail-safe)`);
        try{ await placeSpotSellMarket(sym, boughtBase); botLog(`âœ… Fail-safe spot kapandÄ±`); }catch(e){ botLog(`ğŸ’¥ Fail-safe spot kapanamadÄ±: ${e?.message||e}`); }
      }
    }

  } catch(err){
    botLog(`ğŸ’¥ [OPEN] Hata: ${err?.message||err}`);
  } finally {
    S.bot.busy = false;
  }
}

/* KapanÄ±ÅŸ: Futures shortâ€™u kapat + Spot sat */
async function closePair(sym){
  if(S.bot.busy) return;
  const pos = S.active.get(sym);
  if(!pos) return;

  S.bot.busy = true;
  botLog(`â¹ [CLOSE] ${sym} LONG sinyali â†’ pozisyon kapatÄ±lÄ±yor`);

  try{
    if(S.bot.dry){
      botLog(`(dry-run) â†’ Futures BUY reduce_only size=${pos.futContracts} + Spot SELL baseâ‰ˆ${roundTo(pos.baseQty,6)}`);
      S.active.delete(sym);
      return;
    }

    // Futures kapama
    let futClosed=false, spotClosed=false;

    if(pos.futContracts>0){
      try{
        const r= await closeFuturesShortMarket(sym, pos.futContracts);
        futClosed=true; botLog(`âœ… Futures kapandÄ±: ${r?.id||'â€”'}`);
      }catch(e){ botLog(`âŒ Futures kapanÄ±ÅŸ hata: ${e?.message||e}`); }
    } else {
      futClosed=true; // dry veya data yoksa baÅŸarÄ± varsay
    }

    // Spot kapama: kayÄ±tlÄ± base kadar sat; yetmezse mevcut bakiyeyi sat
    let sellBase = pos.baseQty;
    try{
      const meta = await getSpotPairMeta(sym);
      const avail = await getSpotAvailable(meta.base);
      if(!(avail>0)) throw new Error(`Spot ${meta.base} bakiyesi yok`);
      if(sellBase > avail) sellBase = avail; // fazla isteme
      const r = await placeSpotSellMarket(sym, sellBase);
      spotClosed=true; botLog(`âœ… Spot SELL OK: ${r?.id||'â€”'} | soldâ‰ˆ${roundTo(sellBase,meta.amount_precision)}`);
    }catch(e){ botLog(`âŒ Spot kapanÄ±ÅŸ hata: ${e?.message||e}`); }

    if(futClosed && spotClosed){
      S.active.delete(sym);
      botLog(`ğŸ [DONE] ${sym} iÅŸlem kapandÄ±`);
    } else {
      botLog(`âš  [CLOSE] ${sym} kapama tamamlanamadÄ± (futClosed=${futClosed}, spotClosed=${spotClosed}). Tekrar denenecek.`);
    }

  } catch(err){
    botLog(`ğŸ’¥ [CLOSE] Hata: ${err?.message||err}`);
  } finally {
    S.bot.busy = false;
  }
}

/* ====== BaÅŸlangÄ±Ã§ ====== */
function start(){
  $('#themeSel').value = S.ui.theme;

  // Proxy alanlarÄ±nÄ± yÃ¼kle
  $('#proxyUrl').value = S.bot.proxy;
  $('#proxyToken').value = S.bot.proxyToken || '';

  // Bot UI varsayÄ±lanlar
  $('#botOpenThresh').value = String(S.bot.openThresh);
  $('#botCloseThresh').value = String(S.bot.closeThresh);
  $('#botNotional').value = String(S.bot.notional);
  $('#botLev').value = String(S.bot.lev);
  $('#botMargin').value = S.bot.margin;
  $('#botCooldown').value = String(S.bot.cooldown);

  // Mevcut coinleri abone et
  S.coins.forEach(sym=>{ ensureRow(sym); sub(sym); });

  // Saat ve ilk Ã§izim
  $('#clock').textContent = now();
  scheduleDraw();
}
start();
</script>
</body>
</html>
