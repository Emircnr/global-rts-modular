<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures â€” Rastgele Bot (Maker Reprice + IOC Fallback) + Muhasebe</title>
<style>
:root{
  --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
  --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
  --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
  --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:15px; --maxW:1200px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--fg);
  background:
    radial-gradient(1200px 800px at 15% -10%, #0f2b59 0%, transparent 55%),
    radial-gradient(1000px 700px at 110% 0%, transparent 55%),
    linear-gradient(180deg,#0a1222 0%, #0b0f19 60%);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
}
.wrap{max-width:var(--maxW); margin:0 auto; padding:18px}
header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(5,10,22,.85), transparent); backdrop-filter:blur(10px)}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
h1{margin:0; font-size:22px}
.chip{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); display:inline-flex; gap:8px; align-items:center}
.btn{border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel2)); color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer}
.btn:hover{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 20%, transparent)}
.iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:12px}
input,select,textarea{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); color:var(--fg); border-radius:12px; padding:10px 12px}
.mono{font-variant-numeric:tabular-nums slashed-zero; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.badge{font-size:11px; padding:3px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
.good{color:var(--good)} .bad{color:var(--bad)}

.card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow:0 10px 34px rgba(0,0,0,.22)}
table{width:100%; border-collapse:separate; border-spacing:0 var(--gap)}
thead th{font-size:12px; color:var(--muted); padding:0 10px; text-align:left}
tbody td{padding:var(--padY) var(--padX); font-size:var(--font); background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-left:none; border-right:none}
tbody tr td:first-child{border-top-left-radius:var(--radius); border-bottom-left-radius:var(--radius); border-left:1px solid var(--border)}
tbody tr td:last-child{border-top-right-radius:var(--radius); border-bottom-right-radius:var(--radius); border-right:1px solid var(--border)}
.sym{font-weight:800}

#btnCoins,#btnBot,#btnAcc{position:fixed; right:22px; z-index:50}
#btnCoins{top:18px} #btnBot{top:70px} #btnAcc{top:122px}

.modal{position:fixed; inset:0; display:none; z-index:60}
.modal.open{display:block}
.overlay{position:absolute; inset:0; background:rgba(3,6,15,.55); backdrop-filter:blur(4px); opacity:0; animation:fadeIn .15s ease forwards}
@keyframes fadeIn{to{opacity:1}}
.panel{ position:absolute; right:24px; top:72px; width:min(960px, calc(100% - 32px)); background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border); border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.45); transform:translateY(-10px); opacity:0; animation:pop .18s ease forwards }
@keyframes pop{to{transform:none; opacity:1}}
.panel header{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 0}
.panel h3{margin:0; font-size:16px}
.panel .content{padding:12px 14px 14px; display:grid; gap:12px}
.grp{border:1px dashed var(--border); border-radius:14px; padding:10px}
.lbl{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
.chips{display:flex; flex-wrap:wrap; gap:8px}
.chipx{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center}
.chipx b{letter-spacing:.3px}
.chipx button{all:unset; cursor:pointer; color:var(--muted)}
#log{height:140px; resize:vertical}
.stat{padding:10px; border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,var(--panel),var(--panel2)); display:grid; gap:4px}
.stat b{font-size:12px; color:var(--muted)}
.stat .v{font-size:18px}
.grid{display:grid; gap:12px}
.grid.stats{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
</style>
</head>
<body>
<header class="wrap">
  <div class="row">
    <h1>Gate.io Futures â€” Rastgele Bot</h1>
    <div class="chip">Saat: <span id="clock" class="mono">â€”:â€”:â€”</span></div>
    <span class="badge">Maker Reprice + IOC Fallback Â· TP/SL Zorunlu Â· Takip Garantili</span>
  </div>
</header>

<main class="wrap" style="padding-bottom:70px">
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Sembol</th><th>Bid</th><th>Ask</th><th>Son</th><th>Durum</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="emptyNote" style="margin:10px 6px 2px; color:var(--muted); font-size:13px; display:none">Liste boÅŸ.</p>
  </div>
</main>

<button id="btnCoins" class="btn iconbtn" title="Coin Listesi">ðŸ§©</button>
<button id="btnBot" class="btn iconbtn" title="Bot Kontrol">ðŸ¤–</button>
<button id="btnAcc" class="btn iconbtn" title="Muhasebe">ðŸ“’</button>

<!-- Coins Modal -->
<div id="coinsModal" class="modal">
  <div class="overlay" data-close="1"></div>
  <div class="panel" style="width:min(560px, calc(100% - 32px))">
    <header><h3>Coin Listesi</h3><button class="btn iconbtn" data-close="1">âœ–</button></header>
    <div class="content">
      <div class="grp">
        <label class="lbl">Sembol ekle (Ã¶rn: <b>ETH_USDT</b>)</label>
        <div class="row">
          <input id="addSym" placeholder="BTC_USDT"/>
          <button id="btnAdd" class="btn">Ekle</button>
          <button id="btnClr" class="btn" style="margin-left:auto">TÃ¼mÃ¼nÃ¼ Sil</button>
        </div>
        <div id="chipWrap" class="chips" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bot Modal -->
<div id="botModal" class="modal">
  <div class="overlay" data-close="1"></div>
  <div class="panel">
    <header><h3>Rastgele Bot â€” Kontrol</h3><button class="btn iconbtn" data-close="1">âœ–</button></header>
    <div class="content">
      <div class="grp">
        <label class="lbl">Ã‡alÄ±ÅŸma</label>
        <div class="row" style="gap:12px; flex-wrap:wrap">
          <label class="row"><input type="checkbox" id="botOn"/> Botu BaÅŸlat</label>
          <label class="row"><input type="checkbox" id="dry" /> Dry-Run (emir gÃ¶nderme)</label>
          <label class="row"><input type="checkbox" id="randClose" checked/> Rastgele kapanÄ±ÅŸ (kÃ¢rda ise)</label>
          <label class="row"><input type="checkbox" id="onePerCoin" checked/> Tek pozisyon/coin</label>
        </div>
      </div>

      <div class="grp">
        <label class="lbl">Rastgele Parametre AralÄ±klarÄ±</label>
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <label> Lev. Min <input id="levMin" type="number" value="2" style="width:90px"></label>
          <label> Lev. Max <input id="levMax" type="number" value="10" style="width:90px"></label>
          <label> Notional Min (USDT) <input id="notMin" type="number" value="20" style="width:120px"></label>
          <label> Notional Max (USDT) <input id="notMax" type="number" value="120" style="width:120px"></label>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
          <label> TP % Min <input id="tpMin" type="number" step="0.01" value="0.40" style="width:100px"></label>
          <label> TP % Max <input id="tpMax" type="number" step="0.01" value="2.00" style="width:100px"></label>
          <label> SL % Min <input id="slMin" type="number" step="0.01" value="0.40" style="width:100px"></label>
          <label> SL % Max <input id="slMax" type="number" step="0.01" value="2.00" style="width:100px"></label>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
          <label> Maker OlasÄ±lÄ±ÄŸÄ± % <input id="makerPct" type="number" value="55" style="width:100px"></label>
          <label> KapanÄ±ÅŸ ÅžansÄ± % <input id="closePct" type="number" value="40" style="width:100px"></label>
          <label> KapanÄ±ÅŸ Gecikme (sn) Min <input id="closeMin" type="number" value="20" style="width:120px"></label>
          <label> KapanÄ±ÅŸ Gecikme (sn) Max <input id="closeMax" type="number" value="180" style="width:120px"></label>
        </div>
      </div>

      <div class="grp">
        <label class="lbl">Maker Ä°zleme & Fallback</label>
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <label> Pending Timeout (sn) <input id="pendTO" type="number" value="8" style="width:120px"></label>
          <label> Reprice Deneme <input id="maxReprice" type="number" value="2" style="width:120px"></label>
          <label class="row"><input type="checkbox" id="fallbackIOC" checked/> Son Ã§are IOC (market)</label>
        </div>
      </div>

      <div class="grp">
        <label class="lbl">API & Proxy</label>
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <input id="keyF" placeholder="Futures API KEY" style="flex:1 1 220px"/>
          <input id="secF" placeholder="Futures API SECRET" type="password" style="flex:1 1 220px"/>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
          <input id="proxyUrl" value="http://localhost:8787/" placeholder="Proxy URL" style="flex:1 1 320px"/>
          <input id="proxyTok" placeholder="Proxy Token (opsiyonel)" style="flex:1 1 220px"/>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
          <label class="row"><input type="checkbox" id="isolated" checked/> Isolated</label>
          <button id="btnApplyLev" class="btn">Ã–rnek kontrata kaldÄ±raÃ§ & mod</button>
        </div>
        <span class="badge">Proxy; <b>POST</b> {url,method,headers,body}</span>
      </div>

      <div class="grp">
        <label class="lbl">Log</label>
        <textarea id="log" class="mono" placeholder="Log..."></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Accounting Modal -->
<div id="accModal" class="modal">
  <div class="overlay" data-close="1"></div>
  <div class="panel">
    <header><h3>Muhasebe â€” PNL, Ãœcret, ROI</h3><button class="btn iconbtn" data-close="1">âœ–</button></header>
    <div class="content">
      <div id="sumCards" class="grid stats"></div>

      <div class="grp">
        <label class="lbl">KayÄ±tlar</label>
        <table id="accTable">
          <thead>
            <tr>
              <th>Zaman</th><th>ID</th><th>Sembol</th><th>YÃ¶n</th><th>Lev</th>
              <th>SÃ¶z.</th><th>Entry</th><th>Exit</th><th>Notional</th>
              <th>BrÃ¼t PnL</th><th>Ãœcret</th><th>Net</th><th>Durum</th>
            </tr>
          </thead>
          <tbody id="accBody"></tbody>
        </table>
      </div>

      <div class="grp">
        <label class="lbl">Coin BazlÄ± Ã–zet</label>
        <table id="agg">
          <thead>
            <tr><th>Coin</th><th>Ä°ÅŸlem</th><th>KazanÃ§lÄ±</th><th>ZararlÄ±</th><th>Notional</th><th>BrÃ¼t</th><th>Ãœcret</th><th>Net</th><th>ROI %</th></tr>
          </thead>
          <tbody id="aggBody"></tbody>
        </table>
      </div>

      <div class="grp">
        <button id="btnCSV" class="btn">CSV Ä°ndir</button>
        <button id="btnClearAcc" class="btn">Muhasebeyi Temizle</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const nowStr=()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const nf = new Intl.NumberFormat('tr-TR',{maximumFractionDigits:8});
const rnd=(a,b)=>Math.random()*(b-a)+a, rndi=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const sleep=ms=>new Promise(r=>setTimeout(r,ms)); const ts=()=>Math.floor(Date.now()/1000);

/* ===== Global State ===== */
const S={
  coins: new Set(JSON.parse(localStorage.getItem('rb:coins')||'["BTC_USDT","ETH_USDT"]')),
  ws:null, ticks:new Map(), rows:new Map(),
  bot:{on:false,dry:false,randClose:true,onePerCoin:true,levMin:2,levMax:10,notMin:20,notMax:120,tpMin:0.4,tpMax:2,slMin:0.4,slMax:2,
       makerPct:55,closePct:40,closeMin:20,closeMax:180, isolated:true, key:'',sec:'',proxy:'http://localhost:8787/',token:'',
       pendTO:8,maxReprice:2,fallbackIOC:true, futSetup:new Set()},
  /* pos: sym -> {status, side, lev, contracts, entry, maker, orderId, tpId, slId, openTs, fees, notional, tradeId, attempts, lastCheck} */
  pos:new Map(),
  ledger: JSON.parse(localStorage.getItem('rb:ledger')||'[]')
};

/* ===== UI Top ===== */
setInterval(()=>$('#clock').textContent=nowStr(),1000);

/* ===== Coins UI ===== */
$('#btnCoins').onclick=()=>openM('coinsModal');
$('#btnBot').onclick=()=>openM('botModal');
$('#btnAcc').onclick=()=>{openM('accModal'); renderAccounting();};
function openM(id){ $('#'+id).classList.add('open'); }
$$('.modal').forEach(m=>m.addEventListener('click',e=>{ if(e.target.dataset.close) m.classList.remove('open'); }));
document.addEventListener('keydown',e=>{ if(e.key==='Escape') $$('.modal').forEach(m=>m.classList.remove('open')); });

function saveCoins(){ localStorage.setItem('rb:coins', JSON.stringify([...S.coins])); }
function renderChips(){
  const w=$('#chipWrap'); if(!w) return; w.innerHTML='';
  const frag=document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d=document.createElement('div'); d.className='chipx'; d.innerHTML=`<b>${sym}</b>`;
    const x=document.createElement('button'); x.textContent='âœ•';
    x.onclick=()=>{ S.coins.delete(sym); saveCoins(); S.rows.get(sym)?.tr.remove(); S.rows.delete(sym); };
    d.appendChild(x); frag.appendChild(d);
  }); w.appendChild(frag);
}
$('#btnAdd')?.addEventListener('click',()=>{
  const raw=$('#addSym').value.trim().toUpperCase(); if(!raw) return;
  const sym = raw.includes('_')?raw:raw.replace('USDT','_USDT');
  S.coins.add(sym); saveCoins(); ensureRow(sym);
});
$('#btnClr')?.addEventListener('click',()=>{
  if(confirm('TÃ¼m coinleri silinsin mi?')){
    S.coins.clear(); saveCoins(); S.rows.forEach(o=>o.tr.remove()); S.rows.clear();
  }
});
renderChips();

/* ===== Table ===== */
function ensureRow(sym){
  renderChips();
  if(S.rows.has(sym)) return;
  const tr=document.createElement('tr');
  const td1=document.createElement('td'); td1.textContent=sym; td1.className='sym';
  const td2=document.createElement('td'); const td3=document.createElement('td');
  const td4=document.createElement('td'); const td5=document.createElement('td');
  td2.className='mono'; td3.className='mono'; td4.className='mono'; td5.className='mono';
  tr.append(td1,td2,td3,td4,td5); $('#tbody').appendChild(tr);
  S.rows.set(sym,{tr,td2,td3,td4,td5}); drawRow(sym);
}
function drawRow(sym){
  const r=S.rows.get(sym); if(!r) return;
  const t=S.ticks.get(sym)||{};
  r.td2.textContent=isFinite(t.bid)?nf.format(t.bid):'â€”';
  r.td3.textContent=isFinite(t.ask)?nf.format(t.ask):'â€”';
  r.td4.textContent=isFinite(t.last)?nf.format(t.last):'â€”';
  const p=S.pos.get(sym);
  let badge='â€”';
  if(p){
    if(p.status==='pending'){
      const waited = ((Date.now()-p.openTs)/1000)|0;
      badge=`<span class="badge">PENDING Â· ${waited}s Â· try ${p.attempts||0}</span>`;
    } else if(p.status==='open'){
      badge = p.side>0?'<span class="badge good">LONG aÃ§Ä±k</span>':'<span class="badge bad">SHORT aÃ§Ä±k</span>';
    } else if(p.status==='closing'){
      badge = '<span class="badge">CLOSING</span>';
    }
  }
  r.td5.innerHTML=badge;
}

/* ===== WS ===== */
function wsStart(){
  try{ S.ws?.close?.(); }catch{}
  const ws=new WebSocket('wss://fx-ws.gateio.ws/v4/ws/usdt'); S.ws=ws;
  ws.onopen=()=>{
    for(const sym of S.coins){ ws.send(JSON.stringify({time:ts(),channel:'futures.book_ticker',event:'subscribe',payload:[sym]})); ensureRow(sym);}
  };
  ws.onmessage=(ev)=>{
    try{
      const j=JSON.parse(ev.data);
      if(j.event==='update' && j.channel==='futures.book_ticker'){
        const r=j.result; const sym=r.s; const bid=+r.b, ask=+r.a, last=+r.p;
        if(isFinite(bid)||isFinite(ask)||isFinite(last)){ S.ticks.set(sym,{bid,ask,last}); drawRow(sym); }
      }
    }catch(_){}
  };
  ws.onclose=()=>setTimeout(wsStart,1000);
  setInterval(()=>{ if(ws.readyState===1) ws.send(JSON.stringify({time:ts(),channel:'futures.ping'})); },15000);
}
wsStart();

/* ===== Bot Controls ===== */
const B=S.bot;
$('#botOn').onchange=e=>{ B.on=e.target.checked; log(B.on?'Bot AÃ‡IK':'Bot KAPALI'); if(B.on) loop(); };
$('#dry').onchange=e=>B.dry=e.target.checked;
$('#randClose').onchange=e=>B.randClose=e.target.checked;
$('#onePerCoin').onchange=e=>B.onePerCoin=e.target.checked;
['levMin','levMax','notMin','notMax','tpMin','tpMax','slMin','slMax','makerPct','closePct','closeMin','closeMax','pendTO','maxReprice']
  .forEach(id=>$('#'+id).onchange=e=>B[id]=+e.target.value);
$('#fallbackIOC').onchange=e=>B.fallbackIOC=e.target.checked;
$('#isolated').onchange=e=>B.isolated=e.target.checked;
$('#keyF').oninput=e=>B.key=e.target.value.trim();
$('#secF').oninput=e=>B.sec=e.target.value.trim();
$('#proxyUrl').oninput=e=>B.proxy=e.target.value.trim();
$('#proxyTok').oninput=e=>B.token=e.target.value.trim();
$('#btnApplyLev').onclick=async()=>{
  const sym=[...S.coins][0]; if(!sym) return alert('Ã–nce coin ekleyin.');
  try{ await ensureFutSettings(sym,B.isolated?'isolated':'cross',rndi(B.levMin,B.levMax)); log(`âš™ ayar uygulandÄ± (${sym})`);}catch(e){log('ayar hata: '+(e?.message||e));}
};
function log(m){ const ta=$('#log'); ta.value+=`[${nowStr()}] ${m}\n`; ta.scrollTop=ta.scrollHeight; }

/* ===== Gate Futures REST (Proxy) ===== */
const G={host:'https://fx-api.gateio.ws',prefix:'/api/v4'};
async function sha512Hex(s){const d=new TextEncoder().encode(s||'');const h=await crypto.subtle.digest('SHA-512',d);return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');}
async function hmac512Hex(secret,msg){const key=await crypto.subtle.importKey('raw',new TextEncoder().encode(secret),{name:'HMAC',hash:'SHA-512'},false,['sign']);const sig=await crypto.subtle.sign('HMAC',key,new TextEncoder().encode(msg));return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');}
async function signHeaders(method,path,query,body){const t=ts().toString();const bh=await sha512Hex(body||'');const s=`${method}\n${G.prefix}${path}\n${query||''}\n${bh}\n${t}`;const sign=await hmac512Hex(B.sec,s);return {'Content-Type':'application/json','Accept':'application/json','KEY':B.key,'Timestamp':t,'SIGN':sign};}
async function gateFetch(method,path,{query='',bodyObj=null}={}){const body=bodyObj?JSON.stringify(bodyObj):'';const headers=await signHeaders(method,path,query,body);const url=G.host+G.prefix+path+(query?`?${query}`:'');const target=(B.proxy||'').replace(/\/+$/,'');if(target){const h={'Content-Type':'application/json'};if(B.token)h['x-proxy-token']=B.token;const r=await fetch(target,{method:'POST',headers:h,body:JSON.stringify({url,method,headers,body})});if(!r.ok){const t=await r.text().catch(()=>r.status);throw new Error(`Proxy ${r.status}: ${t}`);}const ct=r.headers.get('content-type')||'';return ct.includes('json')?r.json():r.text();}else{const r=await fetch(url,{method,headers,body});if(!r.ok){const t=await r.text().catch(()=>r.status);throw new Error(`HTTP ${r.status}: ${t}`);}const ct=r.headers.get('content-type')||'';return ct.includes('json')?r.json():r.text();}}
const Meta=new Map();
async function getMeta(sym){if(Meta.has(sym))return Meta.get(sym);const m=await gateFetch('GET',`/futures/usdt/contracts/${sym}`);const meta={qm:+m.quanto_multiplier||1,tick:+m.order_price_round||0.0001,minSz:+m.order_size_min||1,maxSz:+m.order_size_max||1e6,step:+m.order_size_step||1,makerFee:+m.maker_fee_rate||0,takerFee:+m.taker_fee_rate||0};Meta.set(sym,meta);return meta;}
function priceUp(px,t){const k=Math.round(px/t);return (k+1)*t;}
function priceDn(px,t){const k=Math.round(px/t);return Math.max(t,(k-1)*t);}
async function orderBook1(sym){const ob=await gateFetch('GET',`/futures/usdt/order_book`,{query:`contract=${sym}&limit=1`});const ask=ob.asks?.[0]?.p?+ob.asks[0].p:(S.ticks.get(sym)?.ask||NaN);const bid=ob.bids?.[0]?.p?+ob.bids[0].p:(S.ticks.get(sym)?.bid||NaN);return {bid,ask};}
async function ensureFutSettings(sym,mode,lev){
  const key=`${sym}:${mode}:${lev}`; if(S.bot.futSetup.has(key)) return;
  try{await gateFetch('POST',`/futures/usdt/positions/margin_mode`,{bodyObj:{mode:mode==='cross'?'cross':'isolated'}});}catch(e){try{await gateFetch('POST',`/futures/usdt/positions/cross_mode`,{query:`cross=${mode==='cross'}`});}catch(e2){log(`(uyarÄ±) margin_mode deÄŸiÅŸmedi: ${e?.message||e} | alt: ${e2?.message||e2}`);}}
  try{await gateFetch('POST',`/futures/usdt/positions/${sym}/leverage`,{query:`leverage=${lev}`});}catch(e){log(`(uyarÄ±) leverage set edilemedi: ${e?.message||e}`);}
  S.bot.futSetup.add(key);
}
async function placeOrder(sym,size,price,tif='gtc',reduce_only=false,close=false,text='t-rand'){const body={contract:sym,size,price:String(price),tif,reduce_only,close,text};return gateFetch('POST',`/futures/usdt/orders`,{bodyObj:body});}
async function cancelOrder(sym,id){return gateFetch('DELETE',`/futures/usdt/orders/${id}`);}
async function getOrder(sym,id){return gateFetch('GET',`/futures/usdt/orders/${id}`);}
async function placeTrigger(sym,price,rule,reduce_only=true,text='t-trig'){
  const body={initial:{contract:sym,size:0,price:String(price),tif:'gtc',reduce_only,close:true,text},trigger:{strategy_type:0,price_type:0,price:String(price),rule,expiration:7*24*3600}};
  const r=await gateFetch('POST',`/futures/usdt/price_orders`,{bodyObj:body}); return r?.id;
}
async function cancelTrigger(id){return gateFetch('DELETE',`/futures/usdt/price_orders/${id}`);}
async function getPosition(sym){return gateFetch('GET',`/futures/usdt/positions/${sym}`);}
async function myTrades(sym,limit=200){return gateFetch('GET',`/futures/usdt/my_trades`,{query:`contract=${sym}&limit=${limit}`});}
function feeFromOrder(o){let f=0; if(o?.mkfr) f+=+o.mkfr; if(o?.tkfr) f+=+o.tkfr; return f;}

/* ===== Random Loop with Maker Reprice/Fallback ===== */
function pickAny(){const a=[...S.coins];return a.length? a[Math.floor(Math.random()*a.length)]:null;}
function pickOpenable(){const c=[...S.coins].filter(sym=>!S.pos.has(sym));return c.length?c[Math.floor(Math.random()*c.length)]:null;}

async function loop(){
  while(B.on){
    try{
      const sym = B.onePerCoin? (pickOpenable()||null): pickAny();
      if(!sym){ await sleep(900); continue; }
      ensureRow(sym);

      const {bid,ask}=await orderBook1(sym); if(!isFinite(bid)||!isFinite(ask)){ await sleep(600); continue; }
      const m=await getMeta(sym);

      const dir = Math.random()<0.5? +1 : -1;              // +1 LONG, -1 SHORT
      const lev = rndi(B.levMin,B.levMax);
      const notion = Math.max(10, Math.round(rnd(B.notMin,B.notMax)));
      const maker = Math.random()*100 < B.makerPct;

      const entryPx = dir>0 ? (maker ? priceDn(bid,m.tick) : ask) : (maker ? priceUp(ask,m.tick) : bid);
      let base = notion / entryPx; let contracts = Math.floor( Math.max(m.minSz, Math.min((base/m.qm), m.maxSz)) / m.step ) * m.step;
      contracts = Math.trunc(contracts); if(!(contracts>0)){ log(`(sÃ¶zleÅŸme yetersiz) ${sym}`); await sleep(600); continue; }

      await ensureFutSettings(sym, B.isolated?'isolated':'cross', lev);

      const size = dir>0? +contracts : -contracts;
      const tif  = maker? 'poc' : 'ioc';
      const px   = maker? entryPx : 0;

      const tradeId = `${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      S.pos.set(sym,{status:'pending', side:dir, lev, contracts, entry:entryPx, maker, orderId:null, tpId:null, slId:null, openTs:Date.now(), fees:0, notional:contracts*m.qm*entryPx, tradeId, attempts:0, lastCheck:0});
      drawRow(sym);

      log(`ðŸŽ² ${sym} | ${dir>0?'LONG':'SHORT'} lev=${lev} notâ‰ˆ${notion} ${maker?'MAKER(poc)':'IOC'} px=${px?nf.format(px):'MKT'} ctr=${contracts}`);

      if(!B.dry){
        const res = await placeOrder(sym,size,px,tif,false,false,`t-entry-${tradeId}`);
        S.pos.get(sym).orderId = res?.id||null;
        S.pos.get(sym).fees   += feeFromOrder(res);
        if(res?.fill_price>0){ S.pos.get(sym).entry=+res.fill_price; S.pos.get(sym).status='open'; log(`âœ… entry fill @ ${nf.format(+res.fill_price)} id=${res.id}`); }
      }else{
        // Dry: anÄ±nda aÃ§Ä±k kabul
        S.pos.get(sym).status='open';
      }
      drawRow(sym);

      // TP/SL kur
      const p=S.pos.get(sym); if(p){
        const tpPct=rnd(B.tpMin,B.tpMax)/100, slPct=rnd(B.slMin,B.slMax)/100;
        const tpPx = p.side>0 ? p.entry*(1+tpPct) : p.entry*(1-tpPct);
        const slPx = p.side>0 ? p.entry*(1-slPct) : p.entry*(1+slPct);
        if(!B.dry){
          try{ p.tpId = await placeTrigger(sym,tpPx, p.side>0?1:2, true, `t-tp-${tradeId}`); log(`ðŸŽ¯ TP @ ${nf.format(tpPx)} id=${p.tpId}`);}catch(e){log('TP hata: '+(e?.message||e));}
          try{ p.slId = await placeTrigger(sym,slPx, p.side>0?2:1, true, `t-sl-${tradeId}`); log(`ðŸ›¡ SL @ ${nf.format(slPx)} id=${p.slId}`);}catch(e){log('SL hata: '+(e?.message||e));}
        }else{
          log(`(dry) TP ${nf.format(tpPx)} / SL ${nf.format(slPx)}`);
        }
      }

      await sleep(rndi(1200,2400)); // dÃ¶ngÃ¼ arasÄ± kÄ±sa
    }catch(e){ log('ðŸ’¥ '+(e?.message||e)); await sleep(600); }
  }
}

/* ===== Reconcile (Pending Watchdog + Close + Accounting) ===== */
setInterval(()=>reconcile().catch(e=>log('reconcile err: '+(e?.message||e))), 1200);

async function reconcile(){
  for(const [sym,p] of S.pos){
    if(Date.now()-(p.lastCheck||0) < 600) continue; p.lastCheck=Date.now();
    drawRow(sym);

    try{
      // 1) Pending: maker reprice or fallback
      if(p.status==='pending'){
        if(B.dry){ p.status='open'; continue; }
        if(!p.orderId){ // gÃ¼venlik: kapat ve IOC
          await forceIOC(sym,p);
          continue;
        }
        const od=await getOrder(sym,p.orderId);
        if(od?.status==='closed'){
          if(od.finish_as==='filled' || od.fill_price>0){
            p.entry=+od.fill_price||p.entry; p.fees+=feeFromOrder(od); p.status='open';
            log(`âœ… ${sym} pendingâ†’open fill @ ${nf.format(p.entry)}`); continue;
          }else if(od.finish_as==='cancelled'){
            // hemen yeniden dene
            await forceIOC(sym,p); continue;
          }
        }else{
          // hala aÃ§Ä±k -> timeout?
          const waited=(Date.now()-p.openTs)/1000;
          if(waited > B.pendTO){
            if((p.attempts||0) < B.maxReprice){
              p.attempts=(p.attempts||0)+1;
              await repriceMaker(sym,p);
            }else if(B.fallbackIOC){
              await replaceIOC(sym,p);
            }else{
              await repriceMaker(sym,p); // fallback kapalÄ±ysa tekrar reprice
            }
          }
        }
      }

      // 2) Open: pozisyon var mÄ±?
      if(p.status==='open' && !B.dry){
        const pos=await getPosition(sym);
        const size=pos?.size? +pos.size : 0;
        if(Math.abs(size)===0){
          // Pozisyon kapanmÄ±ÅŸ (TP/SL vs) â†’ finalize my_trades
          await finalizeFromTrades(sym,p);
          continue;
        }else{
          // Ä°sterse rasgele kapanÄ±ÅŸ (kÃ¢rdaysa)
          if(B.randClose && Math.random()*100 < B.closePct){
            const mark = (S.ticks.get(sym)?.last)||(S.ticks.get(sym)?.bid)||(S.ticks.get(sym)?.ask)||p.entry;
            const qm=(Meta.get(sym)?.qm)||1;
            const gross=(mark-p.entry)*p.contracts*qm*(p.side>0?+1:-1);
            if(gross>0){ await randomClose(sym); }
          }
        }
      }

      // 3) Closing flag â†’ bekleme (randomClose iÃ§i halleder)
    }catch(e){ log(`reconcile(${sym}) hata: ${e?.message||e}`); }
  }
}

/* ----- Pending Helpers ----- */
async function repriceMaker(sym,p){
  try{
    if(p.orderId){ try{ await cancelOrder(sym,p.orderId); }catch(_){ } }
    const {bid,ask}=await orderBook1(sym); const m=await getMeta(sym);
    const newPx = p.side>0 ? priceDn(bid,m.tick) : priceUp(ask,m.tick);
    const size  = p.side>0 ? +p.contracts : -p.contracts;
    const res = await placeOrder(sym,size,newPx,'poc',false,false,`t-reprice-${p.tradeId}`);
    p.orderId = res?.id||null; p.openTs=Date.now(); p.entry=newPx; p.maker=true;
    log(`â†º ${sym} reprice @ ${nf.format(newPx)} (try ${p.attempts}/${B.maxReprice})`);
  }catch(e){ log(`reprice hata: ${e?.message||e}`); }
}
async function replaceIOC(sym,p){
  try{
    if(p.orderId){ try{ await cancelOrder(sym,p.orderId); }catch(_){ } }
    const size = p.side>0? +p.contracts : -p.contracts;
    const res = await placeOrder(sym,size,0,'ioc',false,false,`t-ioc-${p.tradeId}`);
    p.orderId = res?.id||null; p.maker=false; p.openTs=Date.now();
    if(res?.fill_price>0){ p.entry=+res.fill_price; p.status='open'; log(`âš¡ ${sym} fallback IOC fill @ ${nf.format(p.entry)}`); }
    else log(`âš¡ ${sym} IOC gÃ¶nderildi (fill bekleniyor)`);
  }catch(e){ log(`IOC hata: ${e?.message||e}`); }
}
async function forceIOC(sym,p){
  try{
    const size=p.side>0? +p.contracts : -p.contracts;
    const res=await placeOrder(sym,size,0,'ioc',false,false,`t-ioc2-${p.tradeId}`);
    p.orderId=res?.id||null; p.maker=false; if(res?.fill_price>0){ p.entry=+res.fill_price; p.status='open'; }
    log(`âš¡ ${sym} force IOC`);
  }catch(e){ log(`forceIOC hata: ${e?.message||e}`); }
}

/* ----- Random Close (only if profit) ----- */
async function randomClose(sym){
  const p=S.pos.get(sym); if(!p||p.status!=='open'||B.dry) return;
  p.status='closing'; drawRow(sym);
  try{
    const res = await placeOrder(sym,0, "0", "ioc", true, true, `t-close-${p.tradeId}`);
    const fee = feeFromOrder(res);
    const exit = res?.fill_price? +res.fill_price : p.entry;
    try{ if(p.tpId) await cancelTrigger(p.tpId); }catch(_){}
    try{ if(p.slId) await cancelTrigger(p.slId); }catch(_){}
    finishTrade(sym,p.entry,exit,fee);
  }catch(e){ log('close err: '+(e?.message||e)); p.status='open'; drawRow(sym); }
}

/* ----- Finalize from trades (TP/SL) ----- */
async function finalizeFromTrades(sym,p){
  let trades=[]; try{ trades=await myTrades(sym,200);}catch(e){ log('my_trades err: '+(e?.message||e)); }
  const since=p.openTs||0, qm=(Meta.get(sym)?.qm)||1;
  let filledOpp=0,sumPxSz=0,fees=0;
  for(const t of trades){
    const ms=t.create_time_ms?+t.create_time_ms:(+t.create_time*1000||0);
    if(ms<since) continue;
    const sz=+t.size, px=+t.price, fee=Math.abs(+t.fee||0);
    if( (p.side>0 && sz<0) || (p.side<0 && sz>0) ){ const abs=Math.abs(sz); filledOpp+=abs; sumPxSz+=abs*px; fees+=fee; }
  }
  const exit = sumPxSz>0? (sumPxSz/filledOpp) : (S.ticks.get(sym)?.last || p.entry);
  try{ if(p.tpId) await cancelTrigger(p.tpId); }catch(_){}
  try{ if(p.slId) await cancelTrigger(p.slId); }catch(_){}
  finishTrade(sym,p.entry,exit,fees);
}

/* ----- Finish & Accounting ----- */
function finishTrade(sym,entry,exit,feeClose=0){
  const p=S.pos.get(sym); if(!p) return;
  const qm=(Meta.get(sym)?.qm)||1;
  const gross=(exit-entry)*p.contracts*qm*(p.side>0?+1:-1);
  const fees=(p.fees||0)+Math.abs(feeClose||0);
  const net=gross-Math.abs(fees);
  const row={t:new Date().toLocaleString('tr-TR'),id:p.tradeId||Date.now()+'',sym,side:p.side>0?'LONG':'SHORT',lev:p.lev,contracts:p.contracts,
             entry:+entry,exit:+exit,notional:+(p.contracts*qm*entry),pnl:+(+gross).toFixed(6),fee:+(+fees).toFixed(6),net:+(+net).toFixed(6),status:'closed'};
  S.ledger.push(row); localStorage.setItem('rb:ledger', JSON.stringify(S.ledger));
  S.pos.delete(sym); drawRow(sym);
  log(`ðŸ“˜ ${sym} NET=${row.net>=0?'+':''}${nf.format(row.net)} (pnl=${nf.format(row.pnl)} fee=${nf.format(row.fee)})`);
  if($('#accModal').classList.contains('open')) renderAccounting();
}

/* ===== Accounting UI ===== */
function compute(rows){
  const x={cnt:0,w:0,l:0,br:0,fee:0,net:0,not:0,best:null,worst:null};
  for(const r of rows){x.cnt++; if(r.net>=0)x.w++; else x.l++; x.br+=r.pnl; x.fee+=Math.abs(r.fee||0); x.net+=r.net; x.not+=Math.abs(r.notional||0); x.best=(x.best==null||r.net>x.best)?r.net:x.best; x.worst=(x.worst==null||r.net<x.worst)?r.net:x.worst;}
  x.winRate=x.cnt? x.w/x.cnt*100:0; x.roi=x.not? x.net/x.not*100:0; x.avg=x.cnt? x.net/x.cnt:0; return x;
}
function renderAccounting(){
  const rows=S.ledger.slice().reverse();
  const s=compute(rows);
  const cards=[
    ['Toplam Ä°ÅŸlem',s.cnt],['KazanÃ§lÄ±',s.w],['ZararlÄ±',s.l],['Win Rate %',s.winRate.toFixed(2)],
    ['Toplam Notional',nf.format(s.not)],['BrÃ¼t PnL',`${s.br>=0?'+':''}${nf.format(s.br)}`],
    ['Toplam Ãœcret',`-${nf.format(s.fee)}`],['Net PnL',`${s.net>=0?'+':''}${nf.format(s.net)}`],
    ['ROI %',`${s.roi>=0?'+':''}${s.roi.toFixed(2)}`],['Ortalama Net',`${s.avg>=0?'+':''}${nf.format(s.avg)}`],
    ['En Ä°yi',s.best==null?'â€”':`${s.best>=0?'+':''}${nf.format(s.best)}`],['En KÃ¶tÃ¼',s.worst==null?'â€”':`${s.worst>=0?'+':''}${nf.format(s.worst)}`]
  ];
  const box=$('#sumCards'); box.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid stats';
  for(const [k,v] of cards){ const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<b>${k}</b><div class="v mono">${v}</div>`; grid.appendChild(d); }
  box.appendChild(grid);

  const tb=$('#accBody'); tb.innerHTML='';
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.t}</td><td class="mono">${r.id}</td><td>${r.sym}</td><td>${r.side}</td><td>${r.lev}</td>
      <td class="mono">${r.contracts}</td><td class="mono">${nf.format(r.entry)}</td>
      <td class="mono">${nf.format(r.exit)}</td><td class="mono">${nf.format(r.notional||0)}</td>
      <td class="mono ${r.pnl>=0?'good':'bad'}">${nf.format(r.pnl)}</td>
      <td class="mono">${nf.format(r.fee)}</td>
      <td class="mono ${r.net>=0?'good':'bad'}">${nf.format(r.net)}</td>
      <td>${r.status}</td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);

  // Agg by coin
  const m=new Map();
  for(const r of S.ledger){
    const a=m.get(r.sym)||{sym:r.sym,cnt:0,w:0,l:0,not:0,br:0,fee:0,net:0};
    a.cnt++; if(r.net>=0) a.w++; else a.l++; a.not+=Math.abs(r.notional||0); a.br+=r.pnl; a.fee+=Math.abs(r.fee||0); a.net+=r.net; m.set(r.sym,a);
  }
  const ab=$('#aggBody'); ab.innerHTML='';
  for(const a of m.values()){
    const roi=a.not? a.net/a.not*100:0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.sym}</td><td>${a.cnt}</td><td>${a.w}</td><td>${a.l}</td>
      <td class="mono">${nf.format(a.not)}</td>
      <td class="mono ${a.br>=0?'good':'bad'}">${nf.format(a.br)}</td>
      <td class="mono">${nf.format(a.fee)}</td>
      <td class="mono ${a.net>=0?'good':'bad'}">${nf.format(a.net)}</td>
      <td class="mono ${roi>=0?'good':'bad'}">${(roi>=0?'+':'')+roi.toFixed(2)}</td>`;
    ab.appendChild(tr);
  }
}
$('#btnCSV').onclick=()=>{
  const cols=['time','id','symbol','side','lev','contracts','entry','exit','notional','pnl','fee','net','status'];
  const lines=S.ledger.map(r=>[r.t,r.id,r.sym,r.side,r.lev,r.contracts,r.entry,r.exit,r.notional||0,r.pnl,r.fee,r.net,r.status].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  const csv=cols.join(',')+'\n'+lines.join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='ledger.csv';document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},100);
};
$('#btnClearAcc').onclick=()=>{ if(confirm('Muhasebe sÄ±fÄ±rlansÄ±n mÄ±?')){ S.ledger=[]; localStorage.setItem('rb:ledger','[]'); renderAccounting(); }};

/* ===== Init ===== */
function ensureRows(){ S.coins.forEach(sym=>ensureRow(sym)); }
function init(){ ensureRows(); $('#clock').textContent=nowStr(); }
init();
</script>
</body>
</html>
