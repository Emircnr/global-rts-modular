<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gate.io MAC Channel Bot — Single File</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --acc:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --radius:18px; --gap:14px; --font:16px; --maxW:1200px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:400 var(--font)/1.55 'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:var(--maxW);margin:28px auto;padding:0 14px}
  h1{margin:0 0 6px;font-size:26px}
  .sub{margin:0 0 16px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .sec{padding:14px 14px 2px;color:var(--muted);font-size:13px;border-bottom:1px dashed var(--border)}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px}
  .form.full{grid-template-columns:1fr}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0d1528;color:var(--fg)}
  textarea{min-height:64px;resize:vertical}
  button{background:var(--acc);color:#071122;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--fg);font-weight:600}
  .row{display:flex;gap:10px;align-items:center}
  .kpis{display:flex;flex-wrap:wrap;gap:10px;padding:12px 14px;border-top:1px dashed var(--border)}
  .tag{padding:6px 10px;border-radius:12px;background:var(--glass);border:1px solid var(--border);font-size:14px}
  .tag.good{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.1)}
  .tag.bad{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.08)}
  .list{padding:14px}
  .sym{display:grid;grid-template-columns:110px repeat(7,1fr);gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border);font-size:14px}
  .sym .badge{font-size:12px;color:var(--muted)}
  .sym .s{font-weight:700}
  .status{padding:10px 14px;color:#ffb4b4}
  .muted{color:var(--muted);font-size:13px}
  .footer{opacity:.65;text-align:center;margin-top:16px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Gate.io MAC Channel Bot</h1>
  <div class="sub">Saniyede 1 güncellenen OCO benzeri mantık: kanal içindeyken üst banda <b>LONG</b>, alt banda <b>SHORT</b> emirleri; biri dolunca diğeri iptal ve <b>karşı banttan trailing STOP</b>.</div>

  <div class="grid">
    <!-- Sol Panel: Ayarlar -->
    <div class="card">
      <div class="sec">Bağlantı & Güvenlik</div>
      <div class="form">
        <div><label>Proxy Base URL</label><input id="proxy" placeholder="https://senin-proxy.com"/></div>
        <div><label>Piyasa</label>
          <select id="market">
            <option value="um">USDT-M Perp</option>
            <option value="cm">USD-M Perp</option>
          </select>
        </div>
        <div><label>Gate API Key</label><input id="apiKey" placeholder="Kamu anahtar"/></div>
        <div><label>Gate API Secret</label><input id="apiSecret" placeholder="GİZLİ anahtar" type="password"/></div>
      </div>

      <div class="sec">Sinyal (MAC Kanal)</div>
      <div class="form">
        <div><label>Interval</label>
          <select id="interval">
            <option>1m</option><option selected>5m</option><option>15m</option><option>30m</option>
            <option>60m</option><option>4h</option><option>1d</option>
          </select>
        </div>
        <div><label>Periyot (n)</label><input id="n" type="number" min="2" value="20"/></div>
        <div><label>MA Tipi</label>
          <select id="ma"><option>SMA</option><option>EMA</option></select>
        </div>
        <div><label>Kanal Modu</label>
          <select id="mode"><option value="hl" selected>High/Low</option><option value="envelope">Envelope</option></select>
        </div>
        <div><label>Envelope % (0.01 = %1)</label><input id="envPct" type="number" step="0.001" value="0.01"/></div>
        <div><label>Kline Limit</label><input id="limit" type="number" min="100" max="1000" value="500"/></div>
      </div>

      <div class="sec">Risk / Emir</div>
      <div class="form">
        <div><label>Kaldıraç (x)</label><input id="lev" type="number" min="1" value="10"/></div>
        <div><label>Tutar (USDT)</label><input id="usd" type="number" min="5" value="50"/></div>
        <div><label>Tick Güncelleme (sn)</label><input id="tick" type="number" min="1" value="1"/></div>
        <div><label>Slip/Buffer (bps)</label><input id="bps" type="number" min="0" value="2"/></div>
      </div>

      <div class="sec">Semboller</div>
      <div class="form full">
        <div><label>Semboller (virgül ile):</label>
          <input id="symbols" placeholder="BTC_USDT,ETH_USDT" value="BTC_USDT"/>
        </div>
        <div class="row" style="padding:0 14px 14px;">
          <button id="start">START</button>
          <button id="stop" class="ghost">STOP</button>
          <span class="muted">API Secret’ı tarayıcıda kullanmak risklidir. Proxy tarafında imzalama yapınız.</span>
        </div>
      </div>

      <div class="sec">Firestore (opsiyonel log)</div>
      <div class="form">
        <div><label>Project ID</label><input id="fs_projectId" value="macbot-b7b45"/></div>
        <div><label>API Key</label><input id="fs_apiKey" value="AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To"/></div>
        <div><label>App ID</label><input id="fs_appId" value="1:88494187419:web:9e0fd1a37e51332203373e"/></div>
        <div><label>Auth Domain</label><input id="fs_authDomain" value="macbot-b7b45.firebaseapp.com"/></div>
        <div><label>Log Koleksiyonu</label><input id="fs_col" value="gate_mac_logs"/></div>
        <div class="row"><button id="fs_init" class="ghost">Firestore Bağlan</button><span id="fs_stat" class="muted">Bağlı değil</span></div>
      </div>
    </div>

    <!-- Sağ Panel: Durum -->
    <div class="card">
      <div class="sec">Durum</div>
      <div class="kpis" id="kpis">
        <div class="tag">Loop: <span id="loop" class="badge">STOPPED</span></div>
        <div class="tag">Son tick: <span id="lastTick" class="badge">-</span></div>
        <div class="tag">Hata: <span id="err" class="badge">-</span></div>
      </div>
      <div class="sec">Semboller</div>
      <div class="list" id="symList">
        <!-- satırlar dinamik -->
      </div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <div class="footer">Uyarı: Bu araç eğitim amaçlıdır. Gerçek işlem ciddi risk taşır; kendi sorumluluğunuzdadır.</div>
</div>

<!-- Firebase (Firestore) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/* ===================== Yardımcılar ===================== */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const nowMs = ()=> Date.now();
const fmt = n => (n==null||isNaN(n))?'-':(+n).toLocaleString(undefined,{maximumFractionDigits:8});
const bpsToMult = bps => 1 + (bps/10000);

/* Basit MA */
function sma(arr, n){
  const out = new Array(arr.length).fill(null);
  let sum=0;
  for(let i=0;i<arr.length;i++){
    sum += arr[i];
    if(i>=n) sum -= arr[i-n];
    if(i>=n-1) out[i] = sum/n;
  }
  return out;
}
function ema(arr, n){
  const out = new Array(arr.length).fill(null);
  const k = 2/(n+1);
  let e = null;
  for(let i=0;i<arr.length;i++){
    const v = arr[i];
    if(i<n-1){ out[i]=null; e = (e==null? v : (e*(i)+v)/(i+1)); continue; }
    if(out[i-1]==null) e = arr.slice(0,n).reduce((a,b)=>a+b,0)/n;
    e = (v - e)*k + e;
    out[i]=e;
  }
  return out;
}
function movingAverage(arr, n, kind){ return (kind==='EMA')?ema(arr,n):sma(arr,n); }

/* MAC hesapla */
function macFromKlines(klines, n, kind, mode, envPct){
  const highs = klines.map(k=>k.h), lows = klines.map(k=>k.l), closes = klines.map(k=>k.c);
  let upper, lower, mid;
  if(mode==='envelope'){
    mid = movingAverage(closes, n, kind);
    upper = mid.map(x => x==null?null:x*(1+envPct));
    lower = mid.map(x => x==null?null:x*(1-envPct));
  }else{
    upper = movingAverage(highs, n, kind);
    lower = movingAverage(lows,  n, kind);
    mid = upper.map((u,i)=> (u==null||lower[i]==null)?null:(u+lower[i])/2);
  }
  const c = closes[closes.length-1];
  const u = upper[upper.length-1], l = lower[lower.length-1];
  const inside = (u!=null && l!=null) ? (l<=c && c<=u) : null;
  let pos = 'UNKNOWN';
  if(u!=null && l!=null){
    pos = (c>u)?'ABOVE':(c<l?'BELOW':'INSIDE');
  }
  // kesişim (son 2 bar)
  let crossUp=false, crossDown=false;
  if(upper.length>=2 && upper[upper.length-2]!=null && lower[lower.length-2]!=null){
    const pc = closes[closes.length-2], pu = upper[upper.length-2], pl = lower[lower.length-2];
    if(pc<=pu && c>u) crossUp=true;
    if(pc>=pl && c<l) crossDown=true;
  }
  return {upper,mid,lower, c, u, l, inside, pos, crossUp, crossDown};
}

/* ===================== Firestore ===================== */
let FS=null; // firestore instance
async function fsInit(){
  try{
    const cfg = {
      apiKey: qs('fs_apiKey').value.trim(),
      authDomain: qs('fs_authDomain').value.trim(),
      projectId: qs('fs_projectId').value.trim(),
      appId: qs('fs_appId').value.trim()
    };
    const app = firebase.initializeApp(cfg, 'gate-mac-bot-'+Math.random());
    FS = firebase.firestore(app);
    qs('fs_stat').textContent = 'Bağlı';
  }catch(e){
    qs('fs_stat').textContent = 'Hata: '+e.message;
  }
}
async function fsLog(symbol, payload){
  if(!FS) return;
  try{
    const colName = qs('fs_col').value.trim() || 'gate_mac_logs';
    await FS.collection(colName).add({
      symbol, ts_ms: nowMs(), ...payload
    });
  }catch(e){
    qs('status').textContent = 'Firestore yazım hatası: '+e.message;
  }
}

/* ===================== Proxy API (kendi backend’in) ===================== */
async function proxyCall(path, body){
  const base = qs('proxy').value.trim();
  if(!base) throw new Error('Proxy Base URL boş');
  const url = base.replace(/\/+$/,'') + path;
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const j = await r.json().catch(()=>({ok:false,error:'invalid json'}));
  if(!r.ok || j.ok===false) throw new Error(j.error || r.status+' '+r.statusText);
  return j;
}

/* Örnek proxy rotaları:
 * POST /gate/klines      {symbol, interval, limit} -> {ok, data:[{t,o,h,l,c}]}
 * POST /gate/placeOrder  {apiKey, apiSecret, market, symbol, side, price, size, leverage, type, reduceOnly, tif, stopPrice, stopType} -> {ok, orderId}
 * POST /gate/cancelOrder {apiKey, apiSecret, market, symbol, orderId} -> {ok}
 */

/* ===================== Bot Döngüsü ===================== */
let looping = false, timer = null;
const state = {}; // symbol -> durum

function uiSetErr(msg){ qs('err').textContent = msg || '-'; }
function uiSetTick(){ qs('lastTick').textContent = new Date().toLocaleTimeString(); }
function renderSymRows(){
  const list = qs('symList');
  list.innerHTML = '';
  Object.keys(state).forEach(sym=>{
    const s = state[sym];
    const el = document.createElement('div'); el.className='sym';
    el.innerHTML = `
      <div class="s">${sym}</div>
      <div><span class="badge">Fiyat</span><div>${fmt(s.price)}</div></div>
      <div><span class="badge">U</span><div>${fmt(s.u)}</div></div>
      <div><span class="badge">M</span><div>${fmt(s.m)}</div></div>
      <div><span class="badge">L</span><div>${fmt(s.l)}</div></div>
      <div><span class="badge">Poz</span><div>${s.position||'-'}</div></div>
      <div><span class="badge">Çalışan</span><div>${s.working||'-'}</div></div>
      <div><span class="badge">Stop</span><div>${fmt(s.stopPrice)}</div></div>
    `;
    list.appendChild(el);
  });
}

async function tickSymbol(sym){
  const apiKey = qs('apiKey').value.trim();
  const apiSecret = qs('apiSecret').value.trim();
  const market = qs('market').value;
  const interval = qs('interval').value;
  const limit = +qs('limit').value || 500;
  const n = +qs('n').value || 20;
  const ma = qs('ma').value;
  const mode = qs('mode').value;
  const envPct = +qs('envPct').value || 0.01;
  const lev = +qs('lev').value || 10;
  const usd = +qs('usd').value || 50;
  const bps = +qs('bps').value || 0;

  // 1) Kline çek
  const K = await proxyCall('/gate/klines', {symbol: sym, interval, limit});
  const klines = K.data; // {t,o,h,l,c}
  if(!klines || klines.length===0) throw new Error('Kline yok');
  const mac = macFromKlines(klines, n, ma, mode, envPct);
  const last = klines[klines.length-1];
  const price = +last.c;

  // 2) Pozisyon/çalışan emir simülasyonu: UI kendi state’ini tutar.
  if(!state[sym]) state[sym] = {position:'NONE', working:'-', stopPrice:null, orderLong:null, orderShort:null, entry:null};
  const S = state[sym];
  S.price = price; S.u=mac.u; S.m=mac.mid?.[mac.mid.length-1]??null; S.l=mac.l;

  // Hesapla miktar (contract “size”): basitçe USDT / price
  const size = Math.max(0.0001, usd / price);

  // 3) Kanal içindeysek iki bekleyen emir…
  if(mac.inside){
    const longPx  = +(mac.u * bpsToMult(+bps)).toFixed(8);
    const shortPx = +(mac.l / bpsToMult(+bps)).toFixed(8);

    // LONG bekleyen
    if(!S.orderLong || Math.abs(S.orderLong.price - longPx) / longPx > 0.0001){
      // eski varsa iptal
      if(S.orderLong?.id){
        await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.orderLong.id});
      }
      const pl = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, symbol: sym, side:'buy', price: longPx, size, leverage: lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderLong = {id: pl.orderId, price: longPx};
    }

    // SHORT bekleyen
    if(!S.orderShort || Math.abs(S.orderShort.price - shortPx) / shortPx > 0.0001){
      if(S.orderShort?.id){
        await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.orderShort.id});
      }
      const ps = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, symbol: sym, side:'sell', price: shortPx, size, leverage: lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderShort = {id: ps.orderId, price: shortPx};
    }
    S.working = `L@${S.orderLong.price} / S@${S.orderShort.price}`;
  }

  // 4) Dolum kontrolü (basit tetik): fiyat >= longPx → LONG doldu; fiyat <= shortPx → SHORT doldu
  // Gerçekte fill kontrolü için proxy üzerinden order/positions sorgulamalısın.
  if(S.orderLong && price >= S.orderLong.price){
    // LONG gerçekleşti → SHORT iptal, STOP = lower band (trail)
    if(S.orderShort?.id) await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.orderShort.id});
    S.position = 'LONG'; S.entry = S.orderLong.price; S.orderShort=null; S.working='-';
    const stopPx = mac.l;
    if(stopPx){
      const st = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, symbol: sym, side:'sell', price: stopPx, size, leverage: lev,
        type:'stop', stopPrice: stopPx, stopType:'down', reduceOnly:true, tif:'gtc'
      });
      S.stopId = st.orderId; S.stopPrice = stopPx;
    }
  } else if(S.orderShort && price <= S.orderShort.price){
    // SHORT gerçekleşti → LONG iptal, STOP = upper band (trail)
    if(S.orderLong?.id) await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.orderLong.id});
    S.position = 'SHORT'; S.entry = S.orderShort.price; S.orderLong=null; S.working='-';
    const stopPx = mac.u;
    if(stopPx){
      const st = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, symbol: sym, side:'buy', price: stopPx, size, leverage: lev,
        type:'stop', stopPrice: stopPx, stopType:'up', reduceOnly:true, tif:'gtc'
      });
      S.stopId = st.orderId; S.stopPrice = stopPx;
    }
  }

  // 5) Trailing STOP (pozisyondayken karşı band değişirse stop’u güncelle)
  if(S.position==='LONG' && S.stopId && mac.l && Math.abs(mac.l - S.stopPrice)/S.stopPrice > 0.0005){
    // iptal et → yeni stop
    await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.stopId});
    const st2 = await proxyCall('/gate/placeOrder', {
      apiKey, apiSecret, market, symbol: sym, side:'sell', price: mac.l, size, leverage: lev,
      type:'stop', stopPrice: mac.l, stopType:'down', reduceOnly:true, tif:'gtc'
    });
    S.stopId = st2.orderId; S.stopPrice = mac.l;
  }
  if(S.position==='SHORT' && S.stopId && mac.u && Math.abs(mac.u - S.stopPrice)/S.stopPrice > 0.0005){
    await proxyCall('/gate/cancelOrder', {apiKey, apiSecret, market, symbol: sym, orderId: S.stopId});
    const st2 = await proxyCall('/gate/placeOrder', {
      apiKey, apiSecret, market, symbol: sym, side:'buy', price: mac.u, size, leverage: lev,
      type:'stop', stopPrice: mac.u, stopType:'up', reduceOnly:true, tif:'gtc'
    });
    S.stopId = st2.orderId; S.stopPrice = mac.u;
  }

  // 6) Firestore log
  await fsLog(sym, {
    interval, n, ma_type:ma, mode, envelope_pct:+envPct,
    close:price, upper:mac.u, mid:mac.mid?.[mac.mid.length-1]??null, lower:mac.l,
    in_channel: mac.inside, position: mac.pos,
    seconds_since_enter: 0, // (istersen pozisyon kronometresi ekleyebilirsin)
  });

  renderSymRows();
}

async function loop(){
  if(looping) return;
  looping = true;
  qs('loop').textContent = 'RUNNING';
  uiSetErr('-');
  const syms = qs('symbols').value.split(',').map(s=>s.trim()).filter(Boolean);
  syms.forEach(s=>{ if(!state[s]) state[s] = {}; });
  renderSymRows();

  const tickSec = Math.max(1, +qs('tick').value || 1);
  while(looping){
    try{
      for(const sym of syms){
        await tickSymbol(sym);
      }
      uiSetTick();
      await sleep(tickSec*1000);
    }catch(e){
      uiSetErr(e.message||String(e));
      await sleep(1000);
    }
  }
  qs('loop').textContent = 'STOPPED';
}

function stopLoop(){ looping=false; }

/* ===================== Events ===================== */
qs('start').addEventListener('click', loop);
qs('stop').addEventListener('click', stopLoop);
qs('fs_init').addEventListener('click', fsInit);
</script>
</body>
</html>
