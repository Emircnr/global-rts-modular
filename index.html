<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MEXC Futures ‚Üî Spot ‚Äî Anlƒ±k Fark (Limit IOC Bot, E≈üit Notional)</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --spotAsk:#ef4444; --spotBid:#22c55e; --futBid:#22c55e; --futAsk:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:16px; --maxW:1180px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#4b5563; --panel:#f4f7fb; --panel2:#ffffff;
    --glass:rgba(0,0,0,.06); --border:#d7e0ef; --accent:#2563eb;
    --good:#16a34a; --bad:#dc2626;
    --spotAsk:#b91c1c; --spotBid:#15803d; --futBid:#15803d; --futAsk:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    background:
      radial-gradient(1200px 800px at 15% -10%, #0f2b59 0%, transparent 55%),
      radial-gradient(1000px 700px at 110% 0%, #153160 0%, transparent 55%),
      linear-gradient(180deg,#0a1222 0%, #0b0f19 60%);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  }
  .wrap{max-width:var(--maxW); margin:0 auto; padding:18px}
  header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(5,10,22,.85), transparent); backdrop-filter:blur(10px)}
  .center{display:flex; justify-content:center}
  h1{margin:0; font-size:22px; letter-spacing:.2px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel2));
    color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer
  }
  .btn:hover{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 20%, transparent)}
  .iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:12px}
  input,select,textarea{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); color:var(--fg); border-radius:12px; padding:10px 12px
  }
  .chip{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); display:inline-flex; gap:8px; align-items:center}

  #topCard{ margin:18px auto; max-width:900px; padding:16px 18px; border-radius:20px; border:1px solid var(--border);
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent),
                radial-gradient(900px 400px at -10% -30%, rgba(96,165,250,.18), transparent 60%),
                linear-gradient(180deg,var(--panel),var(--panel2));
  }
  #topCard.hidden{display:none}
  .pill{border:1px solid var(--border); padding:5px 10px; border-radius:999px}
  .mono{font-variant-numeric:tabular-nums slashed-zero; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .blink{animation:blink .6s ease-in-out 1}
  @keyframes blink{50%{filter:brightness(1.35)}}
  .sym{font-weight:800; font-size:22px}

  .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow:0 10px 34px rgba(0,0,0,.22)}
  table{width:100%; border-collapse:separate; border-spacing:0 var(--gap)}
  thead th{font-size:13px; color:var(--muted); text-align:left; padding:0 12px}
  tbody td{padding:var(--padY) var(--padX); font-size:var(--font); background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-left:none; border-right:none}
  tbody tr td:first-child{border-top-left-radius:var(--radius); border-bottom-left-radius:var(--radius); border-left:1px solid var(--border)}
  tbody tr td:last-child{border-top-right-radius:var(--radius); border-bottom-right-radius:var(--radius); border-right:1px solid var(--border)}
  .src-spotAsk{background:color-mix(in oklab, var(--spotAsk) 18%, transparent)}
  .src-futBid{background:color-mix(in oklab, var(--futBid) 18%, transparent)}
  .src-spotBid{background:color-mix(in oklab, var(--spotBid) 18%, transparent)}
  .src-futAsk{background:color-mix(in oklab, var(--futAsk) 18%, transparent)}
  .pctPos{color:var(--good); font-weight:800}

  .status{display:inline-flex; gap:8px; align-items:center}
  .badge{font-size:12px; border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted); background:var(--glass)}
  .badge.wait{color:#f59e0b; border-color:#634f1a; background:rgba(245,158,11,.15)}
  .badge.lock{color:#60a5fa; border-color:#1b3b73; background:rgba(96,165,250,.15)}
  .badge.block{color:#94a3b8; border-color:#334155; background:rgba(148,163,184,.15)}
  .btn-mini{border:1px solid var(--border); background:linear-gradient(180deg,var(--panel),var(--panel2)); color:var(--fg); padding:3px 8px; border-radius:8px; cursor:pointer; font-size:12px}

  #mgrBtn{position:fixed; right:22px; top:18px; z-index:50}
  #botBtn{position:fixed; right:72px; top:18px; z-index:50}
  .modal{position:fixed; inset:0; display:none; z-index:60}
  .modal.open{display:block}
  .overlay{position:absolute; inset:0; background:rgba(3,6,15,.55); backdrop-filter:blur(4px); opacity:0; animation:fadeIn .15s ease forwards}
  @keyframes fadeIn{to{opacity:1}}
  .panel{ position:absolute; right:24px; top:72px; width:min(560px, calc(100% - 32px)); background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.45); transform:translateY(-10px); opacity:0; animation:pop .18s ease forwards }
  @keyframes pop{to{transform:none; opacity:1}}
  .panel header{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 0}
  .panel h3{margin:0; font-size:16px}
  .panel .content{padding:12px 14px 14px; display:grid; gap:12px}
  .grp{border:1px dashed var(--border); border-radius:14px; padding:10px}
  .lbl{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chipx{background:var(--glass); border:1px solid var(--border); border-radius:999px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset; cursor:pointer; color:var(--muted)}
  .warn{font-size:12px; color:var(--muted)}
  #botLog{height:150px; resize:vertical}
</style>
</head>
<body>
  <button id="botBtn" class="btn iconbtn" title="Bot"> ü§ñ </button>
  <button id="mgrBtn" class="btn iconbtn" title="Y√∂netim"> ‚öôÔ∏è </button>

  <header class="wrap center">
    <div class="row">
      <h1>MEXC Futures ‚Üî Spot ‚Äî Anlƒ±k Fark</h1>
      <div class="chip">Saat: <span id="clock" class="mono">‚Äî:‚Äî:‚Äî</span></div>
    </div>
  </header>

  <div class="wrap center">
    <div id="topCard" class="card" style="width:100%; max-width:900px;">
      <span id="topSym" class="sym">‚Äî</span>
      <span id="topSide" class="pill">‚Äî</span>
      <span id="topDesc" class="mono">‚Äî</span>
      <span id="topPct" class="mono">‚Äî</span>
    </div>
  </div>

  <main class="wrap center" style="padding-bottom:34px">
    <div class="card" style="width:100%">
      <table>
        <thead>
          <tr>
            <th>Coin</th>
            <th>Durum</th>
            <th>Spot ASK</th>
            <th>Fut BID</th>
            <th>% Short</th>
            <th>Spot BID</th>
            <th>Fut ASK</th>
            <th>% Long</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p id="emptyNote" style="margin:12px 6px 2px; color:var(--muted); font-size:13px; display:none">Liste bo≈ü.</p>
    </div>
  </main>

  <!-- Y√∂netim Modal -->
  <div id="mgrModal" class="modal">
    <div class="overlay" data-close="1"></div>
    <div class="panel">
      <header>
        <h3>Y√∂netim</h3>
        <div class="row">
          <select id="themeSel">
            <option value="dark">Koyu tema</option>
            <option value="light">A√ßƒ±k tema</option>
          </select>
          <button class="btn iconbtn" title="Kapat" data-close="1">‚úñ</button>
        </div>
      </header>
      <div class="content">
        <div class="grp">
          <label class="lbl">Coin ekle / √ßƒ±kar (√∂rn: ETH veya ETHUSDT)</label>
          <div class="row">
            <input id="addSym" type="text" placeholder="Sembol"/>
            <button id="btnAdd" class="btn">Ekle</button>
            <button id="btnClear" class="btn" style="margin-left:auto">T√ºm√ºn√º Sil</button>
          </div>
          <div id="chipWrap" class="chips" style="margin-top:8px"></div>
        </div>
        <div class="grp">
          <label class="lbl">Vurgu e≈üiƒüi (%)</label>
          <div class="row">
            <input id="thresh" type="number" step="0.01" value="0.10" style="width:160px"/>
            <label class="row" style="margin-left:auto"><input type="checkbox" id="toggleTop" checked/> En y√ºksek fark kartƒ±</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT Modal -->
  <div id="botModal" class="modal">
    <div class="overlay" data-close="1"></div>
    <div class="panel">
      <header>
        <h3>Limit IOC Bot ‚Äî E≈üit Notional</h3>
        <button class="btn iconbtn" title="Kapat" data-close="1">‚úñ</button>
      </header>
      <div class="content">
        <div class="grp">
          <label class="lbl">√áalƒ±≈üma</label>
          <div class="row">
            <label class="row"><input type="checkbox" id="botEnable"/> Botu Ba≈ülat</label>
            <label class="row"><input type="checkbox" id="botDry" checked/> Dry-Run</label>
            <label class="row"><input type="checkbox" id="botUseTableThresh" checked/> A√ßƒ±lƒ±≈ü i√ßin tablo e≈üiƒüi</label>
          </div>
        </div>
        <div class="grp">
          <label class="lbl">E≈üikler & Tutar</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <label> A√ßƒ±≈ü E≈üiƒüi % <input id="botOpenThresh" type="number" step="0.01" value="0.30" style="width:120px"/></label>
            <label> Kapanƒ±≈ü E≈üiƒüi % (LONG) <input id="botCloseThresh" type="number" step="0.01" value="0.20" style="width:150px"/></label>
            <label> ƒ∞≈ülem Tutarƒ± (USDT) <input id="botNotional" type="number" step="1" value="10" style="width:120px"/></label>
          </div>
        </div>
        <div class="grp">
          <label class="lbl">Futures Ayarlarƒ±</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <label> Kaldƒ±ra√ß <input id="botLev" type="number" step="1" value="5" style="width:100px"/></label>
            <label> Marjin
              <select id="botMargin" style="width:140px">
                <option value="isolated" selected>Isolated</option>
                <option value="cross">Cross</option>
              </select>
            </label>
            <label> Cooldown (sn) <input id="botCooldown" type="number" step="1" value="0" style="width:90px"/></label>
          </div>
          <div class="warn">Aynƒ± sembolde aynƒ± anda tek i≈ülem. LONG sinyali ‚Üí tam kapanƒ±≈ü.</div>
        </div>
        <div class="grp">
          <label class="lbl">API & Proxy</label>
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <input id="spotKey" placeholder="Spot API KEY" style="flex:1 1 220px"/>
            <input id="spotSec" placeholder="Spot API SECRET" type="password" style="flex:1 1 220px"/>
          </div>
          <div class="row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
            <input id="futKey" placeholder="Futures API KEY" style="flex:1 1 220px"/>
            <input id="futSec" placeholder="Futures API SECRET" type="password" style="flex:1 1 220px"/>
          </div>
          <div class="row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
            <input id="proxyUrl" value="http://localhost:8787/" placeholder="Proxy URL (√∂rn: http://localhost:8787/ veya Cloudflare/Vercel)" style="flex:1 1 320px"/>
            <input id="proxyToken" placeholder="Proxy Token (opsiyonel)" style="flex:1 1 220px"/>
          </div>
          <div class="warn">CORS i√ßin proxy zorunludur. Tek API anahtarƒ±nƒ± iki pazarda da kullanabilirsiniz.</div>
        </div>
        <div class="grp">
          <label class="lbl">Log</label>
          <textarea id="botLog" class="mono" placeholder="Log..."></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
/*** ===== Yardƒ±mcƒ±lar ===== ***/
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const now = ()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const nf = new Intl.NumberFormat('tr-TR',{maximumFractionDigits:9});
const toNum = v => (typeof v === 'number') ? v : parseFloat(v);
const pctStr = v => isFinite(v) ? ((v>=0?'+':'') + v.toFixed(3) + '%') : '‚Äî';
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const roundTo = (x,dec=6)=> Number.parseFloat(x).toFixed(dec);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const fmtPx = p => String(Number(p).toFixed(8));
function roundDown(x, step){ if(!step || step<=0) return x; return Math.floor(x/step)*step; }

/*** ===== Durum ===== ***/
const CANCEL_BLOCK_MS = 30_000;
const SPOT_FAST_MS = 150; // agresif & √ßok hƒ±zlƒ±
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('mexc:list')||'["BTCUSDT","ETHUSDT"]')),
  ui: { thresh:+(localStorage.getItem('mexc:thresh')||0.10), theme: localStorage.getItem('mexc:theme') || 'dark', showTop: JSON.parse(localStorage.getItem('mexc:showTop')||'true') },
  spot: new Map(),  fut: new Map(), rowEls: new Map(),
  wsFut:null, rafScheduled:false, lastTop:null,
  locks:new Map(), active:new Map(), blockedUntil:new Map(),
  bot:{
    enabled:false, dry:true, useTableThresh:true,
    openThresh:0.30, closeThresh:0.20,
    notional:10, lev:5, margin:'isolated',
    cooldown:0, lastExecBySym:new Map(),
    spotKey:'', spotSec:'', futKey:'', futSec:'',
    proxy:'http://localhost:8787/', proxyToken:'',
    futSetup:new Set()
  },
  meta:{ spot:new Map(), fut:new Map() }
};
function saveList(){ localStorage.setItem('mexc:list', JSON.stringify([...S.coins])); }
function saveUI(){ localStorage.setItem('mexc:thresh', S.ui.thresh); localStorage.setItem('mexc:theme', S.ui.theme); localStorage.setItem('mexc:showTop', S.ui.showTop); }

/*** ===== Tema & UI ===== ***/
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
applyTheme();
setInterval(()=>$('#clock').textContent=now(), 1000);

const mgr = { open(){ $('#mgrModal').classList.add('open'); $('#addSym').focus(); }, close(){ $('#mgrModal').classList.remove('open'); } };
const bot = { open(){ $('#botModal').classList.add('open'); }, close(){ $('#botModal').classList.remove('open'); } };
$('#mgrBtn').onclick = ()=>mgr.open();
$('#botBtn').onclick = ()=>bot.open();
document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target.dataset.close) m.classList.remove('open'); }));
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ mgr.close(); bot.close(); }});

$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#themeSel').value = S.ui.theme;
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); scheduleDraw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop=e.target.checked; saveUI(); scheduleDraw(); };
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };

function botLog(line){ const ta=$('#botLog'); ta.value += `[${now()}] ${line}\n`; ta.scrollTop = ta.scrollHeight; }
$('#botEnable').onchange = e=>{ S.bot.enabled = e.target.checked; botLog(S.bot.enabled?'Bot A√áIK':'Bot KAPALI'); };
$('#botDry').onchange = e=>{ S.bot.dry = e.target.checked; };
$('#botUseTableThresh').onchange = e=>{ S.bot.useTableThresh = e.target.checked; };
$('#botOpenThresh').onchange = e=>{ S.bot.openThresh = +e.target.value; };
$('#botCloseThresh').onchange = e=>{ S.bot.closeThresh = +e.target.value; };
$('#botNotional').onchange = e=>{ S.bot.notional = Math.max(10, +e.target.value||0); };
$('#botLev').onchange = e=>{ S.bot.lev = clamp(+e.target.value||1, 1, 125); };
$('#botMargin').onchange = e=>{ S.bot.margin = e.target.value; };
$('#botCooldown').onchange = e=>{ S.bot.cooldown = Math.max(0, +e.target.value||0); };
$('#spotKey').oninput = e=>S.bot.spotKey=e.target.value.trim();
$('#spotSec').oninput = e=>S.bot.spotSec=e.target.value.trim();
$('#futKey').oninput  = e=>S.bot.futKey = e.target.value.trim();
$('#futSec').oninput  = e=>S.bot.futSec = e.target.value.trim();
$('#proxyUrl').oninput = e=>S.bot.proxy = e.target.value.trim();
$('#proxyToken').oninput = e=>S.bot.proxyToken = e.target.value.trim();

/*** ===== Sembol yardƒ±mcƒ±larƒ± ===== ***/
const futOf = spotSym => spotSym.replace(/USDT$/,'_USDT'); // BTCUSDT -> BTC_USDT
const spotOf = futSym => futSym.replace('_',''); // BTC_USDT -> BTCUSDT

/*** ===== Coin UI ===== ***/
function renderChips(){
  const wrap = $('#chipWrap'); wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d = document.createElement('div'); d.className='chipx';
    const b = document.createElement('b'); b.textContent = sym;
    const x = document.createElement('button'); x.textContent='‚úï';
    x.onclick=()=>{ S.coins.delete(sym); saveList(); unsub(sym); S.rowEls.get(sym)?.tr.remove(); S.rowEls.delete(sym); scheduleDraw(); };
    d.append(b,x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
renderChips();
$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase();
  if(!raw) return;
  let sym = raw.endsWith('USDT') ? raw : (raw + 'USDT');
  sym = sym.replace(/[^A-Z0-9]/g,'');
  if(!sym.endsWith('USDT')) return alert('Sadece *USDT √ßiftleri.');
  if(!S.coins.has(sym)){ S.coins.add(sym); saveList(); renderChips(); ensureRow(sym); sub(sym); }
  $('#addSym').value='';
};
$('#btnClear').onclick = ()=>{
  if(confirm('T√ºm coinleri sil?')){
    [...S.coins].forEach(s=>unsub(s));
    S.coins.clear(); saveList();
    S.rowEls.forEach(el=>el.tr.remove()); S.rowEls.clear();
    scheduleDraw();
  }
};

/*** ===== WS: Futures ===== ***/
function wsFutConnect(){
  try{ S.wsFut?.close?.(); }catch{}
  const ws = new WebSocket('wss://contract.mexc.com/edge'); S.wsFut = ws;
  ws.onopen = ()=>{
    // her sembol i√ßin ticker
    for(const sym of S.coins){
      const fut = futOf(sym);
      ws.send(JSON.stringify({ method:'sub.ticker', param:{ symbol:fut } }));
    }
    // ping
    setInterval(()=>{ if(ws.readyState===1) ws.send(JSON.stringify({method:'ping'})); }, 15000);
  };
  ws.onmessage = (ev)=>{
    try{
      const j=JSON.parse(ev.data);
      if(j && j.channel==='push.ticker' && j.data && j.data.symbol){
        const sym = j.data.symbol; // BTC_USDT
        const bid = toNum(j.data.bid1), ask = toNum(j.data.ask1);
        if(isFinite(bid)||isFinite(ask)) S.fut.set(sym,{bid,ask,ts:Date.now()});
        scheduleDraw();
      }
    }catch(_){}
  };
  ws.onclose = ()=>{ setTimeout(wsFutConnect, 300 + Math.random()*500); };
}
function sub(spotSym){
  // futures ws subscribe
  if(S.wsFut?.readyState===1){
    S.wsFut.send(JSON.stringify({ method:'sub.ticker', param:{ symbol:futOf(spotSym) } }));
  }
}
function unsub(spotSym){
  if(S.wsFut?.readyState===1){
    S.wsFut.send(JSON.stringify({ method:'unsub.ticker', param:{ symbol:futOf(spotSym) } }));
  }
  S.fut.delete(futOf(spotSym)); S.spot.delete(spotSym);
}

/*** ===== SPOT: √áok hƒ±zlƒ± REST polling (bookTicker) ===== ***/
let spotTimer = null;
const SPOT_HOST = 'https://api.mexc.com';
async function spotBookTicker(sym){
  const url = `${SPOT_HOST}/api/v3/ticker/bookTicker?symbol=${encodeURIComponent(sym)}`;
  try{
    const f = await fetch(url, { cache:'no-store', keepalive:true });
    if(!f.ok) return;
    const d = await f.json();
    const bid=toNum(d.bidPrice), ask=toNum(d.askPrice);
    if(isFinite(bid)||isFinite(ask)) S.spot.set(sym,{bid,ask,ts:Date.now()});
  }catch(_){}
}
function startSpotLoop(){
  if(spotTimer) clearInterval(spotTimer);
  spotTimer = setInterval(()=>{
    for(const sym of S.coins){ spotBookTicker(sym); }
  }, SPOT_FAST_MS);
}

/*** ===== Hesaplama & √áizim ===== ***/
function cmpFor(spotSym){
  const sp=S.spot.get(spotSym), fu=S.fut.get(futOf(spotSym));
  if(!sp || !fu) return null;
  const askS=sp.ask, bidS=sp.bid, bidF=fu.bid, askF=fu.ask;
  const okShort = isFinite(askS)&&isFinite(bidF)&&askS>0;
  const okLong  = isFinite(bidS)&&isFinite(askF)&&askF>0;
  const shortPct = okShort ? ( (bidF - askS) / askS * 100 ) : NaN;
  const longPct  = okLong  ? ( (bidS - askF) / askF * 100 ) : NaN;
  return {sym:spotSym, askS, bidS, bidF, askF, shortPct, longPct};
}

function ensureRow(spotSym){
  if(S.rowEls.has(spotSym)) return;
  const tr=document.createElement('tr'); tr.dataset.sym=spotSym;

  const tdC=document.createElement('td'); tdC.className='sym'; tdC.textContent=spotSym;
  const tdStatus=document.createElement('td'); tdStatus.className='status';
  const statusBadge=document.createElement('span'); statusBadge.className='badge'; statusBadge.textContent='‚Äî';
  const cancelBtn=document.createElement('button'); cancelBtn.className='btn-mini'; cancelBtn.textContent='ƒ∞ptal'; cancelBtn.style.display='none';
  cancelBtn.onclick=()=> cancelWaiting(spotSym);
  tdStatus.append(statusBadge, cancelBtn);

  const tdSAsk=document.createElement('td'); tdSAsk.className='mono src-spotAsk'; tdSAsk.textContent='‚Äî';
  const tdFBid=document.createElement('td'); tdFBid.className='mono src-futBid'; tdFBid.textContent='‚Äî';
  const tdShort=document.createElement('td'); tdShort.className='mono'; tdShort.textContent='‚Äî';
  const tdSBid=document.createElement('td'); tdSBid.className='mono src-spotBid'; tdSBid.textContent='‚Äî';
  const tdFAsk=document.createElement('td'); tdFAsk.className='mono src-futAsk'; tdFAsk.textContent='‚Äî';
  const tdLong=document.createElement('td'); tdLong.className='mono'; tdLong.textContent='‚Äî';

  tr.append(tdC,tdStatus,tdSAsk,tdFBid,tdShort,tdSBid,tdFAsk,tdLong);
  $('#tbody').appendChild(tr);
  S.rowEls.set(spotSym,{tr, tdStatus, statusBadge, cancelBtn, tdSAsk, tdFBid, tdShort, tdSBid, tdFAsk, tdLong});
}
function updateStatusUI(spotSym){
  const el = S.rowEls.get(spotSym); if(!el) return;
  const locked = !!S.locks.get(spotSym);
  const active = S.active.has(spotSym);
  const until = S.blockedUntil.get(spotSym) || 0;
  const blocked = Date.now() < until;

  el.statusBadge.className='badge'; el.statusBadge.textContent='‚Äî'; el.cancelBtn.style.display='none';
  if(locked){ el.statusBadge.classList.add('lock'); el.statusBadge.textContent='‚öôÔ∏è ƒ∞≈ülem'; }
  else if(active){ el.statusBadge.classList.add('wait'); el.statusBadge.textContent='‚è≥ Beklemede'; el.cancelBtn.style.display=''; }
  else if(blocked){ el.statusBadge.classList.add('block'); el.statusBadge.textContent='‚è∏ Blok (30s)'; }
}
function scheduleDraw(){ if(!S.rafScheduled){ S.rafScheduled=true; requestAnimationFrame(draw); } }

async function draw(){
  S.rafScheduled=false;
  let any=false;
  for(const spotSym of S.coins){
    ensureRow(spotSym);
    const r = cmpFor(spotSym);
    updateStatusUI(spotSym);
    if(r){
      const thr = Number(S.ui.thresh)||0;
      const sh = isFinite(r.shortPct) && r.shortPct>0 && r.shortPct>=thr;
      const lo = isFinite(r.longPct)  && r.longPct>0  && r.longPct>=thr;

      const el=S.rowEls.get(spotSym);
      el.tdSAsk.textContent = isFinite(r.askS) ? nf.format(r.askS) : '‚Äî';
      el.tdFBid.textContent = isFinite(r.bidF) ? nf.format(r.bidF) : '‚Äî';
      el.tdSBid.textContent = isFinite(r.bidS) ? nf.format(r.bidS) : '‚Äî';
      el.tdFAsk.textContent = isFinite(r.askF) ? nf.format(r.askF) : '‚Äî';
      el.tdShort.innerHTML = isFinite(r.shortPct) ? `<span class="${sh?'pctPos':''}">${pctStr(r.shortPct)}</span>` : '‚Äî';
      el.tdLong .innerHTML = isFinite(r.longPct)  ? `<span class="${lo?'pctPos':''}">${pctStr(r.longPct)}</span>`  : '‚Äî';

      any=true;
      await maybeBot(spotSym, r);
    }
  }
  $('#emptyNote').style.display = S.coins.size===0 || !any ? '' : 'none';

  const top=$('#topCard');
  if(!S.ui.showTop || S.coins.size===0){ top.classList.add('hidden'); }
  else{
    let best=null;
    for(const sym of S.coins){
      const r = cmpFor(sym); if(!r) continue;
      const thr = Number(S.ui.thresh)||0;
      const sh = isFinite(r.shortPct) && r.shortPct>0 && r.shortPct>=thr;
      const lo = isFinite(r.longPct)  && r.longPct>0  && r.longPct>=thr;
      if(sh || lo){
        const bestPct = Math.max(sh?r.shortPct:-Infinity, lo?r.longPct:-Infinity);
        if(!best || bestPct>best.bestPct) best={r, bestPct, isLong: bestPct===r.longPct};
      }
    }
    if(!best){ top.classList.add('hidden'); }
    else{
      const t=best.r; const isLong=best.isLong;
      $('#topSym').textContent = t.sym;
      $('#topSide').textContent = isLong ? 'FUTURES LONG' : 'FUTURES SHORT';
      $('#topSide').className = 'pill ' + (isLong ? 'good' : 'bad');
      $('#topDesc').textContent = isLong
        ? `Spot BID ${nf.format(t.bidS)} ‚Üî Fut ASK ${nf.format(t.askF)}`
        : `Spot ASK ${nf.format(t.askS)} ‚Üî Fut BID ${nf.format(t.bidF)}`;
      const pctEl = $('#topPct'); pctEl.textContent = pctStr(best.bestPct); pctEl.className='mono good';
      if(!S.lastTop || S.lastTop.sym!==t.sym || S.lastTop.side!==(isLong?'L':'S') || Math.abs(S.lastTop.pct-best.bestPct)>0.0005){
        top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 220);
        S.lastTop = {sym:t.sym, side:isLong?'L':'S', pct:best.bestPct};
      }
      top.classList.remove('hidden');
    }
  }
  $('#clock').textContent = now();
}

/*** ===== Bekleme iptali ===== ***/
function cancelWaiting(spotSym){
  if(!S.active.has(spotSym)){ botLog(`‚Ñπ ${spotSym}: aktif bekleme yok.`); return; }
  S.active.delete(spotSym);
  S.blockedUntil.set(spotSym, Date.now()+CANCEL_BLOCK_MS);
  botLog(`üõë ${spotSym}: Bekleme iptal edildi, ${CANCEL_BLOCK_MS/1000}s blok.`);
  updateStatusUI(spotSym);
}

/*** ===== SPOT & FUT: imza/fetch (proxy) ===== ***/
async function hmac256Hex(key, msg){
  const ckey = await crypto.subtle.importKey('raw', new TextEncoder().encode(key), {name:'HMAC',hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', ckey, new TextEncoder().encode(msg));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function proxyFetch({url, method='GET', headers={}, body=null}){
  const target = (S.bot.proxy||'').endsWith('/')? S.bot.proxy.slice(0,-1) : (S.bot.proxy||'');
  if(!target) throw new Error('Proxy gerekli');
  const h={'Content-Type':'application/json'}; if(S.bot.proxyToken) h['x-proxy-token']=S.bot.proxyToken;
  const res = await fetch(target, { method:'POST', headers:h, body:JSON.stringify({ url, method, headers, body }) });
  if(!res.ok) throw new Error(`Proxy ${res.status}: ${await res.text()}`);
  const ct = res.headers.get('content-type')||'';
  return ct.includes('application/json') ? res.json() : res.text();
}

/*** ===== SPOT private ===== ***/
const SPOT_API = 'https://api.mexc.com';
function spotCreds(){ return { key:S.bot.spotKey || S.bot.futKey, sec:S.bot.spotSec || S.bot.futSec }; }
async function spotSigned({path, method='GET', qs={}, body=null}){
  const {key, sec} = spotCreds();
  const ts = Date.now();
  const params = new URLSearchParams(Object.entries({...qs, timestamp:ts})).toString();
  const sig = await hmac256Hex(sec, params + (body||''));
  const url = `${SPOT_API}${path}?${params}&signature=${sig}`;
  const headers = { 'X-MEXC-APIKEY': key, 'Content-Type':'application/json', 'Accept':'application/json' };
  return proxyFetch({ url, method, headers, body });
}
async function spotExchangeInfo(symbols){
  const u = `${SPOT_API}/api/v3/exchangeInfo?symbols=${symbols.join(',')}`;
  const f = await fetch(u); const j = await f.json();
  const arr = Array.isArray(j.symbols)? j.symbols : (j.data||[]);
  arr.forEach(s=>{
    S.meta.spot.set(s.symbol, {
      base: s.baseAsset, quote: s.quoteAsset,
      baseStep: parseFloat(s.baseSizePrecision||'0'), // step size
      minQuote: parseFloat(s.quoteAmountPrecision||'0'), // min quote amt
      baseDecimals: parseInt(s.baseAssetPrecision||'6',10)
    });
  });
}

/*** ===== FUTURES private ===== ***/
const FUT_API = 'https://contract.mexc.com';
function futCreds(){ return { key:S.bot.futKey || S.bot.spotKey, sec:S.bot.futSec || S.bot.spotSec }; }
async function futSigned({path, method='GET', params=null, bodyObj=null}){
  const {key, sec} = futCreds();
  const reqTime = String(Date.now());
  let requestParam = '';
  let body = '';
  if(method==='GET' || method==='DELETE'){
    if(params && Object.keys(params).length){
      // s√∂zl√ºk sƒ±ralƒ± & URL-encode
      const entries = Object.entries(params).filter(([_,v])=>v!==undefined&&v!==null);
      entries.sort((a,b)=> a[0]<b[0]?-1:1);
      requestParam = entries.map(([k,v])=> `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`).join('&');
    }
  } else if(bodyObj){
    body = JSON.stringify(bodyObj);
    requestParam = body; // futures POST: JSON string imzaya girer
  }
  const signStr = (S.bot.futKey||'') + reqTime + requestParam;
  const signature = await hmac256Hex(sec, signStr);
  let url = `${FUT_API}${path}`;
  if(requestParam && (method==='GET' || method==='DELETE')) url += `?${requestParam}`;
  const headers = { 'ApiKey': key, 'Request-Time': reqTime, 'Signature': signature, 'Content-Type':'application/json', 'Accept':'application/json' };
  return proxyFetch({ url, method, headers, body: body||null });
}
async function getContractMeta(futSym){
  if(S.meta.fut.has(futSym)) return S.meta.fut.get(futSym);
  const url = `${FUT_API}/api/v1/contract/detail?symbol=${encodeURIComponent(futSym)}`;
  const f = await fetch(url); const j = await f.json();
  let rec = null;
  if(j && j.data && Array.isArray(j.data)) rec = j.data.find(x=>x.symbol===futSym) || j.data[0];
  const m = {
    contractSize: Number(rec?.contractSize||1),
    volUnit: Number(rec?.volUnit||1),
    minVol: Number(rec?.minVol||1),
    maxVol: Number(rec?.maxVol||5_000_000),
    volScale: Number(rec?.volScale||0),
    priceUnit: Number(rec?.priceUnit||0.5)
  };
  S.meta.fut.set(futSym, m); return m;
}

/*** ===== Bot tetik ===== ***/
function isLocked(sym){ return !!S.locks.get(sym); }
function lock(sym){ S.locks.set(sym, true); updateStatusUI(sym); }
function unlock(sym){ S.locks.delete(sym); updateStatusUI(sym); }

async function maybeBot(spotSym, r){
  if(!S.bot.enabled || isLocked(spotSym)) return;

  const openRef  = S.bot.useTableThresh ? S.ui.thresh : S.bot.openThresh;
  const closeRef = S.bot.closeThresh;

  const shortOK = isFinite(r.shortPct) && r.shortPct>=openRef && r.shortPct>0;
  const longOK  = isFinite(r.longPct)  && r.longPct>=closeRef && r.longPct>0;

  const hasActive = S.active.has(spotSym);
  const blockUntil = S.blockedUntil.get(spotSym) || 0;
  const isBlocked = Date.now() < blockUntil;

  if(longOK && hasActive){
    lock(spotSym);
    try{ await closePairFull(spotSym, r); } finally{ unlock(spotSym); }
    return;
  }
  if(shortOK && !hasActive && !isBlocked){
    const last = S.bot.lastExecBySym.get(spotSym) || 0;
    if(Date.now() - last >= S.bot.cooldown*1000){
      lock(spotSym);
      try{ await openPairEqualNotional(spotSym, r); } finally{ unlock(spotSym); }
    }
  }
}

/*** ===== A√ßƒ±lƒ±≈ü: E≈ûƒ∞T NOTIONAL iki bacak ===== ***/
async function openPairEqualNotional(spotSym, r){
  S.bot.lastExecBySym.set(spotSym, Date.now());
  const ask = r?.askS||0, bidF=r?.bidF||0;
  const futSym = futOf(spotSym);
  if(!(ask>0 && bidF>0)){ botLog(`‚è© [OPEN] ${spotSym} fiyat eksik (ask/bidF)`); return; }

  const N = S.bot.notional; // USDT
  botLog(`‚è© [OPEN] ${spotSym} hedef N=${N} USDT | Fiyat: spotAsk=${fmtPx(ask)} futBid=${fmtPx(bidF)} | fark=${pctStr(r.shortPct)}`);

  if(S.bot.dry){
    S.active.set(spotSym, { openedAt: Date.now(), targetN: N });
    updateStatusUI(spotSym);
    botLog(`(dry-run) ‚Üí iki bacak sim√ºle (e≈üit notional)`);
    return;
  }

  // Futures ayar (kaldƒ±ra√ß/marjin) ‚Äî MEXC: change_leverage gerekiyor (position yoksa openType + symbol + positionType)
  try{
    await futSigned({ path:'/api/v1/private/position/change_leverage', method:'POST',
      bodyObj:{ openType: (S.bot.margin==='cross')?2:1, leverage: S.bot.lev, symbol: futSym, positionType: 2 } // 2: short
    });
  }catch(_){}

  // Futures: vol hesapla (IOC short @ bid1)
  const m = await getContractMeta(futSym);
  const per = m.contractSize>0 ? m.contractSize : 1;
  let vol = N / (per * bidF);
  // adƒ±m/limit
  vol = Math.ceil(vol / (m.volUnit||1)) * (m.volUnit||1);
  if(m.volScale>0){ const step = Math.pow(10, -m.volScale); vol = Math.ceil(vol/step)*step; }
  vol = Math.max(m.minVol||1, Math.min(vol, m.maxVol||5_000_000));
  vol = Math.floor(vol); if(!(vol>0)) vol = m.minVol||1;

  const futBody = {
    symbol: futSym, price: fmtPx(bidF),
    vol, leverage: S.bot.lev,
    side: 3, // open short
    type: 3, // IOC
    openType: (S.bot.margin==='cross')?2:1
  };

  // Spot: miktar ‚âà N / price ‚Üí adƒ±m/min quote d√ºzelt
  const sm = await getSpotPairMeta(spotSym);
  let amt = N / ask;
  amt = roundDown(amt, sm.baseStep || Math.pow(10, - (sm.baseDecimals||6)));
  if(sm.minQuote && amt*ask < sm.minQuote){
    const need = sm.minQuote/ask;
    amt = roundDown(need, sm.baseStep || Math.pow(10, - (sm.baseDecimals||6)));
  }
  if(!(amt>0)) amt = sm.baseStep || Math.pow(10, - (sm.baseDecimals||6));

  const spotBody = new URLSearchParams({
    symbol: spotSym, side:'BUY', type:'LIMIT',
    quantity: String(amt), price: fmtPx(ask), timeInForce:'IOC', recvWindow:'60000'
  }).toString();

  // Paralel dene
  const futP = futSigned({ path:'/api/v1/private/order/submit', method:'POST', bodyObj:futBody });
  const spotP = spotSigned({ path:'/api/v3/order', method:'POST', qs:{}, body: spotBody });

  const [futRes, spotRes] = await Promise.allSettled([futP, spotP]);

  let futOk=false, spotOk=false;
  if(futRes.status==='fulfilled'){ futOk=true; botLog(`‚úÖ Futures SHORT IOC OK: id=${futRes.value?.data||'‚Äî'} | vol=${vol} | N‚âà${(vol*per*bidF).toFixed(4)}`); }
  else botLog(`‚ùå Futures hata [OPEN]: ${futRes.reason?.message||String(futRes.reason)}`);

  if(spotRes.status==='fulfilled'){ spotOk=true; botLog(`‚úÖ Spot BUY IOC OK: ${spotRes.value?.orderId||'‚Äî'} | qty‚âà${roundTo(amt,6)} | N‚âà${(amt*ask).toFixed(4)}`); }
  else botLog(`‚ùå Spot hata [OPEN]: ${spotRes.reason?.message||String(spotRes.reason)}`);

  if(futOk && spotOk){
    S.active.set(spotSym, { openedAt: Date.now(), targetN: N });
    updateStatusUI(spotSym);
    botLog(`üìå [OPEN] ${spotSym} AKTƒ∞F (e≈üit notional). LONG sinyalde tam kapanƒ±≈ü bekleniyor.`);
  } else {
    // Fail-safe
    if(futOk && !spotOk){
      botLog(`‚Ü© Fail-safe: Spot FAIL ‚Üí futures short‚Äôu kapat`);
      try{ await closeFuturesShortIOC(futSym, r.askF||bidF); botLog(`‚úÖ Fail-safe futures kapandƒ±`); }catch(e){ botLog(`üí• Fail-safe fut close hata: ${e?.message||e}`); }
    }
    if(!futOk && spotOk){
      botLog(`‚Ü© Fail-safe: Futures FAIL ‚Üí spot‚Äôu sat`);
      try{ await placeSpotSellLimitAllIOC(spotSym, r.bidS||ask); botLog(`‚úÖ Fail-safe spot satƒ±ldƒ±`); }catch(e){ botLog(`üí• Fail-safe spot close hata: ${e?.message||e}`); }
    }
  }
}

/*** ===== Kapanƒ±≈ü: LONG sinyali ‚Üí tam kapanƒ±≈ü ===== ***/
async function closePairFull(spotSym, r){
  const futSym = futOf(spotSym);
  const askF=r?.askF||0, bidS=r?.bidS||0;
  if(!(askF>0 && bidS>0)){ botLog(`‚èπ [CLOSE] ${spotSym} fiyat eksik`); return; }

  botLog(`‚èπ [CLOSE] ${spotSym} ‚Üí fut BUY (close short) IOC @${fmtPx(askF)} + spot SELL ALL IOC @${fmtPx(bidS)} | fark=${pctStr(r.longPct)}`);

  if(S.bot.dry){
    S.active.delete(spotSym); updateStatusUI(spotSym);
    botLog(`(dry-run) ‚Üí t√ºm pozisyon varsayƒ±msal kapatƒ±ldƒ±`);
    return;
  }

  const futP  = closeFuturesShortIOC(futSym, askF);
  const spotP = placeSpotSellLimitAllIOC(spotSym, bidS);
  const [futRes, spotRes] = await Promise.allSettled([futP, spotP]);

  let futOk=false, spotOk=false;
  if(futRes.status==='fulfilled'){ futOk=true; botLog(`‚úÖ Futures close OK: ${JSON.stringify(futRes.value)}`); }
  else botLog(`‚ùå Futures close hata: ${futRes.reason?.message||String(futRes.reason)}`);

  if(spotRes.status==='fulfilled'){ spotOk=true; botLog(`‚úÖ Spot SELL ALL OK: ${spotRes.value?.orderId||'‚Äî'}`); }
  else botLog(`‚ùå Spot SELL ALL hata: ${spotRes.reason?.message||String(spotRes.reason)}`);

  if(futOk || spotOk){
    S.active.delete(spotSym); updateStatusUI(spotSym);
    botLog(`üèÅ [DONE] ${spotSym} kapatma tamamlandƒ± (>=1 bacak ba≈üarƒ±)`);
  } else {
    botLog(`‚ö† [CLOSE] ${spotSym} iki bacak da ba≈üarƒ±sƒ±z oldu`);
  }
}

/*** ===== Futures yardƒ±mcƒ±lar ===== ***/
async function closeFuturesShortIOC(futSym, limitPx){
  // one-way mod i√ßin reduceOnly=true g√ºvenli; ayrƒ±ca side=2 (close short)
  return futSigned({ path:'/api/v1/private/order/submit', method:'POST', bodyObj:{
    symbol:futSym, price:fmtPx(limitPx), vol: 9_999_999, // b√ºy√ºk vol (IOC + reduceOnly ise sadece mevcut kadar doldurur)
    side:2, type:3, openType:(S.bot.margin==='cross')?2:1, reduceOnly:true
  }});
}

/*** ===== Spot yardƒ±mcƒ±lar ===== ***/
async function getSpotPairMeta(spotSym){
  if(S.meta.spot.has(spotSym)) return S.meta.spot.get(spotSym);
  await spotExchangeInfo([spotSym]);
  return S.meta.spot.get(spotSym) || { base:spotSym.replace('USDT',''), quote:'USDT', baseStep:0, minQuote:0, baseDecimals:6 };
}
async function getSpotAvailable(base){
  const j = await spotSigned({ path:'/api/v3/account', method:'GET', qs:{} });
  const arr = j?.balances||[];
  const rec = arr.find(x => (x.asset||'').toUpperCase()===base.toUpperCase());
  return rec ? Number(rec.free||0) : 0;
}
async function placeSpotSellLimitAllIOC(spotSym, limitPx){
  const meta = await getSpotPairMeta(spotSym);
  let avail = await getSpotAvailable(meta.base);
  // adƒ±m & min d√ºzelt
  const step = meta.baseStep || Math.pow(10, -(meta.baseDecimals||6));
  avail = roundDown(avail, step);
  if(!(avail>0)) return { sold:0 };
  const body = new URLSearchParams({
    symbol: spotSym, side:'SELL', type:'LIMIT',
    quantity:String(avail), price:fmtPx(limitPx), timeInForce:'IOC', recvWindow:'60000'
  }).toString();
  return spotSigned({ path:'/api/v3/order', method:'POST', qs:{}, body });
}

/*** ===== Start ===== ***/
function start(){
  $('#themeSel').value = S.ui.theme;
  $('#proxyUrl').value = S.bot.proxy;
  $('#proxyToken').value = S.bot.proxyToken || '';
  $('#botOpenThresh').value = String(S.bot.openThresh);
  $('#botCloseThresh').value = String(S.bot.closeThresh);
  $('#botNotional').value = String(S.bot.notional);
  $('#botLev').value = String(S.bot.lev);
  $('#botMargin').value = S.bot.margin;
  $('#botCooldown').value = String(S.bot.cooldown);

  S.coins.forEach(sym=> ensureRow(sym));
  wsFutConnect();
  startSpotLoop();

  $('#clock').textContent = now();
  scheduleDraw();
}
start();
</script>
</body>
</html>
