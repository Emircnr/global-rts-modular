<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gate.io USDT‑M Futures — MA Channel Bot (Tek Dosya, Gizli Ayarlı)</title>
  <style>
    :root{
      --bg:#0b0f19; --fg:#e6eef7; --muted:#9fb0c9;
      --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
      --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:15px; --maxW:1280px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--sans);font-size:var(--font)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:var(--maxW);margin:30px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 14px}
    .sub{color:var(--muted);margin-bottom:24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{grid-column: span 12;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:var(--padY) var(--padX);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    @media(min-width:900px){.col6{grid-column:span 6}.col4{grid-column:span 4}.col8{grid-column:span 8}.col3{grid-column:span 3}.col9{grid-column:span 9}}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{color:var(--muted);font-size:13px;margin-right:6px}
    input,select,button,textarea{background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--fg);border-radius:12px;padding:10px 12px;font-size:14px;font-family:var(--sans)}
    input[type="password"]{letter-spacing:1px}
    input::placeholder,textarea::placeholder{color:#8aa0bf}
    textarea{width:100%;min-height:90px;resize:vertical}
    button{cursor:pointer;background:linear-gradient(180deg,#1a2a4a,#15223e);border-color:#22345c}
    .btn{padding:10px 14px;border-radius:12px}
    .btn.primary{background:linear-gradient(180deg,#2a5b99,#214c82);border-color:#2b6dbb}
    .btn.green{background:linear-gradient(180deg,#1e7a3a,#17602d);border-color:#2b8f4a}
    .btn.red{background:linear-gradient(180deg,#8a1b1b,#6e1313);border-color:#a22a2a}
    .btn.yellow{background:linear-gradient(180deg,#a46f12,#8d5d0e);border-color:#c7871f}
    .tiny{font-size:12px;color:var(--muted)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{appearance:none;width:42px;height:24px;background:#223;position:relative;border-radius:999px;outline:none;border:1px solid var(--border)}
    .switch input:checked{background:#24476b}
    .switch input:before{content:"";position:absolute;width:18px;height:18px;border-radius:50%;left:3px;top:2.5px;background:#cad7ee;transition:.2s}
    .switch input:checked:before{left:21px}
    .k{font-family:var(--mono);font-size:12px;background:rgba(255,255,255,.05);padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{color:#a9bdd9;text-align:left;font-weight:600;font-size:13px;padding:6px 8px}
    .table td{padding:10px 8px;background:#0e1322;border-top:1px solid #17223e;border-bottom:1px solid #17223e}
    .table tr td:first-child{border-left:1px solid #17223e;border-top-left-radius:10px;border-bottom-left-radius:10px}
    .table tr td:last-child{border-right:1px solid #17223e;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .pill.ok{background:rgba(34,197,94,.08);color:#6be39c;border-color:#245437}
    .pill.bad{background:rgba(239,68,68,.1);color:#ff8d8d;border-color:#5b2323}
    .pill.warn{background:rgba(245,158,11,.1);color:#ffd27a;border-color:#5b431d}
    .mono{font-family:var(--mono)}
    pre.log{background:#0d1322;border:1px solid var(--border);border-radius:12px;padding:12px;max-height:380px;overflow:auto;font-family:var(--mono);font-size:12px;line-height:1.45}
    .hint{color:#9fb0c9}
    .section-title{font-size:16px;margin:4px 0 10px;color:#bcd0ee}
    .row .grow{flex:1}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .tag{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:8px;color:#9fb0c9}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0e162b;border:1px solid var(--border);border-radius:999px}
    .chip .x{background:transparent;border:none;color:#9fb0c9;font-size:14px;cursor:pointer}
    .chip .x:hover{color:#ff9b9b}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gate.io USDT‑M Futures — MA Channel Bot</h1>
    <div class="sub">Tek dosya (HTML+CSS+JS). Firestore canlı sinyal (⚠️ <span class="k">config arkaplanda kayıtlı</span>). Proxy (⚠️ <span class="k">arkaplanda</span>) ile <span class="k">/api/v4</span> imzalı emir. Strateji: kanal içinde üst banda <span class="pill ok">LONG</span>, alt banda <span class="pill bad">SHORT</span>. Dolan karşıda <span class="pill warn">reduce‑only STOP</span> mid’i takip eder.</div>

    <div class="grid">
      <!-- Gate.io Bağlantı (Proxy ayarları gizli) -->
      <div class="card col6">
        <div class="section-title">Gate.io Bağlantı</div>
        <div class="row" style="gap:12px">
          <label>Çevre</label>
          <label class="switch"><input id="envTestnet" type="checkbox"/><span>Testnet</span></label>
          <span class="hint">Proxy & host arkaplanda saklanır. İstek yolu: <span class="k">BASE + /api/v4/...</span></span>
        </div>
        <div class="sep"></div>
        <div class="row" style="gap:8px">
          <label style="width:150px">API Key</label>
          <input id="apiKey" class="grow" placeholder="KEY"/>
        </div>
        <div class="row" style="margin-top:8px;gap:8px">
          <label style="width:150px">API Secret</label>
          <input id="apiSecret" type="password" class="grow" placeholder="SECRET"/>
        </div>
        <div class="row" style="margin-top:10px;gap:10px">
          <label class="switch"><input id="rememberKeys" type="checkbox"/><span>Key/Secret localStorage’a kaydet</span></label>
        </div>
        <div class="row" style="margin-top:12px;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnSaveConn">Kaydet</button>
          <button class="btn" id="btnLoadConn">Yükle</button>
          <button class="btn primary" id="btnTime">Sunucu Saati Test</button>
          <span class="tiny">GET <span class="k">/api/v4/spot/time</span></span>
        </div>
      </div>

      <!-- Firestore (config gizli) -->
      <div class="card col6">
        <div class="section-title">Firestore — Canlı Sinyal (Config gizli, sadece kaynak & alan adları)</div>
        <div class="row" style="gap:14px;flex-wrap:wrap">
          <label>Kaynak tipi:</label>
          <label class="switch"><input id="srcDoc" type="radio" name="srcType" checked/><span>Doc pattern</span></label>
          <label class="switch"><input id="srcCol" type="radio" name="srcType"/><span>Collection latest</span></label>
        </div>
        <div class="row" style="margin-top:8px;gap:8px">
          <label style="width:160px">Yol</label>
          <input id="fb_path" class="grow" placeholder="signals/{symbol}" value="signals/{symbol}"/>
        </div>
        <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
          <label>Alanlar:</label>
          <label>upper</label><input id="f_upper" value="upper" style="width:110px"/>
          <label>lower</label><input id="f_lower" value="lower" style="width:110px"/>
          <label>mid</label><input id="f_mid" value="mid" style="width:110px"/>
          <label>close</label><input id="f_close" value="close" style="width:110px"/>
          <label>symbol</label><input id="f_symbol" value="symbol" style="width:140px"/>
          <label>ts_ms</label><input id="f_ts" value="ts_ms" style="width:140px"/>
        </div>
        <div class="row" style="margin-top:12px;gap:10px;flex-wrap:wrap">
          <button class="btn green" id="btnFbConnect">Bağlan</button>
          <span class="tiny">Config arkaplandan yüklenecek.</span>
        </div>
      </div>

      <!-- Strateji & Emir -->
      <div class="card col12">
        <div class="section-title">Strateji & Emir</div>
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <label>Settle</label>
          <input id="settle" value="usdt" style="width:100px"/>
          <label>Kaldıraç</label>
          <input id="leverage" value="10" style="width:90px"/>
          <button class="btn" id="btnSetLeverage">Ayarla</button>
          <label>Tutar (USDT)</label>
          <input id="usdtAmount" value="50" style="width:120px"/>
          <label>Hz</label>
          <select id="hz" style="width:120px">
            <option value="0.5">0.5 Hz</option>
            <option value="1" selected>1 Hz</option>
            <option value="1.5">1.5 Hz</option>
            <option value="2">2 Hz</option>
          </select>
          <label>Coinler</label>
          <input id="coins" type="hidden" value="BTCUSDT,ETHUSDT"/>
          <input id="coinInput" placeholder="BTCUSDT" style="width:160px"/>
          <button class="btn" id="btnAddCoin">Ekle</button>
          <div id="coinChips" class="chips"></div>
          <label class="switch"><input id="optReduce" type="checkbox" checked/><span>Reduce‑only STOP</span></label>
          <label class="switch"><input id="dryRun" type="checkbox"/><span>Dry‑run</span></label>
        </div>
        <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
          <button class="btn green" id="btnStart">Başlat</button>
          <button class="btn red" id="btnStop">Durdur</button>
          <button class="btn yellow" id="btnCancelAll">Seçili coinlerde tüm açık emirleri iptal</button>
        </div>
      </div>

      <!-- Durum Tablosu -->
      <div class="card col12">
        <div class="section-title">Durum</div>
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Kontrat</th>
              <th>Close</th>
              <th>Lower</th>
              <th>Upper</th>
              <th>İçeride mi?</th>
              <th>LongID</th>
              <th>ShortID</th>
              <th>StopID</th>
              <th>Pozisyon</th>
              <th>TS</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- Log -->
      <div class="card col12">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="section-title">Log</div>
          <div class="row" style="gap:8px">
            <button class="btn" id="btnClearLog">Temizle</button>
            <span class="tiny">İmza stringleri ve Gate yanıtları burada. (Gizli ayarlar log’a dökülmez)</span>
          </div>
        </div>
        <pre class="log" id="log"></pre>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  // =============================
  // HIDDEN CONFIG (Proxy + Firebase) — Arkaplanda saklanır
  // =============================
  const HIDDEN_KEY = 'hiddenCfg_v1';
  const DEFAULT_HIDDEN = {
    useProxy: true,
    proxyBase: 'http://localhost:8787',
    directHost: 'https://api.gateio.ws',
    firebase: {
      apiKey: 'AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To',
      authDomain: 'macbot-b7b45.firebaseapp.com',
      databaseURL: 'https://macbot-b7b45-default-rtdb.firebaseio.com',
      projectId: 'macbot-b7b45',
      storageBucket: 'macbot-b7b45.firebasestorage.app',
      messagingSenderId: '88494187419',
      appId: '1:88494187419:web:9e0fd1a37e51332203373e',
      measurementId: 'G-SVG851WK7Y'
    }
  };
  function loadHiddenCfg(){
    try{ const j = localStorage.getItem(HIDDEN_KEY); if(j){ return JSON.parse(j); } }catch(e){}
    localStorage.setItem(HIDDEN_KEY, JSON.stringify(DEFAULT_HIDDEN));
    return JSON.parse(JSON.stringify(DEFAULT_HIDDEN));
  }
  function saveHiddenCfg(cfg){ localStorage.setItem(HIDDEN_KEY, JSON.stringify(cfg)); }
  // Konsoldan düzenlemek için yardımcılar (UI'da görünmez)
  window.__hiddenCfg = () => JSON.parse(localStorage.getItem(HIDDEN_KEY)||'{}');
  window.__setHiddenCfg = (partial) => { const cur = loadHiddenCfg(); const next = {...cur, ...partial}; saveHiddenCfg(next); console.log('hiddenCfg updated'); return next; };

  const HIDDEN = loadHiddenCfg();

  // =============================
  // Util — UI & Logging
  // =============================
  const $ = sel => document.querySelector(sel);
  const logEl = $('#log');
  function log(obj, level='info'){
    const ts = new Date().toISOString();
    const line = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    const prefix = level.toUpperCase();
    logEl.textContent = `[${ts}] [${prefix}]
` + line + "

" + logEl.textContent;
  }
  $('#btnClearLog').onclick = () => { logEl.textContent = ''; };

  // =============================
  // Persist (localStorage) — sadece Key/Secret
  // =============================
  function saveConn(){
    const data = {
      envTestnet: $('#envTestnet').checked,
      rememberKeys: $('#rememberKeys').checked,
    };
    if($('#rememberKeys').checked){
      data.apiKey = $('#apiKey').value;
      data.apiSecret = $('#apiSecret').value;
    }
    localStorage.setItem('conn', JSON.stringify(data));
    log({msg:'Bağlantı ayarları kaydedildi'});
  }
  function loadConn(){
    const raw = localStorage.getItem('conn');
    if(!raw){ log('Kayıtlı bağlantı bulunamadı'); return; }
    const d = JSON.parse(raw);
    $('#envTestnet').checked = !!d.envTestnet;
    $('#rememberKeys').checked = !!d.rememberKeys;
    if(d.rememberKeys){
      $('#apiKey').value = d.apiKey || '';
      $('#apiSecret').value = d.apiSecret || '';
    }
    log('Bağlantı ayarları yüklendi');
  }
  $('#btnSaveConn').onclick = saveConn;
  $('#btnLoadConn').onclick = loadConn;

  // =============================
  // Crypto helpers — SHA512 / HMAC‑SHA512 (hex)
  // =============================
  function encUtf8(str){ return new TextEncoder().encode(str); }
  function buf2hex(buffer){ const b = new Uint8Array(buffer); let s=''; for(let i=0;i<b.length;i++){ s+=b[i].toString(16).padStart(2,'0'); } return s; }
  async function sha512Hex(str){ const h = await crypto.subtle.digest('SHA-512', encUtf8(str)); return buf2hex(h); }
  async function hmacSha512Hex(key, msg){ const k = await crypto.subtle.importKey('raw', encUtf8(key), {name:'HMAC', hash:'SHA-512'}, false, ['sign']); const sig = await crypto.subtle.sign('HMAC', k, encUtf8(msg)); return buf2hex(sig); }

  // =============================
  // Gate API — signer + fetch
  // =============================
  function buildQS(params){ if(!params) return ''; const entries = Object.entries(params).filter(([k,v])=> v!==undefined && v!==null && v!==''); if(entries.length===0) return ''; entries.sort((a,b)=> a[0].localeCompare(b[0])); return entries.map(([k,v])=> encodeURIComponent(k)+'='+encodeURIComponent(String(v))).join('&'); }
  function symbolToContract(sym){ const s=(sym||'').toUpperCase().replace(/[^A-Z0-9_]/g,''); if(s.endsWith('USDT') && !s.includes('_')){ return s.replace('USDT','') + '_USDT'; } return s; }
  function decimalsFromStep(step){ const t=String(step); const idx=t.indexOf('.'); return idx===-1?0:(t.length-idx-1); }
  function floorToInc(x, inc){ const f=Number(inc); if(!isFinite(f)||f<=0) return x; const n=Math.floor(x/f)*f; const d=decimalsFromStep(inc); return Number(n.toFixed(d)); }
  function roundToTick(x, tick){ const t=Number(tick); if(!isFinite(t)||t<=0) return x; const n=Math.round(x/t)*t; const d=decimalsFromStep(tick); return Number(n.toFixed(d)); }

  class Gate {
    constructor(getBase, getKey, getSecret){ this.getBase=getBase; this.getKey=getKey; this.getSecret=getSecret; }
    async req(method, path, params={}, bodyObj=null, forceUnsigned=false){
      const base = this.getBase();
      const qs = buildQS(params);
      const url = base + path + (qs? ('?'+qs):'');
      const ts = Math.floor(Date.now()/1000).toString();
      const bodyStr = bodyObj? JSON.stringify(bodyObj): '';
      const headers = {'Accept':'application/json','Content-Type':'application/json'};
      const key = this.getKey(); const secret = this.getSecret();
      const shouldSign = !!(key && secret) && !forceUnsigned;
      let sigStr=null; let bodyHex=null; let signHex=null;
      if(shouldSign){
        bodyHex = await sha512Hex(bodyStr);
        sigStr = [method.toUpperCase(), path, qs, bodyHex, ts].join('
');
        signHex = await hmacSha512Hex(secret, sigStr);
        headers.KEY = key; headers.Timestamp = ts; headers.SIGN = signHex;
      }
      const infoForLog = {method, url, path, qs, body: bodyObj, timestamp: ts, signature_string: sigStr};
      log({send: infoForLog});
      if($('#dryRun').checked){ return {ok:true,status:200,json:{dry:true}}; }
      const res = await fetch(url, {method, headers, body: bodyStr || undefined});
      let data=null; try{ data=await res.json(); }catch(e){ data={text: await res.text().catch(()=> res.statusText)} }
      if(!res.ok){ log({error:'Gate hata', status: res.status, data}); } else { log({recv: data}); }
      return {ok:res.ok, status:res.status, json:data};
    }
    get(path, params={}, forceUnsigned=false){ return this.req('GET', path, params, null, forceUnsigned); }
    post(path, bodyObj={}, params={}){ return this.req('POST', path, params, bodyObj); }
    del(path, params={}){ return this.req('DELETE', path, params, null); }
  }

  // =============================
  // Bot State
  // =============================
  const state = {
    listeners: {}, // symbol -> unsubscribe
    coins: {},     // contract -> per-coin state
    coinSymbols: [],
    running: false,
    loopTimer: null,
    gate: new Gate(() => {
      const base = HIDDEN.useProxy ? HIDDEN.proxyBase : HIDDEN.directHost;
      const testnet = $('#envTestnet').checked; return base + (testnet? '/testnet': '');
    }, () => $('#apiKey').value.trim(), () => $('#apiSecret').value.trim()),
  };

  function ensureCoin(contract){
    if(!state.coins[contract]){
      state.coins[contract] = {
        contract,
        tick_size: null, order_size_increment: null, quanto_multiplier: null,
        priceDec: 8, sizeInc: 1, busy: false,
        close: null, lower:null, upper:null, mid:null, ts:null, inside:false,
        long:null, short:null, stop:null, posSize:0, lastStopPx:null,
      };
    }
    return state.coins[contract];
  }

  function renderTable(){
    const tbody = $('#tbody'); tbody.innerHTML='';
    Object.values(state.coins).forEach(c => {
      const tr=document.createElement('tr'); const inside=c.inside? '<span class="pill ok">Evet</span>':'<span class="pill bad">Hayır</span>';
      const ts=c.ts? new Date(c.ts).toLocaleTimeString(): '-';
      tr.innerHTML = `
        <td class="mono">${c.contract}</td>
        <td class="mono">${fmtNum(c.close)}</td>
        <td class="mono">${fmtNum(c.lower)}</td>
        <td class="mono">${fmtNum(c.upper)}</td>
        <td>${inside}</td>
        <td class="mono">${c.long?.id||''}</td>
        <td class="mono">${c.short?.id||''}</td>
        <td class="mono">${c.stop?.id||''}</td>
        <td class="mono">${c.posSize}</td>
        <td class="mono">${ts}</td>`;
      tbody.appendChild(tr);
    });
  }
  function fmtNum(x){ return (x===null || x===undefined) ? '-' : Number(x).toString(); }

  // === Coin chips UI ===
  const coinChipsEl = document.getElementById('coinChips');
  function normalizeSym(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9_]/g,''); }
  function updateHiddenCoins(){ document.getElementById('coins').value = state.coinSymbols.join(','); }
  function renderCoinChips(){ if(!coinChipsEl) return; coinChipsEl.innerHTML=''; state.coinSymbols.forEach(sym=>{ const chip=document.createElement('span'); chip.className='chip'; chip.innerHTML = '<span class="mono">'+sym+'</span> <button class="x" title="Kaldır">×</button>'; chip.querySelector('.x').onclick=()=> removeCoinSymbol(sym); coinChipsEl.appendChild(chip); }); updateHiddenCoins(); }
  function addCoinSymbol(sym){ sym=normalizeSym(sym); if(!sym) return; if(state.coinSymbols.includes(sym)) { log({msg:'Coin zaten listede', sym}); return; } state.coinSymbols.push(sym); ensureCoin(symbolToContract(sym)); renderCoinChips(); renderTable(); if(fbDb){ const f = getFieldsConfig(); const {useDoc, path} = getFirebaseSrc(); attachListenerFor(sym, f, useDoc, path); } }
  function removeCoinSymbol(sym){ const i = state.coinSymbols.indexOf(sym); if(i>=0){ state.coinSymbols.splice(i,1); } if(state.listeners[sym]){ try{ state.listeners[sym](); }catch(e){} delete state.listeners[sym]; } const cName = symbolToContract(sym); delete state.coins[cName]; renderCoinChips(); renderTable(); }
  document.getElementById('btnAddCoin').onclick = ()=> { const inp = document.getElementById('coinInput'); addCoinSymbol(inp.value.trim()); inp.value=''; inp.focus(); };
  document.getElementById('coinInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('btnAddCoin').click(); }});

  // =============================
  // Firestore — connect & listeners (config HIDDEN.firebase)
  // =============================
  let fbApp = null; let fbDb = null;
  function getFieldsConfig(){ return { upper: $('#f_upper').value.trim(), lower: $('#f_lower').value.trim(), mid: $('#f_mid').value.trim(), close: $('#f_close').value.trim(), symbol: $('#f_symbol').value.trim(), ts: $('#f_ts').value.trim(), }; }
  function getFirebaseSrc(){ const useDoc = $('#srcDoc').checked; const path = $('#fb_path').value.trim(); return {useDoc, path}; }
  function attachListenerFor(sym, f, useDoc, path){ const contract = symbolToContract(sym); ensureCoin(contract); if(state.listeners[sym]){ try{ state.listeners[sym](); }catch(e){} } if(useDoc){ const realPath = path.replace('{symbol}', sym); state.listeners[sym] = fbDb.doc(realPath).onSnapshot(snap => { if(!snap.exists){ log({warn:`Doc yok: ${realPath}`}); return; } const d = snap.data(); applySignal(sym, contract, d, f); }); log({msg:'Doc dinleniyor', sym, path: realPath}); } else { const q = fbDb.collection(path).where(f.symbol,'==', sym).orderBy(f.ts,'desc').limit(1); state.listeners[sym] = q.onSnapshot(s => { s.forEach(doc=>{ const d = doc.data(); applySignal(sym, contract, d, f); }); }); log({msg:'Collection latest dinleniyor', sym, path}); } }

  async function connectFirebase(){
    if(fbApp){ log('Firestore zaten bağlı'); return; }
    const cfg = HIDDEN.firebase; // gizli konfig
    fbApp = firebase.initializeApp(cfg);
    fbDb = firebase.firestore();
    log({msg:'Firebase bağlandı', projectId: cfg.projectId, note:'Ayrıntılar gizli tutulur'});

    const coins = state.coinSymbols.slice();
    const f = getFieldsConfig();
    const {useDoc, path} = getFirebaseSrc();
    for(const sym of coins){ attachListenerFor(sym, f, useDoc, path); }
  }
  $('#btnFbConnect').onclick = connectFirebase;

  function applySignal(sym, contract, d, f){
    const c = ensureCoin(contract);
    const close = Number(d[f.close]);
    const lower = Number(d[f.lower]);
    const upper = Number(d[f.upper]);
    const mid = Number(d[f.mid]);
    const ts = Number(d[f.ts]);
    if([close,lower,upper,mid].some(n => !isFinite(n))){ log({warn:'Geçersiz sinyal değerleri', sym, d}); return; }
    c.close = close; c.lower=lower; c.upper=upper; c.mid=mid; c.ts= ts || Date.now(); c.inside = (lower < close && close < upper);
    renderTable();
  }

  // =============================
  // Gate helpers — specs, orders, position
  // =============================
  async function fetchSpec(contract){
    const settle = $('#settle').value.trim();
    const r = await state.gate.get(`/api/v4/futures/${settle}/contracts/${encodeURIComponent(contract)}`);
    if(!r.ok){ return null; }
    const d = r.json; const c = ensureCoin(contract);
    c.tick_size = Number(d.tick_size); c.order_size_increment = Number(d.order_size_increment); c.quanto_multiplier = Number(d.quanto_multiplier || 1);
    c.priceDec = decimalsFromStep(d.tick_size); c.sizeInc = Number(d.order_size_increment);
    log({msg:'Spec yüklendi', contract, tick_size:c.tick_size, order_size_increment:c.order_size_increment, quanto_multiplier:c.quanto_multiplier});
    return d;
  }
  async function setLeverageFor(contract, lev){ const settle = $('#settle').value.trim(); return await state.gate.post(`/api/v4/futures/${settle}/positions/${encodeURIComponent(contract)}/leverage`, {}, { leverage: lev }); }
  async function getPosition(contract){ const settle = $('#settle').value.trim(); const r = await state.gate.get(`/api/v4/futures/${settle}/positions/${encodeURIComponent(contract)}`); if(!r.ok){ return null; } return r.json; }
  async function listOpenOrders(contract){ const settle = $('#settle').value.trim(); const r = await state.gate.get(`/api/v4/futures/${settle}/orders`, {contract, status:'open'}); return r.ok ? r.json : []; }
  async function cancelAll(contract){ const settle = $('#settle').value.trim(); const r = await state.gate.del(`/api/v4/futures/${settle}/orders`, {contract}); return r.ok; }
  async function cancelById(id){ if(!id) return false; const settle = $('#settle').value.trim(); const r = await state.gate.del(`/api/v4/futures/${settle}/orders/${encodeURIComponent(id)}`); return r.ok; }
  async function placeLimit(contract, size, price, reduceOnly=false, tif='gtc', text=''){ const settle = $('#settle').value.trim(); const body = {contract, size: Number(size), price: Number(price), reduce_only: !!reduceOnly, tif, text}; const r = await state.gate.post(`/api/v4/futures/${settle}/orders`, body); if(!r.ok){ return null; } return r.json; }

  // =============================
  // Sizing & rounding
  // =============================
  function calcSizeFromUSDT(c, usdt){ if(!c || !isFinite(c.close) || !isFinite(c.quanto_multiplier) || !isFinite(c.order_size_increment)) return 0; const baseQty = Number(usdt) / Number(c.close); const rawSize = baseQty / Number(c.quanto_multiplier || 1); const floored = floorToInc(rawSize, c.order_size_increment); return floored; }
  function roundPrice(c, px){ return roundToTick(px, c.tick_size || 0.01); }

  // =============================
  // Main loop per coin
  // =============================
  async function tickCoin(contract){
    const c = ensureCoin(contract); if(c.busy) return; c.busy = true;
    try{
      if(!c.tick_size || !c.order_size_increment || !c.quanto_multiplier){ await fetchSpec(contract); }
      const pos = await getPosition(contract); if(pos){ c.posSize = Number(pos.size || 0); }
      if(!isFinite(c.close) || !isFinite(c.lower) || !isFinite(c.upper) || !isFinite(c.mid)){ return; }
      c.inside = (c.lower < c.close && c.close < c.upper);

      const usdt = Number($('#usdtAmount').value || 0);
      const desiredSize = calcSizeFromUSDT(c, usdt);
      const longPx = roundPrice(c, c.upper); const shortPx = roundPrice(c, c.lower);

      if(c.posSize !== 0){
        if(c.long?.id){ await cancelById(c.long.id); c.long=null; }
        if(c.short?.id){ await cancelById(c.short.id); c.short=null; }
        if($('#optReduce').checked){
          const stopPx = roundPrice(c, c.mid);
          if(!c.stop || c.lastStopPx !== stopPx){
            if(c.stop?.id){ await cancelById(c.stop.id); c.stop=null; }
            const sideSize = Math.abs(c.posSize) * (c.posSize>0 ? -1 : 1);
            const placed = await placeLimit(contract, sideSize, stopPx, true, 'gtc', `stop-${Date.now()}`);
            if(placed){ c.stop = {id: placed.id, price: stopPx, size: sideSize}; c.lastStopPx = stopPx; }
          }
        }
        return; // pozisyondayken giriş emri yok
      }

      if(c.stop?.id){ await cancelById(c.stop.id); c.stop=null; c.lastStopPx=null; }
      if(!c.inside){ if(c.long?.id){ await cancelById(c.long.id); c.long=null; } if(c.short?.id){ await cancelById(c.short.id); c.short=null; } return; }
      if(!(desiredSize>0) || desiredSize < (c.order_size_increment||1)){ log({warn:'Size çok küçük, emir atlanıyor', contract, desiredSize}); if(c.long?.id){ await cancelById(c.long.id); c.long=null; } if(c.short?.id){ await cancelById(c.short.id); c.short=null; } return; }

      if(!c.long){ const placed = await placeLimit(contract, +desiredSize, longPx, false, 'gtc', `long-${Date.now()}`); if(placed){ c.long = {id: placed.id, price: longPx, size: +desiredSize}; } }
      else if( (c.long.price !== longPx) || (Number(c.long.size) !== Number(desiredSize)) ){ await cancelById(c.long.id); const placed = await placeLimit(contract, +desiredSize, longPx, false, 'gtc', `long-${Date.now()}`); if(placed){ c.long = {id: placed.id, price: longPx, size: +desiredSize}; } }

      if(!c.short){ const placed = await placeLimit(contract, -desiredSize, shortPx, false, 'gtc', `short-${Date.now()}`); if(placed){ c.short = {id: placed.id, price: shortPx, size: -desiredSize}; } }
      else if( (c.short.price !== shortPx) || (Number(c.short.size) !== Number(-desiredSize)) ){ await cancelById(c.short.id); const placed = await placeLimit(contract, -desiredSize, shortPx, false, 'gtc', `short-${Date.now()}`); if(placed){ c.short = {id: placed.id, price: shortPx, size: -desiredSize}; } }
    } catch(e){ log({error:String(e)}); } finally { renderTable(); c.busy=false; }
  }

  // =============================
  // Master loop
  // =============================
  async function loop(){ const coins = Object.keys(state.coins); for(const contract of coins){ if(!state.running) return; await tickCoin(contract); } }
  function startLoop(){ if(state.running) return; state.running = true; const hz = Number($('#hz').value || 1); const interval = Math.max(250, Math.round(1000/Math.max(0.1, hz))); state.loopTimer = setInterval(loop, interval); log({msg:'Bot başlatıldı', hz, interval_ms: interval}); }
  function stopLoop(){ state.running = false; if(state.loopTimer){ clearInterval(state.loopTimer); state.loopTimer=null; } log('Bot durduruldu'); }
  $('#btnStart').onclick = startLoop; $('#btnStop').onclick = stopLoop;

  // =============================
  // UI Buttons
  // =============================
  $('#btnTime').onclick = async () => { const r = await state.gate.get('/api/v4/spot/time', {}, !($('#apiKey').value && $('#apiSecret').value)); log({endpoint:'/api/v4/spot/time', ok:r.ok, status:r.status, data:r.json}); };
  $('#btnSetLeverage').onclick = async () => { const lev = Number($('#leverage').value||0); const coins = state.coinSymbols.slice(); for(const sym of coins){ const c = symbolToContract(sym); ensureCoin(c); const r = await setLeverageFor(c, lev); log({msg:'Kaldıraç ayarlandı', contract:c, status:r.status, ok:r.ok, resp:r.json}); } };
  $('#btnCancelAll').onclick = async () => { const coins = state.coinSymbols.slice(); for(const sym of coins){ const c = symbolToContract(sym); ensureCoin(c); await cancelAll(c); const pc = state.coins[c]; if(pc){ if(pc.long?.id) pc.long=null; if(pc.short?.id) pc.short=null; if(pc.stop?.id){ await cancelById(pc.stop.id); pc.stop=null; } } renderTable(); log({msg:'Tüm açık emirler iptal edildi', contract:c}); } };

  // =============================
  // Bootstrap
  // =============================
  function bootstrapCoins(){ const hidden = ($('#coins').value||'').split(',').map(s=>s.trim()).filter(Boolean); state.coinSymbols = Array.from(new Set(hidden.map(s=>s.toUpperCase()))); state.coinSymbols.forEach(sym=> ensureCoin(symbolToContract(sym)) ); renderCoinChips(); renderTable(); }
  bootstrapCoins();
  loadConn();
  log({msg:'Gizli ayarlar yüklendi', useProxy:HIDDEN.useProxy, base:HIDDEN.useProxy? HIDDEN.proxyBase : HIDDEN.directHost, firebase_project:HIDDEN.firebase?.projectId});
  </script>
</body>
</html>
