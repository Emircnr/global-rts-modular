<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io USDT-M “MA Channel Botu” — Tek Dosya</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:15px; --maxW:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f19 0%,#0b0f19 60%,#0a0e17 100%);color:var(--fg);font:400 var(--font)/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  a{color:var(--accent);text-decoration:none}
  h1{font-size:22px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 10px;color:var(--muted)}
  .wrap{max-width:var(--maxW);margin:24px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);padding:var(--padY) var(--padX); box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .card h3{margin:0 0 8px;font-size:16px;color:#cfe3ff;letter-spacing:.2px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 160px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel2);color:var(--fg);outline:none}
  input[type="checkbox"]{width:auto}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer;background:linear-gradient(180deg,#1a2645,#16213a);border-color:#21325b}
  button:hover{filter:brightness(1.1)}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .btn-danger{background:linear-gradient(180deg,#4a1010,#3a0e0e);border-color:#61202a}
  .btn-ok{background:linear-gradient(180deg,#124021,#0e341b);border-color:#1d5b36}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:#cfe3ff;font-size:12px}
  .muted{color:var(--muted)}
  .kicker{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .kicker .left{display:flex;align-items:center;gap:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px dashed #1d2b4d;text-align:left;font-size:14px}
  .table th{color:#bcd2ff;font-weight:600}
  .badge{padding:2px 8px;border-radius:999px;font-size:12px}
  .badge.ok{background:#14331f;color:#9be6b3;border:1px solid #1f5b36}
  .badge.err{background:#3a1515;color:#ffb3b3;border:1px solid #6a1f1f}
  .badge.warn{background:#3a2a12;color:#ffd79f;border:1px solid #6a4f1f}
  .log{height:280px;overflow:auto;background:radial-gradient(1200px 300px at 20% 0%,rgba(48,86,166,.12),transparent 60%) ,var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
  .log .item{border-bottom:1px dotted #23345e;padding:6px 2px}
  .log .time{color:#9fb0c9;font-size:12px;margin-right:6px}
  .log pre{margin:6px 0 0;white-space:pre-wrap;word-break:break-word}
  .footer{margin:18px 0 6px;color:#7592c3;font-size:12px}
  .hl{color:#a2d2ff}
  .sectionTitle{font-weight:600;color:#d6e6ff;letter-spacing:.2px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="kicker">
      <div class="left">
        <h1>Gate.io USDT‑M “MA Channel Botu”</h1>
        <span class="pill">Tek dosya • Proxy + Firestore • OCO benzeri strateji</span>
      </div>
      <div class="right muted">Dry‑run ile test edebilirsiniz.</div>
    </div>

    <div class="grid">
      <!-- Bağlantı -->
      <div class="card" style="grid-column: span 12;">
        <h3>1) Gate.io Bağlantı</h3>
        <div class="row">
          <div>
            <label>Çevre</label>
            <select id="env">
              <option value="mainnet">Mainnet</option>
              <option value="testnet">Testnet</option>
            </select>
          </div>
          <div>
            <label>Proxy Base URL</label>
            <input id="baseUrl" placeholder="http://localhost:8787" value="http://localhost:8787"/>
          </div>
          <div>
            <label>Doğrudan Host (proxy yoksa)</label>
            <input id="directHost" placeholder="https://api.gateio.ws" value="https://api.gateio.ws"/>
          </div>
          <div>
            <label>API Key</label>
            <input id="apiKey" type="password" autocomplete="off"/>
          </div>
          <div>
            <label>API Secret</label>
            <input id="apiSecret" type="password" autocomplete="off"/>
          </div>
        </div>
        <div class="btnRow" style="margin-top:10px">
          <button id="btnSave">Kaydet (localStorage)</button>
          <button id="btnLoad">Yükle</button>
          <button id="btnTime">Sunucu Saati Test (GET /api/v4/spot/time)</button>
        </div>
      </div>

      <!-- Firebase -->
      <div class="card" style="grid-column: span 12;">
        <h3>2) Firebase (Firestore canlı sinyal)</h3>
        <div class="row">
          <div>
            <label>apiKey</label>
            <input id="fb_apiKey" value="AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To"/>
          </div>
          <div>
            <label>authDomain</label>
            <input id="fb_authDomain" value="macbot-b7b45.firebaseapp.com"/>
          </div>
          <div>
            <label>databaseURL</label>
            <input id="fb_databaseURL" value="https://macbot-b7b45-default-rtdb.firebaseio.com"/>
          </div>
          <div>
            <label>projectId</label>
            <input id="fb_projectId" value="macbot-b7b45"/>
          </div>
          <div>
            <label>storageBucket</label>
            <input id="fb_storageBucket" value="macbot-b7b45.firebasestorage.app"/>
          </div>
          <div>
            <label>messagingSenderId</label>
            <input id="fb_messagingSenderId" value="88494187419"/>
          </div>
          <div>
            <label>appId</label>
            <input id="fb_appId" value="1:88494187419:web:9e0fd1a37e51332203373e"/>
          </div>
          <div>
            <label>measurementId</label>
            <input id="fb_measurementId" value="G-SVG851WK7Y"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Kaynak tipi</label>
            <select id="sourceType">
              <option value="doc">Doc pattern</option>
              <option value="collection">Collection latest</option>
            </select>
          </div>
          <div>
            <label>Yol / Koleksiyon</label>
            <input id="sourcePath" placeholder="signals/{SYMBOL}" value="signals/{SYMBOL}"/>
          </div>
          <div>
            <label>Alan: upper</label>
            <input id="f_upper" value="upper"/>
          </div>
          <div>
            <label>Alan: lower</label>
            <input id="f_lower" value="lower"/>
          </div>
          <div>
            <label>Alan: mid</label>
            <input id="f_mid" value="mid"/>
          </div>
          <div>
            <label>Alan: close</label>
            <input id="f_close" value="close"/>
          </div>
          <div>
            <label>Alan: symbol</label>
            <input id="f_symbol" value="symbol"/>
          </div>
          <div>
            <label>Alan: ts_ms</label>
            <input id="f_ts" value="ts_ms"/>
          </div>
        </div>
        <div class="btnRow" style="margin-top:10px">
          <button id="btnConnectFb" class="btn-ok">Bağlan (dinlemeyi başlat)</button>
        </div>
      </div>

      <!-- Strateji & Emirler -->
      <div class="card" style="grid-column: span 12;">
        <h3>3) Strateji & Emir</h3>
        <div class="row">
          <div>
            <label>Settle</label>
            <input id="settle" value="usdt"/>
          </div>
          <div>
            <label>Kaldıraç</label>
            <input id="leverage" type="number" step="1" value="10"/>
          </div>
          <div>
            <label>Tutar (USDT)</label>
            <input id="usdtAmt" type="number" step="0.01" value="50"/>
          </div>
          <div>
            <label>Güncelleme hızı (Hz)</label>
            <select id="hz">
              <option value="0.5">0.5</option>
              <option value="1" selected>1</option>
              <option value="1.5">1.5</option>
              <option value="2">2</option>
            </select>
          </div>
          <div>
            <label>Coin listesi (virgüllü)</label>
            <input id="symbols" value="BTCUSDT,ETHUSDT"/>
          </div>
          <div>
            <label>&nbsp;</label>
            <div style="display:flex;gap:16px;align-items:center">
              <label class="row" style="align-items:center;gap:8px"><input id="optReduce" type="checkbox" checked/> Reduce‑only STOP</label>
              <label class="row" style="align-items:center;gap:8px"><input id="optDry" type="checkbox"/> Dry‑run</label>
            </div>
          </div>
        </div>
        <div class="btnRow" style="margin-top:10px">
          <button id="btnStart" class="btn-ok">Başlat</button>
          <button id="btnStop" class="btn-danger">Durdur</button>
          <button id="btnSetLev">Kaldıraç Ayarla (tüm seçili coinler)</button>
          <button id="btnCancelAll" class="btn-danger">Seçili coinlerde tüm açık emirleri iptal</button>
        </div>
      </div>

      <!-- Durum Tablosu -->
      <div class="card" style="grid-column: span 12;">
        <h3>4) Durum</h3>
        <div class="muted" style="margin-bottom:8px">Kontrat, son sinyal ve emir/pozisyon durumu</div>
        <div style="overflow:auto">
          <table class="table" id="statusTable">
            <thead>
              <tr>
                <th>Kontrat</th>
                <th>Close</th>
                <th>Lower</th>
                <th>Mid</th>
                <th>Upper</th>
                <th>İçeride mi?</th>
                <th>LongID</th>
                <th>ShortID</th>
                <th>StopID</th>
                <th>Poz. Size</th>
                <th>Son TS</th>
              </tr>
            </thead>
            <tbody id="statusBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Log -->
      <div class="card" style="grid-column: span 12;">
        <h3>5) Log</h3>
        <div class="log" id="log"></div>
        <div class="footer">İmza stringleri ve Gate cevapları burada görünür. <span class="hl">Dry‑run</span> aktifken emir gönderilmez.</div>
      </div>

    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
(() => {
  // ===================== Yardımcılar =====================
  const $ = (sel) => document.querySelector(sel);
  const logBox = $('#log');
  function nowStr(){ const d=new Date(); return d.toLocaleTimeString(); }
  function log(title, obj){
    const div=document.createElement('div');
    div.className='item';
    const t=document.createElement('div');
    t.innerHTML = `<span class="time">${nowStr()}</span> <span class="sectionTitle">${title}</span>`;
    div.appendChild(t);
    if(obj!==undefined){
      const pre=document.createElement('pre');
      pre.className='mono';
      try{ pre.textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }
      catch(e){ pre.textContent = String(obj); }
      div.appendChild(pre);
    }
    logBox.prepend(div);
    // sınırla
    const max=500; while(logBox.children.length>max){ logBox.removeChild(logBox.lastChild); }
  }

  function saveSettings(){
    const data = collectSettings();
    localStorage.setItem('maChannelBot.settings.v1', JSON.stringify(data));
    log('Ayarlar kaydedildi', data);
  }
  function loadSettings(){
    const raw = localStorage.getItem('maChannelBot.settings.v1');
    if(!raw){ log('Kayıtlı ayar bulunamadı'); return; }
    const s = JSON.parse(raw);
    $('#env').value = s.env||'mainnet';
    $('#baseUrl').value = s.baseUrl||'http://localhost:8787';
    $('#directHost').value = s.directHost||'https://api.gateio.ws';
    $('#apiKey').value = s.apiKey||'';
    $('#apiSecret').value = s.apiSecret||'';
    // Firebase
    $('#fb_apiKey').value = s.fb?.apiKey||'';
    $('#fb_authDomain').value = s.fb?.authDomain||'';
    $('#fb_databaseURL').value = s.fb?.databaseURL||'';
    $('#fb_projectId').value = s.fb?.projectId||'';
    $('#fb_storageBucket').value = s.fb?.storageBucket||'';
    $('#fb_messagingSenderId').value = s.fb?.messagingSenderId||'';
    $('#fb_appId').value = s.fb?.appId||'';
    $('#fb_measurementId').value = s.fb?.measurementId||'';

    $('#sourceType').value = s.sourceType||'doc';
    $('#sourcePath').value = s.sourcePath||'signals/{SYMBOL}';

    $('#f_upper').value = s.fields?.upper||'upper';
    $('#f_lower').value = s.fields?.lower||'lower';
    $('#f_mid').value = s.fields?.mid||'mid';
    $('#f_close').value = s.fields?.close||'close';
    $('#f_symbol').value = s.fields?.symbol||'symbol';
    $('#f_ts').value = s.fields?.ts||'ts_ms';

    $('#settle').value = s.settle||'usdt';
    $('#leverage').value = s.leverage||10;
    $('#usdtAmt').value = s.usdtAmt||50;
    $('#hz').value = s.hz||'1';
    $('#symbols').value = s.symbols||'BTCUSDT,ETHUSDT';
    $('#optReduce').checked = !!s.optReduce;
    $('#optDry').checked = !!s.optDry;

    log('Ayarlar yüklendi');
  }
  function collectSettings(){
    return {
      env: $('#env').value.trim(),
      baseUrl: $('#baseUrl').value.trim(),
      directHost: $('#directHost').value.trim(),
      apiKey: $('#apiKey').value,
      apiSecret: $('#apiSecret').value,
      fb:{
        apiKey: $('#fb_apiKey').value.trim(),
        authDomain: $('#fb_authDomain').value.trim(),
        databaseURL: $('#fb_databaseURL').value.trim(),
        projectId: $('#fb_projectId').value.trim(),
        storageBucket: $('#fb_storageBucket').value.trim(),
        messagingSenderId: $('#fb_messagingSenderId').value.trim(),
        appId: $('#fb_appId').value.trim(),
        measurementId: $('#fb_measurementId').value.trim(),
      },
      sourceType: $('#sourceType').value,
      sourcePath: $('#sourcePath').value.trim(),
      fields:{
        upper: $('#f_upper').value.trim(),
        lower: $('#f_lower').value.trim(),
        mid: $('#f_mid').value.trim(),
        close: $('#f_close').value.trim(),
        symbol: $('#f_symbol').value.trim(),
        ts: $('#f_ts').value.trim(),
      },
      settle: $('#settle').value.trim(),
      leverage: Number($('#leverage').value),
      usdtAmt: Number($('#usdtAmt').value),
      hz: $('#hz').value,
      symbols: $('#symbols').value.trim(),
      optReduce: $('#optReduce').checked,
      optDry: $('#optDry').checked,
    };
  }

  // ============ Kripto yardımcıları (SHA512 / HMAC-SHA512) ============
  const te = new TextEncoder();
  function toHex(buffer){
    const b = new Uint8Array(buffer);
    let s=''; for(const x of b){ s += x.toString(16).padStart(2,'0'); }
    return s;
  }
  async function sha512Hex(input){
    const data = (typeof input==='string') ? te.encode(input) : input;
    const hash = await crypto.subtle.digest('SHA-512', data);
    return toHex(hash);
  }
  async function hmacSha512Hex(secret, message){
    const key = await crypto.subtle.importKey(
      'raw', te.encode(secret), {name:'HMAC', hash:'SHA-512'}, false, ['sign']
    );
    const sig = await crypto.subtle.sign('HMAC', key, te.encode(message));
    return toHex(sig);
  }

  function sortedQueryString(params){
    const keys = Object.keys(params||{}).filter(k=>params[k]!==undefined && params[k]!==null);
    keys.sort();
    const usp = new URLSearchParams();
    for(const k of keys){ usp.append(k, String(params[k])); }
    return usp.toString();
  }

  function symToContract(sym){
    // "BTCUSDT" -> "BTC_USDT"
    if(!sym) return '';
    return sym.replace(/USDT$/,'_USDT');
  }

  function decimalsFromStep(step){
    const s = String(step);
    if(!s.includes('.')) return 0;
    return s.length - s.indexOf('.') - 1;
  }
  function floorToIncrement(val, inc){
    const d = decimalsFromStep(inc);
    const res = Math.floor(val/inc) * inc;
    return Number(res.toFixed(d));
  }
  function roundToTick(price, tick){
    const d = decimalsFromStep(tick);
    const res = Math.round(price/tick) * tick;
    return Number(res.toFixed(d));
  }

  // ============ Gate.io İmzalı İstek ============
  function baseRoot(env, baseUrl, directHost){
    if(baseUrl){
      // Proxy kullan: mainnet: /, testnet: /testnet
      const suffix = (env==='testnet') ? '/testnet' : '';
      return baseUrl.replace(/\/$/,'') + suffix;
    }
    return directHost?.replace(/\/$/,'')||'https://api.gateio.ws';
  }

  async function signedFetch({env, baseUrl, directHost, apiKey, apiSecret}, method, urlPath, queryParams, bodyObj){
    const root = baseRoot(env, baseUrl, directHost);
    const qs = sortedQueryString(queryParams||{});
    const bodyStr = bodyObj? JSON.stringify(bodyObj) : '';
    const bodyHash = await sha512Hex(bodyStr);
    const ts = Math.floor(Date.now()/1000);
    const signatureString = `${method.toUpperCase()}\n${urlPath}\n${qs}\n${bodyHash}\n${ts}`;
    const sign = await hmacSha512Hex(apiSecret, signatureString);

    const url = root + urlPath + (qs? ('?'+qs):'');
    const headers = {
      'Content-Type':'application/json',
      'KEY': apiKey,
      'Timestamp': String(ts),
      'SIGN': sign,
    };

    log('İstek', {method, url, urlPath, query:qs, body: bodyStr||'(empty)', signature_string: signatureString});
    if(state.optDry && method!=='GET' && method!=='DELETE'){
      log('Dry‑run: fetch atlanıyor');
      return { dryRun:true };
    }

    const res = await fetch(url, {method, headers, body: bodyStr||undefined});
    const txt = await res.text();
    let data; try{ data = JSON.parse(txt); }catch{ data = txt; }
    log(`Cevap ${res.status}`, data);
    if(!res.ok){ throw new Error(typeof data==='object'? (data.label+': '+data.message) : String(data)); }
    return data;
  }

  // ============ Gate API Kısa Yolları ============
  const API = {
    spotTime: (cfg) => signedFetch(cfg,'GET','/api/v4/spot/time',null,null),
    contractSpec: (cfg, settle, contract) => signedFetch(cfg,'GET',`/api/v4/futures/${settle}/contracts/${contract}`,null,null),
    openOrders: (cfg, settle, contract) => signedFetch(cfg,'GET',`/api/v4/futures/${settle}/orders`,{contract,status:'open'},null),
    cancelById: (cfg, settle, id) => signedFetch(cfg,'DELETE',`/api/v4/futures/${settle}/orders/${id}`,null,null),
    cancelByContract: (cfg, settle, contract) => signedFetch(cfg,'DELETE',`/api/v4/futures/${settle}/orders`,{contract},null),
    createOrder: (cfg, settle, body) => signedFetch(cfg,'POST',`/api/v4/futures/${settle}/orders`,null,body),
    position: (cfg, settle, contract) => signedFetch(cfg,'GET',`/api/v4/futures/${settle}/positions/${contract}`,null,null),
    setLeverage: (cfg, settle, contract, lev) => signedFetch(cfg,'POST',`/api/v4/futures/${settle}/positions/${contract}/leverage`,{leverage:String(lev)},null),
  };

  // ============ Durum & Bellek ============
  const state = {
    running:false,
    optReduce:true,
    optDry:false,
    cfg: null,
    settle:'usdt',
    usdtAmt:50,
    hz:1,
    leverage:10,
    coins: {}, // contract -> { symbol, contract, spec, last, ids, timers, busy }
    fields:null,
    fb:{ app:null, db:null, listeners:{} },
  };

  function getCfg(){
    const s = collectSettings();
    return {
      env: s.env,
      baseUrl: s.baseUrl,
      directHost: s.directHost,
      apiKey: s.apiKey,
      apiSecret: s.apiSecret,
    };
  }

  // ============ UI Bağlama ============
  $('#btnSave').onclick = saveSettings;
  $('#btnLoad').onclick = loadSettings;
  $('#btnTime').onclick = async() => {
    try{
      const cfg = getCfg();
      const data = await API.spotTime(cfg);
      log('Sunucu Saati', data);
    }catch(e){ log('Sunucu Saati Hatası', String(e)); }
  };

  $('#btnConnectFb').onclick = connectFirestore;
  $('#btnStart').onclick = startBot;
  $('#btnStop').onclick = stopBot;
  $('#btnSetLev').onclick = setLeverageAll;
  $('#btnCancelAll').onclick = cancelAllSelected;

  // ============ Firestore Dinleme ============
  function buildFbConfig(){
    const s = collectSettings();
    return {
      apiKey: s.fb.apiKey,
      authDomain: s.fb.authDomain,
      databaseURL: s.fb.databaseURL,
      projectId: s.fb.projectId,
      storageBucket: s.fb.storageBucket,
      messagingSenderId: s.fb.messagingSenderId,
      appId: s.fb.appId,
      measurementId: s.fb.measurementId,
    };
  }

  function connectFirestore(){
    const s = collectSettings();
    state.fields = s.fields;
    if(!state.fb.app){
      state.fb.app = firebase.initializeApp(buildFbConfig());
      state.fb.db = firebase.firestore();
      log('Firebase başlatıldı');
    }
    const symbols = s.symbols.split(',').map(x=>x.trim()).filter(Boolean);
    // Her symbol için listener kur
    symbols.forEach(sym => attachListener(sym, s.sourceType, s.sourcePath));
  }

  function attachListener(symbol, sourceType, path){
    const db = state.fb.db;
    if(state.fb.listeners[symbol]){ state.fb.listeners[symbol](); }

    if(sourceType==='doc'){
      const docPath = path.replace('{SYMBOL}', symbol);
      const unsub = db.doc(docPath).onSnapshot(snap => {
        if(!snap.exists){ return; }
        const data = snap.data();
        onSignal(symbol, data);
      });
      state.fb.listeners[symbol] = unsub;
      log('Firestore dinleme (doc)', {symbol, docPath});
    } else {
      // collection latest: path = collection adı (örn: "signals"); where('symbol','==',SYMBOL).orderBy('ts_ms','desc').limit(1)
      const colRef = db.collection(path);
      const q = colRef.where(state.fields.symbol,'==',symbol).orderBy(state.fields.ts,'desc').limit(1);
      const unsub = q.onSnapshot(snap => {
        snap.forEach(doc => onSignal(symbol, doc.data()));
      });
      state.fb.listeners[symbol] = unsub;
      log('Firestore dinleme (collection latest)', {symbol, collection:path});
    }
  }

  // ============ Sinyal Akışı ============
  function ensureCoin(sym){
    const contract = symToContract(sym);
    if(!state.coins[contract]){
      state.coins[contract] = {
        symbol: sym, contract,
        spec: null,
        last: null, // {close,lower,mid,upper,ts}
        ids: { long:null, short:null, stop:null },
        lastPlaced: { upper:null, lower:null, mid:null },
        busy:false,
        posSize:0,
      };
    }
    return state.coins[contract];
  }

  function onSignal(symbol, raw){
    const f = state.fields;
    const close = Number(raw[f.close]);
    const upper = Number(raw[f.upper]);
    const lower = Number(raw[f.lower]);
    const mid = Number(raw[f.mid]);
    const ts = Number(raw[f.ts]||0);
    const sym = String(raw[f.symbol]||symbol);
    const c = ensureCoin(sym);
    c.last = {close, upper, lower, mid, ts};
    renderStatus();
  }

  // ============ Bot Döngüsü ============
  let loopTimer=null;
  function startBot(){
    const s = collectSettings();
    state.cfg = getCfg();
    state.optReduce = s.optReduce;
    state.optDry = s.optDry;
    state.settle = s.settle;
    state.usdtAmt = s.usdtAmt;
    state.hz = Number(s.hz);
    state.leverage = Number(s.leverage);
    const symbols = s.symbols.split(',').map(x=>x.trim()).filter(Boolean);
    symbols.forEach(sym=>ensureCoin(sym));

    if(loopTimer) clearInterval(loopTimer);
    const intervalMs = Math.max(100, Math.round(1000/state.hz));
    state.running = true;
    loopTimer = setInterval(tickAll, intervalMs);
    log('Bot başlatıldı', {hz: state.hz, intervalMs});
  }
  function stopBot(){
    state.running = false;
    if(loopTimer) clearInterval(loopTimer); loopTimer=null;
    log('Bot durduruldu');
  }

  async function tickAll(){
    if(!state.running) return;
    for(const contract of Object.keys(state.coins)){
      try{ await tickOne(contract); }
      catch(e){ log(`Hata (${contract})`, String(e)); }
    }
  }

  async function loadSpecIfNeeded(c){
    if(c.spec) return;
    const spec = await API.contractSpec(state.cfg, state.settle, c.contract);
    c.spec = {
      tick_size: Number(spec.tick_size||spec.tickSize||spec.order_price_round || 0.01),
      order_size_increment: Number(spec.order_size_increment||spec.orderSizeIncrement||1),
      quanto_multiplier: Number(spec.quanto_multiplier||spec.quantoMultiplier||1),
      min_order_size: Number(spec.order_size_min||spec.orderSizeMin||0),
    };
    log('Kontrat spec', {contract:c.contract, spec:c.spec});
  }

  async function tickOne(contract){
    const c = state.coins[contract];
    if(!c || !c.last) return; // sinyal yok
    if(c.busy) return; c.busy=true;
    try{
      await loadSpecIfNeeded(c);
      // 1) Pozisyon oku
      const pos = await API.position(state.cfg, state.settle, contract);
      const posSize = Number(pos.size||0);
      c.posSize = posSize;

      const {close, upper, lower, mid} = c.last;
      const inside = (lower < close && close < upper);

      // 2) Açık emirleri oku
      const oo = await API.openOrders(state.cfg, state.settle, contract);
      const openIds = new Set((Array.isArray(oo)?oo:[]).map(o=>String(o.id)));
      // var olan id'leri doğrula
      if(c.ids.long && !openIds.has(String(c.ids.long))) c.ids.long = null;
      if(c.ids.short && !openIds.has(String(c.ids.short))) c.ids.short = null;
      if(c.ids.stop && !openIds.has(String(c.ids.stop))) c.ids.stop = null;

      // 3) Strateji
      if(!inside){
        // Kanal dışında: bekleyenleri temizle (pozisyon yoksa stop da temizlenir)
        await cancelPairIfAny(c);
        if(Math.abs(posSize)===0 && c.ids.stop){ await API.cancelById(state.cfg, state.settle, c.ids.stop); c.ids.stop=null; }
        c.lastPlaced.upper=null; c.lastPlaced.lower=null; // zorla yeniden kur
        renderStatus();
        return;
      }

      // İçeride: pozisyon yoksa çift bekleyen emir; pozisyon varsa sadece stop takip
      const spec = c.spec;
      const priceUpper = roundToTick(upper, spec.tick_size);
      const priceLower = roundToTick(lower, spec.tick_size);
      const priceMid   = roundToTick(mid,   spec.tick_size);

      const sizeAbs = computeOrderSizeAbsUSD(state.usdtAmt, close, spec);
      if(sizeAbs <= 0){ log('Min size yetersiz', {contract, sizeAbs}); c.busy=false; return; }

      if(Math.abs(posSize)===0){
        // Çift emir kur / güncelle
        await ensurePairLimits(c, priceUpper, priceLower, sizeAbs);
        // Stop olmamalı
        if(c.ids.stop){ await API.cancelById(state.cfg, state.settle, c.ids.stop); c.ids.stop=null; }
      } else {
        // Pozisyon var: karşı yöne reduce-only limit (mid) ile stop takip
        if(state.optReduce){
          await ensureReduceOnlyStop(c, posSize, priceMid);
        }
        // Pozisyon varken bekleyen çift emirleri sil
        await cancelPairIfAny(c);
      }

      renderStatus();
    } finally { c.busy=false; }
  }

  function computeOrderSizeAbsUSD(usdt, price, spec){
    // base_qty = USDT / price
    // size = base_qty / quanto_multiplier
    const baseQty = usdt / price;
    let size = baseQty / (spec.quanto_multiplier||1);
    size = floorToIncrement(size, spec.order_size_increment||1);
    if(spec.min_order_size && size < spec.min_order_size){ return 0; }
    return size;
  }

  async function ensurePairLimits(c, priceUpper, priceLower, sizeAbs){
    // Eğer fiyat değiştiyse mevcutları iptal + yeniden koy
    const needNewLong = (!c.ids.long) || (c.lastPlaced.upper !== priceUpper);
    const needNewShort = (!c.ids.short) || (c.lastPlaced.lower !== priceLower);

    // Güncelleme sırası: önce iptaller
    if(c.ids.long && needNewLong){ await API.cancelById(state.cfg, state.settle, c.ids.long); c.ids.long=null; }
    if(c.ids.short && needNewShort){ await API.cancelById(state.cfg, state.settle, c.ids.short); c.ids.short=null; }

    // Açık kalan diğer taraf varsa dokunmadan bırak
    if(needNewLong && !c.ids.long){
      const body = {
        contract: c.contract,
        size: +Math.abs(sizeAbs), // BUY/LONG
        price: String(priceUpper),
        tif: 'gtc',
        text: `long-${Date.now()}`,
      };
      const res = await API.createOrder(state.cfg, state.settle, body);
      if(!res.dryRun) c.ids.long = res.id || res.order_id || res.client_id || null;
      c.lastPlaced.upper = priceUpper;
    }
    if(needNewShort && !c.ids.short){
      const body = {
        contract: c.contract,
        size: -Math.abs(sizeAbs), // SELL/SHORT
        price: String(priceLower),
        tif: 'gtc',
        text: `short-${Date.now()}`,
      };
      const res = await API.createOrder(state.cfg, state.settle, body);
      if(!res.dryRun) c.ids.short = res.id || res.order_id || res.client_id || null;
      c.lastPlaced.lower = priceLower;
    }
  }

  async function ensureReduceOnlyStop(c, posSize, priceMid){
    // Pozisyon yönüne göre karşı yöne reduce_only limit
    const wantBuy  = posSize < 0; // short poz -> BUY stop
    const wantSell = posSize > 0; // long poz -> SELL stop

    const needNew = (!c.ids.stop) || (c.lastPlaced.mid !== priceMid);
    if(!needNew) return; // güncel

    // önce var ise iptal et
    if(c.ids.stop){ await API.cancelById(state.cfg, state.settle, c.ids.stop); c.ids.stop=null; }

    const bodyBase = {
      contract: c.contract,
      size: wantBuy ? Math.abs(posSize) : -Math.abs(posSize),
      price: String(priceMid),
      tif: 'gtc',
      reduce_only: true,
      text: `stop-${Date.now()}`,
    };
    const res = await API.createOrder(state.cfg, state.settle, bodyBase);
    if(!res.dryRun) c.ids.stop = res.id || res.order_id || res.client_id || null;
    c.lastPlaced.mid = priceMid;
  }

  async function cancelPairIfAny(c){
    if(c.ids.long){ try{ await API.cancelById(state.cfg, state.settle, c.ids.long); }catch(e){ log('İptal (long) hata', String(e)); }
      c.ids.long=null; }
    if(c.ids.short){ try{ await API.cancelById(state.cfg, state.settle, c.ids.short); }catch(e){ log('İptal (short) hata', String(e)); }
      c.ids.short=null; }
  }

  async function cancelAllSelected(){
    const s = collectSettings();
    const symbols = s.symbols.split(',').map(x=>x.trim()).filter(Boolean);
    for(const sym of symbols){
      const contract = symToContract(sym);
      try{
        await API.cancelByContract(state.cfg||getCfg(), s.settle||'usdt', contract);
        const c = state.coins[contract]; if(c){ c.ids.long=c.ids.short=c.ids.stop=null; }
      }catch(e){ log(`İptal (tümü) hata ${contract}`, String(e)); }
    }
  }

  async function setLeverageAll(){
    const s = collectSettings();
    const symbols = s.symbols.split(',').map(x=>x.trim()).filter(Boolean);
    for(const sym of symbols){
      const contract = symToContract(sym);
      try{
        const res = await API.setLeverage(getCfg(), s.settle||'usdt', contract, Number(s.leverage)||0);
        log('Kaldıraç ayarlandı', {contract, res});
      }catch(e){ log(`Kaldıraç hata ${contract}`, String(e)); }
    }
  }

  // ============ Durum Tablosu ============
  function renderStatus(){
    const tbody = $('#statusBody');
    const rows = [];
    for(const [contract,c] of Object.entries(state.coins)){
      const L = c.last||{};
      const inside = (L.lower < L.close && L.close < L.upper);
      rows.push(`<tr>
        <td class="mono">${contract}</td>
        <td>${fmtNum(L.close)}</td>
        <td>${fmtNum(L.lower)}</td>
        <td>${fmtNum(L.mid)}</td>
        <td>${fmtNum(L.upper)}</td>
        <td>${inside? '<span class="badge ok">İÇERİDE</span>' : '<span class="badge warn">DIŞARIDA</span>'}</td>
        <td class="mono">${c.ids.long||'-'}</td>
        <td class="mono">${c.ids.short||'-'}</td>
        <td class="mono">${c.ids.stop||'-'}</td>
        <td class="mono">${c.posSize??0}</td>
        <td class="mono">${L.ts? new Date(L.ts).toLocaleTimeString():'-'}</td>
      </tr>`);
    }
    tbody.innerHTML = rows.join('');
  }
  function fmtNum(x){ return (x===undefined||x===null||isNaN(x))? '-' : Number(x).toLocaleString(undefined,{maximumFractionDigits:8}); }

  // ============ İlk yükleme ============
  loadSettings();
})();
</script>
</body>
</html>
