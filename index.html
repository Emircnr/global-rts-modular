<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MEXC Spot ↔ Perp Fark (Çoklu Sembol, CORS Fix)</title>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--txt:#e6ecff;--muted:#93a1c8;--acc:#7c5cff;--ok:#22c55e;--bad:#ef476f;--warn:#ffd166;--border:#1b2643}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:
    radial-gradient(1200px 800px at 130% -10%, rgba(124,92,255,.12), transparent 60%),
    linear-gradient(180deg,#0b1220,#0b1220);color:var(--txt)}
  header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{font-size:18px;margin:0} .sub{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 120%),var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row>*{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0e1526;color:var(--txt);font-size:14px}
  input:focus{border-color:#4b58ff;box-shadow:0 0 0 3px rgba(75,88,255,.15)}
  button{cursor:pointer;background:linear-gradient(180deg,#8b6bff,#6d53ff);border:none;font-weight:700}
  button.secondary{background:#121a2c}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:#0f1628;border-radius:999px;padding:6px 10px;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-variant-numeric:tabular-nums}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;font-size:13px}
  thead th{position:sticky;top:0;background:#111a2e;z-index:5}
  th:first-child,td:first-child{text-align:left}
  tbody tr:hover{background:#0e1526}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .muted{color:var(--muted)}
  .tiny{font-size:11px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>MEXC Spot ↔ Perp Fark Programı</h1>
    <div class="sub">CORS çözümü: Cloudflare Worker üzerinden — Çoklu sembol, anlık fark</div>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div style="flex:2">
        <label>Sembol(ler) — Spot formatı (örn. <b>BTCUSDT, ETHUSDT</b>)</label>
        <input id="symbols" placeholder="BTCUSDT, ETHUSDT, XRPUSDT">
      </div>
      <div>
        <label>Yenileme (ms)</label>
        <input id="refresh" type="number" min="200" step="50" value="800">
      </div>
      <div style="flex:0 0 240px">
        <label>&nbsp;</label>
        <div class="row">
          <button id="btnAdd">Ekle</button>
          <button id="btnClear" class="secondary">Hepsini Sil</button>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="pill tiny">Durum: <span id="status">Hazır</span></div>
      <div class="pill tiny">Sembol sayısı: <span id="count">0</span></div>
      <div class="pill tiny">Son güncelleme: <span id="last">—</span></div>
      <div class="pill tiny">Proxy: <span id="proxyShown">—</span></div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <div style="overflow:auto; max-height:70vh;">
      <table>
        <thead>
          <tr>
            <th>Sembol</th>
            <th>Spot Bid</th><th>Bid Qty</th>
            <th>Spot Ask</th><th>Ask Qty</th>
            <th>Perp Bid</th><th>Bid Qty (base)</th>
            <th>Perp Ask</th><th>Ask Qty (base)</th>
            <th>Long % <div class="tiny muted">(Perp Bid − Spot Ask) / Spot Ask)</div></th>
            <th>Short % <div class="tiny muted">(Spot Bid − Perp Ask) / Spot Bid)</div></th>
            <th>Güncel</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
(() => {
  // ==== SENİN PROXY ADRESİN ====
  const proxyBase = "https://<YOUR-WORKER-SUBDOMAIN>.workers.dev"; // <- BURAYA Worker URL'ni yaz
  document.getElementById('proxyShown').textContent = proxyBase;

  const el = {
    symbols: document.getElementById('symbols'),
    refresh: document.getElementById('refresh'),
    btnAdd:  document.getElementById('btnAdd'),
    btnClear:document.getElementById('btnClear'),
    status:  document.getElementById('status'),
    count:   document.getElementById('count'),
    last:    document.getElementById('last'),
    tbody:   document.getElementById('tbody'),
  };

  const LS_KEY = "mexc_fark_syms_v2";
  let list = loadSyms();
  let timer = null;

  function loadSyms(){ try{ const j=JSON.parse(localStorage.getItem(LS_KEY)||"[]"); return Array.isArray(j)? j:[] }catch(e){ return [] } }
  function saveSyms(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(list)); }catch(e){} }
  function nowStr(){ return new Date().toLocaleTimeString(); }
  function cls(td){ td.classList.remove('ok','bad','warn'); }
  function color(td,v){ cls(td); if(!isFinite(v))return; if(v>0)td.classList.add('ok'); else if(v<0)td.classList.add('bad'); else td.classList.add('warn'); }
  function f(n,p=2){ return isFinite(n)? Number(n).toLocaleString(undefined,{maximumFractionDigits:p}):'—' }

  function toRow(sym){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b class="sym">${sym}</b><br><span class="muted tiny perp">${sym.endsWith('USDT')? sym.slice(0,-4)+'_USDT' : sym}</span></td>
      <td class="sBid">—</td><td class="sBidQ">—</td>
      <td class="sAsk">—</td><td class="sAskQ">—</td>
      <td class="pBid">—</td><td class="pBidQ">—</td>
      <td class="pAsk">—</td><td class="pAskQ">—</td>
      <td class="long">—</td><td class="short">—</td>
      <td class="ts tiny muted">—</td>
      <td><button class="del secondary tiny">Sil</button></td>
    `;
    tr.querySelector('.del').onclick = ()=> removeSym(sym);
    return tr;
  }

  function ensureRows(){
    const present = new Set([...el.tbody.querySelectorAll('tr')].map(tr=>tr.querySelector('.sym').textContent));
    list.forEach(sym=>{
      if(!present.has(sym)) el.tbody.appendChild(toRow(sym));
    });
    // fazla olanları temizle
    [...el.tbody.querySelectorAll('tr')].forEach(tr=>{
      const s = tr.querySelector('.sym').textContent;
      if(!list.includes(s)) tr.remove();
    });
    el.count.textContent = String(list.length);
  }

  function removeSym(sym){
    list = list.filter(x=>x!==sym);
    saveSyms();
    ensureRows();
  }

  async function tick(){
    if(!list.length){ el.status.textContent='Boş'; el.last.textContent='—'; return; }
    el.status.textContent='Çekiliyor…';
    try{
      const q = encodeURIComponent(list.join(','));
      const url = `${proxyBase}/mexc?symbols=${q}&limit=5`;
      const r = await fetch(url, { cache:'no-store' });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'proxy error');

      j.data.forEach(rec=>{
        const sym = rec.spotSymbol;
        const tr = [...el.tbody.querySelectorAll('tr')].find(x=>x.querySelector('.sym').textContent===sym);
        if(!tr) return;
        const ps = rec.perp?.priceScale ?? 2;

        tr.querySelector('.sBid').textContent = f(rec.spot.bid, ps);
        tr.querySelector('.sAsk').textContent = f(rec.spot.ask, ps);
        tr.querySelector('.sBidQ').textContent = f(rec.spot.bidQty, 6);
        tr.querySelector('.sAskQ').textContent = f(rec.spot.askQty, 6);

        tr.querySelector('.pBid').textContent = f(rec.perp.bid, ps);
        tr.querySelector('.pAsk').textContent = f(rec.perp.ask, ps);
        tr.querySelector('.pBidQ').textContent = f(rec.perp.bidQtyBase, 6);
        tr.querySelector('.pAskQ').textContent = f(rec.perp.askQtyBase, 6);

        const long  = rec.diffs.long;
        const short = rec.diffs.short;
        const tdL = tr.querySelector('.long');
        const tdS = tr.querySelector('.short');
        tdL.textContent = isFinite(long)? (long*100).toFixed(3)+'%':'—';
        tdS.textContent = isFinite(short)? (short*100).toFixed(3)+'%':'—';
        color(tdL, long); color(tdS, short);

        tr.querySelector('.ts').textContent = nowStr();
      });

      el.status.textContent='Tamam';
      el.last.textContent = nowStr();
    } catch(e){
      el.status.textContent='Hata: '+(e?.message||e);
    }
  }

  function start(){
    if(timer) clearInterval(timer);
    const ms = Math.max(200, Number(el.refresh.value)||800);
    timer = setInterval(tick, ms);
    tick();
  }

  // UI
  document.getElementById('btnAdd').onclick = ()=>{
    const raw = (el.symbols.value||'').toUpperCase();
    const arr = raw.split(/[,\s]+/).map(s=>s.trim()).filter(Boolean).filter(s=>s.endsWith('USDT'));
    arr.forEach(s=>{ if(!list.includes(s)) list.push(s); });
    saveSyms();
    el.symbols.value='';
    ensureRows();
    tick();
  };
  document.getElementById('btnClear').onclick = ()=>{
    list = []; saveSyms(); ensureRows(); tick();
  };
  el.refresh.onchange = start;

  // İlk açılış
  if(!list.length){ list = ['BTCUSDT','ETHUSDT','XRPUSDT']; saveSyms(); }
  ensureRows();
  start();
})();
</script>
</body>
</html>
