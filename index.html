<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Firestore ▶ Gate.io MAC Channel Bot</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --acc:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --radius:18px; --gap:14px; --font:16px; --maxW:1280px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:400 var(--font)/1.55 'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:var(--maxW);margin:28px auto;padding:0 14px}
  h1{margin:0 0 6px;font-size:26px}
  .sub{margin:0 0 16px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .sec{padding:14px 14px 2px;color:var(--muted);font-size:13px;border-bottom:1px dashed var(--border)}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px}
  .form.full{grid-template-columns:1fr}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0d1528;color:#e8eef7}
  textarea{min-height:64px;resize:vertical}
  button{background:var(--acc);color:#071122;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--border);color:#e8eef7;font-weight:600}
  .row{display:flex;gap:10px;align-items:center}
  .kpis{display:flex;flex-wrap:wrap;gap:10px;padding:12px 14px;border-top:1px dashed var(--border)}
  .tag{padding:6px 10px;border-radius:12px;background:var(--glass);border:1px solid var(--border);font-size:14px}
  .tag.good{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.1)}
  .tag.bad{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.08)}
  .list{padding:14px}
  .sym{display:grid;grid-template-columns:110px repeat(8,1fr);gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border);font-size:14px}
  .sym .badge{font-size:12px;color:var(--muted)}
  .sym .s{font-weight:700}
  .status{padding:10px 14px;color:#ffb4b4}
  .muted{color:var(--muted);font-size:13px}
  .footer{opacity:.65;text-align:center;margin-top:16px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Firestore ▶ Gate.io MAC Channel Bot</h1>
  <div class="sub">Firestore’daki MAC kanal verilerine göre: kanal içindeyken üst banda <b>LONG</b>, alt banda <b>SHORT</b> emirleri 3 sn’de bir günceller; biri dolunca diğeri iptal + <b>karşı banttan trailing STOP</b>.</div>

  <div class="grid">
    <!-- Sol Panel -->
    <div class="card">
      <div class="sec">Proxy & Gate API</div>
      <div class="form">
        <div><label>Proxy Base URL</label><input id="proxy" placeholder="http://localhost:8787"/></div>
        <div><label>Piyasa</label>
          <select id="market"><option value="um" selected>USDT-M Perp</option><option value="cm">Coin-M Perp</option></select>
        </div>
        <div><label>Gate API Key</label><input id="apiKey" placeholder="Kamu anahtar"/></div>
        <div><label>Gate API Secret</label><input id="apiSecret" placeholder="GİZLİ anahtar" type="password"/></div>
      </div>

      <div class="sec">Firestore Sinyal Kaynağı</div>
      <div class="form">
        <div><label>Project ID</label><input id="fs_projectId" value="macbot-b7b45"/></div>
        <div><label>API Key</label><input id="fs_apiKey" value="AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To"/></div>
        <div><label>App ID</label><input id="fs_appId" value="1:88494187419:web:9e0fd1a37e51332203373e"/></div>
        <div><label>Auth Domain</label><input id="fs_authDomain" value="macbot-b7b45.firebaseapp.com"/></div>
        <div class="form full" style="padding-top:0">
          <div><label>Collection adı</label><input id="fs_col" value="gate_mac_logs"/></div>
          <div class="row">
            <button id="fs_init" class="ghost">Firestore Bağlan</button>
            <span id="fs_stat" class="muted">Bağlı değil</span>
          </div>
        </div>
      </div>

      <div class="sec">Sinyal → Emir Parametreleri</div>
      <div class="form">
        <div><label>Semboller (Gate kontrat formatı)</label><input id="symbols" value="BTC_USDT"/></div>
        <div><label>FS Sembol Formatı</label>
          <select id="fs_sym_fmt"><option value="auto" selected>Auto (BTC_USDT → BTCUSDT)</option><option value="same">Aynı</option></select>
        </div>
        <div><label>Kaldıraç (x)</label><input id="lev" type="number" min="1" value="10"/></div>
        <div><label>Tutar (USDT)</label><input id="usd" type="number" min="5" value="50"/></div>
        <div><label>Buffer (bps)</label><input id="bps" type="number" min="0" value="3"/></div>
        <div><label>Tick (sn)</label><input id="tick" type="number" min="1" value="3"/></div>
      </div>

      <div class="form full">
        <div class="row" style="padding:0 14px 14px;">
          <button id="start">START</button>
          <button id="stop" class="ghost">STOP</button>
          <span class="muted">Uyarı: API Secret’ı tarayıcıda kullanmak risklidir—sadece yerel testte.</span>
        </div>
      </div>
    </div>

    <!-- Sağ Panel -->
    <div class="card">
      <div class="sec">Durum</div>
      <div class="kpis">
        <div class="tag">Loop: <span id="loop" class="badge">STOPPED</span></div>
        <div class="tag">Son tick: <span id="lastTick" class="badge">-</span></div>
        <div class="tag">FS: <span id="fsBadge" class="badge">disconnected</span></div>
        <div class="tag">Hata: <span id="err" class="badge">-</span></div>
      </div>
      <div class="sec">Semboller</div>
      <div class="list" id="symList"></div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <div class="footer">Eğitim amaçlıdır. Gerçek işlem yüksek risk taşır; sorumluluk size aittir.</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/* ============ Yardımcılar ============ */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const nowMs = ()=> Date.now();
const fmt = n => (n==null||isNaN(n))?'-':(+n).toLocaleString(undefined,{maximumFractionDigits:8});
const bpsToMult = bps => 1 + (bps/10000);
const toFsSymbol = (gateContract, fmtMode='auto')=>{
  if(fmtMode==='same') return gateContract;
  // "BTC_USDT" -> "BTCUSDT"
  return (gateContract||'').toUpperCase().replace('_','');
};
const toGateContract = (symLike)=>{
  if(!symLike) return symLike;
  if(symLike.includes('_')) return symLike.toUpperCase();
  if(symLike.toUpperCase().endsWith('USDT')){
    const base = symLike.slice(0, -4);
    return `${base.toUpperCase()}_USDT`;
  }
  return symLike.toUpperCase();
};

/* ============ Firestore ============ */
let FS=null;                 // firestore instance
let FS_OK=false;             // bağlandı mı
let SNAP_MODE='listen';      // 'listen' ya da 'poll'
const signals = {};          // symbol -> {ts_ms, close, upper, lower, mid, in_channel, ...}

async function fsInit(){
  try{
    const cfg = { apiKey:qs('fs_apiKey').value.trim(), authDomain:qs('fs_authDomain').value.trim(),
                  projectId:qs('fs_projectId').value.trim(), appId:qs('fs_appId').value.trim() };
    const app = firebase.initializeApp(cfg, 'fs-bot-'+Math.random());
    FS = firebase.firestore(app);
    FS_OK = true;
    qs('fs_stat').textContent = 'Bağlı';
    qs('fsBadge').textContent = 'connected';
  }catch(e){
    FS_OK = false;
    qs('fs_stat').textContent = 'Hata: '+e.message;
    qs('fsBadge').textContent = 'error';
  }
}

function attachFsListener(sym){
  // symbol alanına göre en son doküman (onSnapshot) — index gerekebilir
  const col = qs('fs_col').value.trim();
  const symFS = toFsSymbol(sym, qs('fs_sym_fmt').value);
  const ref = FS.collection(col).where('symbol','==',symFS).orderBy('ts_ms','desc').limit(1);
  try{
    return ref.onSnapshot(snap=>{
      if(snap.empty) return;
      const doc = snap.docs[0].data();
      signals[sym] = doc;
    }, err=>{
      // Index yoksa fallback
      SNAP_MODE='poll';
    });
  }catch(e){
    SNAP_MODE='poll';
    return null;
  }
}
async function pollFsLatest(sym){
  // Index yoksa: son 50 kaydı çek, symbol eşleşeni bul
  const col = qs('fs_col').value.trim();
  const symFS = toFsSymbol(sym, qs('fs_sym_fmt').value);
  const ref = FS.collection(col).orderBy('ts_ms','desc').limit(50);
  try{
    const snap = await ref.get();
    let found = null;
    snap.forEach(d=>{
      const x = d.data();
      if((x.symbol||'').toUpperCase()===symFS) { if(!found || (x.ts_ms>found.ts_ms)) found=x; }
    });
    if(found) signals[sym] = found;
  }catch(e){
    // ignore; statusta göster
    qs('status').textContent = 'Firestore polling hata: '+e.message;
  }
}

/* ============ Proxy API ============ */
async function proxyCall(path, body){
  const base = qs('proxy').value.trim();
  if(!base) throw new Error('Proxy Base URL boş');
  const url = base.replace(/\/+$/,'') + path;
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const j = await r.json().catch(()=>({ok:false,error:'invalid json'}));
  if(!r.ok || j.ok===false) throw new Error((j && j.error) ? (typeof j.error==='string'? j.error : JSON.stringify(j.error)) : (r.status+' '+r.statusText));
  return j;
}

/* ============ Bot State & UI ============ */
let looping = false;
const st = {};  // symbol -> { position, working, price, u,l,m, orderLong:{id,price}, orderShort:{id,price}, stopId, stopPrice }

function uiSetErr(msg){ qs('err').textContent = msg || '-'; }
function uiSetTick(){ qs('lastTick').textContent = new Date().toLocaleTimeString(); }
function renderRows(){
  const list = qs('symList'); list.innerHTML='';
  Object.keys(st).forEach(sym=>{
    const s = st[sym] || {};
    const sig = signals[sym] || {};
    const el = document.createElement('div'); el.className='sym';
    el.innerHTML = `
      <div class="s">${sym}</div>
      <div><span class="badge">Fiyat</span><div>${fmt(sig.close)}</div></div>
      <div><span class="badge">U</span><div>${fmt(sig.upper)}</div></div>
      <div><span class="badge">M</span><div>${fmt(sig.mid)}</div></div>
      <div><span class="badge">L</span><div>${fmt(sig.lower)}</div></div>
      <div><span class="badge">Poz</span><div>${s.position||'-'}</div></div>
      <div><span class="badge">Çalışan</span><div>${s.working||'-'}</div></div>
      <div><span class="badge">Stop</span><div>${fmt(s.stopPrice)}</div></div>
      <div><button class="ghost" onclick="flatten('${sym}')">Flatten</button></div>
    `;
    list.appendChild(el);
  });
}

/* ============ Emir Akışı ============ */
async function cancelIf(apiKey, apiSecret, market, orderId){
  if(!orderId) return;
  try{ await proxyCall('/gate/cancelOrder', { apiKey, apiSecret, market, orderId }); }
  catch(e){ /* normal/price_order ayrımı, proxy zaten fallback dener */ }
}

async function manageSymbol(sym){
  const apiKey = qs('apiKey').value.trim();
  const apiSecret = qs('apiSecret').value.trim();
  const market = qs('market').value;
  const lev = +qs('lev').value || 10;
  const usd = +qs('usd').value || 50;
  const bps = +qs('bps').value || 0;

  const sig = signals[sym];
  if(!sig || sig.upper==null || sig.lower==null || sig.close==null) return;

  // State init
  if(!st[sym]) st[sym] = { position:'NONE', working:'-', stopId:null, stopPrice:null, orderLong:null, orderShort:null, entry:null };
  const S = st[sym];

  // Semboller
  const contract = toGateContract(sym); // UI kontratı zaten Gate formatında; yine de normalize edelim

  // Miktar: USDT / close
  const sizeAbs = Math.max(0.0001, (+usd) / (+sig.close));

  // Kanal içinde mi?
  const inside = !!sig.in_channel;

  // Hedef fiyatlar (bps buffer)
  const longPx  = +(sig.upper * bpsToMult(bps)).toFixed(8);
  const shortPx = +(sig.lower / bpsToMult(bps)).toFixed(8);

  // Kanal içi: iki limit emir → 3 sn’de update
  if(inside){
    // LONG limit (size > 0)
    if(!S.orderLong || Math.abs(S.orderLong.price - longPx)/longPx > 0.0001){
      await cancelIf(apiKey, apiSecret, market, S.orderLong?.id);
      const pl = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, contract, side:'buy',
        price: longPx, size: +sizeAbs, leverage: lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderLong = { id: pl.data?.id, price: longPx };
    }
    // SHORT limit (size < 0)
    if(!S.orderShort || Math.abs(S.orderShort.price - shortPx)/shortPx > 0.0001){
      await cancelIf(apiKey, apiSecret, market, S.orderShort?.id);
      const ps = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, contract, side:'sell',
        price: shortPx, size: -sizeAbs, leverage: lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderShort = { id: ps.data?.id, price: shortPx };
    }
    S.working = `L@${S.orderLong?.price ?? '-'} / S@${S.orderShort?.price ?? '-'}`;
  }else{
    // Kanal dışına çıktı -> bekleyenleri kapat
    if(S.orderLong?.id){ await cancelIf(apiKey, apiSecret, market, S.orderLong.id); S.orderLong=null; }
    if(S.orderShort?.id){ await cancelIf(apiKey, apiSecret, market, S.orderShort.id); S.orderShort=null; }
    S.working = '-';
  }

  // Basit dolum tetik (Firestore close ile)
  const price = +sig.close;
  if(S.orderLong && price >= S.orderLong.price){
    // LONG doldu → karşı taraf iptal + STOP (lower band)
    if(S.orderShort?.id){ await cancelIf(apiKey, apiSecret, market, S.orderShort.id); S.orderShort=null; }
    S.position = 'LONG'; S.entry = S.orderLong.price; S.orderLong=null; S.working='-';
    const stopPx = sig.lower;
    if(stopPx){
      const stp = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, contract, side:'sell',
        price: stopPx, size: +sizeAbs, leverage: lev,
        type:'stop', stopPrice: stopPx, stopType:'down', reduceOnly:true, tif:'gtc'
      });
      S.stopId = stp.data?.id; S.stopPrice = stopPx;
    }
  } else if(S.orderShort && price <= S.orderShort.price){
    // SHORT doldu → karşı taraf iptal + STOP (upper band)
    if(S.orderLong?.id){ await cancelIf(apiKey, apiSecret, market, S.orderLong.id); S.orderLong=null; }
    S.position = 'SHORT'; S.entry = S.orderShort.price; S.orderShort=null; S.working='-';
    const stopPx = sig.upper;
    if(stopPx){
      const stp = await proxyCall('/gate/placeOrder', {
        apiKey, apiSecret, market, contract, side:'buy',
        price: stopPx, size: -sizeAbs, leverage: lev,
        type:'stop', stopPrice: stopPx, stopType:'up', reduceOnly:true, tif:'gtc'
      });
      S.stopId = stp.data?.id; S.stopPrice = stopPx;
    }
  }

  // Trailing STOP (band değişirse)
  if(S.position==='LONG' && S.stopId && sig.lower && Math.abs(sig.lower - (S.stopPrice||0))/Math.max(S.stopPrice||1,1) > 0.0005){
    await cancelIf(apiKey, apiSecret, market, S.stopId);
    const st2 = await proxyCall('/gate/placeOrder', {
      apiKey, apiSecret, market, contract, side:'sell',
      price: sig.lower, size: +sizeAbs, leverage: lev,
      type:'stop', stopPrice: sig.lower, stopType:'down', reduceOnly:true, tif:'gtc'
    });
    S.stopId = st2.data?.id; S.stopPrice = sig.lower;
  }
  if(S.position==='SHORT' && S.stopId && sig.upper && Math.abs(sig.upper - (S.stopPrice||0))/Math.max(S.stopPrice||1,1) > 0.0005){
    await cancelIf(apiKey, apiSecret, market, S.stopId);
    const st2 = await proxyCall('/gate/placeOrder', {
      apiKey, apiSecret, market, contract, side:'buy',
      price: sig.upper, size: -sizeAbs, leverage: lev,
      type:'stop', stopPrice: sig.upper, stopType:'up', reduceOnly:true, tif:'gtc'
    });
    S.stopId = st2.data?.id; S.stopPrice = sig.upper;
  }
}

async function flatten(sym){
  // Basit flatten: varsa stop ve bekleyenleri iptal et, ardından reduce_only market emri at (long ise sell, short ise buy).
  const apiKey = qs('apiKey').value.trim();
  const apiSecret = qs('apiSecret').value.trim();
  const market = qs('market').value;
  const lev = +qs('lev').value || 10;
  const sig = signals[sym]; if(!sig) return;
  const S = st[sym] || {};
  const contract = toGateContract(sym);
  const sizeAbs = Math.max(0.0001, (+qs('usd').value || 50) / (+sig.close || 1));

  // Bekleyenleri / stopu kapat
  await cancelIf(apiKey, apiSecret, market, S.orderLong?.id);  S.orderLong=null;
  await cancelIf(apiKey, apiSecret, market, S.orderShort?.id); S.orderShort=null;
  await cancelIf(apiKey, apiSecret, market, S.stopId);         S.stopId=null; S.stopPrice=null;

  if(S.position==='LONG'){
    await proxyCall('/gate/placeOrder', { apiKey, apiSecret, market, contract, side:'sell',
      price: "0", size: +sizeAbs, leverage: lev, type:'limit', reduceOnly:true, tif:'ioc' });
  }else if(S.position==='SHORT'){
    await proxyCall('/gate/placeOrder', { apiKey, apiSecret, market, contract, side:'buy',
      price: "0", size: -sizeAbs, leverage: lev, type:'limit', reduceOnly:true, tif:'ioc' });
  }
  S.position='NONE'; st[sym]=S; renderRows();
}

/* ============ Döngüler ============ */
const fsUnsubs = {}; // sym->unsubscribe func

async function start(){
  if(!FS){ await fsInit(); }
  if(!FS_OK){ uiSetErr('Firestore bağlanamadı'); return; }

  const symbols = qs('symbols').value.split(',').map(s=>s.trim()).filter(Boolean).map(toGateContract);
  symbols.forEach(sym=>{ if(!st[sym]) st[sym]={}; });

  // FS listeners/pollers
  SNAP_MODE='listen';
  for(const sym of symbols){
    if(fsUnsubs[sym]) { fsUnsubs[sym](); fsUnsubs[sym]=null; }
    const unsub = attachFsListener(sym);
    if(unsub) fsUnsubs[sym]=unsub;
  }

  // Eğer index yoksa/patladıysa polling fallback
  setTimeout(()=>{ if(SNAP_MODE==='poll'){ qs('fsBadge').textContent='polling'; } }, 1500);

  let pollingTimer=null;
  if(SNAP_MODE==='poll'){
    pollingTimer = setInterval(async ()=>{
      for(const sym of symbols) await pollFsLatest(sym);
    }, 2000);
  }

  // Bot loop
  looping = true; qs('loop').textContent = 'RUNNING'; uiSetErr('-'); renderRows();
  const tickSec = Math.max(1, +qs('tick').value || 3);
  (async function loop(){
    while(looping){
      try{
        for(const sym of symbols){
          // snapshot geldiyse manage
          if(signals[sym]) await manageSymbol(sym);
        }
        uiSetTick(); renderRows();
        await sleep(tickSec*1000);
      }catch(e){
        uiSetErr(e.message||String(e));
        await sleep(1000);
      }
    }
    if(pollingTimer) clearInterval(pollingTimer);
  })();
}

function stop(){
  looping=false; qs('loop').textContent='STOPPED';
  for(const k in fsUnsubs){ try{ fsUnsubs[k](); }catch{} delete fsUnsubs[k]; }
}

qs('start').addEventListener('click', start);
qs('stop').addEventListener('click', stop);
qs('fs_init').addEventListener('click', fsInit);
</script>
</body>
</html>
