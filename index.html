<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MEXC Futures ↔ Spot — En Hızlı Tahta Farkı (WS, Tek Dosya)</title>
<style>
  :root{
    --bg:#0b1220; --fg:#e6edf7; --muted:#9fb0c9; --panel:#0f1629; --panel2:#111a2e; --border:#1a2a4a;
    --spot:#16a34a; --fut:#f59e0b; --danger:#ef4444; --ok:#22c55e;
    --fontRow:18px; --padY:12px; --padX:10px; --gap:8px; --radius:12px; --maxW:1220px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#556176; --panel:#f3f6fb; --panel2:#ffffff; --border:#d8e1ef;
    --spot:#16a34a; --fut:#d97706;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),transparent)}
  .wrap{max-width:var(--maxW);margin:0 auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .legend{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .spot{background:var(--spot)} .fut{background:var(--fut)}
  .chip{background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:var(--panel2);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:var(--spot)}
  input,select{background:var(--panel2);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px}
  label{font-size:12px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px;margin-top:10px}
  .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
  #topCard{margin:12px 0;padding:12px 14px;border-radius:16px;background:var(--panel2);border:1px solid var(--border);display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
  #topCard.hidden{display:none}
  #topAction{font-weight:900}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--gap)}
  thead th{font-size:14px;color:var(--muted);text-align:left;padding:0 8px}
  tbody td{padding:var(--padY) var(--padX);font-size:var(--fontRow);background:var(--panel2);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
  tbody tr td:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
  .alCell,.satCell,.pctCell{text-align:center;font-weight:800}
  .src-spot{background:var(--spot) !important;color:#091220}
  .src-fut{background:var(--fut) !important;color:#111}
  .pctPos{color:var(--ok);font-weight:800} .pctNeg{color:var(--danger);font-weight:800}
  .blink{animation:blink 1s ease-in-out 1} @keyframes blink{50%{opacity:.55}}
  .note{color:var(--muted);font-size:12px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipx{background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset;cursor:pointer;color:var(--muted)}
  .good{color:#22c55e;font-weight:900} .bad{color:#ef4444;font-weight:900}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>MEXC Futures ↔ Spot (Tahta 1) Fark — Ultra Hızlı (WS)</h1>
      <div class="legend chip"><span class="dot spot"></span>SPOT (Kırmızı=ASK, Yeşil=BID) <span class="dot fut"></span>FUTURES (Kırmızı=ASK, Yeşil=BID)</div>
      <div class="chip">BTC Futures (bid/ask): <b id="btc" class="mono">—</b></div>
      <div class="chip">Saat: <span id="clock" class="mono">—:—:—</span></div>
      <div style="margin-left:auto" class="row">
        <label>Tema</label>
        <select id="themeSel"><option value="dark">Koyu</option><option value="light">Beyaz</option></select>
      </div>
    </div>

    <div id="topCard" class="card">
      <span id="topSym" style="font-weight:800;font-size:22px">—</span>
      <span id="topAction" class="mono">—</span>
      <span id="topPrice" class="mono" style="font-weight:700">—</span>
      <span id="topPct" class="mono" style="font-weight:800">—</span>
      <span class="note">Kural: Spot ASK ↔ Futures BID/ASK. BID>ASK ⇒ <b>FUTURES SHORT</b> • ASK<BID ⇒ <b>FUTURES LONG</b>.</span>
    </div>

    <div class="controls">
      <div class="card">
        <label for="addSym">Coin ekle (örn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
        <div class="row" style="margin-top:6px">
          <input id="addSym" type="text" placeholder="Sembol"/>
          <button id="btnAdd" class="btn">Ekle</button>
          <button id="btnClear" class="btn">Tümünü Sil</button>
        </div>
        <div id="chipWrap" class="chips" style="margin-top:8px"></div>
        <div class="note" style="margin-top:6px">Sadece eklediklerin izlenir; liste kayıtlı kalır.</div>
      </div>

      <div class="card">
        <label>Render hızı (ms)</label>
        <select id="speed">
          <option value="0">Otomatik (raf)</option>
          <option value="8">8 ms (~120 fps)</option>
          <option value="16" selected>16 ms (~60 fps)</option>
          <option value="33">33 ms (~30 fps)</option>
          <option value="50">50 ms</option>
          <option value="100">100 ms</option>
        </select>
        <div class="note" style="margin-top:6px">Veri push’a bağlıdır; bu sadece DOM minimum aralığıdır.</div>
      </div>

      <div class="card">
        <label>SPOT WS interval</label>
        <select id="wsInt">
          <option value="10" selected>10 ms (en hızlı)</option>
          <option value="100">100 ms</option>
        </select>
        <div class="note" style="margin-top:6px">Kanal: <code>...bookTicker.v3.api.pb@{10|100}ms@SYMBOL</code></div>
      </div>

      <div class="card">
        <label for="thresh">Fark eşiği (%)</label>
        <input id="thresh" type="number" step="0.01" value="0.10"/>
        <div class="note" style="margin-top:6px">Bu yüzdeyi aşan farklar listelenir (AL taban fiyatına göre).</div>
      </div>

      <div class="card">
        <label>Görünüm</label>
        <div style="margin-top:6px" class="row">
          <label class="row"><input type="checkbox" id="toggleTop" checked/> En yüksek fark kartı</label>
          <label class="row"><input type="checkbox" id="onlySpotAl"/> Sadece <b>SPOT ALIŞ</b> olanlar</label>
        </div>
        <div class="note" style="margin-top:6px">SPOT ALIŞ filtresi açıkken yalnız Spot ASK < Futures BID durumları listelenir.</div>
      </div>

      <div class="card">
        <label>Bilgi</label>
        <div class="note" style="margin-top:6px">
          Spot bookTicker **WebSocket**: `wss://wbs-api.mexc.com/ws` (eski `wss://wbs.mexc.com/ws` devre dışı).<br/>
          Kanal: <code>spot@public.aggre.bookTicker.v3.api.pb@10ms@SYMBOL</code> (en iyi bid/ask gerçek zamanlı).<br/>
          Futures: `wss://contract.mexc.com/edge` <code>sub.ticker</code>.
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding:12px 0">
  <table>
    <thead>
      <tr><th>Coin</th><th>AL (Ucuz)</th><th>SAT (Pahalı)</th><th>% Fark</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <p class="note" style="margin:10px 2px">Not: Net kârlılık komisyon, slipaj, funding vb. faktörlere bağlıdır.</p>
</main>

<script>
/* ============ Yardımcılar ============ */
const $ = s=>document.querySelector(s);
const now=()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const num = v => (typeof v === 'number') ? v : parseFloat(v);
const fmt9 = v => {
  const n = (typeof v === 'string') ? parseFloat(v) : v;
  if (!isFinite(n)) return '—'; return n.toFixed(9);
};
const pct = p => isFinite(p) ? ((p>=0?'+':'') + p.toFixed(3) + '%') : '—';

/* ============ Durum ============ */
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('mxf:list')||'[]')), // "BTC_USDT"
  spot: new Map(),   // key: "BTC_USDT" -> {bid, ask, bidStr, askStr, ts}
  fut: new Map(),    // key: "BTC_USDT" -> {bid1, ask1, last, ...}
  ui: {
    speed:+(localStorage.getItem('mxf:speed')||16),
    wsInt:+(localStorage.getItem('mxf:wsInt')||10),
    thresh:+(localStorage.getItem('mxf:thresh')||0.10),
    theme: localStorage.getItem('mxf:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('mxf:showTop')||'true'),
    onlySpotAl: JSON.parse(localStorage.getItem('mxf:onlySpotAl')||'false')
  },
  timers:{ clock:null },
  lastRender:0,
  rafScheduled:false
};
function saveUI(){
  localStorage.setItem('mxf:speed',S.ui.speed);
  localStorage.setItem('mxf:wsInt',S.ui.wsInt);
  localStorage.setItem('mxf:thresh',S.ui.thresh);
  localStorage.setItem('mxf:theme',S.ui.theme);
  localStorage.setItem('mxf:showTop',S.ui.showTop);
  localStorage.setItem('mxf:onlySpotAl',S.ui.onlySpotAl);
}
function saveList(){ localStorage.setItem('mxf:list', JSON.stringify([...S.coins])); }

/* ============ Tema & Saat ============ */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };
S.timers.clock=setInterval(()=>$('#clock').textContent=now(), 1000);
applyTheme();

/* ============ UI bağlama ============ */
$('#speed').value = String(S.ui.speed);
$('#wsInt').value = String(S.ui.wsInt);
$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#onlySpotAl').checked = !!S.ui.onlySpotAl;

$('#speed').onchange = e=>{ S.ui.speed=+e.target.value; saveUI(); };
$('#wsInt').onchange = e=>{ S.ui.wsInt=+e.target.value; saveUI(); spotShardManager.resubAll(); };
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); scheduleDraw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop = e.target.checked; saveUI(); scheduleDraw(); };
$('#onlySpotAl').onchange = e=>{ S.ui.onlySpotAl = e.target.checked; saveUI(); scheduleDraw(); };

/* coin chipleri */
function renderChips(){
  const wrap = $('#chipWrap'); wrap.innerHTML = '';
  const frag = document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d = document.createElement('div'); d.className='chipx';
    const b = document.createElement('b'); b.textContent = sym.replace('_','');
    const x = document.createElement('button'); x.textContent='✕';
    x.onclick=()=>{ removeSymbol(sym); };
    d.appendChild(b); d.appendChild(x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
function addSymbol(raw){
  let sym = raw.includes('_')? raw : raw.replace('USDT','_USDT');
  sym = sym.replace(/[^A-Z0-9_]/g,'');
  if(!sym.endsWith('_USDT')) return alert('Sadece *_USDT sembolleri.');
  if(!S.coins.has(sym)){
    S.coins.add(sym); saveList(); renderChips();
    spotShardManager.subscribe(sym); futWs.sub(sym); scheduleDraw();
  }
}
function removeSymbol(sym){
  if(S.coins.delete(sym)){ saveList(); renderChips();
    spotShardManager.unsubscribe(sym); futWs.unsub(sym); S.spot.delete(sym); S.fut.delete(sym); scheduleDraw();
  }
}
$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase(); if(!raw) return;
  addSymbol(raw); $('#addSym').value='';
};
$('#btnClear').onclick = ()=>{
  if(confirm('Tüm coinleri sil?')){
    [...S.coins].forEach(s=>{ spotShardManager.unsubscribe(s); futWs.unsub(s); });
    S.coins.clear(); saveList(); renderChips(); S.spot.clear(); S.fut.clear(); scheduleDraw();
  }
};
renderChips();

/* ============ Spot WS Sharding (bookTicker) ============ */
/*
  MEXC Spot V3 WS (yeni): wss://wbs-api.mexc.com/ws  (eski wss://wbs.mexc.com/ws devre dışı — 4 Aug 2025)
  Kanal: spot@public.aggre.bookTicker.v3.api.pb@{10ms|100ms}@BTCUSDT
  Fields: publicbookticker.bidprice / askprice
*/
class SpotShard {
  constructor(name){
    this.name = name;
    this.ws = null;
    this.set = new Set(); // symbols
    this.connected = false;
    this._pingTimer = null;
    this._reopenTimer = null;
    this.open();
  }
  url(){ return 'wss://wbs-api.mexc.com/ws'; }
  open(){
    try{ if(this.ws) this.ws.close(); }catch{}
    const ws = new WebSocket(this.url()); this.ws = ws;
    ws.onopen = ()=>{ this.connected=true; this._keepAlive(); this._resubscribe(); };
    ws.onclose = ()=>{ this.connected=false; this._stopKeepAlive(); clearTimeout(this._reopenTimer); this._reopenTimer=setTimeout(()=>this.open(), 800); };
    ws.onerror = ()=>{ try{ws.close()}catch{} };
    ws.onmessage = (ev)=>{
      let d = ev.data;
      try{
        if(d instanceof ArrayBuffer){ d = new TextDecoder().decode(d); }
        const j = JSON.parse(d);
        // Beklenen: {"channel":"spot@public.aggre.bookTicker.v3.api.pb@10ms@BTCUSDT","publicbookticker":{...},"symbol":"BTCUSDT","sendtime":...}
        if(j && j.publicbookticker && j.symbol){
          const sym = j.symbol.includes('_') ? j.symbol : (j.symbol+'_USDT'); // normalize
          const bk = j.publicbookticker;
          const bid = num(bk.bidprice), ask = num(bk.askprice);
          if(isFinite(bid) && isFinite(ask)){
            S.spot.set(sym, { bid, ask, bidStr:fmt9(bk.bidprice), askStr:fmt9(bk.askprice), ts:Date.now() });
            scheduleDraw();
          }
        }
      }catch(_){}
    };
  }
  _keepAlive(){
    this._pingTimer = setInterval(()=>{ try{ this.ws?.send(JSON.stringify({method:'PING'})); }catch{} }, 15000);
  }
  _stopKeepAlive(){ clearInterval(this._pingTimer); this._pingTimer=null; }
  _resubscribe(){
    if(!this.connected) return;
    // birden çok sembol aynı SUBSCRIPTION params dizisinde gönderilebilir
    if(this.set.size===0) return;
    const params = [...this.set].map(sym=>{
      const s = sym.replace('_','');
      return `spot@public.aggre.bookTicker.v3.api.pb@${S.ui.wsInt}ms@${s}`;
    });
    try{ this.ws.send(JSON.stringify({method:'SUBSCRIPTION', params})); }catch{}
  }
  subscribe(sym){ this.set.add(sym); if(this.connected){
    const s = sym.replace('_','');
    const ch = `spot@public.aggre.bookTicker.v3.api.pb@${S.ui.wsInt}ms@${s}`;
    try{ this.ws.send(JSON.stringify({method:'SUBSCRIPTION', params:[ch]})); }catch{}
  }}
  unsubscribe(sym){ if(this.set.delete(sym) && this.connected){
    const s = sym.replace('_','');
    const ch = `spot@public.aggre.bookTicker.v3.api.pb@${S.ui.wsInt}ms@${s}`;
    try{ this.ws.send(JSON.stringify({method:'UNSUBSCRIPTION', params:[ch]})); }catch{}
  }}
  close(){ try{ this.ws?.close(); }catch{} this._stopKeepAlive(); }
}
const spotShardManager = {
  shards: [],
  MAX_PER: 25, // 30 sınırın altında güvenli
  getShardFor(sym){
    // mevcut shardlardan en az yüklü olanını seç
    let best = this.shards[0];
    for(const sh of this.shards){ if(sh.set.size < (best?.set.size ?? 1e9)) best = sh; }
    if(!best || best.set.size >= this.MAX_PER){
      best = new SpotShard('S'+(this.shards.length+1)); this.shards.push(best);
    }
    return best;
  },
  subscribe(sym){ const sh = this.getShardFor(sym); sh.subscribe(sym); },
  unsubscribe(sym){ for(const sh of this.shards) if(sh.set.has(sym)) sh.unsubscribe(sym); },
  resubAll(){ // wsInt değişince tüm abonelikleri baştan gönder
    for(const sh of this.shards){ sh.close(); }
    this.shards = [];
    for(const sym of S.coins) this.subscribe(sym);
  }
};
// başlangıç abonelikleri:
for(const sym of S.coins) spotShardManager.subscribe(sym);

/* ============ Futures WS (ticker) ============ */
const futWs = {
  ws:null, set:new Set(), _ping:null, _reopen:null,
  open(){
    try{ this.ws?.close(); }catch{}
    const ws = new WebSocket('wss://contract.mexc.com/edge'); this.ws = ws;
    ws.onopen = ()=>{
      this._ping = setInterval(()=>{ try{ ws.send(JSON.stringify({method:'ping'})); }catch{} }, 15000);
      // BTC + mevcut abonelikler
      try{ ws.send(JSON.stringify({method:'sub.ticker', param:{symbol:'BTC_USDT'}})); }catch{}
      try{ ws.send(JSON.stringify({method:'sub.index.price', param:{symbol:'BTC_USDT'}})); }catch{}
      for(const s of this.set){ this._subOne(s); }
    };
    ws.onclose = ()=>{ clearInterval(this._ping); clearTimeout(this._reopen); this._reopen=setTimeout(()=>this.open(), 800); };
    ws.onerror = ()=>{ try{ws.close()}catch{} };
    ws.onmessage = (ev)=>{
      try{
        const j = JSON.parse(ev.data);
        if(j.channel==='push.ticker' && j.data){
          const s=j.symbol; const d=j.data;
          const last=num(d.lastPrice), bid1=num(d.bid1), ask1=num(d.ask1);
          const m=S.fut.get(s)||{};
          m.last=last; m.lastStr=fmt9(d.lastPrice);
          m.bid1=bid1; m.bidStr=fmt9(d.bid1);
          m.ask1=ask1; m.askStr=fmt9(d.ask1);
          m.ts=Date.now(); S.fut.set(s,m);
          if(s==='BTC_USDT') $('#btc').textContent = `${m.bidStr || '—'} / ${m.askStr || '—'} USDT`;
          scheduleDraw();
        }
      }catch(_){}
    };
  },
  _subOne(sym){
    try{ this.ws?.send(JSON.stringify({method:'sub.ticker', param:{symbol:sym}})); }catch{}
    try{ this.ws?.send(JSON.stringify({method:'sub.index.price', param:{symbol:sym}})); }catch{}
  },
  sub(sym){ this.set.add(sym); if(this.ws?.readyState===1) this._subOne(sym); },
  unsub(sym){ if(this.set.delete(sym)){
    try{ this.ws?.send(JSON.stringify({method:'unsub.ticker', param:{symbol:sym}})); }catch{}
    try{ this.ws?.send(JSON.stringify({method:'unsub.index.price', param:{symbol:sym}})); }catch{}
  }},
};
futWs.open();

/* ============ Hesaplama (AL taban) ============ */
function computeRows(){
  const thr = Number(S.ui.thresh)||0;
  const rows=[];
  for(const sym of S.coins){
    const f=S.fut.get(sym); const sb=S.spot.get(sym);
    if(!f || !sb) continue;
    const futBid=f.bid1, futAsk=f.ask1; if(!isFinite(futBid)||!isFinite(futAsk)) continue;
    const spotAsk=sb.ask, spotBid=sb.bid;

    let best=null;
    // SPOT AL (ASK) vs FUTURES SAT (BID) -> FUTURES SHORT
    if(isFinite(spotAsk) && isFinite(futBid) && futBid > spotAsk){
      const p1 = (futBid - spotAsk) / spotAsk * 100;
      if(p1 >= thr){
        best = {
          sym, low:spotAsk, high:futBid, pct:p1,
          lowSrc:'spot', highSrc:'fut',
          lowStr: sb.askStr, highStr: f.bidStr,
          action: 'FUTURES SHORT',
          futPrice: f.bidStr, spotPrice: sb.askStr
        };
      }
    }
    // FUTURES AL (ASK) vs SPOT SAT (BID) -> FUTURES LONG
    if(isFinite(futAsk) && isFinite(spotBid) && spotBid > futAsk){
      const p2 = (spotBid - futAsk) / futAsk * 100;
      if(p2 >= thr){
        const alt = {
          sym, low:futAsk, high:spotBid, pct:p2,
          lowSrc:'fut', highSrc:'spot',
          lowStr: f.askStr, highStr: sb.bidStr,
          action: 'FUTURES LONG',
          futPrice: f.askStr, spotPrice: sb.bidStr
        };
        if(!best || alt.pct > best.pct) best = alt;
      }
    }
    if(!best) continue;
    if(S.ui.onlySpotAl && best.lowSrc!=='spot') continue;
    rows.push(best);
  }
  rows.sort((a,b)=> b.pct - a.pct);
  return rows;
}

/* ============ Çizim (raf) ============ */
function draw(){
  const minGap = S.ui.speed|0; // ms
  const nowt = performance.now();
  if(minGap>0 && (nowt - S.lastRender) < minGap) return; // throttle
  S.lastRender = nowt;

  const rows = computeRows();

  // Top card
  const top=$('#topCard');
  if(!S.ui.showTop || rows.length===0){ top.classList.add('hidden'); }
  else{
    top.classList.remove('hidden');
    const r=rows[0];
    $('#topSym').textContent = r.sym.replace('_','');
    $('#topAction').innerHTML = r.action.includes('LONG') ? '<span class="good">FUTURES LONG</span>' : '<span class="bad">FUTURES SHORT</span>';
    $('#topPrice').textContent = `${r.futPrice} USDT`;
    $('#topPct').textContent = pct(r.pct);
    top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 200);
  }

  // Tablo
  const tb=$('#tbody');
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    const tdC=document.createElement('td'); tdC.textContent=r.sym.replace('_',''); tdC.style.fontWeight='800';
    const tdL=document.createElement('td'); tdL.className='alCell mono ' + (r.lowSrc==='spot'?'src-spot':'src-fut'); tdL.textContent=r.lowStr;
    const tdH=document.createElement('td'); tdH.className='satCell mono ' + (r.highSrc==='spot'?'src-spot':'src-fut'); tdH.textContent=r.highStr;
    const tdP=document.createElement('td'); tdP.className='pctCell mono'; tdP.innerHTML=`<span class="${r.pct>=0?'pctPos':'pctNeg'}">${pct(r.pct)}</span>`;
    tr.append(tdC,tdL,tdH,tdP); frag.appendChild(tr);
  }
  tb.replaceChildren(frag);
  $('#clock').textContent = now();
}
function scheduleDraw(){
  if(S.rafScheduled) return;
  S.rafScheduled = true;
  requestAnimationFrame(()=>{ S.rafScheduled=false; draw(); });
}

/* ============ Başlat ============ */
(function start(){
  // mevcut coinler için futures abonelikleri
  for(const sym of S.coins) futWs.sub(sym);
  // periyodik saat
  setInterval(()=>$('#clock').textContent=now(), 1000);
  // ilk çizim
  scheduleDraw();
})();
</script>
</body>
</html>
