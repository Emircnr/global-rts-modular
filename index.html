<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures — MAC (MA Channel) Bot + Firestore (Tek Dosya)</title>
<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --warn:#f59e0b;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:16px; --maxW:1280px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:400 var(--font)/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:var(--maxW);margin:auto;padding:24px}
  h1{font-weight:800;font-size:28px;margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 20px}
  .grid{display:grid;gap:var(--gap)}
  .row{display:grid;gap:var(--gap);grid-template-columns:repeat(12,1fr)}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:var(--padY) var(--padX);box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button,textarea{
    width:100%;border:1px solid var(--border);background:var(--glass);color:var(--fg);
    border-radius:12px;padding:10px 12px;font:500 14px/1.3 ui-sans-serif,system-ui;outline:none
  }
  input::placeholder{color:#7f92b7}
  button{cursor:pointer;background:linear-gradient(180deg,#3a6ef6,#2551c9);border:none}
  button.secondary{background:linear-gradient(180deg,#334155,#1f2937)}
  button.good{background:linear-gradient(180deg,#22c55e,#198c43)}
  button.bad{background:linear-gradient(180deg,#ef4444,#b91c1c)}
  button.warn{background:linear-gradient(180deg,#f59e0b,#b45309)}
  .hint{font-size:12px;color:#93a7cd;margin-top:6px}
  .switch{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-flex;gap:8px;background:var(--glass);border:1px solid var(--border);padding:6px 8px;border-radius:999px;align-items:center}
  .log{white-space:pre-wrap;max-height:400px;overflow:auto;background:#0b1222;border:1px dashed var(--border);border-radius:12px;padding:12px}
  .tbl{width:100%;border-collapse:collapse;font-size:14px}
  .tbl th,.tbl td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  .tag{display:inline-flex;gap:6px;align-items:center;background:var(--glass);border:1px solid var(--border);padding:4px 8px;border-radius:999px;margin:2px 4px}
  .tag b{color:#cfe1ff}
  .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}
  .col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-9{grid-column:span 9}.col-12{grid-column:span 12}
  @media (max-width:1000px){.row>[class^="col-"]{grid-column:span 12}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Gate.io Futures — MA Channel Bot (Firestore)</h1>
  <p class="sub">Proxy & API → Firebase bağlan → Coin listesi → Tutar (USDT) & Kaldıraç → <b>Başlat</b>. Fiyat kanal <i>içindeyse</i> üst banda LONG, alt banda SHORT <u>GTC</u> limit emirleri saniyede 1 güncellenir; biri dolarsa diğeri iptal edilir ve iptal edilen seviye <b>reduce-only takip stop</b> olarak izlenir.</p>

  <!-- Bağlantı -->
  <div class="card grid">
    <div class="title"><h3>Gate.io Bağlantı</h3></div>
    <div class="row">
      <div class="col-3">
        <label>Çevre</label>
        <select id="env">
          <option value="mainnet" selected>Mainnet</option>
          <option value="testnet">Testnet</option>
        </select>
        <div class="hint">Testnet seçince Proxy URL otomatik <code>/testnet</code> ile kullanılır.</div>
      </div>
      <div class="col-5">
        <label>Proxy Base URL</label>
        <input id="proxy" placeholder="örn. http://localhost:8787"/>
        <div class="hint">Mainnet: <code>http://localhost:8787</code> — Testnet: <code>http://localhost:8787/testnet</code></div>
      </div>
      <div class="col-4">
        <label>Doğrudan API Host (proxy yoksa)</label>
        <input id="host" value="https://api.gateio.ws" placeholder="https://api.gateio.ws"/>
      </div>
      <div class="col-6">
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="api v4 key"/>
      </div>
      <div class="col-6">
        <label>API Secret</label>
        <input id="apiSecret" type="password" placeholder="api v4 secret"/>
      </div>
      <div class="col-12 switch">
        <label class="pill"><input id="remember" type="checkbox"/> Bu tarayıcıda hatırla</label>
        <button id="saveConn" class="secondary">Kaydet</button>
        <button id="btnTime" class="secondary">Sunucu Saati</button>
        <button id="btnCancelAll" class="warn">Tüm Açık Emirleri İptal (Seçili coinler)</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <div class="card grid">
    <div class="title"><h3>Firebase (Firestore)</h3></div>
    <div class="row">
      <div class="col-4"><label>apiKey</label><input id="fb_apiKey" value="AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To"/></div>
      <div class="col-4"><label>authDomain</label><input id="fb_authDomain" value="macbot-b7b45.firebaseapp.com"/></div>
      <div class="col-4"><label>projectId</label><input id="fb_projectId" value="macbot-b7b45"/></div>
      <div class="col-4"><label>storageBucket</label><input id="fb_storageBucket" value="macbot-b7b45.firebasestorage.app"/></div>
      <div class="col-4"><label>messagingSenderId</label><input id="fb_msg" value="88494187419"/></div>
      <div class="col-4"><label>appId</label><input id="fb_appId" value="1:88494187419:web:9e0fd1a37e51332203373e"/></div>
      <div class="col-4"><label>measurementId (ops.)</label><input id="fb_measurementId" value="G-SVG851WK7Y"/></div>
      <div class="col-4"><label>Kaynak Tipi</label>
        <select id="fb_src_type">
          <option value="docPattern" selected>Doc Pattern</option>
          <option value="collectionLatest">Collection (ts_ms desc, limit 1)</option>
        </select>
      </div>
      <div class="col-8"><label>Doc Pattern / Koleksiyon</label>
        <input id="fb_path" value="signals/{symbol}" placeholder="ör. signals/{symbol} veya mac_signals"/>
        <div class="hint">Doc Pattern: <code>{symbol}</code> yer tutucu (örn. <b>signals/BTCUSDT</b>). Collection: her coin için <b>where('symbol','==',...)</b> + <b>orderBy('ts_ms','desc').limit(1)</b>.</div>
      </div>
      <div class="col-12 switch">
        <label class="pill">upper=<input id="fld_upper" value="upper" style="width:110px"/></label>
        <label class="pill">lower=<input id="fld_lower" value="lower" style="width:110px"/></label>
        <label class="pill">mid=<input id="fld_mid" value="mid" style="width:110px"/></label>
        <label class="pill">close=<input id="fld_close" value="close" style="width:110px"/></label>
        <label class="pill">symbol=<input id="fld_symbol" value="symbol" style="width:110px"/></label>
        <label class="pill">ts_ms=<input id="fld_ts" value="ts_ms" style="width:110px"/></label>
      </div>
      <div class="col-12 switch">
        <button id="btnFbConnect" class="good">Firebase Bağlan</button>
        <div class="hint">Bağlandıktan sonra coinler için canlı dinleme başlar (Başlat deyince emir döngüsü çalışır).</div>
      </div>
    </div>
  </div>

  <!-- Strateji -->
  <div class="card grid">
    <div class="title"><h3>Strateji ve Emir Parametreleri</h3></div>
    <div class="row">
      <div class="col-3"><label>Settle</label>
        <select id="settle">
          <option value="usdt" selected>USDT</option>
          <option value="btc">BTC</option>
        </select>
      </div>
      <div class="col-3"><label>Kaldıraç</label>
        <div class="stack">
          <input id="leverage" type="number" min="0" max="125" step="1" value="10"/>
          <button id="btnSetLev" class="secondary">Ayarla</button>
        </div>
        <div class="hint">0=cross, >0=izole</div>
      </div>
      <div class="col-3"><label>Tutar (USDT)</label><input id="usdt" type="number" min="5" step="1" value="50"/></div>
      <div class="col-3"><label>Güncelleme Sıklığı</label>
        <select id="hz">
          <option value="1000" selected>1 Hz (1 sn)</option>
          <option value="500">2 Hz (0.5 sn)</option>
          <option value="2000">0.5 Hz (2 sn)</option>
        </select>
      </div>

      <div class="col-8">
        <label>Coinler (virgülle):</label>
        <input id="coins" value="BTCUSDT,ETHUSDT" placeholder="örn. BTCUSDT,ETHUSDT"/>
        <div class="hint">Sembol → Kontrat eşlemesi otomatik: <b>BTCUSDT → BTC_USDT</b></div>
      </div>
      <div class="col-4">
        <label>Aktarım</label>
        <div class="switch">
          <label class="pill"><input id="reduceOnlyStops" type="checkbox" checked/> Reduce-only Stop (tavsiye)</label>
          <label class="pill"><input id="dryRun" type="checkbox"/> Dry-Run (emir atma, sadece log)</label>
        </div>
      </div>
      <div class="col-12 switch">
        <button id="btnStart" class="good">Başlat</button>
        <button id="btnStop" class="bad">Durdur</button>
      </div>
    </div>
  </div>

  <!-- Durum -->
  <div class="card grid">
    <div class="title"><h3>Durum</h3></div>
    <div class="row">
      <div class="col-12">
        <table class="tbl" id="tbl">
          <thead><tr><th>Kontrat</th><th>Close</th><th>Lower</th><th>Upper</th><th>İçeride mi?</th><th>LongID</th><th>ShortID</th><th>Pozisyon</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <div class="title"><h3>Log</h3></div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ====================== Yardımcılar ====================== */
const $ = id => document.getElementById(id);
const enc = new TextEncoder();
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function appendLog(msg, obj){
  const el = $('log'); const t = new Date().toLocaleTimeString();
  el.textContent = `[${t}] ${msg}\n` + (obj? JSON.stringify(obj,null,2)+'\n':'') + el.textContent;
}
function toContract(sym){ // BTCUSDT -> BTC_USDT
  if(sym.includes('_')) return sym.toUpperCase();
  return sym.replace(/USDT$/i, '_USDT').replace(/BTC$/i,'_BTC').toUpperCase();
}
function fmt(x, d=6){ if(x==null||isNaN(x)) return '-'; return Number(x).toFixed(d); }
function qs(obj){ const p = new URLSearchParams(); Object.entries(obj||{}).forEach(([k,v])=>{ if(v!==undefined&&v!==null&&v!=='') p.append(k, String(v)); }); return p.toString(); }

/* ====================== Gate.io API ====================== */
function buildBase(){
  const env = $('env').value;          // mainnet | testnet
  const proxy = $('proxy').value.trim().replace(/\/+$/,'');
  const host = $('host').value.trim().replace(/\/+$/,'') || 'https://api.gateio.ws';
  if(proxy){
    if(env==='testnet' && !/\/testnet$/.test(proxy)) return proxy + '/testnet';
    return proxy;
  }
  if(env==='testnet'){ return 'https://api-testnet.gateapi.io'; }
  return host;
}
async function sha512Hex(s){ const buf = await crypto.subtle.digest('SHA-512', enc.encode(s||'')); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function hmac512Hex(secret, message){
  const key = await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-512'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function signHeaders({method, urlPath, queryString, bodyString, apiKey, apiSecret}){
  const ts = Math.floor(Date.now()/1000).toString();
  const bodyHash = await sha512Hex(bodyString || "");
  const sigStr = `${method.toUpperCase()}\n${urlPath}\n${queryString||""}\n${bodyHash}\n${ts}`;
  const SIGN = await hmac512Hex(apiSecret, sigStr);
  return { KEY: apiKey, Timestamp: ts, SIGN, __sig_debug:{sigStr, bodyHash} };
}
async function apiV4({method='GET', endpoint='', queryObj=null, bodyObj=null}){
  const base = buildBase();
  const path = `/api/v4${endpoint}`;
  const queryString = qs(queryObj||{});
  const url = `${base}${path}${queryString?`?${queryString}`:''}`;
  const apiKey = $('apiKey').value.trim();
  const apiSecret = $('apiSecret').value.trim();
  if(!apiKey || !apiSecret) throw new Error('API Key/Secret eksik');
  const bodyString = bodyObj ? JSON.stringify(bodyObj) : '';
  const sig = await signHeaders({method, urlPath:path, queryString, bodyString, apiKey, apiSecret});
  const headers = {'Accept':'application/json','Content-Type':'application/json','KEY':sig.KEY,'Timestamp':sig.Timestamp,'SIGN':sig.SIGN};
  appendLog('REQ', {method,url,path,queryString,body:bodyObj||null, sign_debug:sig.__sig_debug});
  const res = await fetch(url, {method, headers, body: bodyString || undefined});
  const text = await res.text(); let data; try{ data = text? JSON.parse(text):{} }catch(e){ data = { raw:text } }
  if(!res.ok){ const label = (data && (data.label||data.message)) ? `${data.label||''} ${data.message||''}`.trim() : `HTTP ${res.status}`; throw new Error(`${label} (status ${res.status})`); }
  return data;
}

/* Sık kullanılan Gate çağrıları */
async function getContractSpec(settle, contract){
  return apiV4({method:'GET', endpoint:`/futures/${settle}/contracts/${encodeURIComponent(contract)}`});
}
async function setLeverage(settle, contract, lev){
  return apiV4({method:'POST', endpoint:`/futures/${settle}/positions/${encodeURIComponent(contract)}/leverage`, queryObj:{ leverage:String(lev) }});
}
async function placeOrder(settle, body){ return apiV4({method:'POST', endpoint:`/futures/${settle}/orders`, bodyObj: body}); }
async function cancelOrders(settle, contract){ return apiV4({method:'DELETE', endpoint:`/futures/${settle}/orders`, queryObj:{ contract }}); }
async function listOpenOrders(settle, contract){ return apiV4({method:'GET', endpoint:`/futures/${settle}/orders`, queryObj:{ contract, status:'open' }}); }
async function getPosition(settle, contract){ return apiV4({method:'GET', endpoint:`/futures/${settle}/positions/${encodeURIComponent(contract)}`); }

/* ====================== Firestore ====================== */
let fbApp=null, db=null;
const feeds = {};   // { contract: { unsub: fn, last:{upper,lower,mid,close,ts_ms}, symbol, spec:{}, orders:{longId, shortId, stopId}, pos:{size:0}, trailing:{active:false, side:null} } }

function fbConfigFromUI(){
  return {
    apiKey: $('fb_apiKey').value.trim(),
    authDomain: $('fb_authDomain').value.trim(),
    projectId: $('fb_projectId').value.trim(),
    storageBucket: $('fb_storageBucket').value.trim(),
    messagingSenderId: $('fb_msg').value.trim(),
    appId: $('fb_appId').value.trim(),
    measurementId: $('fb_measurementId').value.trim() || undefined
  };
}
function startFeedForSymbol(sym){
  const symbol = sym.trim().toUpperCase();
  if(!symbol) return;
  const contract = toContract(symbol);
  if(feeds[contract]?.unsub){ feeds[contract].unsub(); }
  feeds[contract] = { unsub:null, last:null, symbol, spec:null, orders:{}, pos:{size:0}, trailing:{active:false, side:null} };

  const fldU=$('fld_upper').value, fldL=$('fld_lower').value, fldM=$('fld_mid').value, fldC=$('fld_close').value, fldS=$('fld_symbol').value, fldT=$('fld_ts').value;
  const srcType = $('fb_src_type').value, path = $('fb_path').value.trim();

  if(srcType==='docPattern'){
    const docPath = path.replace('{symbol}', symbol);
    const [col, docId] = (docPath.includes('/') ? docPath.split('/') : [docPath, symbol]);
    const ref = db.collection(col).doc(docId);
    feeds[contract].unsub = ref.onSnapshot(snap=>{
      if(!snap.exists) return;
      const d = snap.data()||{};
      feeds[contract].last = { upper:Number(d[fldU]), lower:Number(d[fldL]), mid:Number(d[fldM]), close:Number(d[fldC]), ts_ms:Number(d[fldT]||Date.now()) };
      feeds[contract].symbol = (d[fldS] || symbol);
      renderRow(contract);
    }, err=>appendLog('Firestore hata: '+err.message));
  }else{
    // collectionLatest
    const col = path;
    feeds[contract].unsub = db.collection(col)
      .where($('fld_symbol').value, '==', symbol)
      .orderBy($('fld_ts').value, 'desc').limit(1)
      .onSnapshot(qs=>{
        qs.forEach(snap=>{
          const d = snap.data()||{};
          feeds[contract].last = { upper:Number(d[fldU]), lower:Number(d[fldL]), mid:Number(d[fldM]), close:Number(d[fldC]), ts_ms:Number(d[fldT]||Date.now()) };
          feeds[contract].symbol = (d[fldS] || symbol);
          renderRow(contract);
        });
      }, err=>appendLog('Firestore hata: '+err.message));
  }
  appendLog('Firestore dinleme başladı: '+contract);
}

/* ====================== Tablo ====================== */
function renderRow(contract){
  const tb = $('tbody');
  let tr = tb.querySelector(`tr[data-ct="${contract}"]`);
  if(!tr){ tr = document.createElement('tr'); tr.setAttribute('data-ct', contract); tb.appendChild(tr); }
  const feed = feeds[contract];
  const L = feed?.last || {};
  const inside = (L && isFinite(L.lower) && isFinite(L.upper) && isFinite(L.close)) ? (L.close > L.lower && L.close < L.upper) : false;
  const posSz = feed.pos?.size || 0;
  tr.innerHTML = `
    <td><span class="tag"><b>${contract}</b></span></td>
    <td>${fmt(L.close, 4)}</td>
    <td>${fmt(L.lower, 4)}</td>
    <td>${fmt(L.upper, 4)}</td>
    <td>${inside ? '<span class="tag" style="border-color:#22c55e">EVET</span>' : '<span class="tag" style="border-color:#ef4444">HAYIR</span>'}</td>
    <td>${feed.orders.longId||'-'}</td>
    <td>${feed.orders.shortId||'-'}</td>
    <td>${posSz}</td>
  `;
}

/* ====================== Strateji Döngüsü ====================== */
let loopTimer = null;

async function ensureSpecLoaded(settle, contract){
  if(feeds[contract].spec) return feeds[contract].spec;
  const spec = await getContractSpec(settle, contract);
  // tahmini alanlar
  const tick = Number(spec.tick_size || spec.order_price_round || 0.1);
  const sizeInc = Number(spec.order_size_increment || 1);
  const qmul = Number(spec.quanto_multiplier || 1);
  feeds[contract].spec = { tick, sizeInc, qmul };
  appendLog('Spec yüklendi: '+contract, feeds[contract].spec);
  return feeds[contract].spec;
}
function roundTo(x, step){ if(!step) return x; return Math.round(x/step)*step; }
function floorTo(x, step){ if(!step) return Math.floor(x/step)*step; return Math.floor(x/step)*step; }

async function computeSizeFromUSDT(settle, contract, price){
  const { qmul, sizeInc } = await ensureSpecLoaded(settle, contract);
  const usdt = Number($('usdt').value)||0;
  if(usdt<=0 || !price) return 0;
  const baseQty = usdt/price; // coin miktarı
  let size = baseQty / (qmul || 1); // kontrat adedi
  size = Math.floor(size / (sizeInc||1)) * (sizeInc||1); // adımına yuvarla
  return Math.max(size, 0);
}

async function refreshPosition(settle, contract){
  try{
    const p = await getPosition(settle, contract);
    // Gate dönen format: size (pozitif long / negatif short) bekliyoruz
    feeds[contract].pos = { size: Number(p.size||0) };
    renderRow(contract);
  }catch(e){ appendLog('Pozisyon sorgu hata: '+contract+' '+e.message); }
}

async function updatePairOrders(settle, contract){
  const f = feeds[contract]; if(!f || !f.last) return;
  const { upper, lower, close } = f.last;
  const { tick } = await ensureSpecLoaded(settle, contract);
  const inside = close > lower && close < upper;
  const dry = $('dryRun').checked;

  // aktif pozisyonu güncelle
  await refreshPosition(settle, contract);
  const pos = f.pos.size || 0;

  // Eğer pozisyon açık ise: karşı taraftaki emri iptal + trailing stop’u güncelle
  if(pos !== 0){
    // long pozisyon: stop=lower band; short pozisyon: stop=upper band
    const stopPrice = pos>0 ? lower : upper;
    // reduce-only limit (soft stop)
    if(!dry){
      // önce karşı emri iptal
      try{
        const opens = await listOpenOrders(settle, contract);
        for(const o of opens){
          if((pos>0 && o.size<0) || (pos<0 && o.size>0)){ // karşı emir
            try{ await apiV4({method:'DELETE', endpoint:`/futures/${settle}/orders/${encodeURIComponent(o.id)}`}); }catch{}
          }
        }
      }catch(e){/* yok say */}
      // mevcut stop varsa fiyat farkı büyükse güncelle (iptal+yenile)
      if(f.orders.stopId){
        try{
          const opens = await listOpenOrders(settle, contract);
          const cur = opens.find(o=> String(o.id)===String(f.orders.stopId));
          const needPx = roundTo(stopPrice, tick);
          if(!cur || Math.abs(Number(cur.price)-needPx) >= tick){
            // iptal ve yeniden
            try{ if(cur) await apiV4({method:'DELETE', endpoint:`/futures/${settle}/orders/${encodeURIComponent(cur.id)}`}); }catch{}
            const body = {
              contract, tif:'GTC', text:`stop-${Date.now()}`, reduce_only: $('reduceOnlyStops').checked!==false
            };
            if(pos>0){ body.size = -Math.abs(await computeSizeFromUSDT(settle, contract, close)); body.price = String(needPx); }
            else     { body.size =  Math.abs(await computeSizeFromUSDT(settle, contract, close)); body.price = String(needPx); }
            const out = await placeOrder(settle, body);
            f.orders.stopId = out?.id;
            appendLog('Stop yenilendi: '+contract, out);
          }
        }catch(e){ appendLog('Stop güncelle hata: '+contract+' '+e.message); }
      }else{
        try{
          const needPx = roundTo(stopPrice, tick);
          const body = {
            contract, tif:'GTC', text:`stop-${Date.now()}`, reduce_only: $('reduceOnlyStops').checked!==false
          };
          if(pos>0){ body.size = -Math.abs(await computeSizeFromUSDT(settle, contract, close)); body.price = String(needPx); }
          else     { body.size =  Math.abs(await computeSizeFromUSDT(settle, contract, close)); body.price = String(needPx); }
          const out = await placeOrder(settle, body);
          f.orders.stopId = out?.id; appendLog('Stop kondu: '+contract, out);
        }catch(e){ appendLog('Stop koyma hata: '+contract+' '+e.message); }
      }
    }
    return; // pozisyon varken çift emir kurmuyoruz
  }

  // Pozisyon yokken: kanal içindeyse çift taraflı bekleyen emirler
  if(!inside){
    // içeride değil: var ise açık emirleri iptal
    if(!dry){ try{ await cancelOrders(settle, contract); f.orders.longId=null; f.orders.shortId=null; f.orders.stopId=null; }catch{} }
    return;
  }

  // İçeride → üst banda LONG (BUY, pozitif size), alt banda SHORT (SELL, negatif size)
  const size = await computeSizeFromUSDT(settle, contract, close);
  if(size<=0){ appendLog('Size 0, atlanıyor: '+contract); return; }

  // Long
  const needLongPx = roundTo(upper, (await ensureSpecLoaded(settle, contract)).tick);
  if(!f.orders.longId){
    if(!dry){
      try{
        const body={ contract, size:+Math.abs(size), tif:'GTC', price:String(needLongPx), text:`long-${Date.now()}` };
        const out=await placeOrder(settle, body); f.orders.longId=out?.id; appendLog('LONG yerleştirildi: '+contract, out);
      }catch(e){ appendLog('LONG yerleştirme hata: '+contract+' '+e.message); }
    }
  }else{
    // fiyat değiştiyse iptal+yenile
    if(!dry){
      try{
        const opens = await listOpenOrders(settle, contract);
        const cur = opens.find(o=> String(o.id)===String(f.orders.longId));
        if(!cur || Math.abs(Number(cur.price)-needLongPx) >= (await ensureSpecLoaded(settle, contract)).tick){
          try{ if(cur) await apiV4({method:'DELETE', endpoint:`/futures/${settle}/orders/${encodeURIComponent(cur.id)}`}); }catch{}
          const body={ contract, size:+Math.abs(size), tif:'GTC', price:String(needLongPx), text:`long-${Date.now()}` };
          const out=await placeOrder(settle, body); f.orders.longId=out?.id; appendLog('LONG güncellendi: '+contract, out);
        }
      }catch(e){ appendLog('LONG update hata: '+contract+' '+e.message); }
    }
  }

  // Short
  const needShortPx = roundTo(lower, (await ensureSpecLoaded(settle, contract)).tick);
  if(!f.orders.shortId){
    if(!dry){
      try{
        const body={ contract, size:-Math.abs(size), tif:'GTC', price:String(needShortPx), text:`short-${Date.now()}` };
        const out=await placeOrder(settle, body); f.orders.shortId=out?.id; appendLog('SHORT yerleştirildi: '+contract, out);
      }catch(e){ appendLog('SHORT yerleştirme hata: '+contract+' '+e.message); }
    }
  }else{
    if(!dry){
      try{
        const opens = await listOpenOrders(settle, contract);
        const cur = opens.find(o=> String(o.id)===String(f.orders.shortId));
        if(!cur || Math.abs(Number(cur.price)-needShortPx) >= (await ensureSpecLoaded(settle, contract)).tick){
          try{ if(cur) await apiV4({method:'DELETE', endpoint:`/futures/${settle}/orders/${encodeURIComponent(cur.id)}`}); }catch{}
          const body={ contract, size:-Math.abs(size), tif:'GTC', price:String(needShortPx), text:`short-${Date.now()}` };
          const out=await placeOrder(settle, body); f.orders.shortId=out?.id; appendLog('SHORT güncellendi: '+contract, out);
        }
      }catch(e){ appendLog('SHORT update hata: '+contract+' '+e.message); }
    }
  }
}

async function strategyLoop(){
  const settle = $('settle').value;
  const hz = Number($('hz').value)||1000;

  // coinler
  const coins = ($('coins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  for(const sym of coins){
    const ct = toContract(sym);
    if(!feeds[ct]) startFeedForSymbol(sym);
    // kontrat spec ve kaldıraç önbellekle
    try{ await ensureSpecLoaded(settle, ct); }catch(e){ appendLog('Spec hata: '+ct+' '+e.message); }
  }

  // döngü
  clearInterval(loopTimer);
  loopTimer = setInterval(async ()=>{
    for(const contract of Object.keys(feeds)){
      try{
        await updatePairOrders(settle, contract);
        renderRow(contract);
      }catch(e){ appendLog('Loop hata: '+contract+' '+e.message); }
    }
  }, hz);
}

/* ====================== UI Bağlantılar ====================== */
(function init(){
  // load cfg
  try{ const s=JSON.parse(localStorage.getItem('gateio_mac_cfg')||'{}');
    if(s){ ['env','proxy','host','settle','coins','usdt','leverage','hz','fb_apiKey','fb_authDomain','fb_projectId','fb_storageBucket','fb_msg','fb_appId','fb_measurementId','fb_src_type','fb_path','fld_upper','fld_lower','fld_mid','fld_close','fld_symbol','fld_ts'].forEach(k=>{ if(s[k]!=null) $(k).value=s[k]; });
      if(s.remember){ $('remember').checked=true; ['apiKey','apiSecret'].forEach(k=>{ if(s[k]) $(k).value=s[k]; }); }
    }
  }catch{}

  $('saveConn').addEventListener('click', ()=>{
    const remember = $('remember').checked;
    const keys = ['env','proxy','host','settle','coins','usdt','leverage','hz','fb_apiKey','fb_authDomain','fb_projectId','fb_storageBucket','fb_msg','fb_appId','fb_measurementId','fb_src_type','fb_path','fld_upper','fld_lower','fld_mid','fld_close','fld_symbol','fld_ts'];
    const cfg = Object.fromEntries(keys.map(k=>[k,$(k).value]));
    if(remember){ cfg.remember=true; cfg.apiKey=$('apiKey').value; cfg.apiSecret=$('apiSecret').value; }
    localStorage.setItem('gateio_mac_cfg', JSON.stringify(cfg));
    appendLog('Ayarlar kaydedildi.');
  });

  $('btnTime').addEventListener('click', async ()=>{
    try{
      const out = await apiV4({method:'GET', endpoint:'/spot/time'});
      appendLog('Sunucu saati', out);
    }catch(e){ appendLog('Hata (spot/time): '+e.message); }
  });

  $('btnSetLev').addEventListener('click', async ()=>{
    const settle = $('settle').value, lev=Number($('leverage').value)||0;
    const coins = ($('coins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    for(const sym of coins){
      const ct = toContract(sym);
      try{ const out = await setLeverage(settle, ct, lev); appendLog(`Kaldıraç (${ct}) → ${lev}x`, out); }catch(e){ appendLog(`Kaldıraç hata (${ct}): `+e.message); }
    }
  });

  $('btnCancelAll').addEventListener('click', async ()=>{
    const settle=$('settle').value; const coins = ($('coins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    for(const sym of coins){ const ct=toContract(sym); try{ const out=await cancelOrders(settle, ct); appendLog('İptal (hepsi): '+ct, out); feeds[ct]&& (feeds[ct].orders={}); }catch(e){ appendLog('İptal hata: '+ct+' '+e.message); } }
  });

  $('btnFbConnect').addEventListener('click', ()=>{
    try{
      if(!fbApp){ fbApp = firebase.initializeApp(fbConfigFromUI()); db = firebase.firestore(); appendLog('Firebase bağlandı.'); }
      // coin listesine göre dinleme başlat
      const coins = ($('coins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      coins.forEach(startFeedForSymbol);
    }catch(e){ appendLog('Firebase bağlanma hata: '+e.message); }
  });

  $('btnStart').addEventListener('click', strategyLoop);
  $('btnStop').addEventListener('click', ()=>{
    clearInterval(loopTimer); loopTimer=null;
    appendLog('Döngü durduruldu.');
  });
})();
</script>
</body>
</html>
