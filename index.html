<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures — Tek Dosya Emir Botu (Proxy’li)</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#101a32; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:16px; --maxW:1180px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:400 var(--font)/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:var(--maxW);margin:auto;padding:24px}
  h1{font-weight:700;font-size:28px;margin:0 0 10px}
  .sub{color:var(--muted);margin:0 0 24px}
  .grid{display:grid;gap:var(--gap)}
  .row{display:grid;gap:var(--gap);grid-template-columns:repeat(12,1fr)}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:var(--padY) var(--padX);box-shadow:0 6px 20px rgba(0,0,0,.25)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button,textarea{
    width:100%;border:1px solid var(--border);background:var(--glass);color:var(--fg);
    border-radius:12px;padding:10px 12px;font:500 14px/1.3 ui-sans-serif,system-ui;
    outline:none
  }
  input::placeholder{color:#7f92b7}
  button{cursor:pointer;background:linear-gradient(180deg,#3a6ef6,#2551c9);border:none}
  button.secondary{background:linear-gradient(180deg,#334155,#1f2937)}
  button.good{background:linear-gradient(180deg,#22c55e,#198c43)}
  button.bad{background:linear-gradient(180deg,#ef4444,#b91c1c)}
  .hint{font-size:12px;color:#93a7cd;margin-top:6px}
  .switch{display:flex;gap:10px;align-items:center}
  .stack{display:flex;gap:10px}
  .pill{display:inline-flex;gap:8px;background:var(--glass);border:1px solid var(--border);padding:6px 8px;border-radius:999px;align-items:center}
  .muted{color:var(--muted)}
  .log{white-space:pre-wrap;max-height:360px;overflow:auto;background:#0b1222;border:1px dashed var(--border);border-radius:12px;padding:12px}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
  @media (max-width:900px){.row>[class^="col-"]{grid-column:span 12}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Gate.io Futures — Emir Botu</h1>
  <p class="sub">API & Proxy bilgilerini gir → <b>Kaldıraç</b> ayarla → <b>LONG/SHORT</b> seç → <b>Emir Gönder</b>. Tümü tarayıcıda, tek dosyada.</p>

  <!-- Bağlantı / Kimlik -->
  <div class="card grid">
    <div class="row">
      <div class="col-6">
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="gateio api v4 key"/>
        <div class="hint">Anahtarın en az: <b>Futures Read/Write</b> izni olmalı.</div>
      </div>
      <div class="col-6">
        <label>API Secret</label>
        <input id="apiSecret" type="password" placeholder="gateio api v4 secret"/>
      </div>
      <div class="col-6">
        <label>API Host</label>
        <input id="host" placeholder="https://api.gateio.ws" value="https://api.gateio.ws"/>
        <div class="hint">TestNet: <code>https://api-testnet.gateapi.io</code></div>
      </div>
      <div class="col-6">
        <label>Proxy Base URL (opsiyonel ama önerilir)</label>
        <input id="proxy" placeholder="ör. https://senin-proxy.example.com"/>
        <div class="hint">Proxy, <code>/api/v4/...</code> yolunu hedefe aynen yönlendirmeli ve CORS'ı açmalı.</div>
      </div>
      <div class="col-12 switch">
        <label class="pill"><input id="remember" type="checkbox"/> Bilgileri bu tarayıcıda hatırla (LocalStorage)</label>
        <button class="secondary" id="saveConn">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Sözleşme / Kaldıraç -->
  <div class="card grid">
    <div class="row">
      <div class="col-4">
        <label>Settle</label>
        <select id="settle">
          <option value="usdt" selected>USDT (Perp)</option>
          <option value="btc">BTC (Perp)</option>
        </select>
      </div>
      <div class="col-4">
        <label>Contract (Sembol)</label>
        <input id="contract" placeholder="BTC_USDT" value="BTC_USDT"/>
      </div>
      <div class="col-4">
        <label>Kaldıraç</label>
        <div class="stack">
          <input id="leverage" type="number" min="0" max="125" step="1" value="10"/>
          <button id="setLev" class="good" title="0 = Cross, >0 = Isolated">Kaldıracı Ayarla</button>
        </div>
        <div class="hint">Cross için <b>0</b> gir. İzole için pozitif sayı.</div>
      </div>
    </div>
  </div>

  <!-- Emir -->
  <div class="card grid">
    <div class="row">
      <div class="col-3">
        <label>Emir Tipi</label>
        <select id="orderType">
          <option value="market" selected>Market</option>
          <option value="limit">Limit</option>
        </select>
      </div>
      <div class="col-3">
        <label>Fiyat (Limit için)</label>
        <input id="price" type="number" step="0.0001" placeholder="örn. 65000.0" disabled/>
      </div>
      <div class="col-3">
        <label>Miktar (size, kontrat)</label>
        <input id="size" type="number" step="1" value="1"/>
        <div class="hint">Gate futures’ta <b>size > 0 = BUY (LONG)</b>, <b>size &lt; 0 = SELL (SHORT)</b>.</div>
      </div>
      <div class="col-3">
        <label>Zaman (TIF)</label>
        <select id="tif">
          <option value="gtc" selected>GTC</option>
          <option value="ioc">IOC</option>
          <option value="poc">POC</option>
          <option value="fok">FOK</option>
        </select>
      </div>

      <div class="col-6">
        <label>Yön</label>
        <div class="stack">
          <button id="btnLong" class="good">LONG</button>
          <button id="btnShort" class="bad">SHORT</button>
          <label class="pill"><input id="reduceOnly" type="checkbox"/> Reduce-Only</label>
        </div>
      </div>
      <div class="col-6 stack">
        <button id="sendOrder">Emir Gönder</button>
        <button id="cancelOpen" class="secondary">Açık Emirleri İptal (Bu kontrat)</button>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <label>Log</label>
    <div id="log" class="log"></div>
    <div class="hint">CORS hatası alırsan bir reverse proxy kuracağız (sonraki adımında “SA proxy” dersen bash ile kurulum tarif edeceğim).</div>
  </div>
</div>

<script>
/* ========= Yardımcılar ========= */
const els = id => document.getElementById(id);
const enc = new TextEncoder();

function appendLog(msg, obj){
  const el = els('log');
  const time = new Date().toLocaleTimeString();
  el.textContent = `[${time}] ${msg}\n` + (obj? JSON.stringify(obj,null,2)+'\n':'') + el.textContent;
}

async function sha512Hex(str){
  const buf = await crypto.subtle.digest('SHA-512', enc.encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function hmacSha512Hex(secret, message){
  const key = await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-512'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// İmza başlıkları — Gate API v4
async function signHeaders({method, urlPath, queryString, bodyString, apiKey, apiSecret}){
  const ts = Math.floor(Date.now()/1000).toString(); // saniye
  const bodyHash = await sha512Hex(bodyString || "");
  const sigStr = `${method.toUpperCase()}\n${urlPath}\n${queryString || ""}\n${bodyHash}\n${ts}`;
  const sign = await hmacSha512Hex(apiSecret, sigStr);
  return { 'KEY': apiKey, 'Timestamp': ts, 'SIGN': sign };
}

// Temel istek
async function apiRequest({method='GET', endpoint='', query='', body=null}){
  const apiKey = els('apiKey').value.trim();
  const apiSecret = els('apiSecret').value.trim();
  const host = (els('host').value.trim().replace(/\/+$/,'') || 'https://api.gateio.ws');
  const proxy = els('proxy').value.trim().replace(/\/+$/,'');
  if(!apiKey || !apiSecret){ throw new Error('API Key/Secret eksik'); }

  const path = `/api/v4${endpoint}`;
  const full = `${(proxy || host)}${path}${query ? `?${query}`:''}`;
  const bodyString = body ? JSON.stringify(body) : '';
  const headers = {
    'Accept':'application/json',
    'Content-Type':'application/json',
    ...(await signHeaders({method, urlPath: path, queryString: query, bodyString, apiKey, apiSecret}))
  };

  const res = await fetch(full, { method, headers, body: bodyString || undefined });
  const text = await res.text();
  let data;
  try{ data = text ? JSON.parse(text) : {}; } catch(e){ data = { raw:text }; }
  if(!res.ok){
    const msg = (data && (data.label || data.message)) ? `${data.label||''} ${data.message||''}`.trim() : `HTTP ${res.status}`;
    throw new Error(msg || 'İstek başarısız');
  }
  return data;
}

/* ========= UI Mantığı ========= */
(function init(){
  // localStorage yükle
  try{
    const saved = JSON.parse(localStorage.getItem('gateio_bot_cfg')||'{}');
    if(saved.remember){
      ['apiKey','apiSecret','host','proxy'].forEach(k=>{ if(saved[k]) els(k).value = saved[k]; });
      els('remember').checked = true;
    }else{
      if(saved.host) els('host').value = saved.host;
      if(saved.proxy) els('proxy').value = saved.proxy;
    }
  }catch{}

  els('orderType').addEventListener('change', e=>{
    const isLimit = e.target.value === 'limit';
    els('price').disabled = !isLimit;
    if(!isLimit){ els('tif').value = 'ioc'; } // market için öneri
  });

  els('saveConn').addEventListener('click', ()=>{
    const remember = els('remember').checked;
    const cfg = {
      remember,
      apiKey: remember ? els('apiKey').value : '',
      apiSecret: remember ? els('apiSecret').value : '',
      host: els('host').value,
      proxy: els('proxy').value
    };
    localStorage.setItem('gateio_bot_cfg', JSON.stringify(cfg));
    appendLog('Bağlantı ayarları kaydedildi (localStorage).');
  });

  els('setLev').addEventListener('click', async ()=>{
    try{
      const settle = els('settle').value;
      const contract = els('contract').value.trim();
      const lev = Number(els('leverage').value);
      if(!contract) throw new Error('Contract boş olamaz');
      const q = new URLSearchParams({ leverage: String(lev) }).toString();
      const endpoint = `/futures/${settle}/positions/${encodeURIComponent(contract)}/leverage`;
      appendLog(`Kaldıraç ayarlanıyor: ${contract} → ${lev}x`);
      const out = await apiRequest({ method:'POST', endpoint, query:q });
      appendLog('Kaldıraç sonucu:', out);
    }catch(err){ appendLog('Hata (Kaldıraç): '+err.message); }
  });

  // Long/Short hızlı butonları
  els('btnLong').addEventListener('click', ()=>{ const s=els('size'); s.value = Math.abs(Number(s.value)||1); });
  els('btnShort').addEventListener('click', ()=>{ const s=els('size'); s.value = -Math.abs(Number(s.value)||1); });

  els('sendOrder').addEventListener('click', async ()=>{
    try{
      const settle = els('settle').value;
      const contract = els('contract').value.trim();
      if(!contract) throw new Error('Contract boş olamaz');
      let size = Number(els('size').value);
      if(!size || !Number.isFinite(size)) throw new Error('Geçersiz size');

      const type = els('orderType').value;
      const tif = els('tif').value;
      const reduceOnly = els('reduceOnly').checked;

      let body = { contract, size, tif, text:'t-web-bot' };
      if(type === 'market'){
        // Gate: price=0 + tif=IOC => Market
        body.price = "0";
        if(tif !== 'ioc'){ body.tif = 'ioc'; }
      }else{
        const px = els('price').value;
        if(!px) throw new Error('Limit emri için fiyat gerekli');
        body.price = String(px);
      }
      if(reduceOnly) body.reduce_only = true;

      appendLog('Emir gönderiliyor:', body);
      const out = await apiRequest({ method:'POST', endpoint:`/futures/${settle}/orders`, body });
      appendLog('Emir yanıtı:', out);
    }catch(err){ appendLog('Hata (Emir): '+err.message); }
  });

  els('cancelOpen').addEventListener('click', async ()=>{
    try{
      const settle = els('settle').value;
      const contract = els('contract').value.trim();
      if(!contract) throw new Error('Contract boş olamaz');
      appendLog(`Açık emirler iptal ediliyor: ${contract}`);
      const q = new URLSearchParams({ contract }).toString();
      const out = await apiRequest({ method:'DELETE', endpoint:`/futures/${settle}/orders`, query:q });
      appendLog('İptal sonucu:', out);
    }catch(err){ appendLog('Hata (İptal): '+err.message); }
  });
})();
</script>
</body>
</html>
