<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MEXC Futures ↔ Spot — En İyi Tahta Farkı (Proxy Yok, Tek Dosya)</title>
<style>
  :root{
    --bg:#0b1220; --fg:#e6edf7; --muted:#9fb0c9; --panel:#0f1629; --panel2:#111a2e; --border:#1a2a4a;
    --spot:#16a34a;      /* YEŞİL */
    --fut:#f59e0b;       /* TURUNCU */
    --danger:#ef4444; --ok:#22c55e;
    --fontRow:18px; --padY:12px; --padX:10px; --gap:8px; --radius:12px; --maxW:1220px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#556176; --panel:#f3f6fb; --panel2:#ffffff; --border:#d8e1ef;
    --spot:#16a34a; --fut:#d97706;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),transparent)}
  .wrap{max-width:var(--maxW);margin:0 auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .legend{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .spot{background:var(--spot)} .fut{background:var(--fut)}
  .chip{background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:var(--panel2);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:var(--spot)}
  input,select{background:var(--panel2);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px}
  label{font-size:12px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px;margin-top:10px}
  .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
  #topCard{margin:12px 0;padding:12px 14px;border-radius:16px;background:var(--panel2);border:1px solid var(--border);display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
  #topCard.hidden{display:none}
  #topAction{font-weight:900}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--gap)}
  thead th{font-size:14px;color:var(--muted);text-align:left;padding:0 8px}
  tbody td{padding:var(--padY) var(--padX);font-size:var(--fontRow);background:var(--panel2);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
  tbody tr td:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
  .alCell,.satCell,.pctCell{text-align:center;font-weight:800}
  .src-spot{background:var(--spot) !important;color:#091220}
  .src-fut{background:var(--fut) !important;color:#111}
  .pctPos{color:var(--ok);font-weight:800} .pctNeg{color:var(--danger);font-weight:800}
  .blink{animation:blink 1s ease-in-out 1} @keyframes blink{50%{opacity:.55}}
  .note{color:var(--muted);font-size:12px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipx{background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset;cursor:pointer;color:var(--muted)}
  .good{color:#22c55e;font-weight:900} .bad{color:#ef4444;font-weight:900}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>MEXC Futures ↔ Spot (Tahta 1) Fark (USDT)</h1>
      <div class="legend chip">
        <span class="dot spot"></span>SPOT (Kırmızı=ASK, Yeşil=BID)
        <span class="dot fut"></span>FUTURES (Kırmızı=ASK, Yeşil=BID)
      </div>
      <div class="chip">BTC Futures (bid/ask): <b id="btc" class="mono">—</b></div>
      <div class="chip">Saat: <span id="clock" class="mono">—:—:—</span></div>
      <div style="margin-left:auto" class="row">
        <label>Tema</label>
        <select id="themeSel"><option value="dark">Koyu</option><option value="light">Beyaz</option></select>
      </div>
    </div>

    <!-- EN YÜKSEK FARK KARTI -->
    <div id="topCard" class="card">
      <span id="topSym" style="font-weight:800;font-size:22px">—</span>
      <span id="topAction" class="mono">—</span>
      <span id="topPrice" class="mono" style="font-weight:700">—</span>
      <span id="topPct" class="mono" style="font-weight:800">—</span>
      <span class="note">
        Kural: 
        ① <b>Spot BID</b> (yeşil) vs <b>Futures ASK</b> (kırmızı): <i>Spot BID > Fut ASK</i> ⇒ <b>SPOT SAT + FUTURES AL (LONG)</b>. 
        ② <b>Spot ASK</b> (kırmızı) vs <b>Futures BID</b> (yeşil): <i>Spot ASK < Fut BID</i> ⇒ <b>SPOT AL + FUTURES SAT (SHORT)</b>.
      </span>
    </div>

    <!-- Kontroller -->
    <div class="controls">
      <div class="card">
        <label for="addSym">Coin ekle (örn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
        <div class="row" style="margin-top:6px">
          <input id="addSym" type="text" placeholder="Sembol"/>
          <button id="btnAdd" class="btn">Ekle</button>
          <button id="btnClear" class="btn">Tümünü Sil</button>
        </div>
        <div id="chipWrap" class="chips" style="margin-top:8px"></div>
        <div class="note" style="margin-top:6px">Sadece eklediklerin izlenir; liste kayıtlı kalır.</div>
      </div>

      <div class="card">
        <label for="speed">Görsel yenileme</label>
        <select id="speed">
          <option value="1">0.001 sn</option>
          <option value="5">0.005 sn</option>
          <option value="10">0.01 sn</option>
          <option value="25">0.025 sn</option>
          <option value="50">0.05 sn</option>
          <option value="100">0.1 sn</option>
          <option value="250" selected>0.25 sn</option>
          <option value="500">0.5 sn</option>
          <option value="1000">1 sn</option>
          <option value="2000">2 sn</option>
        </select>
        <div class="note" style="margin-top:6px">Bu sadece DOM güncelleme hızıdır.</div>
      </div>

      <div class="card">
        <label for="spotFreq">SPOT veri yenileme (REST)</label>
        <select id="spotFreq">
          <option value="30">0.03 sn</option>
          <option value="50">0.05 sn</option>
          <option value="75">0.075 sn</option>
          <option value="100" selected>0.10 sn</option>
          <option value="150">0.15 sn</option>
          <option value="200">0.20 sn</option>
          <option value="250">0.25 sn</option>
          <option value="500">0.50 sn</option>
        </select>
        <div class="note" style="margin-top:6px">En iyi bid/ask REST’ten paralel çekilir (CORS engelinde eklenti gerekebilir).</div>
      </div>

      <div class="card">
        <label for="thresh">Fark eşiği (%)</label>
        <input id="thresh" type="number" step="0.01" value="0.10"/>
        <div class="note" style="margin-top:6px">AL bacağı taban alınarak yüzde hesaplanır.</div>
      </div>

      <div class="card">
        <label>Listeyi dışa/içe aktar</label>
        <div class="row" style="margin-top:6px">
          <button id="btnExport" class="btn">Dışa aktar</button>
          <button id="btnImport" class="btn">İçe al</button>
          <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        </div>
      </div>

      <div class="card">
        <label>Görünüm</label>
        <div style="margin-top:6px" class="row">
          <label class="row"><input type="checkbox" id="toggleTop" checked/> En yüksek fark kartı</label>
          <label class="row"><input type="checkbox" id="onlySpotAl"/> Sadece <b>SPOT ALIŞ</b> olanlar</label>
        </div>
        <div class="note" style="margin-top:6px">SPOT ALIŞ filtresi açıkken sadece ② kuralındaki eşleşmeler listelenir.</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding:12px 0">
  <table>
    <thead>
      <tr><th>Coin</th><th>AL (Ucuz)</th><th>SAT (Pahalı)</th><th>% Fark</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <p class="note" style="margin:10px 2px">Not: Net kârlılık komisyon, slipaj, funding vb. etkilenir.</p>

  <!-- BOT PANELİ (opsiyonel; Proxy yoksa CORS engeli olabilir) -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label class="row"><input id="botEnable" type="checkbox"/> Bot Aktif</label>
        <label class="row"><input id="dryRun" type="checkbox" checked/> Dry-Run</label>
      </div>
      <div class="note">✨ Proxy yoksa tarayıcıdan signed endpoint çağrıları CORS’a takılabilir.</div>
    </div>
    <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:10px">
      <div><label>Eşik %</label><br><input id="botTh" type="number" step="0.01" value="0.50" style="width:110px"></div>
      <div><label>Kaldıraç</label><br><input id="leverage" type="number" min="1" max="125" step="1" value="10" style="width:110px"></div>
      <div><label>Tutar (USDT)</label><br><input id="amount" type="number" min="5" step="1" value="50" style="width:120px"></div>
      <div><label>Cooldown (sn)</label><br><input id="cooldown" type="number" min="0" step="1" value="60" style="width:120px"></div>
      <div><label>Marjin</label><br>
        <select id="openType" style="width:140px">
          <option value="1" selected>Isolated</option>
          <option value="2">Cross</option>
        </select>
      </div>
      <div style="flex:1"></div>
      <div><label>MEXC API Key</label><br><input id="apiKey" type="text" placeholder="..." style="min-width:260px"></div>
      <div><label>MEXC API Secret</label><br><input id="apiSecret" type="password" placeholder="..." style="min-width:260px"></div>
    </div>
  </div>
</main>

<script>
/* ===== Küçük yardımcılar ===== */
const $ = s=>document.querySelector(s);
const now=()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const enc = new TextEncoder();
const num = v => (typeof v === 'number') ? v : parseFloat(v);

/* Her yerde 9 ondalık basamak göster */
const fmt9 = v => {
  const n = (typeof v === 'string') ? parseFloat(v) : v;
  return (isFinite(n) ? n.toFixed(9) : '—');
};
const pct = p => isFinite(p) ? ((p>=0?'+':'') + p.toFixed(3) + '%') : '—';

/* ===== Durum ===== */
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('mxf:list')||'[]')), // "BTC_USDT"
  spotBook: new Map(),   // key: "BTC_USDT" val: {bid, ask, bidStr, askStr, ts}
  fut: new Map(),        // key: "BTC_USDT" val: {bid1, ask1, bidStr, askStr, ts}
  ui: {
    speed:+(localStorage.getItem('mxf:speed')||250),     // render ms
    spotMs:+(localStorage.getItem('mxf:spotms')||100),   // spot fetch ms
    thresh:+(localStorage.getItem('mxf:thresh')||0.10),
    theme: localStorage.getItem('mxf:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('mxf:showTop')||'true'),
    onlySpotAl: JSON.parse(localStorage.getItem('mxf:onlySpotAl')||'false')
  },
  timers:{ render:null, clock:null },
  ws:null,                      // Futures WS (derinlik)
  spotTimers:new Map(),         // per-symbol fetch timers
  spotAbort:new Map(),          // per-symbol AbortController
  lastActionAt:0,
  bot: Object.assign({
    enabled:false,dry:true,th:0.50,lev:10,amt:50,cooldown:60,openType:1,key:'',sec:''
  }, JSON.parse(localStorage.getItem('mxf:bot')||'{}'))
};

/* ===== Kaydetme ===== */
function saveUI(){
  localStorage.setItem('mxf:speed',S.ui.speed);
  localStorage.setItem('mxf:spotms',S.ui.spotMs);
  localStorage.setItem('mxf:thresh',S.ui.thresh);
  localStorage.setItem('mxf:theme',S.ui.theme);
  localStorage.setItem('mxf:showTop',S.ui.showTop);
  localStorage.setItem('mxf:onlySpotAl',S.ui.onlySpotAl);
}
function saveList(){ localStorage.setItem('mxf:list', JSON.stringify([...S.coins])); }
function saveBot(){ localStorage.setItem('mxf:bot', JSON.stringify(S.bot)); }

/* ===== Tema & saat ===== */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };
S.timers.clock=setInterval(()=>$('#clock').textContent=now(), 1000);

/* ===== UI bağlama ===== */
$('#speed').value = String(S.ui.speed);
$('#spotFreq').value = String(S.ui.spotMs);
$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#onlySpotAl').checked = !!S.ui.onlySpotAl;
applyTheme();

/* coin chipleri */
function renderChips(){
  const wrap = $('#chipWrap'); wrap.innerHTML = '';
  const frag = document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d = document.createElement('div'); d.className='chipx';
    const b = document.createElement('b'); b.textContent = sym.replace('_','');
    const x = document.createElement('button'); x.textContent='✕';
    x.onclick=()=>removeCoin(sym);
    d.appendChild(b); d.appendChild(x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
function addCoin(rawSym){
  let sym = rawSym.includes('_')? rawSym : rawSym.replace('USDT','_USDT');
  sym = sym.replace(/[^A-Z0-9_]/g,'').toUpperCase();
  if(!sym.endsWith('_USDT')) return alert('Sadece *_USDT sembolleri.');
  if(S.coins.has(sym)) return;
  S.coins.add(sym); saveList(); renderChips();
  wsSub(sym,true);               // FUTURES derinlik WS
  startSpotLoop(sym);            // SPOT REST hızlı döngü
}
function removeCoin(sym){
  wsSub(sym,false);
  stopSpotLoop(sym);
  S.coins.delete(sym); saveList(); renderChips(); draw();
}
renderChips();

$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase(); if(!raw) return;
  addCoin(raw);
  $('#addSym').value=''; draw();
};
$('#btnClear').onclick = ()=>{
  if(confirm('Tüm coinleri sil?')){
    [...S.coins].forEach(s=>removeCoin(s));
  }
};
$('#speed').onchange = e=>{ S.ui.speed=+e.target.value; saveUI(); tickRender(); };
$('#spotFreq').onchange = e=>{ S.ui.spotMs=+e.target.value; saveUI(); resetAllSpotLoops(); };
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); draw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop = e.target.checked; saveUI(); draw(); };
$('#onlySpotAl').onchange = e=>{ S.ui.onlySpotAl = e.target.checked; saveUI(); draw(); };

$('#btnExport').onclick = ()=>{
  const data = JSON.stringify({coins:[...S.coins]}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mexc-list.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('#btnImport').onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text(); const obj=JSON.parse(txt);
    if(Array.isArray(obj.coins)) obj.coins.forEach(s=> addCoin(s));
    draw();
  }catch{ alert('Geçersiz dosya'); }
};

/* ===== Futures WebSocket — DERİNLİK (top of book) ===== */
function wsConnect(){
  if(S.ws) try{S.ws.close()}catch{}
  const ws=new WebSocket('wss://contract.mexc.com/edge'); S.ws=ws;
  ws.onopen=()=>{
    ping();
    // BTC chip için
    ws.send(JSON.stringify({method:'sub.ticker', param:{symbol:'BTC_USDT'}}));
    // Listede olanlar
    [...S.coins].forEach(sym=> wsSub(sym,true));
  };
  ws.onmessage=(ev)=>{
    try{
      const j=JSON.parse(ev.data);

      // TICKER (yalnızca BTC chip ve yedek)
      if(j.channel==='push.ticker' && j.data){
        const s=j.symbol; const d=j.data;
        const m=S.fut.get(s)||{};
        const bid1 = num(d.bid1), ask1 = num(d.ask1);
        if(isFinite(bid1)) { m.bid1=bid1; m.bidStr=fmt9(d.bid1); }
        if(isFinite(ask1)) { m.ask1=ask1; m.askStr=fmt9(d.ask1); }
        m.ts=Date.now(); S.fut.set(s,m);
        if(s==='BTC_USDT') $('#btc').textContent = `${m.bidStr||'—'} / ${m.askStr||'—'} USDT`;
      }

      // DERİNLİK (ana kaynak)
      if(j.channel && j.channel.indexOf('depth')!==-1 && j.data){
        const s=j.symbol;
        const bidsArr = Array.isArray(j.data.bids) ? j.data.bids : [];
        const asksArr = Array.isArray(j.data.asks) ? j.data.asks : [];
        // En iyi seviye: en yüksek bid, en düşük ask
        const bestBid = bidsArr.reduce((acc, it)=>{
          const p = num(Array.isArray(it)? it[0] : it.price);
          const q = num(Array.isArray(it)? it[1] : (it.qty??it.volume));
          return (isFinite(p) && isFinite(q) && q>0 && (acc==null || p>acc.p)) ? {p, q} : acc;
        }, null);
        const bestAsk = asksArr.reduce((acc, it)=>{
          const p = num(Array.isArray(it)? it[0] : it.price);
          const q = num(Array.isArray(it)? it[1] : (it.qty??it.volume));
          return (isFinite(p) && isFinite(q) && q>0 && (acc==null || p<acc.p)) ? {p, q} : acc;
        }, null);
        const m=S.fut.get(s)||{};
        if(bestBid){ m.bid1 = bestBid.p; m.bidStr = fmt9(bestBid.p); }
        if(bestAsk){ m.ask1 = bestAsk.p; m.askStr = fmt9(bestAsk.p); }
        m.ts=Date.now(); S.fut.set(s,m);
      }

    }catch(_){}
  };
  ws.onclose = ()=>setTimeout(wsConnect, 1000);
}
function wsSub(sym,on){
  if(!S.ws || S.ws.readyState!==1) return;
  const method = on?'sub':'unsub';
  // Derinlik: top-of-book için 5 seviye yeter
  S.ws.send(JSON.stringify({method:method+'.depth', param:{symbol:sym, limit:5}}));
  // İsteğe bağlı: ticker da açık kalsın
  S.ws.send(JSON.stringify({method:method+'.ticker', param:{symbol:sym}}));
}
function ping(){ if(S.ws?.readyState===1){ S.ws.send(JSON.stringify({method:'ping'})); setTimeout(ping,15000);} }
wsConnect();

/* ===== SPOT bookTicker (REST) — Paralel hızlı döngü ===== */
const SPOT_BASE='https://api.mexc.com';
async function fetchSpotBookOnce(sym, controller){
  const symbol = sym.replace('_','');
  const r = await fetch(`${SPOT_BASE}/api/v3/ticker/bookTicker?symbol=${symbol}`, {
    cache:'no-store',
    signal: controller.signal,
    keepalive:true
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  const bidStr = fmt9(j.bidPrice);
  const askStr = fmt9(j.askPrice);
  S.spotBook.set(sym, {
    bid: num(j.bidPrice), ask: num(j.askPrice),
    bidStr, askStr, ts: Date.now()
  });
}
function startSpotLoop(sym){
  stopSpotLoop(sym); // temiz başlat
  const loop = async ()=>{
    if(!S.coins.has(sym)) return;
    const ac = new AbortController();
    S.spotAbort.set(sym, ac);
    try{
      await fetchSpotBookOnce(sym, ac);
    }catch(_){ /* sessiz */ }
    finally{
      const t = setTimeout(loop, S.ui.spotMs);
      S.spotTimers.set(sym, t);
    }
  };
  loop();
}
function stopSpotLoop(sym){
  const t = S.spotTimers.get(sym); if(t){ clearTimeout(t); S.spotTimers.delete(sym); }
  const ac = S.spotAbort.get(sym); if(ac){ try{ ac.abort(); }catch{} S.spotAbort.delete(sym); }
}
function resetAllSpotLoops(){
  [...S.coins].forEach(sym=> startSpotLoop(sym));
}

/* ===== HESAPLAMA — İstediğin KURALLARLA =====
   ① Spot BID (yeşil) > Futures ASK (kırmızı)  => SPOT SAT + FUTURES AL (LONG)
      Yüzde = (SpotBID - FutASK) / FutASK * 100   (AL tabanı: futures ask)
   ② Spot ASK (kırmızı) < Futures BID (yeşil)  => SPOT AL + FUTURES SAT (SHORT)
      Yüzde = (FutBID - SpotASK) / SpotASK * 100 (AL tabanı: spot ask)
*/
function computeRows(){
  const thr = Number(S.ui.thresh)||0;
  const rows=[];
  for(const sym of S.coins){
    const f=S.fut.get(sym); const sb=S.spotBook.get(sym);
    if(!f || !sb) continue;

    const spotBid = sb.bid, spotAsk = sb.ask;
    const futBid  = f.bid1, futAsk  = f.ask1;
    if(!isFinite(spotBid)||!isFinite(spotAsk)||!isFinite(futBid)||!isFinite(futAsk)) continue;

    let best = null;

    // ① SPOT SAT + FUTURES AL (LONG) — Spot BID > Fut ASK
    if(spotBid > futAsk){
      const pct1 = (spotBid - futAsk) / futAsk * 100;
      if(pct1 >= thr){
        best = {
          sym,
          low: futAsk, high: spotBid, pct: pct1,
          lowSrc:'fut', highSrc:'spot',
          lowStr: f.askStr, highStr: sb.bidStr,
          action: 'SPOT SAT + FUTURES AL (LONG)',
          futPrice: f.askStr, spotPrice: sb.bidStr
        };
      }
    }

    // ② SPOT AL + FUTURES SAT (SHORT) — Spot ASK < Fut BID
    if(spotAsk < futBid){
      const pct2 = (futBid - spotAsk) / spotAsk * 100;
      if(pct2 >= thr){
        const alt = {
          sym,
          low: spotAsk, high: futBid, pct: pct2,
          lowSrc:'spot', highSrc:'fut',
          lowStr: sb.askStr, highStr: f.bidStr,
          action: 'SPOT AL + FUTURES SAT (SHORT)',
          futPrice: f.bidStr, spotPrice: sb.askStr
        };
        if(!best || alt.pct > best.pct) best = alt;
      }
    }

    if(!best) continue;
    if(S.ui.onlySpotAl && !best.action.includes('SPOT AL')) continue; // sadece ②
    rows.push(best);
  }
  rows.sort((a,b)=> b.pct - a.pct);
  return rows;
}

/* ===== Çizim ===== */
function draw(){
  const rows=computeRows();

  // Top card
  const top=$('#topCard');
  if(!S.ui.showTop || rows.length===0){ top.classList.add('hidden'); }
  else{
    top.classList.remove('hidden');
    const r=rows[0];
    $('#topSym').textContent = r.sym.replace('_','');
    const isLong = r.action.includes('LONG');
    $('#topAction').innerHTML = isLong
      ? '<span class="good">SPOT SAT + FUTURES AL (LONG)</span>'
      : '<span class="bad">SPOT AL + FUTURES SAT (SHORT)</span>';
    // Kartta futures tarafını göster
    $('#topPrice').textContent = `${r.futPrice} USDT`;
    $('#topPct').textContent = pct(r.pct);
    top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 200);
  }

  // Tablo
  const tb=$('#tbody');
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    const tdC=document.createElement('td'); tdC.textContent=r.sym.replace('_',''); tdC.style.fontWeight='800';
    const tdL=document.createElement('td'); tdL.className='alCell mono ' + (r.lowSrc==='spot'?'src-spot':'src-fut'); tdL.textContent=r.lowStr; // AL (ucuz)
    const tdH=document.createElement('td'); tdH.className='satCell mono ' + (r.highSrc==='spot'?'src-spot':'src-fut'); tdH.textContent=r.highStr; // SAT (pahalı)
    const tdP=document.createElement('td'); tdP.className='pctCell mono'; tdP.innerHTML=`<span class="${r.pct>=0?'pctPos':'pctNeg'}">${pct(r.pct)}</span>`;
    tr.append(tdC,tdL,tdH,tdP); frag.appendChild(tr);
  }
  tb.replaceChildren(frag);
  $('#clock').textContent = now();
}
function tickRender(){
  clearInterval(S.timers.render);
  const ms = Math.max(1, Math.min(2000, S.ui.speed|0)); // 1ms–2000ms
  S.timers.render = setInterval(()=>{ draw(); maybeBot(); }, ms);
}
tickRender();

/* ===== BOT ayarları (opsiyonel) ===== */
function bindBot(){
  const g = id=>document.getElementById(id);
  const update=()=>{
    S.bot.enabled = g('botEnable').checked;
    S.bot.dry     = g('dryRun').checked;
    S.bot.th      = parseFloat(g('botTh').value||'0');
    S.bot.lev     = parseInt(g('leverage').value||'10');
    S.bot.amt     = parseFloat(g('amount').value||'50');
    S.bot.cooldown= parseInt(g('cooldown').value||'60');
    S.bot.openType= parseInt(g('openType').value||'1');
    S.bot.key     = g('apiKey').value.trim();
    S.bot.sec     = g('apiSecret').value.trim();
    saveBot();
  };
  ['botEnable','dryRun','botTh','leverage','amount','cooldown','openType','apiKey','apiSecret'].forEach(id=> g(id).addEventListener('change', update));
  // init UI
  g('botEnable').checked = !!S.bot.enabled;
  g('dryRun').checked    = !!S.bot.dry;
  g('botTh').value       = S.bot.th;
  g('leverage').value    = S.bot.lev;
  g('amount').value      = S.bot.amt;
  g('cooldown').value    = S.bot.cooldown;
  g('openType').value    = S.bot.openType;
  g('apiKey').value      = S.bot.key;
  g('apiSecret').value   = S.bot.sec;
}
bindBot();

/* ===== MEXC REST (SIGNED) — emir (opsiyonel; CORS olabilir) ===== */
const BASE = 'https://contract.mexc.com';
async function hmacHex(key, str){
  const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(key), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(str));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function mexcSigned(path, method='POST', bodyObj=null){
  const reqTime = Date.now().toString();
  const body = bodyObj ? JSON.stringify(bodyObj) : '';
  const query = '';
  const toSign = `${reqTime}${method}${path}${body}${query}`;
  const signature = await hmacHex(S.bot.sec, toSign);
  const res = await fetch(`${BASE}${path}`, {
    method,
    headers:{ 'Content-Type':'application/json', 'ApiKey': S.bot.key, 'Request-Time': reqTime, 'Signature': signature },
    body: body || undefined
  });
  return res.json();
}
// Public contract details
async function contractDetail(sym){
  try{
    const r = await fetch(`${BASE}/api/v1/contract/detail?symbol=${encodeURIComponent(sym)}`, {cache:'no-store'});
    const j = await r.json();
    const d = j.data && (Array.isArray(j.data)? j.data.find(x=>x.symbol===sym) : j.data);
    if(d) return { contractSize: d.contractSize||0.0001, volUnit:d.volUnit||1, minVol:d.minVol||1 };
  }catch(e){}
  return { contractSize: 0.0001, volUnit:1, minVol:1 };
}

/* ===== BOT ÇALIŞ (örnek) ===== */
async function maybeBot(){
  if(!S.bot.enabled) return;
  if(!S.bot.key || !S.bot.sec) return;
  const nowms = Date.now();
  if(nowms - S.lastActionAt < (S.bot.cooldown*1000)) return;

  const rows = computeRows();
  if(rows.length===0) return;
  const r = rows[0];
  if(r.pct < S.bot.th) return;

  const isLong = r.action.includes('LONG');
  const side = isLong ? 1 : 3; // 1 open long, 3 open short

  const det = await contractDetail(r.sym);
  const futPrice = num(isLong ? S.fut.get(r.sym)?.ask1 : S.fut.get(r.sym)?.bid1);
  if(!isFinite(futPrice)) return;

  const coinQty = S.bot.amt / futPrice;
  let vol = Math.floor( (coinQty / det.contractSize) / det.volUnit ) * det.volUnit;
  if(vol < det.minVol) vol = det.minVol;

  if(S.bot.dry){ S.lastActionAt = nowms; return; }

  try{
    await mexcSigned('/api/v1/private/position/change_leverage', 'POST', {
      openType: S.bot.openType, leverage: S.bot.lev, symbol: r.sym, positionType: side===1?1:2
    });
    const order = await mexcSigned('/api/v1/private/order/submit', 'POST', {
      symbol: r.sym, price: futPrice, vol, leverage: S.bot.lev, side, type:5, openType: S.bot.openType
    });
    if(order && order.success !== false){ S.lastActionAt = nowms; alert(`Emir OK: ${r.sym} ${isLong?'LONG':'SHORT'} vol=${vol}`); }
  }catch(err){ console.error('Emir hatası (muhtemel CORS):', err); }
}

/* ===== Başlat ===== */
function start(){
  setInterval(()=>$('#clock').textContent=now(), 1000);
  tickRender(); draw();
  // mevcut coinler için döngüler
  [...S.coins].forEach(sym=>{ wsSub(sym,true); startSpotLoop(sym); });
}
start();
</script>
</body>
</html>
