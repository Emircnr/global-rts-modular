<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MEXC Spot ↔ Perp Fark Programı (Çoklu Sembol)</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --soft:#111a2e; --txt:#e7ecff; --muted:#9aa8c7;
    --acc:#7c5cff; --ok:#22c55e; --bad:#ef476f; --warn:#ffd166; --border:#1b2643;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
       color:var(--txt); background:
       radial-gradient(1200px 800px at 130% -10%, rgba(124,92,255,.12), transparent 60%),
       linear-gradient(180deg, #0b1220 0%, #0b1220 100%);}
  header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);
         border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:10px;height:10px;border-radius:50%;background:var(--acc);box-shadow:0 0 18px var(--acc)}
  h1{font-size:18px;margin:0}
  .sub{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 120%), var(--card);
        border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row>*{flex:1}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
               background:#0e1526; color:var(--txt); font-size:14px; outline:none}
  input:focus{border-color:#4b58ff; box-shadow:0 0 0 3px rgba(75,88,255,.15)}
  button{cursor:pointer; background:linear-gradient(180deg,#8b6bff,#6d53ff); border:none; font-weight:700}
  button.secondary{background:#121a2c}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
        background:#0f1628;border-radius:999px;padding:6px 10px;font-size:12px}
  .grid{display:grid;gap:10px}
  .g-2{grid-template-columns:1fr 1fr}
  @media (max-width:900px){ .g-2{grid-template-columns:1fr} }
  table{width:100%; border-collapse:separate; border-spacing:0; font-variant-numeric:tabular-nums}
  thead th{position:sticky; top:0; background:#111a2e; z-index:5}
  th, td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:right; font-size:13px}
  th:first-child, td:first-child{text-align:left}
  tbody tr:hover{background:#0e1526}
  .mono{font-variant-numeric:tabular-nums}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .muted{color:var(--muted)}
  .chip{padding:2px 6px;border-radius:6px;background:#0f182b;border:1px solid var(--border)}
  .act{display:flex;gap:6px;justify-content:flex-end}
  .danger{background:linear-gradient(180deg,#ff6b6b,#ef476f)}
  .tiny{font-size:11px}
  .right{justify-self:end}
  .foot{margin-top:10px;color:var(--muted);font-size:11px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <h1>MEXC Spot ↔ Perp Fark Programı</h1>
    </div>
    <div class="sub">Çoklu sembol • En iyi bid/ask fiyat ve miktarlar • Long/Short yüzde fark • Ultra hızlı yenileme</div>
  </div>
</header>

<main>
  <section class="card">
    <div class="grid g-2">
      <div class="row">
        <div style="flex:2">
          <label>Sembol(ler) — Spot formatında (ör. <b>BTCUSDT</b>, <b>ETHUSDT</b>) — virgülle ekleyebilirsin</label>
          <input id="symbols" placeholder="BTCUSDT, ETHUSDT, XRPUSDT">
        </div>
        <div>
          <label>Yenileme (ms)</label>
          <input id="refresh" type="number" min="200" step="50" value="800">
        </div>
        <div class="right" style="flex:0 0 220px">
          <label>&nbsp;</label>
          <div class="row">
            <button id="btnAdd">Ekle</button>
            <button id="btnClear" class="secondary">Hepsini Sil</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="pill tiny">Durum: <span id="statusTxt" class="muted">Hazır</span></div>
        <div class="pill tiny">Sembol sayısı: <span id="symCount">0</span></div>
        <div class="pill tiny">Son güncelleme: <span id="lastUpdate">—</span></div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <div style="overflow:auto; max-height:70vh;">
      <table id="table">
        <thead>
          <tr>
            <th>Sembol</th>
            <th>Spot Bid</th>
            <th>Bid Qty</th>
            <th>Spot Ask</th>
            <th>Ask Qty</th>
            <th>Perp Bid</th>
            <th>Bid Qty (base)</th>
            <th>Perp Ask</th>
            <th>Ask Qty (base)</th>
            <th>Long Fark %<br><span class="tiny muted">(Perp Bid − Spot Ask) / Spot Ask</span></th>
            <th>Short Fark %<br><span class="tiny muted">(Spot Bid − Perp Ask) / Spot Bid</span></th>
            <th>Güncel</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="foot">
      <div>Not: Perp miktarları, kontrat adedinden **base adede** çevrilir (contractSize). Farklar <b>yalnızca fiyat</b> üzerinden hesaplanır.</div>
      <div>İpucu: Long fırsatları için <b>Perp Bid vs Spot Ask</b>; Short için <b>Spot Bid vs Perp Ask</b> sütunlarını takip et.</div>
    </div>
  </section>
</main>

<script>
(() => {
  // ============ Ayarlar / Sabitler ============
  const SPOT = 'https://api.mexc.com';                 // /api/v3/...
  const PERP = 'https://contract.mexc.com';            // /api/v1/contract/...
  const LS_KEY = 'mexc_fark_symbols_v1';

  const el = {
    symbols:   document.getElementById('symbols'),
    refresh:   document.getElementById('refresh'),
    btnAdd:    document.getElementById('btnAdd'),
    btnClear:  document.getElementById('btnClear'),
    statusTxt: document.getElementById('statusTxt'),
    symCount:  document.getElementById('symCount'),
    lastUpdate:document.getElementById('lastUpdate'),
    tbody:     document.getElementById('tbody'),
    table:     document.getElementById('table'),
  };

  // Sembol listesi ve row state
  let symbols = loadSymbols();     // ['BTCUSDT', 'ETHUSDT', ...]
  let rows = new Map();            // symbol -> {tr, cells..., cache}
  let timer = null;
  let inflight = new Map();        // symbol -> AbortController (çakışma önleme)

  // ============ Yardımcılar ============
  const toPerp = (spot) => {
    spot = String(spot||'').toUpperCase().trim();
    if (!spot.endsWith('USDT')) return spot;          // basit; USDT pariteleri hedefleniyor
    return spot.slice(0, -4) + '_USDT';
  };
  const fmt = (n, p=2) => (isFinite(n) ? Number(n).toFixed(p) : '—');
  const fnum = (n, p=2) => (isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:p}) : '—');
  const nowStr = () => new Date().toLocaleTimeString();
  const colorize = (td, val) => {
    td.classList.remove('ok','bad','warn');
    if (!isFinite(val)) return;
    if (val > 0) td.classList.add('ok');
    else if (val < 0) td.classList.add('bad');
    else td.classList.add('warn');
  };
  function saveSymbols(list){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(list)); }catch(e){}
  }
  function loadSymbols(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
      if (Array.isArray(s)) return s;
    }catch(e){}
    return [];
  }
  function upStatus(txt){ el.statusTxt.textContent = txt; }

  // ============ API Çağrıları ============
  async function fetchJSON(url, timeoutMs=4000){
    const c = new AbortController();
    const id = setTimeout(()=>c.abort('timeout'), timeoutMs);
    try{
      const res = await fetch(url, {cache:'no-store', signal:c.signal});
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    } finally { clearTimeout(id); }
  }

  // Spot best bid/ask + qty (bookTicker)
  async function getSpotBest(spotSym){
    const url = `${SPOT}/api/v3/ticker/bookTicker?symbol=${spotSym}`;
    // bookTicker -> {bidPrice, bidQty, askPrice, askQty}
    const j = await fetchJSON(url);
    const bid = Number(j.bidPrice), ask = Number(j.askPrice);
    const bidQty = Number(j.bidQty), askQty = Number(j.askQty);
    if (!isFinite(bid) || !isFinite(ask)) throw new Error('Spot bookTicker invalid');
    return { bid, ask, bidQty, askQty };
  }

  // Perp depth (best bid/ask) + contractSize (cache)
  const contractCache = new Map(); // perpSym -> {contractSize, priceScale}
  async function getPerpBest(perpSym){
    // depth: {bids:[[price,vol,...],...], asks:[[price,vol,...],...]}
    const depthUrl = `${PERP}/api/v1/contract/depth/${perpSym}?limit=5`;
    const d = await fetchJSON(depthUrl);
    const b0 = d?.bids?.[0], a0 = d?.asks?.[0];
    if (!b0 || !a0) throw new Error('Perp depth empty');
    const bid = Number(b0[0]), bidVol = Number(b0[1]);
    const ask = Number(a0[0]), askVol = Number(a0[1]);

    // contractSize çek (cache’li)
    let cc = contractCache.get(perpSym);
    if (!cc){
      const detUrl = `${PERP}/api/v1/contract/detail?symbol=${perpSym}`;
      const dj = await fetchJSON(detUrl);
      const one = (dj?.data||[]).find(x=>x.symbol===perpSym) || dj?.data?.[0];
      const contractSize = Number(one?.contractSize||0.0001);
      const priceScale   = Number(one?.priceScale||2);
      cc = {contractSize, priceScale};
      contractCache.set(perpSym, cc);
    }
    const bidQtyBase = bidVol * cc.contractSize;
    const askQtyBase = askVol * cc.contractSize;

    return { bid, ask, bidQtyBase, askQtyBase, priceScale: cc.priceScale };
  }

  // ============ Tablo Satırı Oluşturma ============
  function ensureRow(spotSym){
    let row = rows.get(spotSym);
    if (row) return row;

    const tr = document.createElement('tr');
    tr.dataset.sym = spotSym;

    function td(){ const x=document.createElement('td'); return x; }

    const tds = {
      sym: td(),
      sBid: td(), sBidQ: td(), sAsk: td(), sAskQ: td(),
      pBid: td(), pBidQ: td(), pAsk: td(), pAskQ: td(),
      longDiff: td(), shortDiff: td(),
      ts: td(),
      del: td(),
    };

    tds.sym.innerHTML = `<b>${spotSym}</b><br><span class="muted tiny">${toPerp(spotSym)}</span>`;
    tds.del.innerHTML = `<div class="act"><button class="danger tiny">Sil</button></div>`;
    tds.del.querySelector('button').addEventListener('click', ()=> removeSymbol(spotSym));

    Object.values(tds).forEach(cell=>tr.appendChild(cell));
    el.tbody.appendChild(tr);

    row = { tr, ...tds, priceScale:2 };
    rows.set(spotSym, row);
    el.symCount.textContent = String(rows.size);
    return row;
  }

  function removeSymbol(spotSym){
    // Timer altında güvenli kaldır
    try{
      const row = rows.get(spotSym);
      if (row && row.tr && row.tr.parentNode) row.tr.parentNode.removeChild(row.tr);
      rows.delete(spotSym);
      symbols = symbols.filter(s=>s!==spotSym);
      saveSymbols(symbols);
      el.symCount.textContent = String(rows.size);

      // Devam eden fetch varsa iptal
      const ctl = inflight.get(spotSym);
      if (ctl){ try{ctl.abort('removed');}catch(e){} inflight.delete(spotSym); }
    }catch(e){}
  }

  // ============ Hesap / Güncelle ============
  async function updateOne(spotSym){
    // Çakışmayı engelle
    const prevCtl = inflight.get(spotSym);
    if (prevCtl){ try{prevCtl.abort('overlap');}catch(e){} }
    const ctl = new AbortController();
    inflight.set(spotSym, ctl);

    const row = ensureRow(spotSym);
    const perpSym = toPerp(spotSym);

    try{
      const [spotBest, perpBest] = await Promise.all([
        getSpotBest(spotSym),
        getPerpBest(perpSym)
      ]);

      const ps = perpBest.priceScale || 2;

      // Fiyat ve miktarları yaz
      row.sBid.textContent = fnum(spotBest.bid, ps);
      row.sAsk.textContent = fnum(spotBest.ask, ps);
      row.sBidQ.textContent = fnum(spotBest.bidQty, 6);
      row.sAskQ.textContent = fnum(spotBest.askQty, 6);

      row.pBid.textContent = fnum(perpBest.bid, ps);
      row.pAsk.textContent = fnum(perpBest.ask, ps);
      row.pBidQ.textContent = fnum(perpBest.bidQtyBase, 6);
      row.pAskQ.textContent = fnum(perpBest.askQtyBase, 6);
      row.priceScale = ps;

      // Farklar
      const longDiff  = (perpBest.bid - spotBest.ask) / spotBest.ask; // PerpBid vs SpotAsk
      const shortDiff = (spotBest.bid - perpBest.ask) / spotBest.bid; // SpotBid vs PerpAsk

      row.longDiff.textContent  = (isFinite(longDiff)? (longDiff*100).toFixed(3)+'%':'—');
      row.shortDiff.textContent = (isFinite(shortDiff)? (shortDiff*100).toFixed(3)+'%':'—');
      colorize(row.longDiff, longDiff);
      colorize(row.shortDiff, shortDiff);

      row.ts.innerHTML = `<span class="tiny muted">${nowStr()}</span>`;
      inflight.delete(spotSym);
      return true;
    } catch(err){
      row.ts.innerHTML = `<span class="tiny bad">Hata</span>`;
      inflight.delete(spotSym);
      return false;
    }
  }

  async function tick(){
    if (!symbols.length){ el.lastUpdate.textContent='—'; return; }
    el.statusTxt.textContent = 'Güncelleniyor…';

    const start = performance.now();
    // Tüm semboller için paralel güncelle (çok hızlı)
    await Promise.all(symbols.map(s => updateOne(s)));
    const dur = Math.round(performance.now() - start);

    el.statusTxt.textContent = `Tamam (${dur} ms)`;
    el.lastUpdate.textContent = nowStr();
  }

  function start(){
    if (timer) { clearInterval(timer); timer=null; }
    const iv = Math.max(200, Number(el.refresh.value)||800);
    timer = setInterval(tick, iv);
    tick();
  }

  // ============ UI Olayları ============
  el.btnAdd.addEventListener('click', ()=>{
    const raw = (el.symbols.value||'').toUpperCase();
    const list = raw.split(/[,\s]+/).map(x=>x.trim()).filter(Boolean);
    if (!list.length) return;

    list.forEach(sym=>{
      if (!sym.endsWith('USDT')) return; // basit doğrulama
      if (!symbols.includes(sym)) symbols.push(sym);
      ensureRow(sym);
    });
    saveSymbols(symbols);
    el.symCount.textContent = String(rows.size);
    el.symbols.value='';
    tick();
  });

  el.btnClear.addEventListener('click', ()=>{
    [...rows.keys()].forEach(removeSymbol);
    saveSymbols(symbols);
  });

  el.refresh.addEventListener('change', start);

  // ============ İlk yük ============
  // Önceki listeyi getir
  if (symbols.length){
    symbols.forEach(s=>ensureRow(s));
    start();
  }else{
    // Örnek demo satırları
    ['BTCUSDT','ETHUSDT','XRPUSDT'].forEach(s=>{
      symbols.push(s);
      ensureRow(s);
    });
    saveSymbols(symbols);
    start();
  }
})();
</script>
</body>
</html>
