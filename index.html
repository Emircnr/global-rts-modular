<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gate.io USDT‑M — MA Channel Bot (Tek Dosya)</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#111a30; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444;
    --radius:16px; --gap:14px; --padY:12px; --padX:14px; --font:15px; --maxW:1200px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; font-size:var(--font)}
  header{max-width:var(--maxW);margin:24px auto 0;padding:0 var(--padX)}
  h1{font-size:20px;margin:0 0 8px 0;display:flex;align-items:center;gap:10px}
  .hint{color:var(--muted);font-size:13px}
  .wrap{max-width:var(--maxW);margin:16px auto;padding:0 var(--padX);display:grid;grid-template-columns:1.2fr .8fr;gap:var(--gap)}
  .card{background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .controls{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:8px}
  input,select,textarea{width:100%;background:rgba(255,255,255,.04);color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none}
  textarea{min-height:64px;resize:vertical}
  .row{display:flex;flex-wrap:wrap; gap:10px; align-items:center}
  .btn{background:var(--glass);border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;user-select:none}
  .btn:hover{border-color:#2a4e85}
  .btn.primary{background:#0f1f3d;border-color:#2d57a3}
  .btn.danger{background:#35121a;border-color:#7a1e2b}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:auto}
  .muted{color:var(--muted)}
  .log{padding:0;overflow:auto;height:360px}
  .log pre{margin:0;padding:12px;white-space:pre-wrap;word-break:break-word}
  .log .line{padding:6px 12px;border-bottom:1px dashed rgba(255,255,255,.06)}
  .tag{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.04);font-size:12px;margin-right:6px}
  .ok{color:var(--good)} .err{color:var(--bad)} .acc{color:var(--accent)}

  /* PnL Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(100%,var(--maxW));max-height:86vh;overflow:auto;background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--border); border-radius:18px;padding:16px}
  .modal h2{margin:0 0 10px 0;font-size:18px}
  .modal .close{float:right}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:10px 0 16px}
  .kpi{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:10px}
  .kpi .v{font-weight:700;font-size:18px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px 6px;text-align:left}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

  @media(max-width:980px){
    .wrap{grid-template-columns:1fr}
    .grid{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
  <header>
    <h1>Gate.io USDT‑M — MA Channel Bot <span class="tag">Tek Dosya</span><span class="tag">GTC + Takip Stop</span></h1>
    <div class="hint">Proxy & Firestore & API anahtarları arka planda. İlk kurulum (tek seferlik) için DevTools Console'a şunu girin:
      <span class="mono">localStorage.setItem('gateio.secure.v1', JSON.stringify({key:'K', secret:'S'}))</span>
    </div>
  </header>

  <div class="wrap">
    <div class="card controls">
      <div class="grid">
        <div>
          <label>Settle</label>
          <select id="settle">
            <option value="usdt" selected>usdt</option>
            <option value="btc">btc</option>
          </select>
        </div>
        <div>
          <label>Kaldıraç</label>
          <input id="leverage" type="number" min="1" max="100" step="1" value="10"/>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button id="btnLev" class="btn">Kaldıracı Uygula (Tüm Seçili)</button>
        </div>
        <div>
          <label>Tutar (USDT)</label>
          <input id="usdt" type="number" min="1" step="1" value="50"/>
        </div>
        <div>
          <label>Frekans (Hz)</label>
          <select id="hz">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div>
          <label>Seçenekler</label>
          <div class="row">
            <label class="switch"><input id="dry" type="checkbox">Dry‑run</label>
            <label class="switch"><input id="roStop" type="checkbox" checked>Reduce‑only Stop</label>
          </div>
        </div>
      </div>
      <div style="margin-top:12px">
        <label>Coin listesi (virgüllü)</label>
        <input id="coins" placeholder="BTCUSDT,ETHUSDT,VINEUSDT" value="BTCUSDT,ETHUSDT"/>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="start" class="btn primary">Başlat</button>
        <button id="stop" class="btn">Durdur</button>
        <button id="cancelSel" class="btn danger">Seçili coinlerde TÜM açık emirleri iptal</button>
        <button id="pnlBtn" class="btn">PnL Pop‑up</button>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="muted">Durum:</span>
        <span id="status" class="tag">IDLE</span>
        <span class="muted">Time:</span>
        <span id="timeoff" class="tag">-</span>
        <span class="muted">İstek/sn:</span>
        <span id="rps" class="tag">0</span>
      </div>
    </div>

    <div class="card log">
      <pre id="log"></pre>
    </div>
  </div>

  <!-- PnL Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="btn close" id="closeModal">Kapat (ESC)</button>
      <h2>Canlı PnL ve Emir Durumu</h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">Toplam UPnL</div><div id="totUpnl" class="v">0</div></div>
        <div class="kpi"><div class="muted">Toplam RPnL (Oturum)</div><div id="totRpnl" class="v">0</div></div>
        <div class="kpi"><div class="muted">Açık Emir Sayısı</div><div id="totOpen" class="v">0</div></div>
        <div class="kpi"><div class="muted">İstek/Sn (yaklaşık)</div><div id="totRps" class="v">0</div></div>
      </div>
      <table class="tbl mono" id="pnlTable">
        <thead>
          <tr>
            <th>Sembol</th><th>Pos Size</th><th>Entry</th><th>Mark/Last</th><th>UPnL</th><th>RPnL (sess)</th><th>Fee~</th><th>Son Fill</th><th>Bekleyen (Long/Short)</th><th>Takip Stop</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  // === CONFIG (UI'da YOK) ===
  const CONFIG = {
    env: 'mainnet', // testnet için 'testnet' yapın (UI'da görünmez)
    proxyBaseMainnet: 'http://localhost:8787',
    proxyBaseTestnet: 'http://localhost:8787/testnet',
    firebase: {
      apiKey: "AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To",
      authDomain: "macbot-b7b45.firebaseapp.com",
      databaseURL: "https://macbot-b7b45-default-rtdb.firebaseio.com",
      projectId: "macbot-b7b45",
      storageBucket: "macbot-b7b45.firebasestorage.app",
      messagingSenderId: "88494187419",
      appId: "1:88494187419:web:9e0fd1a37e51332203373e",
      measurementId: "G-SVG851WK7Y"
    },
    firestore: {
      collection: 'mac_stream',
      docSuffix: '_5m',
      fields: { upper:'upper', lower:'lower', mid:'mid', close:'close', symbol:'symbol', ts:'ts_ms', inChannel:'in_channel', position:'position' }
    }
  };

  // === LocalStorage Anahtarları ===
  const LS_SECURE = 'gateio.secure.v1'; // {key, secret}
  const LS_CFG    = 'gateio.mac.config.v1'; // {coins, usdt, leverage, settle, hz, toggles}

  // === UI Elemanları ===
  const el = {
    settle: document.getElementById('settle'),
    leverage: document.getElementById('leverage'),
    btnLev: document.getElementById('btnLev'),
    usdt: document.getElementById('usdt'),
    coins: document.getElementById('coins'),
    hz: document.getElementById('hz'),
    dry: document.getElementById('dry'),
    roStop: document.getElementById('roStop'),
    start: document.getElementById('start'),
    stop: document.getElementById('stop'),
    cancelSel: document.getElementById('cancelSel'),
    log: document.getElementById('log'),
    status: document.getElementById('status'),
    timeoff: document.getElementById('timeoff'),
    rps: document.getElementById('rps'),
    pnlBtn: document.getElementById('pnlBtn'),
    backdrop: document.getElementById('backdrop'),
    closeModal: document.getElementById('closeModal'),
    pnlTableBody: document.querySelector('#pnlTable tbody'),
    totUpnl: document.getElementById('totUpnl'),
    totRpnl: document.getElementById('totRpnl'),
    totOpen: document.getElementById('totOpen'),
    totRps: document.getElementById('totRps')
  };

  // === Global Durumlar ===
  const state = {
    running: false,
    timer: null,
    hz: 1,
    serverOffsetMs: 0,
    baseUrl: '',
    requests: [], // zaman damgaları, RPS hesap
    symbols: [],
    coinStates: {}, // symbol -> {busy, signal, spec, pos, openOrders, desired, stopOrderId, lastStopPrice, rpnlSess, lastFillTs}
  };

  // === Yardımcılar ===
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const ts = () => new Date().toLocaleTimeString();
  const nowMs = () => Date.now();
  const toHex = buf => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  const enc = new TextEncoder();

  function log(line, cls=''){
    const div = document.createElement('div');
    div.className = 'line ' + cls;
    div.textContent = `[${ts()}] ${line}`;
    el.log.appendChild(div);
    el.log.scrollTop = el.log.scrollHeight;
  }

  function saveUserCfg(){
    const data = {
      settle: el.settle.value,
      leverage: Number(el.leverage.value||10),
      usdt: Number(el.usdt.value||50),
      hz: Number(el.hz.value||1),
      toggles: { dry: el.dry.checked, roStop: el.roStop.checked },
      coins: el.coins.value
    };
    localStorage.setItem(LS_CFG, JSON.stringify(data));
  }
  function loadUserCfg(){
    const raw = localStorage.getItem(LS_CFG);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      if(d.settle) el.settle.value = d.settle;
      if(d.leverage) el.leverage.value = d.leverage;
      if(d.usdt) el.usdt.value = d.usdt;
      if(d.hz) el.hz.value = d.hz;
      if(d.toggles){ el.dry.checked = !!d.toggles.dry; el.roStop.checked = !!d.toggles.roStop; }
      if(d.coins) el.coins.value = d.coins;
    }catch(e){ console.warn('cfg parse',e); }
  }

  function coinsFromInput(){
    return (el.coins.value||'')
      .split(',')
      .map(s=>s.trim().toUpperCase())
      .filter(s=>s.endsWith('USDT') && s.length>6);
  }
  const toContract = sym => sym.replace(/USDT$/,'_USDT');

  function quantToTick(price, tick){
    if(!isFinite(price)||!isFinite(tick)||tick<=0) return price;
    const q = Math.round(price / tick) * tick;
    const dp = (tick.toString().split('.')[1]||'').length;
    return Number(q.toFixed(dp));
  }
  function floorToInc(sz, inc){
    if(!isFinite(sz)||!isFinite(inc)||inc<=0) return 0;
    const sign = sz>=0? 1 : -1;
    const abs = Math.floor(Math.abs(sz)/inc)*inc;
    const dp = (inc.toString().split('.')[1]||'').length;
    return Number((abs*sign).toFixed(dp));
  }

  // === WebCrypto: SHA512 & HMAC‑SHA512 (hex) ===
  async function sha512Hex(str){
    const buf = await crypto.subtle.digest('SHA-512', enc.encode(str||''));
    return toHex(buf);
  }
  async function hmac512Hex(secret, msg){
    const key = await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-512'}, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', key, enc.encode(msg));
    return toHex(sig);
  }

  // === Gate.io İmza + İstek ===
  function baseUrl(){
    return CONFIG.env==='testnet' ? CONFIG.proxyBaseTestnet : CONFIG.proxyBaseMainnet;
  }
  function addReqTick(){
    const t = nowMs();
    state.requests.push(t);
    // son 10s tut
    while(state.requests.length && t - state.requests[0] > 10000) state.requests.shift();
    // RPS yaklaşık (son 5s /5)
    const last5 = state.requests.filter(x=>t-x<=5000).length;
    const rps = (last5/5).toFixed(1);
    el.rps.textContent = rps;
    el.totRps.textContent = rps;
  }
  function summarizeError(e, json){
    try{
      if(json && (json.label || json.message)){
        const lab = json.label||'err';
        const msg = (json.message||'').toLowerCase().replace(/\s+/g,'_').slice(0,60);
        return `${lab}:${msg}`;
      }
    }catch{}
    const s = (''+e).toLowerCase();
    if(s.includes('403')) return 'forbidden';
    if(s.includes('429')) return 'too_many_requests';
    if(s.includes('insufficient')) return 'insufficient_balance';
    if(s.includes('5')) return 'http_5xx';
    return 'http_err';
  }

  async function gateReq(method, path, {query=null, body=null, auth=true}={}){
    const sec = JSON.parse(localStorage.getItem(LS_SECURE)||'{}');
    const key = sec.key||''; const secret = sec.secret||'';
    const urlBase = baseUrl();
    const qs = query ? new URLSearchParams(query).toString() : '';
    const url = urlBase + path + (qs? ('?'+qs):'');

    const tsSec = Math.floor((nowMs()+state.serverOffsetMs)/1000).toString();
    const bodyStr = body ? JSON.stringify(body) : '';
    const bodyHex = await sha512Hex(bodyStr);
    const sigStr = `${method.toUpperCase()}\n${path}\n${qs}\n${bodyHex}\n${tsSec}`;
    const sign = auth ? await hmac512Hex(secret, sigStr) : '';

    const headers = { 'Content-Type':'application/json' };
    if(auth){ headers['KEY']=key; headers['Timestamp']=tsSec; headers['SIGN']=sign; }

    addReqTick();
    const res = await fetch(url, {method, headers, body: bodyStr||undefined});
    let json=null; try{ json = await res.json(); }catch{}
    if(!res.ok){
      const s = summarizeError(res.statusText, json);
      throw new Error(`ERR:${s}`);
    }
    return json;
  }

  // === Zaman Senkronu ===
  async function syncTime(){
    try{
      const url = '/api/v4/spot/time';
      const t0 = nowMs();
      const r = await gateReq('GET', url, {auth:false});
      const t1 = nowMs();
      const oneWay = (t1 - t0)/2;
      let server = r.server_time; // saniye ya da ms olabilir
      if(server < 1e12) server = server*1000; // saniyeyse ms'e çevir
      state.serverOffsetMs = (server + oneWay) - t1; // yaklaşık ofset
      const tag = Math.abs(state.serverOffsetMs) < 1500 ? 'TIME OK' : 'TIME OFF';
      el.timeoff.textContent = `${tag}: ${(state.serverOffsetMs>=0?'+':'')}${Math.round(state.serverOffsetMs)}ms`;
      log(`${tag}: ${(state.serverOffsetMs>=0?'+':'')}${Math.round(state.serverOffsetMs)}ms`);
    }catch(e){
      log(`TIME OFF: ölçülemedi`, 'err');
    }
  }

  // === Firestore Dinleme ===
  let fb=null, db=null; let unsubMap = {};
  function initFirebase(){
    if(fb) return; // bir kez
    fb = firebase.initializeApp(CONFIG.firebase);
    db = firebase.firestore();
  }
  function startSignalListeners(symbols){
    initFirebase();
    stopSignalListeners();
    for(const sym of symbols){
      const docId = `${sym}${CONFIG.firestore.docSuffix}`;
      const ref = db.collection(CONFIG.firestore.collection).doc(docId);
      unsubMap[sym] = ref.onSnapshot(snap=>{
        if(snap.exists){
          const d = snap.data();
          const f = CONFIG.firestore.fields;
          const sig = {
            symbol: d[f.symbol]||sym,
            ts: d[f.ts]||0,
            upper: Number(d[f.upper]),
            lower: Number(d[f.lower]),
            mid: Number(d[f.mid]),
            close: Number(d[f.close]),
            inChannel: !!d[f.inChannel] || (d[f.position]==='INSIDE') || ((Number(d[f.lower])<Number(d[f.close])) && (Number(d[f.close])<Number(d[f.upper])))
          };
          const cs = ensureCoinState(sym);
          cs.signal = sig;
        }
      }, err=>{
        log(`${sym} FS ERR`, 'err');
      });
    }
  }
  function stopSignalListeners(){
    for(const k in unsubMap){ try{ unsubMap[k](); }catch{} }
    unsubMap = {};
  }

  // === Coin Durum Nesnesi ===
  function ensureCoinState(sym){
    if(!state.coinStates[sym]){
      state.coinStates[sym] = {
        busy:false,
        signal:null,
        spec:null,
        pos:null,
        openOrders:[],
        desired:{long:null, short:null},
        stopOrderId:null,
        lastStopPrice:null,
        rpnlSess:0,
        lastPosSize:0,
        lastFillTs:null,
        lastLongPrice:null,
        lastShortPrice:null
      };
    }
    return state.coinStates[sym];
  }

  // === SPEC Önbellek ===
  async function getSpec(sym){
    const cs = ensureCoinState(sym);
    if(cs.spec) return cs.spec;
    const contract = toContract(sym);
    try{
      const j = await gateReq('GET', `/api/v4/futures/usdt/contracts/${contract}`);
      const s = {
        tick_size: Number(j.tick_size||j.order_price_round||'0.1'),
        order_size_increment: Number(j.order_size_increment||'0.0001'),
        quanto_multiplier: Number(j.quanto_multiplier||'1')
      };
      cs.spec = s;
      log(`SPEC OK: ${contract} tick=${s.tick_size} inc=${s.order_size_increment} qm=${s.quanto_multiplier}`, 'acc');
      return s;
    }catch(e){
      log(`SPEC ERR ${sym}: ${e.message}`, 'err');
      throw e;
    }
  }

  // === Pozisyon & Açık Emirler ===
  async function getPosition(sym){
    const contract = toContract(sym);
    const j = await gateReq('GET', `/api/v4/futures/usdt/positions/${contract}`);
    return j; // {size, entry_price, ...}
  }
  async function getOpenOrders(sym){
    const contract = toContract(sym);
    const j = await gateReq('GET', `/api/v4/futures/usdt/orders`, {query:{contract, status:'open'}});
    return Array.isArray(j)? j: [];
  }

  // === Emir İşlemleri ===
  async function cancelAll(sym){
    const contract = toContract(sym);
    try{
      const dry = el.dry.checked;
      if(dry){ log(`${sym} ORD CXL ALL (dry)`); return; }
      await gateReq('DELETE', `/api/v4/futures/usdt/orders`, {query:{contract}});
      log(`${sym} ORD CXL ALL`, 'acc');
    }catch(e){ log(`${sym} ERR cancel_all: ${e.message}`, 'err'); }
  }
  async function cancelOne(sym, id){
    const contract = toContract(sym);
    try{
      if(!id) return;
      const dry = el.dry.checked;
      if(dry){ log(`${sym} ORD CXL ${id} (dry)`); return; }
      await gateReq('DELETE', `/api/v4/futures/usdt/orders/${id}`);
      log(`${sym} ORD CXL ${id}`);
    }catch(e){ log(`${sym} ERR cxl ${id}: ${e.message}`, 'err'); }
  }
  async function placeLimit(sym, size, price, {reduce_only=false, text=''}={}){
    const contract = toContract(sym);
    const body = { contract, size, price: Number(price), tif:'gtc' };
    if(reduce_only) body.reduce_only = true;
    if(text) body.text = text;
    const dry = el.dry.checked;
    if(dry){
      log(`${sym} ORD NEW ${size}@${price}${reduce_only?' [RO]':''} (dry)`);
      return { id: `dry-${Date.now()}`, ...body };
    }
    try{
      const j = await gateReq('POST', `/api/v4/futures/usdt/orders`, {body});
      log(`${sym} ORD NEW ${j.id||'?'} ${size}@${price}${reduce_only?' [RO]':''}`);
      return j;
    }catch(e){
      log(`${sym} ERR new: ${e.message}`, 'err');
      return null;
    }
  }

  // === Kaldıraç ===
  async function setLeverage(sym, lev){
    const contract = toContract(sym);
    try{
      const dry = el.dry.checked;
      if(dry){ log(`${sym} LEV set ${lev} (dry)`); return; }
      await gateReq('POST', `/api/v4/futures/usdt/positions/${contract}/leverage`, {query:{leverage: lev}});
      log(`${sym} LEV OK ${lev}`, 'acc');
    }catch(e){ log(`${sym} ERR lev: ${e.message}`, 'err'); }
  }

  // === Ticker (Mark/Last) ===
  async function getTicker(sym){
    const contract = toContract(sym);
    try{
      const j = await gateReq('GET', `/api/v4/futures/usdt/tickers`, {query:{contract}});
      if(Array.isArray(j) && j.length){
        const t = j[0];
        return { mark: Number(t.mark_price||t.last||t.last_price||0), last: Number(t.last||t.last_price||0) };
      }
    }catch(e){ /* sessiz */ }
    return { mark:0, last:0 };
  }

  // === Boyut Hesabı ===
  function computeOrderSize(usdt, price, qm, inc, side){
    if(!price||!qm||!inc) return 0;
    const baseQty = usdt / price;
    let size = baseQty / qm; // sözleşme adedi
    size = floorToInc(size, inc);
    if(side==='long') size = Math.abs(size);
    if(side==='short') size = -Math.abs(size);
    return size;
  }

  // === Ana Döngü: coin başına tek aktif ===
  async function stepCoin(sym){
    const cs = ensureCoinState(sym);
    if(cs.busy) return; cs.busy = true;
    try{
      // 1) Spec
      const spec = await getSpec(sym); // {tick_size, order_size_increment, quanto_multiplier}
      // 2) Sinyal
      const sig = cs.signal;
      if(!sig){ cs.busy=false; return; }
      // 3) Pozisyon & Açık Emirler & Ticker
      const [pos, opens, tick] = await Promise.all([
        getPosition(sym),
        getOpenOrders(sym),
        getTicker(sym)
      ]);
      cs.pos = pos; cs.openOrders = opens;

      // PnL hesap (UPnL) ve RPnL approx
      const sizeNow = Number(pos.size||0);
      const entry = Number(pos.entry_price||0);
      const mark = tick.mark||sig.close||0;
      const upnl = sizeNow * (mark - entry) * spec.quanto_multiplier;
      if(cs.lastPosSize && Math.abs(sizeNow) < Math.abs(cs.lastPosSize)){
        // pozisyon azalınca, realize ettik say (yaklaşık)
        const delta = Math.abs(cs.lastPosSize) - Math.abs(sizeNow);
        const realized = (cs.lastPosSize>0 ? (mark - entry) : (entry - mark)) * spec.quanto_multiplier * delta;
        cs.rpnlSess += realized;
        cs.lastFillTs = new Date().toLocaleTimeString();
      }
      cs.lastPosSize = sizeNow;
      // Log kısa
      log(`${sym} POS sz=${sizeNow} entry=${entry} | PnL U=${upnl.toFixed(2)} R=${cs.rpnlSess.toFixed(2)}`);

      const inChan = !!sig.inChannel;
      const longPending = opens.find(o=>Number(o.size)>0 && !o.reduce_only);
      const shortPending= opens.find(o=>Number(o.size)<0 && !o.reduce_only);
      const stopPending = opens.find(o=>o.reduce_only);

      // === Pozisyon varken: sadece takip stop ===
      if(sizeNow !== 0){
        // Karşıt bekleyenleri kaldır
        if(longPending) await cancelOne(sym, longPending.id);
        if(shortPending) await cancelOne(sym, shortPending.id);
        if(!el.roStop.checked){ cs.busy=false; return; }
        const stopSide = sizeNow>0 ? 'short' : 'long';
        const stopPrice = quantToTick(sig.mid, spec.tick_size);
        // Güncelleme ihtiyacı?
        if(!stopPending || Number(stopPending.price)!==stopPrice){
          if(stopPending) await cancelOne(sym, stopPending.id);
          const szAbs = Math.abs(sizeNow); // tamamını kapatacak
          const roSize = stopSide==='short'? -szAbs : szAbs;
          const placed = await placeLimit(sym, roSize, stopPrice, {reduce_only:true, text:'follow-stop'});
          if(placed){ cs.stopOrderId = placed.id; cs.lastStopPrice = stopPrice; log(`${sym} ORD STOP @${stopPrice}`, 'acc'); }
        }
        cs.busy=false; return;
      }

      // === Pozisyon yok ===
      // Kanal dışında: varsa bekleyen çift emir iptal
      if(!inChan){
        if(longPending) await cancelOne(sym, longPending.id);
        if(shortPending) await cancelOne(sym, shortPending.id);
        cs.busy=false; return;
      }

      // Kanal içinde: iki bekleyen GTC limit
      const tickSize = spec.tick_size;
      const longPrice = quantToTick(sig.upper, tickSize);
      const shortPrice= quantToTick(sig.lower, tickSize);
      const orderUsdt = Number(el.usdt.value||0);
      const longSz = computeOrderSize(orderUsdt, sig.mid||sig.close||longPrice, spec.quanto_multiplier, spec.order_size_increment, 'long');
      const shortSz= computeOrderSize(orderUsdt, sig.mid||sig.close||shortPrice, spec.quanto_multiplier, spec.order_size_increment, 'short');

      if(Math.abs(longSz) < spec.order_size_increment || Math.abs(shortSz) < spec.order_size_increment){
        log(`${sym} SPEC OK ama size<inc, atlandı`);
        cs.busy=false; return;
      }

      // Long bekleyen
      if(!longPending || Number(longPending.price)!==longPrice || Number(longPending.size)!==longSz){
        if(longPending) await cancelOne(sym, longPending.id);
        await placeLimit(sym, longSz, longPrice, {text:'ch-long'});
      }
      // Short bekleyen
      if(!shortPending || Number(shortPending.price)!==shortPrice || Number(shortPending.size)!==shortSz){
        if(shortPending) await cancelOne(sym, shortPending.id);
        await placeLimit(sym, shortSz, shortPrice, {text:'ch-short'});
      }

      cs.busy=false;
    }catch(e){
      log(`${sym} ERR step: ${e.message}`, 'err');
      ensureCoinState(sym).busy=false;
    }
  }

  // === Ana Döngüyü Başlat/Durdur ===
  function start(){
    saveUserCfg();
    state.running = true;
    state.hz = Number(el.hz.value||1);
    el.status.textContent = 'RUNNING';
    state.symbols = coinsFromInput();
    startSignalListeners(state.symbols);
    clearInterval(state.timer);
    const iv = Math.max(250, Math.round(1000/state.hz)); // 0.5→2000ms, 2→500ms min clamp 250ms
    state.timer = setInterval(()=>{
      for(const sym of state.symbols) stepCoin(sym);
      refreshPnLModal();
    }, iv);
  }
  function stop(){
    state.running = false;
    el.status.textContent = 'IDLE';
    clearInterval(state.timer);
    state.timer = null;
    stopSignalListeners();
  }

  // === PnL Modal ===
  function openModal(){ el.backdrop.style.display='flex'; refreshPnLModal(); }
  function closeModal(){ el.backdrop.style.display='none'; }
  function refreshPnLModal(){
    let totU=0, totR=0, totOpen=0;
    const body = el.pnlTableBody; body.innerHTML='';
    for(const sym of state.symbols){
      const cs = ensureCoinState(sym);
      const spec = cs.spec||{quanto_multiplier:1};
      const pos = cs.pos||{size:0, entry_price:0};
      const size = Number(pos.size||0);
      const entry = Number(pos.entry_price||0);
      const sig = cs.signal||{}; const mid = Number(sig.mid||0); const close = Number(sig.close||0);
      const mark = mid||close||0;
      const upnl = size * (mark - entry) * (spec.quanto_multiplier||1);
      const opens = cs.openOrders||[]; totOpen += opens.length;
      const longP = opens.find(o=>Number(o.size)>0 && !o.reduce_only);
      const shortP= opens.find(o=>Number(o.size)<0 && !o.reduce_only);
      const stopP = opens.find(o=>o.reduce_only);
      totU += upnl; totR += (cs.rpnlSess||0);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sym}</td>
        <td>${size}</td>
        <td>${entry||''}</td>
        <td>${mark||''}</td>
        <td class="${upnl>=0?'ok':'err'}">${upnl.toFixed(2)}</td>
        <td>${(cs.rpnlSess||0).toFixed(2)}</td>
        <td>~maker</td>
        <td>${cs.lastFillTs||''}</td>
        <td>${longP? (longP.id+` @`+longP.price+` x`+longP.size):'-'} / ${shortP? (shortP.id+` @`+shortP.price+` x`+shortP.size):'-'}</td>
        <td>${stopP? (stopP.id+` @`+stopP.price):'-'}</td>`;
      body.appendChild(tr);
    }
    el.totUpnl.textContent = totU.toFixed(2);
    el.totRpnl.textContent = totR.toFixed(2);
    el.totOpen.textContent = String(totOpen);
    // rps zaten üstte güncelleniyor
  }

  // === Eventler ===
  el.start.onclick = ()=> start();
  el.stop.onclick = ()=> stop();
  el.pnlBtn.onclick = ()=> openModal();
  el.closeModal.onclick = ()=> closeModal();
  window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') closeModal(); });

  el.btnLev.onclick = async()=>{
    saveUserCfg();
    const lev = Number(el.leverage.value||10);
    const syms = coinsFromInput();
    for(const s of syms){ await setLeverage(s, lev); await sleep(100); }
  };

  el.cancelSel.onclick = async()=>{
    saveUserCfg();
    const syms = coinsFromInput();
    for(const s of syms){ await cancelAll(s); await sleep(80); }
  };

  // Değişikliklerde ayarları kaydet
  ['settle','leverage','usdt','hz','dry','roStop','coins'].forEach(id=>{
    document.getElementById(id).addEventListener('change', saveUserCfg);
  });

  // === Başlangıç ===
  (async function init(){
    loadUserCfg();
    state.baseUrl = baseUrl();
    await syncTime();
    log('Hazır. Başlat için düğmeye basın.', 'acc');
  })();

  </script>
</body>
</html>
