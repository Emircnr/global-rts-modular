<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gate.io Futures ↔ Spot — Anlık Fark (Ultra Hızlı, Tek Dosya)</title>
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9; --panel:#0e1526; --panel2:#0f1730; --glass:rgba(255,255,255,.06);
    --border:#1b2a4a; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444; --spot:#ef4444; --spotBid:#22c55e; --futBid:#22c55e; --futAsk:#ef4444;
    --radius:14px; --gap:12px; --padY:12px; --padX:12px; --font:16.5px; --maxW:1280px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#4b5563; --panel:#f5f7fb; --panel2:#ffffff; --glass:rgba(0,0,0,.04);
    --border:#d7e0ef; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --spot:#b91c1c; --spotBid:#15803d; --futBid:#15803d; --futAsk:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, #102750 0%, transparent 50%), radial-gradient(1200px 800px at 120% 10%, #103050 0%, transparent 50%), var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:var(--maxW);margin:0 auto;padding:14px}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(2,6,23,.75), transparent);backdrop-filter:blur(8px)}
  h1{margin:0;font-size:20px;letter-spacing:.2px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--glass);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--fg);padding:9px 12px;border-radius:12px;cursor:pointer}
  .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 20%, transparent)}
  input,select{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);color:var(--fg);border-radius:12px;padding:9px 12px}
  label{font-size:12px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:repeat(6,minmax(200px,1fr));gap:12px;margin-top:12px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.20)}
  .mono{font-variant-numeric:tabular-nums slashed-zero; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .legend{display:flex;gap:10px;align-items:center}
  .dot{width:9px;height:9px;border-radius:50%}
  .spotDot{background:var(--spot)} .spotBidDot{background:var(--spotBid)}
  .futBidDot{background:var(--futBid)} .futAskDot{background:var(--futAsk)}
  #topCard{margin:12px 0;padding:14px;border-radius:18px;border:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap; background:
    linear-gradient(180deg, rgba(255,255,255,.04), transparent),
    radial-gradient(1200px 500px at -10% -30%, rgba(96,165,250,.18), transparent 60%),
    linear-gradient(180deg,var(--panel),var(--panel2));}
  #topCard.hidden{display:none}
  #topPct{font-weight:900}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .blink{animation:blink .7s ease-in-out 1} @keyframes blink{50%{filter:brightness(1.35)}}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipx{background:var(--glass);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
  .chipx b{letter-spacing:.3px}
  .chipx button{all:unset;cursor:pointer;color:var(--muted)}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--gap)}
  thead th{font-size:13px;color:var(--muted);text-align:left;padding:0 10px}
  tbody td{padding:var(--padY) var(--padX);font-size:var(--font);background:linear-gradient(180deg,var(--panel),var(--panel2));border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
  tbody tr td:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
  .src-spotAsk{background:color-mix(in oklab, var(--spot) 18%, transparent)} .src-futBid{background:color-mix(in oklab, var(--futBid) 18%, transparent)}
  .src-spotBid{background:color-mix(in oklab, var(--spotBid) 18%, transparent)} .src-futAsk{background:color-mix(in oklab, var(--futAsk) 18%, transparent)}
  .pctPos{color:var(--good);font-weight:800}
  .note{color:var(--muted);font-size:12px}
  .right{margin-left:auto}
  .pill{border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .sym{font-weight:800}
</style>
</head>
<body>
<header class="wrap">
  <div class="row">
    <h1>Gate.io Futures ↔ Spot — Anlık Tahta Farkı</h1>
    <div class="legend chip">
      <span class="dot spotDot"></span>Spot ASK (Kırmızı)
      <span class="dot spotBidDot"></span>Spot BID (Yeşil)
      <span class="dot futBidDot"></span>Futures BID (Yeşil)
      <span class="dot futAskDot"></span>Futures ASK (Kırmızı)
    </div>
    <div class="chip">Saat: <span id="clock" class="mono">—:—:—</span></div>
    <div class="right row">
      <label>Tema</label>
      <select id="themeSel"><option value="dark">Koyu</option><option value="light">Açık</option></select>
    </div>
  </div>

  <!-- TOP FARK -->
  <div id="topCard" class="card">
    <span id="topSym" class="sym" style="font-size:22px">—</span>
    <span id="topSide" class="pill">—</span>
    <span id="topDesc" class="mono">—</span>
    <span id="topPct" class="mono">—</span>
    <span class="note">Kural: <b>SHORT</b> için Spot ASK ↔ Futures BID • <b>LONG</b> için Spot BID ↔ Futures ASK.</span>
  </div>

  <!-- KONTROLLER -->
  <div class="controls">
    <div class="card">
      <label>Coin ekle (örn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
      <div class="row" style="margin-top:6px">
        <input id="addSym" type="text" placeholder="Sembol"/>
        <button id="btnAdd" class="btn">Ekle</button>
        <button id="btnClear" class="btn">Tümünü Sil</button>
      </div>
      <div id="chipWrap" class="chips" style="margin-top:8px"></div>
      <div class="note" style="margin-top:6px">Sadece eklediklerin izlenir; liste yerel olarak kaydedilir.</div>
    </div>
    <div class="card">
      <label>Fark eşiği (%)</label>
      <input id="thresh" type="number" step="0.01" value="0.10"/>
      <div class="note" style="margin-top:6px">Bu yüzdeyi aşanlar listelenir.</div>
    </div>
    <div class="card">
      <label>Görünüm</label>
      <div class="row" style="margin-top:6px">
        <label class="row"><input type="checkbox" id="toggleTop" checked/> En yüksek fark kartı</label>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding:12px 0 40px">
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Coin</th>
          <th>Spot ASK (Kırmızı)</th>
          <th>Futures BID (Yeşil)</th>
          <th>% Fark (SHORT)</th>
          <th>Spot BID (Yeşil)</th>
          <th>Futures ASK (Kırmızı)</th>
          <th>% Fark (LONG)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <p class="note" style="margin:10px 2px">Senkron hız: Fiyatlar Gate.io WS’ten anlık gelir; DOM güncellemesi kare başına yapılır.</p>
</main>

<script>
/* ========= Yardımcılar ========= */
const $ = s=>document.querySelector(s);
const now = ()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});
const nf = new Intl.NumberFormat('tr-TR',{maximumFractionDigits:9});
const toNum = v => (typeof v === 'number') ? v : parseFloat(v);
const pct = v => isFinite(v) ? ((v>=0?'+':'') + v.toFixed(3) + '%') : '—';

/* ========= Kalıcı Durum ========= */
const S = {
  coins: new Set(JSON.parse(localStorage.getItem('gate:list')||'["BTC_USDT","ETH_USDT"]')),
  ui: {
    thresh:+(localStorage.getItem('gate:thresh')||0.10),
    theme: localStorage.getItem('gate:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('gate:showTop')||'true')
  },
  spot: new Map(), // sym -> {bid, ask, ts}
  fut: new Map(),  // sym -> {bid, ask, ts}
  rowEls: new Map(),
  rafScheduled:false,
  ws:{spot:null, fut:null},
  lastTop:null
};
function saveList(){ localStorage.setItem('gate:list', JSON.stringify([...S.coins])); }
function saveUI(){
  localStorage.setItem('gate:thresh', S.ui.thresh);
  localStorage.setItem('gate:theme', S.ui.theme);
  localStorage.setItem('gate:showTop', S.ui.showTop);
}

/* ========= Tema & Saat ========= */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; saveUI(); applyTheme(); };
applyTheme();
setInterval(()=>$('#clock').textContent=now(), 1000);

/* ========= UI Bağlama ========= */
$('#thresh').value = String(S.ui.thresh);
$('#toggleTop').checked = !!S.ui.showTop;
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; saveUI(); scheduleDraw(); };
$('#toggleTop').onchange = e=>{ S.ui.showTop = e.target.checked; saveUI(); scheduleDraw(); };

function renderChips(){
  const wrap = $('#chipWrap'); wrap.innerHTML = '';
  const frag = document.createDocumentFragment();
  [...S.coins].forEach(sym=>{
    const d = document.createElement('div'); d.className='chipx';
    const b = document.createElement('b'); b.textContent = sym.replace('_','');
    const x = document.createElement('button'); x.textContent='✕';
    x.onclick=()=>{ S.coins.delete(sym); saveList(); unsub(sym); S.rowEls.get(sym)?.remove(); S.rowEls.delete(sym); scheduleDraw(); };
    d.appendChild(b); d.appendChild(x); frag.appendChild(d);
  });
  wrap.appendChild(frag);
}
renderChips();

$('#btnAdd').onclick = ()=>{
  const raw=$('#addSym').value.trim().toUpperCase(); if(!raw) return;
  let sym = raw.includes('_')? raw : raw.replace('USDT','_USDT');
  sym = sym.replace(/[^A-Z0-9_]/g,'');
  if(!sym.endsWith('_USDT')) return alert('Sadece *_USDT sembolleri.');
  if(!S.coins.has(sym)){
    S.coins.add(sym); saveList(); renderChips(); sub(sym);
  }
  $('#addSym').value='';
};
$('#btnClear').onclick = ()=>{
  if(confirm('Tüm coinleri sil?')){
    [...S.coins].forEach(s=>unsub(s)); S.coins.clear(); saveList();
    S.rowEls.forEach(el=>el.remove()); S.rowEls.clear();
    scheduleDraw();
  }
};

/* ========= Gate.io WebSocket ========= */
/* Spot: wss://api.gateio.ws/ws/v4/  channel: spot.book_ticker (payload: ["BTC_USDT"]) */
/* Futures (USDT): wss://fx-ws.gateio.ws/v4/ws/usdt  channel: futures.book_ticker (payload: ["BTC_USDT"]) */
function wsConnect(kind){
  const isSpot = kind==='spot';
  try{ S.ws[kind]?.close?.(); }catch{}
  const url = isSpot ? 'wss://api.gateio.ws/ws/v4/' : 'wss://fx-ws.gateio.ws/v4/ws/usdt';
  const ws = new WebSocket(url); S.ws[kind]=ws;

  ws.onopen = ()=>{
    for(const sym of S.coins){ sendSub(kind, sym, true); }
  };
  ws.onmessage = (ev)=>{
    try{
      const j = JSON.parse(ev.data);
      if(!j || j.event!=='update' || !j.result) return;

      if(isSpot && j.channel==='spot.book_ticker'){
        const r = j.result;
        const sym = r.s; const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.spot.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
      if(!isSpot && j.channel==='futures.book_ticker'){
        const r = j.result;
        const sym = r.s; const bid=toNum(r.b), ask=toNum(r.a);
        if(isFinite(bid)||isFinite(ask)) S.fut.set(sym,{bid,ask,ts:r.t||Date.now()});
        scheduleDraw();
      }
    }catch(_){}
  };
  ws.onclose = ()=>{ setTimeout(()=>wsConnect(kind), 800 + Math.random()*400); };
  setInterval(()=>{
    if(ws.readyState===1){
      const t = Math.floor(Date.now()/1000);
      const ch = isSpot ? 'spot.ping' : 'futures.ping';
      ws.send(JSON.stringify({time:t,channel:ch}));
    }
  }, 15000);
}
function sendSub(kind, sym, on){
  const ws=S.ws[kind]; if(!ws || ws.readyState!==1) return;
  const isSpot = kind==='spot';
  const channel = isSpot ? 'spot.book_ticker' : 'futures.book_ticker';
  const msg = { time: Math.floor(Date.now()/1000), channel, event: on?'subscribe':'unsubscribe', payload:[sym] };
  ws.send(JSON.stringify(msg));
}
function sub(sym){ sendSub('spot',sym,true); sendSub('fut',sym,true); ensureRow(sym); }
function unsub(sym){ sendSub('spot',sym,false); sendSub('fut',sym,false); S.spot.delete(sym); S.fut.delete(sym); }

/* Başlat WS */
wsConnect('spot'); wsConnect('fut');

/* ========= Hesaplama ========= */
function cmpFor(sym){
  const sp=S.spot.get(sym), fu=S.fut.get(sym);
  if(!sp || !fu) return null;
  const askS=sp.ask, bidS=sp.bid, bidF=fu.bid, askF=fu.ask;
  const okShort = isFinite(askS)&&isFinite(bidF)&&askS>0;
  const okLong  = isFinite(bidS)&&isFinite(askF)&&askF>0;
  const shortPct = okShort ? ( (bidF - askS) / askS * 100 ) : NaN;
  const longPct  = okLong  ? ( (bidS - askF) / askF * 100 ) : NaN;
  return {sym, askS, bidS, bidF, askF, shortPct, longPct};
}

/* ========= Çizim (rAF ile) ========= */
function ensureRow(sym){
  if(S.rowEls.has(sym)) return;
  const tr=document.createElement('tr'); tr.dataset.sym=sym;
  const tdC=document.createElement('td'); tdC.className='sym'; tdC.textContent=sym.replace('_','');
  const tdSAsk=document.createElement('td'); tdSAsk.className='mono src-spotAsk'; tdSAsk.textContent='—';
  const tdFBid=document.createElement('td'); tdFBid.className='mono src-futBid'; tdFBid.textContent='—';
  const tdShort=document.createElement('td'); tdShort.className='mono'; tdShort.textContent='—';
  const tdSBid=document.createElement('td'); tdSBid.className='mono src-spotBid'; tdSBid.textContent='—';
  const tdFAsk=document.createElement('td'); tdFAsk.className='mono src-futAsk'; tdFAsk.textContent='—';
  const tdLong=document.createElement('td'); tdLong.className='mono'; tdLong.textContent='—';
  tr.append(tdC,tdSAsk,tdFBid,tdShort,tdSBid,tdFAsk,tdLong);
  $('#tbody').appendChild(tr);
  S.rowEls.set(sym,{tr,tdSAsk,tdFBid,tdShort,tdSBid,tdFAsk,tdLong});
}
function scheduleDraw(){ if(!S.rafScheduled){ S.rafScheduled=true; requestAnimationFrame(draw); } }

function draw(){
  S.rafScheduled=false;
  const rows=[];
  for(const sym of S.coins){
    ensureRow(sym);
    const r = cmpFor(sym);
    const el = S.rowEls.get(sym);
    if(!r){
      el.tr.style.display = 'none';
      continue;
    }
    const thr = Number(S.ui.thresh)||0;

    // Pozitif filtre: sadece >0 ve eşiği geçen farklar gösterilir
    const showShort = isFinite(r.shortPct) && r.shortPct > 0 && r.shortPct >= thr;
    const showLong  = isFinite(r.longPct)  && r.longPct  > 0 && r.longPct  >= thr;

    // Satır görünürlüğü: iki yönde de pozitif yoksa satırı gizle
    el.tr.style.display = (showShort || showLong) ? '' : 'none';

    // Fiyat hücreleri her zaman güncellenir (satır görünürse)
    el.tdSAsk.textContent = isFinite(r.askS) ? nf.format(r.askS) : '—';
    el.tdFBid.textContent = isFinite(r.bidF) ? nf.format(r.bidF) : '—';
    el.tdSBid.textContent = isFinite(r.bidS) ? nf.format(r.bidS) : '—';
    el.tdFAsk.textContent = isFinite(r.askF) ? nf.format(r.askF) : '—';

    // Yalnız pozitif yüzdeleri yaz; negatif/0 ise “—”
    el.tdShort.innerHTML = showShort ? `<span class="pctPos">${pct(r.shortPct)}</span>` : '—';
    el.tdLong.innerHTML  = showLong  ? `<span class="pctPos">${pct(r.longPct)}</span>`  : '—';

    if(showShort || showLong){
      const best = Math.max(showShort?r.shortPct:-Infinity, showLong?r.longPct:-Infinity);
      rows.push({sym, best, short:showShort?r.shortPct:NaN, long:showLong?r.longPct:NaN, r});
    }
  }

  // En iyi kart — sadece pozitifler arasından
  const top=$('#topCard');
  if(!S.ui.showTop || rows.length===0){ top.classList.add('hidden'); }
  else{
    rows.sort((a,b)=>b.best-a.best);
    const t=rows[0].r;
    const isLong = (isFinite(t.longPct) && t.longPct>0 && t.longPct>= (Number(S.ui.thresh)||0)) &&
                   (!(isFinite(t.shortPct) && t.shortPct>0) || t.longPct >= t.shortPct);
    $('#topSym').textContent = t.sym.replace('_','');
    $('#topSide').textContent = isLong ? 'FUTURES LONG' : 'FUTURES SHORT';
    $('#topSide').className = 'pill ' + (isLong ? 'good' : 'bad');
    $('#topDesc').textContent = isLong
      ? `Spot BID ${nf.format(t.bidS)} ↔ Futures ASK ${nf.format(t.askF)}`
      : `Spot ASK ${nf.format(t.askS)} ↔ Futures BID ${nf.format(t.bidF)}`;
    const bestPct = isLong ? t.longPct : t.shortPct;
    const pctEl = $('#topPct');
    pctEl.textContent = pct(bestPct);
    pctEl.className = 'mono good';
    if(!S.lastTop || S.lastTop.sym!==t.sym || S.lastTop.side!== (isLong?'L':'S') || Math.abs(S.lastTop.pct - bestPct) > 0.0005){
      top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 300);
      S.lastTop = {sym:t.sym, side:isLong?'L':'S', pct:bestPct};
    }
    top.classList.remove('hidden');
  }

  $('#clock').textContent = now();
}

/* ========= Başlangıç ========= */
function start(){
  S.coins.forEach(sym=>{ ensureRow(sym); sub(sym); });
  $('#clock').textContent = now();
  scheduleDraw();
}
start();
</script>
</body>
</html>
