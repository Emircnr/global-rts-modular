<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAC Channel Bot • Firestore ⇄ Gate.io (Hybrid)</title>
<!-- Geçerli, 1x1 şeffaf favicon (ERR_INVALID_URL engel) -->
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">
<style>
  :root{
    --bg:#0b0f19; --fg:#e8eef7; --muted:#9fb0c9;
    --panel:#0f162a; --panel2:#0d1426; --glass:rgba(255,255,255,.06);
    --border:#1c2948; --acc:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --radius:18px; --gap:14px; --font:16px; --maxW:1320px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #152042 0%, transparent 60%) , var(--bg);color:var(--fg);font:400 var(--font)/1.55 'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:var(--maxW);margin:28px auto;padding:0 14px}
  h1{margin:0 0 6px;font-size:28px;letter-spacing:.3px}
  .sub{margin:0 0 18px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:420px 1fr;gap:16px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 40px rgba(0,0,0,.35)}
  .sec{padding:14px 14px 2px;color:var(--muted);font-size:13px;border-bottom:1px dashed var(--border)}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px}
  .form.full{grid-template-columns:1fr}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0d1528;color:#e8eef7}
  textarea{min-height:64px;resize:vertical}
  button{background:var(--acc);color:#071122;font-weight:700;border:none;cursor:pointer;transition:transform .06s ease}
  button:active{transform:translateY(1px)}
  button.ghost{background:transparent;border:1px solid var(--border);color:#e8eef7;font-weight:600}
  .row{display:flex;gap:10px;align-items:center}
  .kpis{display:flex;flex-wrap:wrap;gap:10px;padding:12px 14px;border-top:1px dashed var(--border)}
  .tag{padding:6px 10px;border-radius:12px;background:var(--glass);border:1px solid var(--border);font-size:14px}
  .list{padding:14px}
  .sym{display:grid;grid-template-columns:120px repeat(9,1fr);gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--border);font-size:14px}
  .sym .badge{font-size:12px;color:var(--muted)}
  .sym .s{font-weight:700}
  .status{padding:10px 14px;min-height:24px;color:#ffb4b4}
  .muted{color:var(--muted);font-size:13px}
  .footer{opacity:.65;text-align:center;margin-top:16px;font-size:13px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass)}
  .pill .dot{width:8px;height:8px;border-radius:50%}
  .pill .on{background:var(--good)} .pill .off{background:#6b7280}
  .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <h1>MAC Channel Bot — Firestore ⇄ Gate.io (Hybrid)</h1>
  <div class="sub">Kanal içindeyken üst banda <b>LONG</b>, alt banda <b>SHORT</b> bekleyen emirler; biri dolunca diğeri iptal + <b>karşı banttan trailing STOP</b>. Varsayılan güncelleme: <b>3 sn</b>.</div>

  <div class="grid">
    <!-- Sol Panel -->
    <div class="card">
      <div class="sec">Proxy & Gate API</div>
      <div class="form">
        <div><label>Proxy Base URL</label><input id="proxy" placeholder="http://localhost:8787"/></div>
        <div><label>Piyasa</label>
          <select id="market"><option value="um" selected>USDT-M Perp</option><option value="cm">Coin-M Perp</option></select>
        </div>
        <div><label>Gate API Key</label><input id="apiKey" placeholder="Kamu anahtar"/></div>
        <div><label>Gate API Secret</label><input id="apiSecret" placeholder="GİZLİ anahtar" type="password"/></div>
        <div class="row" style="grid-column:1/-1">
          <div class="pill"><span class="dot off" id="dotProxy"></span>Proxy</div>
          <button id="btnPing" class="ghost">Proxy Test</button>
        </div>
      </div>

      <div class="sec">Firestore Sinyal Kaynağı</div>
      <div class="form">
        <div><label>Project ID</label><input id="fs_projectId" value="macbot-b7b45"/></div>
        <div><label>API Key</label><input id="fs_apiKey" value="AIzaSyAh6JbnjsZtD-d0g3iSb2maSerPntUP6To"/></div>
        <div><label>App ID</label><input id="fs_appId" value="1:88494187419:web:9e0fd1a37e51332203373e"/></div>
        <div><label>Auth Domain</label><input id="fs_authDomain" value="macbot-b7b45.firebaseapp.com"/></div>
        <div><label>Collection</label><input id="fs_col" value="gate_mac_logs"/></div>
        <div><label>FS Sembol Formatı</label>
          <select id="fs_sym_fmt"><option value="auto" selected>Auto (BTC_USDT → BTCUSDT)</option><option value="same">Aynı</option></select>
        </div>
        <div class="row" style="grid-column:1/-1">
          <button id="fs_init" class="ghost">Firestore Bağlan</button>
          <div class="pill"><span class="dot off" id="dotFS"></span>Firestore</div>
          <span id="fsMode" class="muted">-</span>
        </div>
      </div>

      <div class="sec">Sinyal → Emir Parametreleri</div>
      <div class="form">
        <div><label>Semboller (Gate kontratı)</label><input id="symbols" value="BTC_USDT"/></div>
        <div><label>Kaldıraç (x)</label><input id="lev" type="number" min="1" value="10"/></div>
        <div><label>Tutar (USDT)</label><input id="usd" type="number" min="5" value="50"/></div>
        <div><label>Buffer (bps)</label><input id="bps" type="number" min="0" value="3"/></div>
        <div><label>Tick (sn)</label><input id="tick" type="number" min="1" value="3"/></div>
        <div><label>Yalnız Kanal İçinde?</label>
          <select id="onlyInside"><option value="yes" selected>Evet</option><option value="no">Hayır (daima bantlara)</option></select>
        </div>
        <div><label>Hybrid: FS Bayat Eşik (sn)</label><input id="staleSec" type="number" min="3" value="12"/></div>
        <div><label>Hybrid Kullan?</label>
          <select id="useHybrid"><option value="yes" selected>Evet</option><option value="no">Hayır (yalnız FS)</option></select>
        </div>
      </div>

      <div class="form full">
        <div class="row" style="padding:0 14px 14px;">
          <button id="start">START</button>
          <button id="stop" class="ghost">STOP</button>
          <button id="save" class="ghost">Ayarları Kaydet</button>
        </div>
        <div class="muted" style="padding:0 14px 14px;">Uyarı: API Secret’ı tarayıcıda tutmak güvenli değildir. Üretimde anahtarları <b>proxy</b>’de saklayın.</div>
      </div>
    </div>

    <!-- Sağ Panel -->
    <div class="card">
      <div class="sec">Durum</div>
      <div class="kpis">
        <div class="tag">Loop: <span id="loop" class="badge">STOPPED</span></div>
        <div class="tag">Son tick: <span id="lastTick" class="badge">-</span></div>
        <div class="tag">Hata: <span id="err" class="badge">-</span></div>
      </div>

      <div class="sec">Semboller</div>
      <div class="list" id="symList"></div>

      <div class="status" id="status"></div>
      <div class="muted" style="padding:0 14px 14px;">
        “İşlem yapmıyor” diyorsa çoğu kez <b>fiyat kanalın dışındadır</b>. “Yalnız Kanal İçinde?” ayarını <b>Hayır</b> yaparsanız bantlara her durumda emir günceller.
      </div>
    </div>
  </div>

  <div class="footer">Eğitim amaçlıdır. Gerçek işlem risklidir; tüm sorumluluk size aittir.</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/* ============ Yardımcılar & UI ============ */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const fmt = n => (n==null||isNaN(n))?'-':(+n).toLocaleString(undefined,{maximumFractionDigits:8});
const saveLS = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
const loadLS = (k,d)=> { try{ const v=JSON.parse(localStorage.getItem(k)); return v??d; }catch{ return d; } };
const bpsToMult = bps => 1 + (bps/10000);

function mark(el, ok){ el.classList.remove('on','off'); el.classList.add(ok?'on':'off'); }
const markProxy = ok => mark(qs('dotProxy'), ok);
const markFS    = ok => mark(qs('dotFS'), ok);
function uiSetErr(m){ qs('err').textContent = m || '-'; }
function uiTick(){ qs('lastTick').textContent = new Date().toLocaleTimeString(); }

function normalizeBaseUrl(raw){
  let b=(raw||'').trim(); if(!b) throw new Error('Proxy Base URL boş');
  if(!/^https?:\/\//i.test(b)) b='http://'+b;
  try{ new URL(b); }catch{ throw new Error('Proxy Base URL geçersiz: '+b); }
  return b.replace(/\/+$/,'');
}
const toFsSymbol=(gate,mode='auto')=> mode==='same' ? (gate||'').toUpperCase() : (gate||'').toUpperCase().replace('_','');
const toGate=(sym)=> !sym ? sym : (sym.includes('_') ? sym.toUpperCase() :
                 (sym.toUpperCase().endsWith('USDT') ? sym.slice(0,-4).toUpperCase()+'_USDT' : sym.toUpperCase()));

/* ============ MA & MAC (hybrid için) ============ */
function sma(arr, n){ const out=new Array(arr.length).fill(null); let s=0;
  for(let i=0;i<arr.length;i++){ s+=arr[i]; if(i>=n) s-=arr[i-n]; if(i>=n-1) out[i]=s/n; } return out; }
function ema(arr, n){ const out=new Array(arr.length).fill(null); const k=2/(n+1); let e=null;
  for(let i=0;i<arr.length;i++){ const v=arr[i];
    if(i<n-1){ out[i]=null; e=(e==null?v:(e*i+v)/(i+1)); continue; }
    if(out[i-1]==null) e = arr.slice(0,n).reduce((a,b)=>a+b,0)/n;
    e = (v-e)*k+e; out[i]=e;
  } return out; }
function movingAverage(arr,n,kind){ return (kind==='EMA')?ema(arr,n):sma(arr,n); }
function macFromKlines(kl,n,kind,mode,envPct){
  const highs=kl.map(k=>+k.h), lows=kl.map(k=>+k.l), closes=kl.map(k=>+k.c);
  let upper,lower,mid;
  if(mode==='envelope'){
    mid = movingAverage(closes,n,kind);
    upper = mid.map(x=>x==null?null:x*(1+envPct));
    lower = mid.map(x=>x==null?null:x*(1-envPct));
  }else{
    upper = movingAverage(highs,n,kind);
    lower = movingAverage(lows,n,kind);
    mid = upper.map((u,i)=> (u==null||lower[i]==null)?null:(u+lower[i])/2);
  }
  const c=closes.at(-1), u=upper.at(-1), l=lower.at(-1);
  const inside = (u!=null && l!=null)? (l<=c && c<=u) : null;
  return { upper:u, lower:l, mid:mid.at(-1)??null, close:c, in_channel:inside };
}

/* ============ Firestore ============ */
let FS=null, FS_OK=false, FS_MODE='-';
const SIG = {}; // symbol -> {close,upper,lower,mid,in_channel,ts_ms,...}
const FS_UNSUB = {};
let POLL_TMR=null;

async function fsInit(){
  try{
    const cfg={ apiKey:qs('fs_apiKey').value.trim(), authDomain:qs('fs_authDomain').value.trim(),
                projectId:qs('fs_projectId').value.trim(), appId:qs('fs_appId').value.trim() };
    const app = firebase.initializeApp(cfg, 'mac-fire-'+Math.random());
    FS = firebase.firestore(app);
    FS_OK=true; markFS(true); qs('fsMode').textContent='listen/poll';
  }catch(e){ FS_OK=false; markFS(false); qs('fsMode').textContent='-'; uiSetErr(e.message); }
}
function attachListener(sym){
  const col=qs('fs_col').value.trim(); const fsSym = toFsSymbol(sym, qs('fs_sym_fmt').value);
  try{
    const ref=FS.collection(col).where('symbol','==',fsSym).orderBy('ts_ms','desc').limit(1);
    const unsub = ref.onSnapshot(snap=>{
      FS_MODE='listen'; qs('fsMode').textContent='listen';
      if(!snap.empty){ SIG[sym]=snap.docs[0].data(); }
    }, _=>{ FS_MODE='poll'; qs('fsMode').textContent='poll'; });
    FS_UNSUB[sym]=unsub;
  }catch{ FS_MODE='poll'; qs('fsMode').textContent='poll'; }
}
async function pollLatest(sym){
  const col=qs('fs_col').value.trim(); const fsSym=toFsSymbol(sym,qs('fs_sym_fmt').value);
  try{
    const snap = await FS.collection(col).orderBy('ts_ms','desc').limit(50).get();
    let best=null; snap.forEach(d=>{ const x=d.data(); if((x.symbol||'').toUpperCase()===fsSym){ if(!best || x.ts_ms>best.ts_ms) best=x; }});
    if(best) SIG[sym]=best;
  }catch(e){ qs('status').textContent='Firestore polling hata: '+e.message; }
}

/* ============ Proxy ============ */
let PROXY_BASE=null;
async function pingProxy(){
  try{
    PROXY_BASE = normalizeBaseUrl(qs('proxy').value);
    const r = await fetch(PROXY_BASE+'/healthz'); const j=await r.json().catch(()=>null);
    const ok=r.ok && j && j.ok===true; markProxy(ok); if(!ok) throw new Error('Proxy healthz başarısız');
    return true;
  }catch(e){ markProxy(false); uiSetErr(e.message||String(e)); return false; }
}
async function proxyCall(path, body){
  if(!PROXY_BASE) PROXY_BASE = normalizeBaseUrl(qs('proxy').value);
  const r = await fetch(PROXY_BASE+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
  const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{}
  if(!r.ok || (j && j.ok===false)){ throw new Error((j && j.error)?(typeof j.error==='string'? j.error: JSON.stringify(j.error)):(r.status+' '+r.statusText+' '+t)); }
  return j??{};
}

/* ============ Emir Devleti & UI ============ */
const ST={}; // symbol -> { position, working, orderLong:{id,price}, orderShort:{id,price}, stopId, stopPrice, entry, src:'fs'|'hyb', lastTs }
function renderRows(){
  const list=qs('symList'); list.innerHTML='';
  Object.keys(ST).forEach(sym=>{
    const S=ST[sym]||{}; const G=SIG[sym]||{};
    const age = G.ts_ms? Math.max(0, Math.round((Date.now()-G.ts_ms)/1000)) : null;
    const el=document.createElement('div'); el.className='sym';
    el.innerHTML=`
      <div class="s">${sym} <span class="muted">[${S.src||'-'}${age!=null?`, ${age}s`:' '} ]</span></div>
      <div><span class="badge">Fiyat</span><div>${fmt(G.close)}</div></div>
      <div><span class="badge">U</span><div>${fmt(G.upper)}</div></div>
      <div><span class="badge">M</span><div>${fmt(G.mid)}</div></div>
      <div><span class="badge">L</span><div>${fmt(G.lower)}</div></div>
      <div><span class="badge">Poz</span><div>${S.position||'-'}</div></div>
      <div><span class="badge">Çalışan</span><div>${S.working||'-'}</div></div>
      <div><span class="badge">Stop</span><div>${fmt(S.stopPrice)}</div></div>
      <div><button class="ghost" onclick="flatten('${sym}')">Flatten</button></div>
      <div><button class="ghost" onclick="refreshNow('${sym}')">Refresh</button></div>
    `;
    list.appendChild(el);
  });
}
function uiStatus(msg){ qs('status').textContent=msg||''; setTimeout(()=>{ if(qs('status').textContent===msg) qs('status').textContent=''; }, 4000); }

/* ============ Emir Akışı ============ */
async function cancelOrder(apiKey, apiSecret, market, orderId){ if(!orderId) return; try{ await proxyCall('/gate/cancelOrder',{apiKey,apiSecret,market,orderId}); }catch{} }
async function setLeverage(apiKey, apiSecret, market, contract, lev){ try{ await proxyCall('/gate/setLeverage',{apiKey,apiSecret,market,contract,leverage:lev}); }catch{} }

async function manageOne(sym){
  const apiKey=qs('apiKey').value.trim(), apiSecret=qs('apiSecret').value.trim(), market=qs('market').value;
  const lev=+qs('lev').value||10, usd=+qs('usd').value||50, bps=+qs('bps').value||0;
  const onlyInside = qs('onlyInside').value==='yes';
  const staleSec = +qs('staleSec').value||12;
  const useHybrid = qs('useHybrid').value==='yes';
  const fsSig = SIG[sym];

  // HYBRID: FS bayat ise klines ile tazele
  let sig = fsSig;
  const now=Date.now();
  const isStale = !fsSig || !fsSig.ts_ms || ((now - fsSig.ts_ms) > staleSec*1000);
  if(useHybrid && isStale){
    try{
      const K = await proxyCall('/gate/klines',{ market, contract: sym, interval:'1m', limit:200 });
      // Hybird MAC paramlarını Firestore ile aynı varsayıyoruz: n=20, SMA, mode=hl (gerekirse Firestore alanlarını oku)
      const mac = macFromKlines(K.data, 20, 'SMA', 'hl', 0.01);
      sig = { ...mac, ts_ms: now, symbol: toFsSymbol(sym, qs('fs_sym_fmt').value) };
      SIG[sym]=sig; // UI’da göster
      if(!ST[sym]) ST[sym]={}; ST[sym].src='hyb';
    }catch(e){ uiStatus('Hybrid tazeleme başarısız: '+e.message); }
  }else{
    if(!ST[sym]) ST[sym]={}; ST[sym].src='fs';
  }
  if(!sig || sig.upper==null || sig.lower==null || sig.close==null) return;

  const S = ST[sym] ||= { position:'NONE', working:'-', orderLong:null, orderShort:null, stopId:null, stopPrice:null, entry:null };
  const contract = toGate(sym);
  const sizeAbs = Math.max(0.0001, usd / (+sig.close||1)); // SHORT için negatif göndereceğiz
  const longPx  = +(sig.upper * bpsToMult(bps)).toFixed(8);
  const shortPx = +(sig.lower / bpsToMult(bps)).toFixed(8);

  // Başlangıçta leverage (opsiyonel)
  if(!S._levSet && qs('setLevOnStart')?.value==='yes'){ await setLeverage(apiKey,apiSecret,market,contract,lev); S._levSet=true; }

  // Emir yerleştirme
  const inside = !!sig.in_channel;
  const shouldPlace = onlyInside ? inside : true;

  if(shouldPlace){
    // LONG bekleyen
    if(!S.orderLong || Math.abs(S.orderLong.price - longPx)/longPx > 0.0001){
      await cancelOrder(apiKey, apiSecret, market, S.orderLong?.id);
      const pl = await proxyCall('/gate/placeOrder',{
        apiKey, apiSecret, market, contract, side:'buy',
        price: longPx, size:+sizeAbs, leverage:lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderLong = { id: pl.data?.id, price: longPx };
    }
    // SHORT bekleyen
    if(!S.orderShort || Math.abs(S.orderShort.price - shortPx)/shortPx > 0.0001){
      await cancelOrder(apiKey, apiSecret, market, S.orderShort?.id);
      const ps = await proxyCall('/gate/placeOrder',{
        apiKey, apiSecret, market, contract, side:'sell',
        price: shortPx, size:-sizeAbs, leverage:lev,
        type:'limit', reduceOnly:false, tif:'gtc'
      });
      S.orderShort = { id: ps.data?.id, price: shortPx };
    }
    S.working = `L@${S.orderLong?.price??'-'} / S@${S.orderShort?.price??'-'}`;
  }else{
    // kanal dışı ve onlyInside=Evet → bekleyenleri iptal
    if(S.orderLong?.id){ await cancelOrder(apiKey, apiSecret, market, S.orderLong.id); S.orderLong=null; }
    if(S.orderShort?.id){ await cancelOrder(apiKey, apiSecret, market, S.orderShort.id); S.orderShort=null; }
    S.working='-';
  }

  // Basit dolum tetik — close>=longPx veya close<=shortPx (gerçekte openOrders/positions ile teyit edebilirsin)
  const p=+sig.close;
  if(S.orderLong && p >= S.orderLong.price){
    if(S.orderShort?.id){ await cancelOrder(apiKey, apiSecret, market, S.orderShort.id); S.orderShort=null; }
    S.position='LONG'; S.entry=S.orderLong.price; S.orderLong=null; S.working='-';
    // STOP: lower banda, reduceOnly, sell, size=+sizeAbs
    const stopPx = sig.lower;
    if(stopPx){
      const st = await proxyCall('/gate/placeOrder',{
        apiKey, apiSecret, market, contract, side:'sell',
        price: stopPx, size:+sizeAbs, leverage:lev,
        type:'stop', stopPrice: stopPx, stopType:'down', reduceOnly:true, tif:'gtc'
      });
      S.stopId = st.data?.id; S.stopPrice=stopPx;
    }
  }else if(S.orderShort && p <= S.orderShort.price){
    if(S.orderLong?.id){ await cancelOrder(apiKey, apiSecret, market, S.orderLong.id); S.orderLong=null; }
    S.position='SHORT'; S.entry=S.orderShort.price; S.orderShort=null; S.working='-';
    // STOP: upper banda, reduceOnly, buy, size=-sizeAbs
    const stopPx = sig.upper;
    if(stopPx){
      const st = await proxyCall('/gate/placeOrder',{
        apiKey, apiSecret, market, contract, side:'buy',
        price: stopPx, size:-sizeAbs, leverage:lev,
        type:'stop', stopPrice: stopPx, stopType:'up', reduceOnly:true, tif:'gtc'
      });
      S.stopId = st.data?.id; S.stopPrice=stopPx;
    }
  }

  // Trailing STOP
  if(S.position==='LONG' && S.stopId && sig.lower && Math.abs(sig.lower-(S.stopPrice||0))/Math.max(S.stopPrice||1,1) > 0.0005){
    await cancelOrder(apiKey, apiSecret, market, S.stopId);
    const st2 = await proxyCall('/gate/placeOrder',{
      apiKey, apiSecret, market, contract, side:'sell',
      price: sig.lower, size:+sizeAbs, leverage:lev,
      type:'stop', stopPrice: sig.lower, stopType:'down', reduceOnly:true, tif:'gtc'
    });
    S.stopId=st2.data?.id; S.stopPrice=sig.lower;
  }
  if(S.position==='SHORT' && S.stopId && sig.upper && Math.abs(sig.upper-(S.stopPrice||0))/Math.max(S.stopPrice||1,1) > 0.0005){
    await cancelOrder(apiKey, apiSecret, market, S.stopId);
    const st2 = await proxyCall('/gate/placeOrder',{
      apiKey, apiSecret, market, contract, side:'buy',
      price: sig.upper, size:-sizeAbs, leverage:lev,
      type:'stop', stopPrice: sig.upper, stopType:'up', reduceOnly:true, tif:'gtc'
    });
    S.stopId=st2.data?.id; S.stopPrice=sig.upper;
  }
}

async function flatten(sym){
  const apiKey=qs('apiKey').value.trim(), apiSecret=qs('apiSecret').value.trim(), market=qs('market').value;
  const S=ST[sym]||{}, sig=SIG[sym]||{}, contract=toGate(sym), lev=+qs('lev').value||10;
  const sizeAbs= Math.max(0.0001, (+qs('usd').value||50) / (+sig.close||1));
  await cancelOrder(apiKey,apiSecret,market,S.orderLong?.id); S.orderLong=null;
  await cancelOrder(apiKey,apiSecret,market,S.orderShort?.id); S.orderShort=null;
  await cancelOrder(apiKey,apiSecret,market,S.stopId); S.stopId=null; S.stopPrice=null;

  if(S.position==='LONG'){
    await proxyCall('/gate/placeOrder',{ apiKey, apiSecret, market, contract, side:'sell',
      price:"0", size:+sizeAbs, leverage:lev, type:'limit', reduceOnly:true, tif:'ioc' });
  }else if(S.position==='SHORT'){
    await proxyCall('/gate/placeOrder',{ apiKey, apiSecret, market, contract, side:'buy',
      price:"0", size:-sizeAbs, leverage:lev, type:'limit', reduceOnly:true, tif:'ioc' });
  }
  S.position='NONE'; ST[sym]=S; renderRows();
}

async function refreshNow(sym){
  // Manuel tazele: klines çek → hibrit MAC yaz
  const market=qs('market').value;
  try{
    const K = await proxyCall('/gate/klines',{ market, contract:sym, interval:'1m', limit:200 });
    const mac = macFromKlines(K.data, 20, 'SMA', 'hl', 0.01);
    SIG[sym] = { ...mac, ts_ms: Date.now(), symbol: toFsSymbol(sym, qs('fs_sym_fmt').value) };
    uiStatus(sym+' tazelendi');
  }catch(e){ uiStatus('Refresh hata: '+e.message); }
  renderRows();
}
window.flatten = flatten; // butonlar için
window.refreshNow = refreshNow;

/* ============ Döngü & Olaylar ============ */
let LOOP=false;
function saveSettings(){
  const keys=['proxy','market','apiKey','apiSecret','fs_projectId','fs_apiKey','fs_appId','fs_authDomain','fs_col','fs_sym_fmt','symbols','lev','usd','bps','tick','onlyInside','staleSec','useHybrid','setLevOnStart'];
  const obj={}; keys.forEach(k=>obj[k]=qs(k).value); saveLS('mac_gate_hybrid_cfg',obj); uiStatus('Ayarlar kaydedildi ✔');
}
function loadSettings(){
  const obj=loadLS('mac_gate_hybrid_cfg',null); if(!obj) return; Object.keys(obj).forEach(k=>{ if(qs(k)) qs(k).value=obj[k]; });
}
async function start(){
  saveSettings();
  // Proxy kontrol
  const ok=await pingProxy(); if(!ok){ uiSetErr('Proxy bağlantısı başarısız'); return; }
  // FS
  if(!FS) await fsInit(); if(!FS_OK){ uiSetErr('Firestore bağlanamadı'); return; }

  const symbols = qs('symbols').value.split(',').map(s=>s.trim()).filter(Boolean).map(toGate);
  if(symbols.length===0){ uiSetErr('En az bir sembol giriniz (BTC_USDT gibi)'); return; }
  symbols.forEach(s=>{ if(!ST[s]) ST[s]={}; });

  // Dinleyiciler
  for(const s of symbols){ if(FS_UNSUB[s]){ try{FS_UNSUB[s]();}catch{} } attachListener(s); }

  // Poll fallback
  if(POLL_TMR) clearInterval(POLL_TMR);
  POLL_TMR = setInterval(async()=>{ if(FS_MODE==='poll'){ for(const s of symbols) await pollLatest(s); }}, 2000);

  LOOP=true; qs('loop').textContent='RUNNING'; uiSetErr('-'); renderRows();
  const tickSec=Math.max(1, +qs('tick').value || 3);
  (async function loop(){
    while(LOOP){
      try{
        for(const s of symbols){ await manageOne(s); }
        uiTick(); renderRows();
        await sleep(tickSec*1000);
      }catch(e){ uiSetErr(e.message||String(e)); await sleep(1000); }
    }
  })();
}
function stop(){
  LOOP=false; qs('loop').textContent='STOPPED';
  if(POLL_TMR) clearInterval(POLL_TMR);
  for(const k in FS_UNSUB){ try{FS_UNSUB[k]();}catch{} delete FS_UNSUB[k]; }
}

/* init */
loadSettings();
qs('start').addEventListener('click', start);
qs('stop').addEventListener('click', stop);
qs('save').addEventListener('click', saveSettings);
qs('fs_init').addEventListener('click', fsInit);
qs('btnPing').addEventListener('click', pingProxy);
</script>
</body>
</html>
